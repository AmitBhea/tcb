
(function(app){SUGAR.jssource={"fields":{"base":{"avatar":{"controller":({extendsFrom:'ImageField',plugins:['File','Tooltip'],_render:function(){var template;app.view.invokeParent(this,{type:'field',name:'image',method:'_render'});if(this.action!=='edit'){if(_.isEmpty(this.value)){template=app.template.getField(this.type,'module-icon',this.module);if(template){this.$('.image_field').replaceWith(template({module:this.module}));}}else{this.$('.image_field').addClass('image_rounded');}}
return this;},_loadTemplate:function(){this.type='image';app.view.invokeParent(this,{type:'field',name:'image',method:'_loadTemplate'});this.type=this.def.type;}})},"email":{"controller":({extendsFrom:'ListeditableField',useSugarEmailClient:false,events:{'change .existingAddress':'updateExistingAddress','click  .btn-edit':'toggleExistingAddressProperty','click  .removeEmail':'removeExistingAddress','click  .addEmail':'addNewAddress','change .newEmail':'addNewAddress','click  .composeEmail':'composeEmail'},_flag2Deco:{primary_address:{lbl:"LBL_EMAIL_PRIMARY",cl:"primary"},opt_out:{lbl:"LBL_EMAIL_OPT_OUT",cl:"opted-out"},invalid_email:{lbl:"LBL_EMAIL_INVALID",cl:"invalid"}},plugins:['EllipsisInline','Tooltip'],initialize:function(options){options=options||{};options.def=options.def||{};if(_.isUndefined(options.def.link)){options.def.link=true;}
app.view.Field.prototype.initialize.call(this,options);this.useSugarEmailClient=(app.user.getPreference("use_sugar_email_client")==="true");},addNewAddress:function(evt){if(!evt)return;var email=this.$(evt.currentTarget).val()||this.$('.newEmail').val();if(email!==""){this._addNewAddress(email);}},updateExistingAddress:function(evt){if(!evt)return;var $inputs=this.$('input'),$input=this.$(evt.currentTarget),index=$inputs.index($input),newEmail=$input.val();if(newEmail===""){this._removeExistingAddress(index);}else{this._updateExistingAddress(index,newEmail);}},removeExistingAddress:function(evt){if(!evt)return;var $deleteButtons=this.$('.removeEmail'),$deleteButton=this.$(evt.currentTarget),index=$deleteButtons.index($deleteButton);this._removeExistingAddress(index);},toggleExistingAddressProperty:function(evt){if(!evt)return;var $property=this.$(evt.currentTarget),property=$property.data('emailproperty'),$properties=this.$('[data-emailproperty='+property+']'),index=$properties.index($property);this._toggleExistingAddressProperty(index,property);},_addNewAddress:function(email){var dupeAddress;var existingAddresses=_.clone(this.model.get(this.name))||[];var oldAddresses=this.model.get(this.name)||[];dupeAddress=_.find(oldAddresses,function(address){if(address.email_address==email){return true;}});if(dupeAddress){this.render();return false;}
var newObj={email_address:email};if(existingAddresses.length<1){newObj.primary_address=true;}
existingAddresses.push(newObj);this.updateModel(existingAddresses);},_updateExistingAddress:function(index,newEmail){var existingAddresses=_.clone(this.model.get(this.name));existingAddresses[index].email_address=newEmail;this.updateModel(existingAddresses);},_toggleExistingAddressProperty:function(index,property){var existingAddresses=_.clone(this.model.get(this.name));if(property==='primary_address'){existingAddresses[index][property]=false;_.find(existingAddresses,function(email,i){if(email[property]){existingAddresses[i][property]=false;}});}
if(existingAddresses[index][property]){existingAddresses[index][property]=false;}else{existingAddresses[index][property]=true;}
this.updateModel(existingAddresses);},_removeExistingAddress:function(index){var existingAddresses=_.clone(this.model.get(this.name)),wasPrimary=existingAddresses[index]['primary_address'];existingAddresses=_.reject(existingAddresses,function(emailInfo,i){return i==index;});if(wasPrimary){var address=_.first(existingAddresses);if(address){address.primary_address=true;}}
this.updateModel(existingAddresses);},updateModel:function(value){this.model.set(this.name,value);this.model.trigger('change');this.model.trigger('change:'+this.name);},massUpdateProperty:function(emails,propName,value){_.each(emails,function(emailInfo,index){emails[index][propName]=value;});return emails;},decorateError:function(errors){var emails;this.$el.closest('.record-cell').addClass("error");emails=this.$('input:not(.newEmail)');_.each(errors,function(errorContext,errorName){if(errorName==='email'||errorName==='duplicateEmail'){_.each(emails,function(e){var $email=this.$(e),email=$email.val();var isError=_.find(errorContext,function(emailError){return emailError===email;});if(!_.isUndefined(isError)){this._addErrorDecoration($email,errorName,[isError]);}},this);}else{var $email=this.$('input:first');this._addErrorDecoration($email,errorName,errorContext);}},this);},_addErrorDecoration:function($input,errorName,errorContext){var isWrapped=$input.parent().hasClass('input-append');if(!isWrapped)
$input.wrap('<div class="input-append error '+this.fieldTag+'">');$input.next('.error-tooltip').remove();$input.after(this.exclamationMarkTemplate([app.error.getErrorString(errorName,errorContext)]));var $tooltip=$input.next('.error-tooltip');if(_.isFunction($tooltip.tooltip)){$tooltip.tooltip({container:'body',placement:'top',trigger:'click'});}},bindDomChange:function(){if(this.tplName==='list-edit'){app.view.Field.prototype.bindDomChange.call(this);}},format:function(value){value=app.utils.deepCopy(value);if(_.isArray(value)&&value.length>0){_.each(value,function(email){email.hasAnchor=this.def.link&&!email.opt_out&&!email.invalid_email;},this);}else if((_.isString(value)&&value!=="")||this.view.action==='list'){value=[{email_address:value,primary_address:true,hasAnchor:false,_wasNotArray:true}];}
value=this.addFlagLabels(value);return value;},addFlagLabels:function(value){var flagStr="",flagClassStr="",flagArray,flagClass;_.each(value,function(emailObj){flagStr="";flagArray=_.map(emailObj,function(flagValue,key){if(!_.isUndefined(this._flag2Deco[key])&&this._flag2Deco[key].lbl&&flagValue){return app.lang.get(this._flag2Deco[key].lbl);}},this);flagArray=_.without(flagArray,undefined);if(flagArray.length>0){flagStr=flagArray.join(", ");}
flagClassStr="";flagClass=_.map(emailObj,function(flagValue,key){if(!_.isUndefined(this._flag2Deco[key])&&this._flag2Deco[key].cl&&flagValue){return app.lang.get(this._flag2Deco[key].cl);}},this);flagClass=_.without(flagClass,undefined);if(flagClass.length>0){flagClassStr=flagClass.join(", ");}
emailObj.flagLabel=flagStr;emailObj.flagClass=flagClassStr;},this);return value;},unformat:function(value){var originalNonArrayValue=null;if(this.view.action==='list'){var emails=this.model.get(this.name),changed=false;if(!_.isArray(emails)){emails=[];}
_.each(emails,function(email,index){if(email.primary_address){if(email.email_address!==value){changed=true;emails[index].email_address=value;}}},this);if(emails.length==0){emails.push({email_address:value,primary_address:true,hasAnchor:false,_wasNotArray:true});changed=true;}
if(changed){this.updateModel(emails);}
return emails;}
_.each(value,function(email,index){if(email._wasNotArray){originalNonArrayValue=email.email_address;}else{value[index]=_.pick(email,'email_address','primary_address','opt_out','invalid_email');}},this);if(!_.isNull(originalNonArrayValue)){value=originalNonArrayValue;}
return value;},focus:function(){if(this.focusIndex<0){this.focusIndex=0;}
if(this.focusIndex>=this.$inputs.length){this.focusIndex=-1;return false;}else{this.$inputs[this.focusIndex].focus();this.focusIndex++;return true;}},_render:function(){app.view.Field.prototype._render.call(this);this.$inputs=this.$('input');this.focusIndex=0;},composeEmail:function(evt){evt.stopPropagation();evt.preventDefault();var model=app.data.createBean(this.model.module);model.copy(this.model);model.set('id',this.model.id);app.drawer.open({layout:'compose',context:{create:'true',module:'Emails',prepopulate:{to_addresses:[{email:this.$(evt.currentTarget).text(),bean:model}],related:model}}});}})},"parent":{"controller":({minChars:1,extendsFrom:'RelateField',fieldTag:'input.select2[name=parent_name]',typeFieldTag:'select.select2[name=parent_type]',_render:function(){var result,self=this;app.view.invokeParent(this,{type:'field',name:'relate',method:'_render'});if(this.tplName==='edit'){this.checkAcl('access',this.model.get('parent_type'));var inList=(this.view.name==='recordlist')?true:false;this.$(this.typeFieldTag).select2({dropdownCssClass:inList?'select2-narrow':'',containerCssClass:inList?'select2-narrow':'',width:inList?'off':'100%',minimumResultsForSearch:5}).on("change",function(e){var module=e.val;self.checkAcl.call(self,'edit',module);self.setValue({id:'',value:'',module:module});});if(this.model.get(this.def.type_name)!==this.$(this.typeFieldTag).val()){this.model.set(this.def.type_name,this.$(this.typeFieldTag).val());}
if(app.acl.hasAccessToModel('edit',this.model,this.name)===false){this.$(this.typeFieldTag).select2("disable");}else{this.$(this.typeFieldTag).select2("enable");}}else if(this.tplName==='disabled'){this.$(this.typeFieldTag).select2('disable');}
return result;},_getRelateId:function(){return this.model.get("parent_id");},format:function(value){this.def.module=this.getSearchModule();var moduleString=app.lang.getAppListStrings('moduleListSingular'),module;if(this.getSearchModule()){if(!moduleString[this.getSearchModule()]){app.logger.error("Module '"+this.getSearchModule()+"' doesn't have singular translation.");module=this.getSearchModule();}else{module=moduleString[this.getSearchModule()];}}
this.context.set("record_label",{field:this.name,label:(this.tplName==='detail')?module:app.lang.get(this.def.label,this.module)});this._buildRoute();return value;},checkAcl:function(action,module){if(app.acl.hasAccess(action,module)===false){this.$(this.typeFieldTag).select2("disable");}else{this.$(this.typeFieldTag).select2("enable");}},setValue:function(model){if(model){var silent=model.silent||false;if(app.acl.hasAccess(this.action,this.model.module,this.model.get('assigned_user_id'),this.name)){if(model.module){this.model.set('parent_type',model.module,{silent:silent});}
this.model.set('parent_id',model.id,{silent:silent});this.model.set('parent_name',model.value,{silent:silent});}}},getSearchModule:function(){return this.model.get('parent_type')||this.$(this.typeFieldTag).val();},getPlaceHolder:function(){return app.lang.get('LBL_SEARCH_SELECT',this.module);},unbindDom:function(){this.$(this.typeFieldTag).select2('destroy');app.view.invokeParent(this,{type:'field',name:'relate',method:'unbindDom'});}})},"actionmenu":{"controller":({events:{'click .checkall':'checkAll','click input[name="check"]':'check','change [data-toggle=dropdownmenu]':'dropdownSelected'},plugins:['Tooltip'],fields:null,actionDropDownTag:".dropdown-toggle",fieldTag:"input[name=check]",initialize:function(options){app.view.Field.prototype.initialize.call(this,options);var massCollection=this.context.get('mass_collection');if(!massCollection){var MassCollection=app.BeanCollection.extend({reset:function(){this.filterDef=null;this.entire=false;Backbone.Collection.prototype.reset.call(this);}});massCollection=new MassCollection();this.context.set('mass_collection',massCollection);}
this.def.disable_select_all_alert=!!this.def.disable_select_all_alert;},check:function(evt){this.toggleSelect(this.$(this.fieldTag).is(":checked"));},checkAll:function(evt){var checkbox=this.$(this.fieldTag);if(checkbox&&evt.currentTarget==evt.target){checkbox.attr("checked",!checkbox.is(":checked"));this.toggleSelect(checkbox.is(':checked'));}},dropdownSelected:function(evt){var $el=this.$(evt.currentTarget),selectedIndex=$el.val();if(!selectedIndex){return;}
this.fields[selectedIndex].getFieldElement().trigger("click");$el.blur();evt.currentTarget.selectedIndex=0;},toggleSelect:function(check){var massCollection=this.context.get('mass_collection');if(massCollection){if(check){if(this.model.id){massCollection.add(this.model);}else{massCollection.reset();massCollection.add(this.collection.models);massCollection.filterDef=this.collection.filterDef;}}else{if(this.model.id){if(massCollection.entire){massCollection.reset();massCollection.add(this.collection.models);massCollection.remove(this.model);}else{massCollection.remove(this.model);}}else{massCollection.reset();}}}},bindDataChange:function(){var self=this,massCollection=this.context.get('mass_collection');if(massCollection&&this.model.id){var modelId=this.model.cid;massCollection.on("add",function(model){if(self.model&&model.id==self.model.id){self.$(self.fieldTag).attr("checked",true);}},modelId);massCollection.on("remove",function(model){if(self.model&&model.id==self.model.id){self.$(self.fieldTag).attr("checked",false);}},modelId);massCollection.on("reset",function(){self.$(self.fieldTag).attr("checked",false);},modelId);if(massCollection.get(this.model)||massCollection.entire){this.$(self.fieldTag).attr("checked",true);this.selected=true;}else{delete this.selected;}}else if(massCollection){var cid=this.view.cid;if(this.collection){this.collection.on("reset",function(){if(massCollection.entire){massCollection.reset();}},this);}
this.on("render",this.toggleSelectAll,this);massCollection.on("add",function(model){if(massCollection.length>0){self.$(self.actionDropDownTag).removeClass("disabled");self.$(".dropdown-menu-select").removeClass("hide");}
if(massCollection.length===self.collection.length){self.$(self.fieldTag).attr("checked",true);}
self.toggleSelectAll();},cid);massCollection.on("remove reset",function(model){if(massCollection.length===0){self.$(self.actionDropDownTag).addClass("disabled");self.$(".dropdown-menu-select").addClass("hide");}
self.$(self.fieldTag).attr("checked",false);self.toggleSelectAll();},cid);this.action_enabled=(massCollection.length>0);this.selected=(massCollection.entire);}},getTotalRecords:function(){var massCollection=(this.context)?this.context.get('mass_collection'):null,filterDef=massCollection.filterDef;if(!_.isArray(filterDef)){filterDef=[filterDef];}
var url=app.api.buildURL(this.module,null,null,{fields:'id',max_num:1000,filter:filterDef});app.alert.show('totalrecord',{level:'process',title:app.lang.getAppString('LBL_LOADING'),autoClose:false});massCollection.trigger('massupdate:estimate');app.api.call('read',url,null,{success:_.bind(function(data){if(this.disposed){return;}
app.alert.dismiss('totalrecord');this._processTotalRecords(data.records);this._alertTotalRecords(data.next_offset);},this)});},_processTotalRecords:function(collection){var massCollection=(this.context)?this.context.get('mass_collection'):null;if(!massCollection){return;}
massCollection.add(collection,{silent:true});massCollection.entire=false;massCollection.trigger('massupdate:estimate');},_alertTotalRecords:function(offset){var massCollection=(this.context)?this.context.get('mass_collection'):null;if(!massCollection){return;}
var label=(offset>=0)?'TPL_LISTVIEW_SELECTED_FIRST_OFFSET':'TPL_LISTVIEW_SELECTED_ALL',message=app.lang.get(label,this.module,{num:massCollection.length}),allSelected=$('<div>').html(message);allSelected.find('a').on('click',function(evt){massCollection.reset();});this.view.layout.trigger('list:alert:show',allSelected);},toggleSelectAll:function(){var self=this,massCollection=(this.context)?this.context.get('mass_collection'):null;var buildAlertForReset=function(){var alert=$('<div>').html(app.lang.get('TPL_LISTVIEW_SELECTED_ALL'));alert.find('a').on('click',function(){massCollection.reset();});return alert;};var buildAlertForEntire=function(){var alert=selectAll=$('<div>').html(app.lang.get('TPL_LISTVIEW_SELECT_ALL_RECORDS',this.module,{num:massCollection.length}));alert.find('a').on('click',function(){massCollection.entire=true;self.getTotalRecords();$(this).off('click');});return alert;};var showAlert=function(){var alert;if(massCollection&&self.collection.next_offset>0){if(massCollection.entire){alert=buildAlertForReset();}else if(massCollection.length===self.collection.length){alert=buildAlertForEntire();}}
if(alert){self.view.layout.trigger('list:alert:show',alert);}else{self.view.layout.trigger('list:alert:hide');}};var setButtonsDisabled=function(fields){_.each(fields,function(field){if(field.def.minSelection||field.def.maxSelection){var min=field.def.minSelection||0,max=field.def.maxSelection||massCollection.length;if(massCollection.length<min||massCollection.length>max){field.setDisabled(true);}else{field.setDisabled(false);}}},self);};if(!this.def.disable_select_all_alert){showAlert();}
setButtonsDisabled(this.fields);},getPlaceholder:function(){var self=this,viewName=this.options.viewName||this.view.name;if(!this.fields&&viewName=='list-header'){this.fields=[];var actionMenu='<ul class="dropdown-menu">';_.each(this.def.buttons,function(fieldDef){var field=app.view.createField({def:fieldDef,view:self.view,viewName:self.options.viewName,model:self.model});field.on("show hide",self.setPlaceholder,self);self.fields.push(field);field.parent=self;actionMenu+='<li>'+field.getPlaceholder()+'</li>';});actionMenu+="</ul>";var caret='';if(app.utils.isTouchDevice()){caret+='<select data-toggle="dropdownmenu" class="hide dropdown-menu-select"></select>';}
self.actionPlaceHolder=new Handlebars.SafeString(caret+actionMenu);}
return app.view.Field.prototype.getPlaceholder.call(this);},_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.view.action==='list'&&this.action==='edit'){this.template=app.template.empty;}},setPlaceholder:function(){var index=0,selectEl=this.$(".dropdown-menu-select"),html='<option></option>';_.each(this.fields,function(field,idx){var fieldPlaceholder=this.$("span[sfuuid='"+field.sfId+"']");if(!field.isVisible()){fieldPlaceholder.toggleClass('hide',true);this.$el.append(fieldPlaceholder);}else{fieldPlaceholder.toggleClass('hide',false);this.$(".dropdown-menu").append($('<li>').append(fieldPlaceholder));html+='<option value='+idx+'>'+field.label+'</option>';index++;}},this);if(index<1){this.$(".dropdown-toggle").hide();}else{this.$(".dropdown-toggle").show();}
this.$(".dropdown-menu").children("li").each(function(index,el){if($(el).html()===''){$(el).remove();}});if(app.utils.isTouchDevice()){selectEl.html(html);}},unbindData:function(){var collection=this.context.get('mass_collection');if(collection){var modelId=this.model.cid,cid=this.view.cid;collection.off(null,null,this);if(modelId){collection.off(null,null,modelId);}
if(cid){collection.off(null,null,cid);}}
if(this.collection){this.collection.off("reset",null,this);}
this.off("render",null,this);app.view.Field.prototype.unbindData.call(this);},_dispose:function(){_.each(this.fields,function(field){field.parent=null;field.dispose();});this.fields=null;app.view.Field.prototype._dispose.call(this);},bindDomChange:function(){},unbindDom:function(){}})},"phone":{"controller":({plugins:['EllipsisInline'],initialize:function(options){var serverInfo=app.metadata.getServerInfo();this.skypeEnabled=serverInfo.system_skypeout_on?true:false;app.view.Field.prototype.initialize.call(this,options);},format:function(value){if((this.action==='list'||this.action==='detail'||this.action==='record')&&this.isSkypeFormatted(value)&&this.skypeEnabled){this.skypeValue=this.skypeFormat(value);}
return value;},isSkypeFormatted:function(value){if(_.isString(value)){return value.substr(0,1)==='+'||value.substr(0,2)==='00'||value.substr(0,3)==='011';}else{return false;}},skypeFormat:function(value){if(_.isString(value)){var number=value.replace(/[^\d\(\)\.\-\/ ]/g,'');if(null!==number.match(/[\-]/g)&&number.match(/[\-]/g).length>=2){number=number.replace(/[^\d\-]/g,'').replace(/(\d+)\-(\d+)\-([\d\-]+)/g,function($0,$1,$2,$3){return[$1,$2,$3.replace(/\D/g,'')].join('-');});}else if(null!==number.match(/[\.]/g)&&number.match(/[\.]/g).length>=2){number=number.replace(/[^\d\.]/g,'').replace(/(\d+)\.(\d+)\.([\d\.]+)/g,function($0,$1,$2,$3){return[$1,$2,$3.replace(/\D/g,'')].join('.');});}else if(null!==number.match(/\(\D*\d+\D*\)/g)){number=number.replace(/[^\d\(\)]+/g,'').replace(/(\d+)\((\d+)\)([0-9\(\)]+)/g,function($0,$1,$2,$3){return $1+'('+$2+')'+$3.replace(/\D/g,'');})}else if(null!==number.match(/[\/]/g)&&number.match(/[\/]/g).length>=2){number=number.replace(/[^\d\/]/g,'').replace(/(\d+)\/(\d+)\/([\d\/]+)/g,function($0,$1,$2,$3){return[$1,$2,$3.replace(/\D/g,'')].join('/');});}else if(null!==number.match(/\S+\s+\S+\s+[\S\s]+/g)){number=number.replace(/(\S+)\s+(\S+)\s+([\S\s]+)/g,function($0,$1,$2,$3){return _.map([$1,$2,$3],function(s){return s.replace(/\D/g,'');}).join(' ');})}else{number=number.replace(/\D/g,'');}
if(value.substr(0,1)==='+'||(number.substr(0,2)!=='00'&&number.substr(0,3)!=='011')){number='+'+number;}
return number;}else if(_.isNumber(value)){if(value.substr(0,2)!=='00'&&value.substr(0,3)!=='011'){value='+'+value;}}
return value;}})},"enum":{"controller":({fieldTag:"input",plugins:['EllipsisInline'],defaultOnUndefined:true,BLANK_VALUE_ID:'___i_am_empty___',bindKeyDown:function(callback){this.$('input').on("keydown.record",{field:this},callback);},_render:function(){var self=this;if(_.isUndefined(this.items)){this.loadEnumOptions(false,function(){if(!this.disposed){this.render();}});}
if(this.def.isMultiSelect&&!_.isUndefined(this.items[''])&&this.items['']===''){var obj={};_.each(this.items,function(value,key){if(key!==''&&value!==''){obj[key]=value;}},this);this.items=obj;}
var optionsKeys=_.isObject(this.items)?_.keys(this.items):[];if(this.defaultOnUndefined&&!this.def.isMultiSelect&&_.isUndefined(this.model.get(this.name))){var defaultValue=_.first(optionsKeys);if(defaultValue){this.model.set(this.name,defaultValue);}}
app.view.Field.prototype._render.call(this);var select2Options=this.getSelect2Options(optionsKeys);var $el=this.$(this.fieldTag);if(!_.isEmpty(optionsKeys)){if(this.tplName==='edit'||this.tplName==='list-edit'){$el.select2(select2Options);$el.select2("container").addClass("tleft");$el.on('change',function(ev){var value=ev.val;if(self.model&&!(self.name=='currency_id'&&_.isUndefined(value))){self.model.set(self.name,self.unformat(value));}});if(this.def.ordered){$el.select2("container").find("ul.select2-choices").sortable({containment:'parent',start:function(){$el.select2("onSortStart");},update:function(){$el.select2("onSortEnd");}});}}else if(this.tplName==='disabled'){$el.select2(select2Options);$el.select2('disable');}
if(this.value){if(!_.isArray(this.value)){this.value=[this.value];}
$el.select2('val',this.value);}}else{this.$el.html(app.lang.get("LBL_LOADING"));}
return this;},focus:function(){if(this.action!=='disabled'&&!this.def.isMultiSelect){this.$(this.fieldTag).select2('open');}},loadEnumOptions:function(fetch,callback){var self=this,meta=app.metadata.getModule(this.module,'fields'),fieldMeta=meta&&meta[this.name]?meta[this.name]:this.def;this.items=this.def.options||fieldMeta.options;fetch=fetch||false;if(fetch||_.isUndefined(this.items)){var _key='request:'+this.module+':'+this.name;if(this.context.get(_key)){var request=this.context.get(_key);request.xhr.done(_.bind(function(o){if(this.items!==o){this.items=o;callback.call(this);}},this));}else{var request=app.api.enumOptions(self.module,self.name,{success:function(o){if(self.disposed){return;}
if(self.items!==o){self.items=o;fieldMeta.options=self.items;self.context.unset(_key);callback.call(self);}}});this.context.set(_key,request);}}else if(_.isString(this.items)){this.items=app.lang.getAppListStrings(this.items);}},getSelect2Options:function(optionsKeys){var select2Options={};var emptyIdx=_.indexOf(optionsKeys,"");if(emptyIdx!==-1){select2Options.allowClear=true;if(emptyIdx>1){this.hasBlank=true;}}
if(!this.def.isMultiSelect){select2Options.placeholder=app.lang.get("LBL_SEARCH_SELECT");}
if(_.isEmpty(optionsKeys)){select2Options.placeholder=app.lang.get("LBL_LOADING");}
select2Options.width=this.def.enum_width?this.def.enum_width:'100%';select2Options.dropdownCssClass=this.def.dropdown_class?this.def.dropdown_class:'';select2Options.containerCssClass=this.def.container_class?this.def.container_class:(this.def.isMultiSelect?'select2-choices-pills-close':'');if(this.def.dropdown_width){select2Options.dropdownCss={width:this.def.dropdown_width};}
select2Options.minimumResultsForSearch=this.def.searchBarThreshold?this.def.searchBarThreshold:7;if(this.def.isMultiSelect){select2Options.multiple=true;}
select2Options.separator=this.def.separator||',';if(this.def.separator){select2Options.tokenSeparators=[this.def.separator];}
select2Options.initSelection=_.bind(this._initSelection,this);select2Options.query=_.bind(this._query,this);return select2Options;},_initSelection:function($ele,callback){var data=[];var options=_.isString(this.items)?app.lang.getAppListStrings(this.items):this.items;var values=$ele.val();if(this.def.isMultiSelect){values=values.split(this.def.separator||',');}
_.each(_.pick(options,values),function(value,key){data.push({id:key,text:value});},this);if(data.length===1){callback(data[0]);}else{callback(data);}},_query:function(query){var options=_.isString(this.items)?app.lang.getAppListStrings(this.items):this.items;var data={results:[],more:false};if(_.isObject(options)){_.each(options,function(element,index){var text=""+element;if(query.matcher(query.term,text)){data.results.push({id:index,text:text});}});}else{options=null;}
query.callback(data);},unformat:function(value){if(this.def.isMultiSelect&&_.isArray(value)&&_.indexOf(value,this.BLANK_VALUE_ID)>-1){value=_.clone(value);delete value[this.BLANK_VALUE_ID];}
if(this.def.isMultiSelect&&_.isNull(value)){return[];}else{return value;}},format:function(value){if(this.def.isMultiSelect&&_.isArray(value)&&_.indexOf(value,'')>-1){value=_.clone(value);delete value[''];}
if(this.def.isMultiSelect&&_.isString(value)){return this.convertMultiSelectDefaultString(value);}else{return value;}},convertMultiSelectDefaultString:function(defaultString){var result=defaultString.split(",");_.each(result,function(value,key){if(value!=='^^'){result[key]=value.replace(/\^/g,"");}});return result;},bindDomChange:function(){},unbindDom:function(){this.$(this.fieldTag).select2('destroy');app.view.Field.prototype.unbindDom.call(this);},unbindData:function(){var _key='request:'+this.module+':'+this.name;this.context.unset(_key);app.view.Field.prototype.unbindData.call(this);}})},"unlink-action":{"controller":({extendsFrom:'RowactionField',initialize:function(options){options.def.event=options.def.event||'list:unlinkrow:fire';options.def.acl_action=options.def.acl_action||'delete';app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},hasAccess:function(){var link=this.context.get("link");var parentModule=this.context.get("parentModule");var required=app.utils.isRequiredLink(parentModule,link);if(required){return false;}
return app.view.invokeParent(this,{type:'field',name:'rowaction',method:'hasAccess'});}})},"vcard":{"controller":({extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},rowActionSelect:function(){var self=this;app.api.call('read',app.api.buildURL('ping'),{},{success:function(data){var uri=app.api.buildURL('VCardDownload','read',{},{module:self.model.module,id:self.model.id,oauth_token:app.api.getOAuthToken()});if(_.isEmpty(uri)){app.logger.error('Unable to get the vCard download uri.');return;}
window.location.href=uri;},error:function(data){app.error.handleHttpError(data,self.model);}});},bindDataChange:function(){if(this.model){this.model.on("change",this.render,this);}}})},"date":{"controller":({datepickerVisible:false,dateValue:'',serverDateFormat:'Y-m-d',stripIsoTZ:true,leaveDirty:false,plugins:['EllipsisInline'],initialize:function(options){this.userTimePrefs=app.user.getPreference('timepref');this.usersDatePrefs=app.user.getPreference('datepref');if(!_.isUndefined(this.showAmPm)){this.showAmPm=this.userTimePrefs.match(/[aA]$/)==null?true:false;}
app.view.Field.prototype.initialize.call(this,options);},bindDomChange:function(){},_presetDateValues:function(){this.dateValue=this.$('.datepicker').val();this.dateValue=(this.dateValue)?this.dateValue:'';if(!_.isUndefined(this._setTimeValue)&&_.isFunction(this._setTimeValue)){this._setTimeValue();}},_setupDatepicker:function(){this.datepickerMap=this._patchDatepickerMeta();this.$(".datepicker").attr('placeholder',app.date.toDatepickerFormat(this.usersDatePrefs));if(_.isFunction(this.setRequiredPlaceholder)&&this.def.required){this.setRequiredPlaceholder(this.$(".datepicker"));}
var appendTarget=this.$el.parents('div#drawers').length?'div#drawers .main-pane:first':'div#content .main-pane:first';this.$(".datepicker").datepicker({languageDictionary:this.datepickerMap,format:(this.usersDatePrefs)?app.date.toDatepickerFormat(this.usersDatePrefs):'mm-dd-yyyy',appendTo:appendTarget});this.$(".datepicker").datepicker().on({show:_.bind(this.showDatepicker,this),hide:_.bind(this.hideDatepicker,this)});$('.main-pane.span8').on('scroll',_.bind(function(){this.$('.datepicker').datepicker('place');},this));$('.flex-list-view-content').on('scroll',_.bind(function(){this.$('.datepicker').datepicker('place');},this));},_dispose:function(){$('.main-pane.span8').off();$('.flex-list-view-content').off();app.view.Field.prototype._dispose.call(this);},showDatepicker:function(ev){this.datepickerVisible=true;},hideDatepicker:function(ev){var model=this.model,fieldName=this.name,timeValue='',hrsMins={},dateValue='',$timepicker;this.datepickerVisible=false;model=this.model;fieldName=this.name;if(!_.isUndefined(this._setTimepickerValue)&&_.isFunction(this._setTimepickerValue)){$timepicker=this.$('.ui-timepicker-input');hrsMins=this._getHoursMinutes($timepicker);this._setTimepickerValue($timepicker,hrsMins.hours,hrsMins.minutes);}else{hrsMins={hours:'00',minutes:'00'};}
dateValue=this._getDatepickerValue();if(this._verifyDateString(dateValue)){this.leaveDirty=false;model.set(fieldName,this._buildUnformatted(dateValue,hrsMins.hours,hrsMins.minutes));}else{this.leaveDirty=true;model.set(fieldName,dateValue,hrsMins.hours,hrsMins.minutes);}},_verifyDateString:function(value){var sep,parsed,parts,valueWithForwardSlash,dateFormat=(this.usersDatePrefs)?app.date.toDatepickerFormat(this.usersDatePrefs):'mm-dd-yyyy';parsed=Date.parse(value);if(_.isNaN(parsed)||parsed<0){return $.prototype.DateVerifier(value,dateFormat);}
return true;},_buildUnformatted:function(d,h,m){var parsedDate=app.date.parse(d,this.usersDatePrefs);d=app.date.format(parsedDate,this.serverDateFormat);return this.unformat(d+' '+h+':'+m+':00');},_getDatepickerValue:function(){var date=this.$('input.datepicker'),dateValue;dateValue=this._getTodayDateStringIfNoDate(date.prop('value'));this.dateValue=dateValue;return dateValue;},_setDatepickerValue:function(dateValue){var date=this.$('input.datepicker');dateValue=this._getTodayDateStringIfNoDate(dateValue);date.prop('value',dateValue);},_setServerDateString:function(jsDate,forceToDate){var h,m,d;d=app.date.format(jsDate,this.serverDateFormat);if(forceToDate){return d;}
if(this.stripIsoTZ){d=app.date.format(jsDate,this.serverDateFormat);h=this._forceTwoDigits(jsDate.getHours().toString());m=this._forceTwoDigits(jsDate.getMinutes().toString());return d+'T'+h+':'+m+':00';}
if(_.isFunction(jsDate.toISOString)){return jsDate.toISOString();}
return jsDate;},_getTodayDateStringIfNoDate:function(dateStringToCheck){if(!dateStringToCheck){var d=new Date();return app.date.format(d,this.usersDatePrefs);}
return dateStringToCheck;},_getViewName:function(){return this.view.meta&&this.view.meta.type?this.view.meta.type:this.view.name;},_isEditView:function(viewName){if(this.options.def.view==='edit'||this.options.viewName==='edit'||viewName==='edit'){return true;}
return false;},_patchDatepickerMeta:function(){var pickerMap=[],pickerMapKey,calMapIndex,mapLen,domCalKey,calProp,appListStrings,calendarPropsMap,i,filterIterator;appListStrings=app.metadata.getStrings('app_list_strings');filterIterator=function(v,k,l){return v!=="";};calendarPropsMap=['dom_cal_day_long','dom_cal_day_short','dom_cal_month_long','dom_cal_month_short'];for(calMapIndex=0,mapLen=calendarPropsMap.length;calMapIndex<mapLen;calMapIndex++){domCalKey=calendarPropsMap[calMapIndex];calProp=appListStrings[domCalKey];if(!_.isUndefined(calProp)&&!_.isNull(calProp)){calProp=_.filter(calProp,filterIterator);calProp.push(calProp[0]);}
switch(calMapIndex){case 0:pickerMapKey='day';break;case 1:pickerMapKey='daysShort';break;case 2:pickerMapKey='months';break;case 3:pickerMapKey='monthsShort';break;}
pickerMap[pickerMapKey]=calProp;}
pickerMap['daysMin']=_.map(pickerMap.daysShort,function(day){return(day.length>1)?day.substr(0,2):day;});return pickerMap;},_isNewEditViewWithNoValue:function(value){return(this.model.isNew()&&!value&&this._isEditView(this._getViewName()));},_forceTwoDigits:function(numstr){return numstr.length===1?'0'+numstr:numstr;},_render:function(value){var self=this,viewName;self._presetDateValues();app.view.Field.prototype._render.call(this);viewName=self._getViewName();$(function(){if(self._isEditView(viewName)){self._setupDatepicker();}});if(Modernizr.touch){this.$("[rel=datepicker]").attr('readonly',true);}},format:function(value){var jsDate,parts;if(this._isNewEditViewWithNoValue(value)){jsDate=this._setDateIfDefaultValue();if(!jsDate){return value;}
value=app.date.format(jsDate,this.usersDatePrefs);}else if(!value){return value;}else if(!this.leaveDirty){parts=value.match(/(\d+)/g);if(parts&&parts.length>2){jsDate=new Date(parts[0],parts[1]-1,parts[2]);value=app.date.format(jsDate,this.usersDatePrefs);}else{return value;}}
this.dateValue=value;this.$(".datepicker").datepicker('update',this.dateValue);jsDate=app.date.parse(value);return app.date.format(jsDate,this.usersDatePrefs);},unformat:function(value){var jsDate=new Date(value);if(!jsDate||jsDate.toString()==='Invalid Date'){jsDate=new Date(value.replace(/[\.\-]/g,'/'));}
return app.date.format(jsDate,this.serverDateFormat);},_setDateIfDefaultValue:function(){var value,jsDate;if(this.def.display_default){jsDate=app.date.parseDisplayDefault(this.def.display_default);this.model.set(this.name,app.date.format(jsDate,this.serverDateFormat));}else{return null;}
return jsDate;},unbindDom:function(){app.view.Field.prototype.unbindDom.call(this);},decorateError:function(errors){var ftag=this.fieldTag||'',$ftag=this.$(ftag),errorMessages=[],$tooltip;this.$el.closest('.record-cell').addClass('error');this.$el.addClass('error');this.$el.find(".add-on").remove();_.each(errors,function(errorContext,errorName){errorMessages.push(app.error.getErrorString(errorName,errorContext));});$ftag.wrap('<div class="input-append error '+ftag+'">');$ftag.after(this.exclamationMarkTemplate(errorMessages)+'<span class="add-on"><i class="icon-calendar"></i></span>');$tooltip=this.$('.error-tooltip');if(_.isFunction($tooltip.tooltip)){var tooltipOpts={container:'body',placement:'top',trigger:'click'};$tooltip.tooltip(tooltipOpts);}},clearErrorDecoration:function(){var ftag=this.fieldTag||'',$ftag=this.$(ftag);var isWrapped=$ftag.parent().hasClass('input-append');if(isWrapped){$ftag.parent().removeClass('error');}
this.$el.removeClass(ftag);this.$el.removeClass("error");this.$el.closest("span.edit").removeClass('error');this.$el.closest('.record-cell').removeClass("error");}})},"sidebartoggle":{"controller":({extendsFrom:'button',events:{'click .drawerTrig':'toggle'},_render:function(){app.view.Field.prototype._render.call(this);app.controller.context.trigger("sidebarRendered");},bindDataChange:function(){app.controller.context.on("toggleSidebarArrows",this.updateArrows,this);app.controller.context.on("openSidebarArrows",this.sidebarArrowsOpen,this);},updateArrows:function(){var chevron=this.$('.drawerTrig i'),pointRightClass='icon-double-angle-right';if(chevron.hasClass(pointRightClass)){this.updateArrowsWithDirection('close');}else{this.updateArrowsWithDirection('open');}},sidebarArrowsOpen:function(){this.updateArrowsWithDirection('open');},updateArrowsWithDirection:function(state){var chevron=this.$('.drawerTrig i'),pointRightClass='icon-double-angle-right',pointLeftClass='icon-double-angle-left';if(state==='open'){chevron.removeClass(pointLeftClass).addClass(pointRightClass);app.events.trigger('app:toggle:sidebar','open');}else if(state==='close'){chevron.removeClass(pointRightClass).addClass(pointLeftClass);app.events.trigger('app:toggle:sidebar','close');}else{app.logger.warn("updateArrowsWithDirection called with invalid state; should be 'open' or 'close', but was: "+state)}},toggle:function(){this.context.trigger('toggleSidebar');$(window).trigger('resize');},_dispose:function(){app.view.invokeParent(this,{type:'field',name:'button',method:'_dispose'});app.controller.context.off(null,null,this);}})},"listeditable":{"controller":({_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.view.action==='list'&&_.indexOf(['edit','disabled'],this.tplName)>=0){var tplName='list-'+this.tplName;this.template=app.template.getField(this.type,tplName,this.module,this.tplName)||app.template.empty;this.tplName=tplName;}}})},"url":{"controller":({plugins:['EllipsisInline'],format:function(value){if(value&&!value.match(/^([a-zA-Z]+):\/\//)){value="http://"+value;}
return value;},unformat:function(value){value=(value!=''&&value!='http://')?value.trim():"";return value;},getFieldElement:function(){return this.$('a');},_render:function(){this.def.link_target=_.isUndefined(this.def.link_target)?'_blank':this.def.link_target;app.view.Field.prototype._render.call(this);}})},"rowactions":{"controller":({extendsFrom:'ActiondropdownField',_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);var template=app.template._getField(this.type,this.tplName,this.module,null,true)[1];if(template){this.$el.attr('class','');this.$el.html(template(this));}
if(this.view.action==='list'&&this.action==='edit'){this.$el.hide();}else{this.$el.show();}}})},"manage-subscription":{"controller":({extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},rowActionSelect:function(){var route=app.bwc.buildRoute('Campaigns',this.model.id,'Subscriptions',{return_module:this.module,return_id:this.model.id});app.router.navigate(route,{trigger:true});}})},"change-my-password":{"controller":({extendsFrom:'ChangePasswordField',fieldTag:'input',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'change-password',method:'initialize',args:[options]});app.error.errorName2Keys['current_password']='ERR_ENTER_OLD_PASSWORD';this.__extendModel();},__extendModel:function(){if(this.model&&!this.model._hasChangeMyPasswordModifs){var _proto=_.clone(this.model);this.model._hasChangeMyPasswordModifs=true;this.model._doValidateCurrentPassword=function(fields,errors,callback){var field=_.find(fields,function(field){return field.type==='change-my-password';});var current=this.get(field.name+'_current_password');var password=this.get(field.name+'_new_password'),confirmation=this.get(field.name+'_confirm_password');if(_.isEmpty(current)&&_.isEmpty(password)&&_.isEmpty(confirmation)){callback(null,fields,errors);return;}
var alertOptions={title:app.lang.get("LBL_VALIDATING"),level:"process"};app.alert.show('validation',alertOptions);app.api.verifyPassword(current,{success:function(data){if(!data||!data.valid){errors[field.name]=errors[field.name]||{};errors[field.name]['current_password']=true;}},error:function(error){errors[field.name]=errors[field.name]||{};errors[field.name]['current_password']=true;},complete:function(){app.alert.dismiss('validation');callback(null,fields,errors);}});};this.model.addValidationTask('current_password',_.bind(this.model._doValidateCurrentPassword,this.model));this.model.revertAttributes=function(options){var attrs=_.clone(this.attributes);_.each(attrs,function(value,attr){if(attr.match('_current_password')){this.unset(attr);}},this);_proto.revertAttributes.call(this,options);};}},format:function(value){if(this.action==='edit'){this.currentPassword=this.model.get(this.name+'_current_password');value='';}else if(value===true){value='value_setvalue_set';}
return value;},decorateError:function(errors){var ftag=this.fieldTag;if(errors['current_password']){this.fieldTag='input[name=current_password]';app.view.Field.prototype.decorateError.call(this,{current_password:true});}
errors=_.omit(errors,'current_password');if(!_.isEmpty(errors)){this.fieldTag='input[name!=current_password]';app.view.Field.prototype.decorateError.call(this,errors);}
this.fieldTag=ftag;}})},"forecast-pareto-chart":{"controller":({_serverData:undefined,state:"open",preview_open:false,initialize:function(options){this.once('render',function(){this.renderChart();},this);app.view.Field.prototype.initialize.call(this,options);},bindDataChange:function(){app.events.on('preview:open',function(){this.preview_open=true;},this);app.events.on('preview:close',function(){this.preview_open=false;},this);app.events.on('app:toggle:sidebar',function(state){this.state=state;if(this.state=='open'&&!this.preview_open&&!_.isUndefined(this._serverData)){this.convertDataToChartData();this.generateD3Chart();}},this);this.model.on('change',function(model){var changed=_.keys(model.changed);if(!_.isEmpty(_.intersection(['user_id','display_manager','timeperiod_id'],changed))){this.renderChart();}},this);this.model.on('change:group_by change:dataset change:ranges',function(){if(this.state=='open'&&!this.preview_open&&!_.isUndefined(this._serverData)){this.convertDataToChartData();this.generateD3Chart();}},this);},unbindData:function(){app.events.off(null,null,this);app.view.View.prototype.unbindData.call(this);},renderChart:function(options){if(this.disposed||!this.triggerBefore('chart:pareto:render')||_.isUndefined(this.model.get('timeperiod_id'))||_.isUndefined(this.model.get('user_id'))){return;}
this._serverData=undefined;this.chartId=this.cid+'_chart';this.paretoChart=nv.models.paretoChart().margin({top:0,right:10,bottom:20,left:50}).showTitle(false).tooltips(true).tooltipLine(function(key,x,y,e,graph){var val=App.currency.formatAmountLocale(e.point.y);return'<p>'+key+': <b>'+val+'</b></p>';}).tooltipBar(function(key,x,y,e,graph){var val=App.currency.formatAmountLocale(e.value);return'<p>'+SUGAR.App.lang.get('LBL_SALES_STAGE','Forecasts')+': <b>'+key+'</b></p>'+'<p>'+SUGAR.App.lang.get('LBL_AMOUNT','Forecasts')+': <b>'+val+'</b></p>'+'<p>'+SUGAR.App.lang.get('LBL_PERCENT','Forecasts')+': <b>'+x+'%</b></p>';}).showControls(false).colorData('default').colorFill('default').id(this.chartId);options=options||{};options.success=_.bind(function(data){if(this.model){this._serverData=data;this.convertDataToChartData();this.generateD3Chart();}},this);var read_options={};if(this.model.has('no_data')&&this.model.get('no_data')===true){read_options['no_data']=1;}
var url=app.api.buildURL(this.buildChartUrl(),null,null,read_options);app.api.call('read',url,{},options);},generateD3Chart:function(){var params=this.model.toJSON();if(!_.isEmpty(this.paretoChart)){nv.utils.windowUnResize(this.paretoChart.update);d3.select('#'+this.chartId+' svg').remove();}
this.paretoChart.stacked(!params.display_manager);if(this.d3Data.data.length>0){this.$('.nv-chart').toggleClass('hide',false);this.$('.block-footer').toggleClass('hide',true);d3.select('#'+this.chartId).append('svg').datum(this.d3Data).transition().duration(500).call(this.paretoChart).selectAll('.nv-y.nv-axis .tick').select('text').text(function(d){return App.user.get('preferences').currency_symbol+d3.format(',.2s')(d);});nv.utils.windowResize(this.paretoChart.update);nv.utils.resizeOnPrint(this.paretoChart.update);}else{this.$('.nv-chart').toggleClass('hide',true);this.$('.block-footer').toggleClass('hide',false);}
this.trigger('chart:pareto:rendered');},convertDataToChartData:function(){if(this.state=='closed'||this.preview_open||_.isUndefined(this._serverData)){return-1;}
if(this.model.get('display_manager')){this.convertManagerDataToChartData();}else{this.convertRepDataToChartData(this.model.get('group_by'));}},convertManagerDataToChartData:function(){var dataset=this.model.get('dataset'),records=this._serverData.data,chartData={'properties':{'name':this._serverData.title,'quota':parseFloat(this._serverData.quota),'quotaLabel':app.lang.get('LBL_QUOTA_ADJUSTED','Forecasts'),'groupData':records.map(function(record,i){return{group:i,l:record.name,t:parseFloat(record[dataset])+parseFloat(record[dataset+'_adjusted'])};})},'data':[]},barData=[dataset,dataset+'_adjusted'].map(function(ds,seriesIdx){var vals=records.map(function(rec,recIdx){return{series:seriesIdx,x:recIdx+1,y:parseFloat(rec[ds]),y0:0};});return{key:this._serverData.labels['dataset'][ds],series:seriesIdx,type:'bar',values:vals,valuesOrig:vals};},this),lineData=[dataset,dataset+'_adjusted'].map(function(ds,seriesIdx){var vals=records.map(function(rec,recIdx){return{series:seriesIdx,x:recIdx+1,y:parseFloat(rec[ds])}});var addToLine=0;_.each(vals,function(val,i,list){list[i].y+=addToLine;addToLine=list[i].y;});return{key:this._serverData.labels['dataset'][ds],series:seriesIdx,type:'line',values:vals,valuesOrig:vals};},this);chartData.data=barData.concat(lineData);this.d3Data=chartData;},convertRepDataToChartData:function(type){var dataset=this.model.get('dataset'),ranges=this.model.get('ranges'),seriesIdx=0,barData=[],lineVals=this._serverData['x-axis'].map(function(axis,i){return{series:seriesIdx,x:i+1,y:0}}),line={'key':this._serverData.labels.dataset[dataset],'type':'line','series':seriesIdx,'values':[],'valuesOrig':[]},chartData={'properties':{'name':this._serverData.title,'quota':parseFloat(this._serverData.quota),'quotaLabel':app.lang.get('LBL_QUOTA','Forecasts'),'groupData':this._serverData['x-axis'].map(function(item,i){return{'group':i,'l':item.label,'t':0};})},'data':[]},records=this._serverData.data,data=(!_.isEmpty(ranges))?records.filter(function(rec){return _.contains(ranges,rec.forecast);}):records;_.each(this._serverData.labels[type],function(label,value){var td=data.filter(function(d){return(d[type]==value);});if(!_.isEmpty(td)){var barVal=this._serverData['x-axis'].map(function(axis,i){return{series:seriesIdx,x:i+1,y:0,y0:0}}),axis=this._serverData['x-axis'];_.each(td,function(record){for(var y=0;y<axis.length;y++){if(record.date_closed_timestamp>=axis[y].start_timestamp&&record.date_closed_timestamp<=axis[y].end_timestamp){var val=parseFloat(record[dataset]);barVal[y].y+=val;chartData.properties.groupData[y].t+=val;lineVals[y].y+=val;break;}}},this);barData.push({key:label,series:seriesIdx,type:'bar',values:barVal,valuesOrig:barVal});seriesIdx++;}},this);if(!_.isEmpty(barData)){var addToLine=0;_.each(lineVals,function(val,i,list){list[i].y+=addToLine;addToLine=list[i].y;});line.values=lineVals;line.valuesOrig=lineVals;barData.push(line);chartData.data=barData;}
this.d3Data=chartData;},buildChartUrl:function(){var baseUrl=this.model.get('display_manager')?'ForecastManagerWorksheets':'ForecastWorksheets';return baseUrl+'/chart/'+this.model.get('timeperiod_id')+'/'+this.model.get('user_id');},hasServerData:function(){return!_.isUndefined(this._serverData);},getServerData:function(){return this._serverData;},setServerData:function(data,adjustLabels){this._serverData=data;if(adjustLabels===true){this.adjustProbabilityLabels();}
this.convertDataToChartData();this.generateD3Chart();},adjustProbabilityLabels:function(){var probabilities=_.unique(_.map(this._serverData.data,function(item){return item.probability;})).sort();this._serverData.labels.probability=_.object(probabilities,probabilities);}})},"currency":{"controller":({'events':{'click':'updateCss'},transactionValue:'',_currencyField:null,_currencyFieldDisabled:false,hideCurrencyDropdown:false,_lastCurrencyId:null,initialize:function(options){app.view.Field.prototype.initialize.call(this,options);var currencyField=this.def.currency_field||'currency_id';if(this.model.isNew()&&(!this.model.isCopy())){this.model.set(currencyField,app.user.get('preferences').currency_id);this.model.set(this.def.base_rate_field||'base_rate',app.metadata.getCurrency(app.user.get('preferences').currency_id).conversion_rate);}
this.hideCurrencyDropdown=this.view.action==='list';this._lastCurrencyId=this.model.get(currencyField);},_render:function(){if(this._currencyField){this._currencyField.dispose();this._currencyField=null;}
app.view.Field.prototype._render.call(this);if(this.hideCurrencyDropdown===false&&(this.action==='edit'||this.action==='disabled')){this.getCurrencyField().setElement(this.$('span[sfuuid="'+this.currencySfId+'"]'));this.$el.find('div.select2-container').css('min-width','8px');this.getCurrencyField().render();}
return this;},bindDataChange:function(){this.model.on('change:'+this.name,this._valueChangeHandler,this);if(this.def.is_base_currency){return;}
var currencyField=this.def.currency_field||'currency_id';var baseRateField=this.def.base_rate_field||'base_rate';this.model.on('change:'+currencyField,function(model,currencyId,options){if(!currencyId||!this._lastCurrencyId){this._lastCurrencyId=currencyId;return;}
this.model.set(baseRateField,app.metadata.getCurrency(currencyId).conversion_rate);if(model.has(this.name)){var val=model.get(this.name);if(val===''){val=0;}
this.model.set(this.name,app.currency.convertAmount(app.currency.unformatAmountLocale(val),this._lastCurrencyId,currencyId),{silent:true});var self=this;_.defer(function(){self.model.trigger('change:'+self.name,self.model,self.model.get(self.name));});}
this._lastCurrencyId=currencyId;},this);},_valueChangeHandler:function(model,value)
{if(this.action!='edit'){this.render();}else{this.setCurrencyValue(value);}},setCurrencyValue:function(value){this.$('[name='+this.name+']').val(app.utils.formatNumberLocale(value));},format:function(value){if(_.isNull(value)||_.isUndefined(value)||_.isNaN(value)){value='';}
if(this.tplName==='edit'||(this.tplName=='disabled'&&this.action=='disabled')){this.currencySfId=this.getCurrencyField().sfId;return app.utils.formatNumberLocale(value);}
var baseRate;var currencyId;if(this.def.is_base_currency){currencyId=app.currency.getBaseCurrencyId();}else{this.transactionValue='';if(this.def.convertToBase&&this.def.showTransactionalAmount&&this.model.get(this.def.currency_field||'currency_id')!==app.currency.getBaseCurrencyId()){this.transactionValue=app.currency.formatAmountLocale(this.model.get(this.name)||0,this.model.get(this.def.currency_field||'currency_id'));}
baseRate=this.model.get(this.def.base_rate_field||'base_rate');currencyId=this.model.get(this.def.currency_field||'currency_id');if(this.def.convertToBase){value=app.currency.convertWithRate(value,baseRate)||0;currencyId=app.currency.getBaseCurrencyId();}}
return app.currency.formatAmountLocale(value,currencyId);},unformat:function(value){if(this.tplName==='edit'){return app.utils.unformatNumberStringLocale(value);}
return app.currency.unformatAmountLocale(value);},updateCss:function(){$('div.select2-drop.select2-drop-active').width('auto');},getCurrencyField:function(){if(!_.isNull(this._currencyField)){return this._currencyField;}
var currencyDef=this.model.fields[this.def.currency_field||'currency_id'];currencyDef.type='enum';currencyDef.options=app.currency.getCurrenciesSelector(Handlebars.compile('{{symbol}} ({{iso4217}})'));currencyDef.enum_width='100%';currencyDef.searchBarThreshold=this.def.searchBarThreshold||7;this._currencyField=app.view.createField({def:currencyDef,view:this.view,viewName:this.action,model:this.model});this._currencyField.defaultOnUndefined=false;return this._currencyField;},setMode:function(name){app.view.Field.prototype.setMode.call(this,name);this.getCurrencyField().setMode(name);},dispose:function(){if(this._currencyField){this._currencyField.dispose();this._currencyField=null;}
app.view.Field.prototype.dispose.call(this);}})},"html":{"controller":({fieldSelector:'.htmlareafield',initialize:function(options){options.def.readonly=true;app.view.Field.prototype.initialize.call(this,options);},_render:function(){app.view.Field.prototype._render.call(this);this._getFieldElement().attr('name',this.name);this.setViewContent();},setViewContent:function(){var value=this.value||this.def.default_value;var field=this._getFieldElement();if(field&&!_.isEmpty(field.get(0).contentDocument)){if(field.contents().find('body').length>0){field.contents().find('body').html(value);}}},_getFieldElement:function(){return this.$el.find(this.fieldSelector);}})},"teamset":{"controller":({extendsFrom:'RelateField',minChars:1,allow_single_deselect:false,events:{'click .btn[name=add]':'addItem','click .btn[name=remove]':'removeItem','click .btn[name=primary]':'setPrimaryItem','change input.select2':'inputChanged'},plugins:['QuickSearchFilter','EllipsisInline','Tooltip'],initialize:function(options){app.view.invokeParent(this,{type:'field',name:'relate',method:'initialize',args:[options]});this.model.on("change:team_name_type",this.appendTeam,this);},_loadTemplate:function(){app.view.invokeParent(this,{type:'field',name:'relate',method:'_loadTemplate'});if(this.view.action==='list'&&this.tplName==='edit'){this.template=app.template.getField(this.type,'list',this.module,this.tplName)||app.template.empty;this.tplName='list';}},_render:function(){var self=this;this._super('_render');if(this.tplName==='edit'){this.$(this.fieldTag).each(function(index,el){var plugin=$(el).data("select2");if(!_.isUndefined(plugin)&&_.isUndefined(plugin.setTeamIndex)){plugin.setTeamIndex=function(){self.currentIndex=$(this).data("index");};plugin.opts.element.on("open",plugin.setTeamIndex);}});}},setValue:function(model){if(!model){return;}
var index=this.currentIndex,team=this.value;team[index||0].id=model.id;team[index||0].name=model.value;this._updateAndTriggerChange(team);},format:function(value){if(this.model.isNew()&&(_.isEmpty(value)||this.model.get(this.name)!=value)){if(_.isEmpty(value)){value=app.utils.deepCopy(app.user.getPreference("default_teams"));}
this.model.set(this.name,value);}
value=app.utils.deepCopy(value);if(!_.isArray(value)){value=[{name:value}];}
if(this.view.action==='list'){var primaryTeam=_.find(value,function(team){return team.primary;});return!_.isUndefined(primaryTeam)&&!_.isUndefined(primaryTeam.name)?primaryTeam.name:"";}
if(_.isArray(value)&&value.length>0){_.each(value,function(team){delete team.remove_button;delete team.add_button;});value[value.length-1].add_button=true;var numTeams=_.filter(value,function(team){return!_.isUndefined(team.id);}).length;_.each(value,function(team){if(_.isUndefined(team.id)||numTeams>1){team.remove_button=true;}});}
return value;},addTeam:function(){this.value.push({});this._updateAndTriggerChange(this.value);},removeTeam:function(index){if(index===0&&this.value.length===1){return;}
var removed=this.value.splice(index,1);if(removed&&removed.length>0&&removed[0].primary){this.setPrimary(0);}
this._updateAndTriggerChange(this.value);},appendTeam:function(){var appendTeam=this.model.get("team_name_type");if(appendTeam!=="1"){var primaryTeam=_.find(this.value,function(team){return team.primary;},this);if(_.isEmpty(primaryTeam)){this.setPrimary(0);}}},setPrimary:function(index){var previousPrimary=null,appendTeam=this.model.get("team_name_type");_.each(this.value,function(team,i){if(team.primary&&appendTeam==="1"){previousPrimary=i;}
team.primary=false;});if(previousPrimary!==index&&this.value[index].name){this.value[index].primary=true;}
this._updateAndTriggerChange(this.value);return(this.value[index])?this.value[index].primary:false;},inputChanged:function(evt){this._updateAndTriggerChange(this.value);},_updateAndTriggerChange:function(value){this.model.unset(this.name,{silent:true}).set(this.name,value);this.model.trigger("change");},addItem:_.debounce(function(evt){var index=$(evt.currentTarget).data('index');if(!index||this.value[index].id){this.addTeam();}},0),removeItem:_.debounce(function(evt){var index=$(evt.currentTarget).data('index');if(_.isNumber(index)){this.removeTeam(index);}},0),setPrimaryItem:_.debounce(function(evt){var index=$(evt.currentTarget).data('index');if(!this.value[index]||!this.value[index].id){return;}
this.$(".btn[name=primary]").removeClass("active");if(this.setPrimary(index)){this.$(".btn[name=primary][data-index="+index+"]").addClass("active");}},0)})},"float":{"controller":({unformat:function(value){return app.utils.unformatNumberStringLocale(value,true);},format:function(value){if(this.def.disable_num_format){return value;}
return app.utils.formatNumberLocale(value);}})},"chart":{"controller":({chart:undefined,chartType:'',bindDataChange:function(){this.model.on('change:rawChartData',function(){if(this.model.get('rawChartData').values.length>0){this.$el.find('.nv-chart').toggleClass('hide',false);this.$el.find('.block-footer').toggleClass('hide',true);this.generateD3Chart();this.$el.find('.nv-chart').attr('class','nv-chart nv-'+this.chartType);}else{this.$el.find('.nv-chart').toggleClass('hide',true);this.$el.find('.block-footer').toggleClass('hide',false);}},this);},generateD3Chart:function(){var chartId=this.cid,chartConfig=this.getChartConfig(),params={contentEl:chartId,minColumnWidth:120},chart=new loadSugarChartD3(chartId,this.model.get('rawChartData'),[],chartConfig,params,_.bind(function(chart){this.chart=chart;},this));},getChartConfig:function(){var chartConfig,chartData=this.model.get('rawChartData');switch(chartData.properties[0].type){case'pie chart':chartConfig={pieType:'basic',tip:'name',chartType:'pieChart'};break;case'line chart':chartConfig={lineType:'basic',tip:'name',chartType:'lineChart'};break;case'funnel chart 3D':chartConfig={funnelType:'basic',tip:'name',chartType:'funnelChart'};break;case'gauge chart':chartConfig={gaugeType:'basic',tip:'name',chartType:'gaugeChart'};break;case'stacked group by chart':chartConfig={orientation:'vertical',barType:'stacked',tip:'title',chartType:'barChart'};break;case'group by chart':chartConfig={orientation:'vertical',barType:'grouped',tip:'name',chartType:'barChart'};break;case'bar chart':chartConfig={orientation:'vertical',barType:'basic',tip:'label',chartType:'barChart'};break;case'horizontal group by chart':chartConfig={orientation:'horizontal',barType:'stacked',tip:'name',chartType:'barChart'};break;case'horizontal bar chart':case'horizontal':chartConfig={orientation:'horizontal',barType:'basic',tip:'label',chartType:'barChart'};break;default:chartConfig={orientation:'vertical',barType:'stacked',tip:'name',chartType:'barChart'};break;}
this.chartType=chartConfig.chartType;return chartConfig;}})},"shareaction":{"controller":({extendsFrom:'RowactionField',shareTplSubject:null,shareTplBody:null,shareTplBodyHtml:null,initialize:function(options){options.def=options.def||{};this.events=_.extend({},this.events,options.def.events||{},{'click a[name="share"][data-event="true"]':'share'});app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this._initShareTemplates();if(app.user.getPreference('use_sugar_email_client')!=='true'){options.def.href=this._shareWithMailTo();}},_initShareTemplates:function(){this.shareTplSubject=app.template.getView('share.subject',this.module)||app.template.getView('share.subject');this.shareTplBody=app.template.getView('share.body',this.module)||app.template.getView('share.body');this.shareTplBodyHtml=app.template.getView('share.body-html',this.module)||app.template.getView('share.body-html');},_getShareParams:function(){var moduleString=app.lang.getAppListStrings('moduleListSingular');return _.extend({},this.model.attributes,{module:moduleString[this.module]||this.module,appId:app.config.appId,url:window.location.href,name:this.model.attributes.name||this.model.attributes.full_name});},share:function(){this._shareWithSugarEmailClient();},_shareWithSugarEmailClient:function(){var subject=this.shareTplSubject(this._getShareParams()),body=this.shareTplBody(this._getShareParams()),bodyHtml=this.shareTplBodyHtml(this._getShareParams());app.drawer.open({layout:'compose',context:{create:true,module:'Emails',model:app.data.createBean('Emails',{subject:subject,html_body:bodyHtml||body})}});},_shareWithMailTo:function(){var subject=this.shareTplSubject(this._getShareParams()),body=this.shareTplBody(this._getShareParams());return'mailto:?'+['subject='+encodeURIComponent(subject),'body='+encodeURIComponent(body)].join('&');}})},"change-password":{"controller":({fieldTag:'input:not(:disabled)',events:{'click .togglePasswordFields':'togglePasswordFields'},initialize:function(options){app.view.Field.prototype.initialize.call(this,options);app.error.errorName2Keys['confirm_password']='ERR_REENTER_PASSWORDS';this._extendModel();},_extendModel:function(){if(this.model&&!this.model._hasChangePasswordModifs){var _proto=_.clone(this.model);this.model._hasChangePasswordModifs=true;this.model._doValidatePasswordConfirmation=function(fields,errors,callback){var changePasswordFields=_.filter(fields,function(field){return field.type==='change-password'||field.type==='change-my-password';});_.each(changePasswordFields,function(field){var password=this.get(field.name+'_new_password'),confirmation=this.get(field.name+'_confirm_password');if(password!==confirmation){errors[field.name]=errors[field.name]||{};errors[field.name]['confirm_password']=true;}else if(!errors[field.name]){this.unset(field.name+'_current_password');if(password!==''){this.unset(field.name+'_new_password');this.unset(field.name+'_confirm_password');this.set(field.name,password);}}},this);callback(null,fields,errors);};this.model.addValidationTask('password_confirmation',_.bind(this.model._doValidatePasswordConfirmation,this.model));this.model.revertAttributes=function(options){var attrs=_.clone(this.attributes);_.each(attrs,function(value,attr){if(attr.match('_new_password')||attr.match('_confirm_password')){this.unset(attr);}},this);_proto.revertAttributes.call(this,options);};}},_render:function(){if(this.model){this.newPassword=this.model.get(this.name+'_new_password');this.confirmPassword=this.model.get(this.name+'_confirm_password');this.showPasswordFields=this.showPasswordFields||!this.format(this.value)||!!(this.newPassword||this.confirmPassword);}
app.view.Field.prototype._render.call(this);this.showPasswordFields=false;this.$inputs=this.$(this.fieldTag);this.focusIndex=0;return this;},format:function(value){if(value===true)return'value_setvalue_set';return value;},unformat:function(value){if(value==='value_setvalue_set')return true;return value;},bindDomChange:function(){if(!(this.model instanceof Backbone.Model))return;var self=this;var el=this.$(self.fieldTag);el.on("change",function(){self.model.set(self.name+'_'+$(this).attr('name'),self.unformat($(this).val()));});},focus:function(){if(!this.$inputs.length){this.togglePasswordFields();}
if(this.focusIndex<0){this.focusIndex=0;}
if(this.focusIndex>=this.$inputs.length){this.focusIndex=-1;return false;}else{this.$inputs[this.focusIndex].focus();this.focusIndex++;return true;}},togglePasswordFields:function(event){this.showPasswordFields=true;this.render();}})},"int":{"controller":({unformat:function(value){return app.utils.unformatNumberStringLocale(value,true);},format:function(value){var numberGroupSeparator='',decimalSeparator='';if(!this.def.disable_num_format){numberGroupSeparator=app.user.getPreference('number_grouping_separator')||',';decimalSeparator=app.user.getPreference('decimal_separator')||'.';}
return app.utils.formatNumber(value,0,0,numberGroupSeparator,decimalSeparator);}})},"overdue-badge":{"controller":({_render:function(){var now=new Date(),date=new Date(this.model.get(this.name));this.model.set('overdue',date<now);this._super('_render');}})},"datetimecombo":{"controller":({extendsFrom:'DateField',stripIsoTZ:true,showAmPm:false,timeValue:'',serverTimeFormat:'H:i:s',plugins:['EllipsisInline'],_render:function(value){var self=this,viewName;self._presetDateValues();app.view.invokeParent(this,{type:'field',name:'date',method:'_render',platform:'base'});viewName=self._getViewName();$(function(){if(self._isEditView(viewName)){self._setupTimepicker();}});if(Modernizr.touch){this.$("[rel=timepicker]").attr('readonly',true);}},format:function(value){var jsDate,output,myUser=app.user,d,parts,before24Hours,datetimeParts,datePart,timePart,dateParts,timeParts;if(this.stripIsoTZ){value=app.date.stripIsoTimeDelimterAndTZ(value);}
if(this._isNewEditViewWithNoValue(value)){jsDate=this._setDateIfDefaultValue();if(!jsDate){return value;}}else if(!value){return value;}else if(this.leaveDirty){if(!this.dateValue&&!this.timeValue){try{datetimeParts=this.$el.text().trim().split(" ");if(datetimeParts&&datetimeParts.length){this.dateValue=datetimeParts[0];this.timeValue=datetimeParts.length>1?datetimeParts[1]:'';}}catch(e){}}
return{date:this.dateValue,time:this.timeValue};}else{if(this.stripIsoTZ){parts=value.split(" ");if(parts&&parts.length>1){datePart=parts[0];timePart=parts[1];dateParts=datePart.match(/(\d+)/g);timeParts=timePart.match(/(\d+)/g);if(!this._verifyDateString(datePart)){return value;}
jsDate=new Date(dateParts[0],dateParts[1]-1,dateParts[2]);jsDate.setHours(timeParts[0]);jsDate.setMinutes(timeParts[1]);jsDate.setSeconds(timeParts[2]);}else{app.logger.warn("Issue parsing datetimecombo value: "+value);}}else{if(!this._verifyDateString(value)){return value;}
jsDate=new Date(value);}}
before24Hours=jsDate.getHours();value=app.date.format(jsDate,this.usersDatePrefs)+' '+app.date.format(jsDate,this.userTimePrefs);if(this.view.name==='edit'){jsDate=app.date.roundTime(jsDate);}
value={date:app.date.format(jsDate,this.usersDatePrefs),time:app.date.format(jsDate,this.userTimePrefs),amPm:this.showAmPm?(before24Hours<12?'am':'pm'):''};this.timeValue=value['time'];this.dateValue=value['date'];this.$(".datepicker").datepicker('update',this.dateValue);return value;},unformat:function(value){var jsDate;if(value){jsDate=app.date.parse(value,this.serverDateFormat+' '+this.serverTimeFormat);if(jsDate){return this._setServerDateString(jsDate);}else{app.logger.error("Issue setting the server date string for value: "+value);return value;}}
return value;},_setupTimepicker:function(){var self=this,placeholder=this.userTimePrefs,placeholderFormatMap={'H':'hh','h':'hh','i':'mm','a':'','A':''};this.$(".ui-timepicker-input").attr('placeholder',placeholder.replace(/[HhiaA]/g,function(s){return placeholderFormatMap[s];}));if(_.isFunction(this.setRequiredPlaceholder)&&this.def.required){this.setRequiredPlaceholder(this.$(".ui-timepicker-input"));}
this.$(".ui-timepicker-input").timepicker({'timeFormat':this.userTimePrefs,'scrollDefaultNow':true,'step':15});this.$('.ui-timepicker-input').on({changeTime:_.bind(this.changeTime,this),blur:_.bind(this._handleTimepickerBlur,this),focus:function(){$('.datepicker.dropdown-menu').hide()}});this.$('.ui-timepicker-input').parent().find('.add-on:last').on('click',function(evt){evt.preventDefault();evt.stopPropagation();self.$('.ui-timepicker-input').timepicker('show');});},changeTime:function(ev){var model=this.model,fieldName=this.name,timeValue='',hrsMins={},dateValue='',timeParts,hour,hours,minutes;hrsMins=this._getHoursMinutes($(ev.currentTarget));dateValue=this._getDatepickerValue();this._setDatepickerValue(dateValue);model.set(fieldName,this._buildUnformatted(dateValue,hrsMins.hours,hrsMins.minutes),{silent:true});},_forceRoundedTime:function(timepicker,timeAsDate,hrsMins){var minutes,hours;if(this.view.name==='edit'){timeAsDate=app.date.roundTime(timeAsDate);minutes=this._forceTwoDigits(timeAsDate.getMinutes().toString());hours=this._forceTwoDigits(timeAsDate.getHours().toString());this._setTimepickerValue($(timepicker),hours,minutes);hrsMins.hours=hours;hrsMins.minutes=minutes;}
return hrsMins;},_handleTimepickerBlur:function(ev){this.model.set(this.name,this._val(ev),{silent:true});this.model.trigger("change");},_setTimeValue:function(){this.timeValue=this.$('.ui-timepicker-input').val();this.timeValue=(this.timeValue)?this.timeValue:'';},_getTimepickerValue:function($timepickerElement){var timeValue=$timepickerElement.val();this.timeValue=timeValue;return timeValue;},_getTimepickerValueAsDate:function($timepickerElement){return this.$($timepickerElement).timepicker('getTime');},_setTimepickerValue:function($timepickerElement,hours,minutes){var date=new Date();if(!hours&&!minutes){date.setHours(0,0,0,0);}
else{if(minutes){date.setMinutes(minutes);}
if(hours){date.setHours(hours);}}
$timepickerElement.timepicker('setTime',date);this.timeValue=$timepickerElement.val();},_setDateIfDefaultValue:function(){var value,jsDate;if(this.def.display_default){jsDate=app.date.parseDisplayDefault(this.def.display_default);this.model.set(this.name,this._setServerDateString(jsDate),{silent:true});}else{return null;}
return jsDate;},_getHoursMinutes:function(el){var timeParts,hour,hours,minutes,timeValue,amPm=null;timeValue=this._getTimepickerValue(el)||'';timeParts=timeValue.toLowerCase().match(/(\d+)(?::(\d\d?))?\s*([pa]?)/);if(!timeParts){return this._setIfNoTime(null,null);}
hour=parseInt(timeParts[1]*1,10);if(!_.isEmpty(timeParts[3])){amPm=(timeParts[3]==='a')?'am':'pm';if(hour==12){hours=(timeParts[3]=='a')?0:hour;}else{hours=(hour+(timeParts[3]=='p'?12:0));}}
else{hours=hour;}
minutes=(timeParts[2]*1||0);minutes=this._forceTwoDigits(minutes.toString());hours=this._forceTwoDigits(hours.toString());return this._setIfNoTime(hours,minutes,amPm);},_setIfNoTime:function(h,m,ampm){var o={};o.amPm=ampm?ampm:'am';if(!h&&!m){o.amPm='am';}
o.hours=h?h:'00';o.minutes=m?m:'00';o.hours=o.hours==='12'&&o.amPm==='am'?'00':o.hours;o.hours=o.hours==='00'&&o.amPm==='pm'?'12':o.hours;return o;},val:function(){return this._val({currentTarget:this.$('.ui-timepicker-input')});},_val:function(ev){var dateValue,hrsMins,timeAsDate,hours,minutes,timepicker=ev.currentTarget;hrsMins=this._getHoursMinutes($(ev.currentTarget));timeAsDate=this._getTimepickerValueAsDate($(timepicker));hrsMins=this._forceRoundedTime(timepicker,timeAsDate,hrsMins);this._setTimeValue();dateValue=this._getDatepickerValue();return this._buildUnformatted(dateValue,hrsMins.hours,hrsMins.minutes);},decorateError:function(errors){this.$el.closest('.record-cell').addClass("error");var dateInputs=this.$('input');dateInputs.closest("span.edit").addClass('error');dateInputs.parent().addClass('error');_.each(errors,function(errorContext,errorName){_.each(dateInputs,function(input){var inp=this.$(input);this._addErrorDecoration(inp,errorName,errorContext);},this);},this);},_addErrorDecoration:function(inp,errorName,errorContext){inp.next('.error-tooltip').remove();inp.after(this.exclamationMarkTemplate([app.error.getErrorString(errorName,errorContext)]));var tooltip=inp.next('.error-tooltip');if(_.isFunction(tooltip.tooltip)){tooltip.tooltip({container:'body',placement:'top',trigger:'click'});}}})},"sticky-rowaction":{"controller":({extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},_render:function(){if(this.isDisabled()){if(_.isUndefined(this.def.css_class)||this.def.css_class.indexOf('disabled')===-1){this.def.css_class=(this.def.css_class)?this.def.css_class+" disabled":"disabled";}
this.undelegateEvents();}
app.view.invokeParent(this,{type:'field',name:'rowaction',method:'_render'});},isDisabled:function(){return!app.view.invokeParent(this,{type:'field',name:'rowaction',method:'hasAccess'});},hasAccess:function(){return true;}})},"fieldset-with-labels":{"controller":({extendsFrom:'FieldsetField',_render:function(){if(_.isEmpty(this.fields)){this._createFields();this._renderNewFields();}else{this._renderExistingFields();}
if(this.def&&this.def.css_class){this.getFieldElement().addClass(this.def.css_class);}
return this;},_createFields:function(){this._loadTemplate();this.$el.html(this.template(this));},_renderNewFields:function(){_.each(this.def.fields,function(fieldDef){var field=this.view.getField(fieldDef.name);this.fields.push(field);field.setElement(this.$("span[sfuuid='"+field.sfId+"']"));field.render();},this);},_renderExistingFields:function(){_.each(this.fields,function(field){field.render();},this);},getPlaceholder:function(){return app.view.Field.prototype.getPlaceholder.call(this);},setMode:function(name){this.tplName=name;app.view.invokeParent(this,{type:'field',name:'fieldset',method:'setMode',args:[name]});}})},"editablelistbutton":{"controller":({events:{'click [name=inline-save]':'saveClicked','click [name=inline-cancel]':'cancelClicked'},extendsFrom:'ButtonField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'button',method:'initialize',args:[options]});if(this.name==='inline-save'){this.model.off("change",null,this);this.model.on("change",function(){this.changed=true;},this);}},_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.view.action==='list'&&_.indexOf(['edit','disabled'],this.action)>=0){this.template=app.template.getField('button','edit',this.module,'edit');}else{this.template=app.template.empty;}},_validationComplete:function(isValid){if(!isValid){this.setDisabled(false);return;}
if(!this.changed){this.cancelEdit();return;}
var self=this,options={success:function(model){self.changed=false;self.view.toggleRow(model.id,false);self._refreshListView();},complete:function(){self.setDisabled(false);},showAlerts:{'process':true,'success':{messages:app.lang.get('LBL_RECORD_SAVED',self.module)}},relate:self.model.link?true:false};options=_.extend({},options,self.getCustomSaveOptions(options));var callbacks={success:function(){self.model.save({},options);}};async.forEachSeries(this.view.rowFields[this.model.id],function(view,callback){app.file.checkFileFieldsAndProcessUpload(view,{success:function(){callback.call();}},{deleteIfFails:false},true);},callbacks.success);},getCustomSaveOptions:function(options){return{};},saveModel:function(){this.setDisabled(true);var fieldsToValidate=this.view.getFields(this.module);this.model.doValidate(fieldsToValidate,_.bind(this._validationComplete,this));},cancelEdit:function(){if(this.isDisabled()){this.setDisabled(false);}
this.changed=false;this.model.revertAttributes();this.view.clearValidationErrors();this.view.toggleRow(this.model.id,false);},saveClicked:function(evt){this.saveModel();},cancelClicked:function(evt){this.cancelEdit();},_refreshListView:function(){var filterPanelLayout=this.view;while(filterPanelLayout&&filterPanelLayout.name!=='filterpanel'){filterPanelLayout=filterPanelLayout.layout;}
if(filterPanelLayout&&!filterPanelLayout.disposed&&this.collection){filterPanelLayout.applyLastFilter(this.collection);}}})},"actiondropdown":{"controller":({extendsFrom:'FieldsetField',fields:null,dropdownFields:null,events:{'click [data-toggle=dropdown]':'renderDropdown','change [data-toggle=dropdownmenu]':'dropdownSelected','touchstart [data-toggle=dropdownmenu]':'renderDropdown'},plugins:['Tooltip'],showNoData:false,initialize:function(options){app.view.invokeParent(this,{type:'field',name:'fieldset',method:'initialize',args:[options]});this.dropdownFields=[];var actiondropdownField=app.view._getController({type:'field',name:'actiondropdown'});this.setPlaceholder=_.throttle(actiondropdownField.prototype.setPlaceholder,100);},renderDropdown:function(){if(_.isEmpty(this.dropdownFields)||this.isDisabled()){return;}
_.each(this.dropdownFields,function(field){this.view.fields[field.sfId]=field;field.setElement(this.$('span[sfuuid="'+field.sfId+'"]'));if(this.def['switch_on_click']&&!this.def['no_default_action']){field.$el.on('click.'+this.cid,_.bind(this.switchButton,this));}
field.render();},this);this.dropdownFields=null;if(!this.def['switch_on_click']||this.def['no_default_action']){return;}
var firstField=_.first(this.fields);firstField.$el.on('click.'+this.cid,_.bind(this.switchButton,this));},switchButton:function(evt){var sfId=parseInt(this.$(evt.currentTarget).attr('sfuuid'),10),index=-1;_.some(this.fields,function(field,idx){if(field.sfId===sfId){index=idx;return true;}
return false;},this);if(index<=0){return;}
var firstField=this.fields.shift(),selectedField=this.fields.splice(index-1,1,firstField).pop();this.fields.splice(0,0,selectedField);this.setPlaceholder();},dropdownSelected:function(evt){if(this.isDisabled()){return;}
var $el=this.$(evt.currentTarget),selectedIndex=$el.val();if(!selectedIndex){return;}
this.fields[selectedIndex].getFieldElement().trigger('click');$el.blur();this.setPlaceholder();},getPlaceholder:function(){if(this.options.viewName==='list-header')return app.view.Field.prototype.getPlaceholder.call(this);var caretCss='btn dropdown-toggle';if(this.def['no_default_action']){caretCss+=' btn-invisible';}else if(this.def['primary']){caretCss+=' btn-primary';}
var cssClass=[],container='',caretIcon=this.def['icon']?this.def['icon']:'icon-caret-down',caret='<a class="'+caretCss+'" data-toggle="dropdown" href="javascript:void(0);" data-placement="bottom" rel="tooltip" title="'+app.lang.get('LBL_LISTVIEW_ACTIONS')+'">'+'<span class="'+caretIcon+'"></span>'+'</a>',dropdown='<ul class="dropdown-menu">';if(app.utils.isTouchDevice()){caret+='<select data-toggle="dropdownmenu" class="hide dropdown-menu-select"></select>';}
var index=this.def['no_default_action']?1:0;_.each(this.def.buttons,function(fieldDef){var field=app.view.createField({def:fieldDef,view:this.view,viewName:this.options.viewName,model:this.model});this.fields.push(field);field.on('show hide',this.setPlaceholder,this);field.parent=this;if(fieldDef.type==='divider'){return;}
if(index==0){container+=field.getPlaceholder();}else{delete this.view.fields[field.sfId];this.dropdownFields.push(field);if(index==1){cssClass.push('actions','btn-group');container+=caret;container+=dropdown;}
container+='<li>'+field.getPlaceholder()+'</li>';}
index++;},this);var cssName=cssClass.join(' '),placeholder='<span sfuuid="'+this.sfId+'" class="'+cssName+'">'+container;placeholder+=(_.size(this.def.buttons)>0)?'</ul></span>':'</span>';return new Handlebars.SafeString(placeholder);},_render:function(){app.view.invokeParent(this,{type:'field',name:'fieldset',method:'_render'});this.setPlaceholder();this._updateCaret();},_updateCaret:function(){if(_.isEmpty(this.dropdownFields)){return;}
var caretEnabled=_.some(this.dropdownFields,function(field){if(field.hasAccess()){if(field.def.css_class.indexOf('disabled')>-1){return false;}else if(field.isDisabled()){return false;}else{return true;}}
return false;});if(!caretEnabled){this.$('.icon-caret-down').closest('a').addClass('disabled');}},setPlaceholder:function(){if(this.disposed){return;}
var index=this.def['no_default_action']?1:0,visibleEl=document.createDocumentFragment(),hiddenEl=document.createDocumentFragment(),selectEl=this.$('.dropdown-menu-select'),html='<option></option>';_.each(this.fields,function(field,idx){var cssClass=_.unique(field.def.css_class?field.def.css_class.split(' '):[]),fieldPlaceholder=this.$('span[sfuuid="'+field.sfId+'"]');if(field.type==='divider'){if(index<=1){return;}
var dividerEl=document.createElement('li');dividerEl.className='divider';visibleEl.appendChild(dividerEl);return;}
if(field.isVisible()&&field.hasAccess()){cssClass=_.without(cssClass,'hide');fieldPlaceholder.toggleClass('hide',false);if(index==0){cssClass.push('btn');field.getFieldElement().addClass('btn');if(this.def.primary){cssClass.push('btn-primary');field.getFieldElement().addClass('btn-primary');}
this.$el.prepend(fieldPlaceholder);}else{cssClass=_.without(cssClass,'btn','btn-primary');field.getFieldElement().removeClass('btn btn-primary');var dropdownEl=document.createElement('li');dropdownEl.appendChild(fieldPlaceholder.get(0));visibleEl.appendChild(dropdownEl);html+='<option value='+idx+'>'+field.label+'</option>';}
index++;}else{cssClass.push('hide');fieldPlaceholder.toggleClass('hide',true);hiddenEl.appendChild(fieldPlaceholder.get(0));}
cssClass=_.unique(cssClass);field.def.css_class=cssClass.join(' ');},this);if(index<=1){this.$('.dropdown-toggle').hide();selectEl.addClass('hide');this.$el.removeClass('btn-group');}else{this.$('.dropdown-toggle').show();selectEl.removeClass('hide');this.$el.addClass('btn-group');}
this.$('.dropdown-menu').children('li').remove();this.$('.dropdown-menu').append(visibleEl);this.$el.append(hiddenEl);if(app.utils.isTouchDevice()){selectEl.html(html);}
var firstButton=_.first(this.fields);if(firstButton&&!firstButton.isVisible()){this.renderDropdown();}},setDisabled:function(disable){app.view.invokeParent(this,{type:'field',name:'fieldset',method:'setDisabled',args:[disable]});disable=_.isUndefined(disable)?true:disable;if(disable){this.$('.dropdown-toggle').addClass('disabled');}else{this.$('.dropdown-toggle').removeClass('disabled');}},_dispose:function(){_.each(this.fields,function(field){field.$el.off('click.'+this.cid);field.off('show hide',this.setPlaceholder,this);},this);this.dropdownFields=null;app.view.invokeParent(this,{type:'field',name:'fieldset',method:'_dispose'});},isVisible:function(){return!this.getFieldElement().is(':hidden');}})},"follow":{"controller":({showNoData:false,events:{'click [data-event="list:follow:fire"]':'toggleFollowing'},extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.format();},bindDataChange:function(){if(this.model){this.model.on("change:following",this.resetLabel,this);}
this.model.on("favorite:active",function(){this.model.set("following",true);},this);},format:function(value){value=this.model.get("following");if(this.tplName==="detail"){var label=value?"LBL_FOLLOWING":"LBL_FOLLOW";this.label=app.lang.get(label,this.module);}else{var label=value?"LBL_UNFOLLOW":"LBL_FOLLOW";this.label=app.lang.get(label,this.module);}
return value;},resetLabel:function(){this.render();this.trigger("show");},unbindDom:function(){this.$("[data-hover=true]").off();app.view.invokeParent(this,{type:'field',name:'rowaction',method:'unbindDom'});},_render:function(){var module,mouseoverText,mouseoverClass,self=this;module=app.metadata.getModule(this.model.module);if(!module.activityStreamEnabled){this.hide();}else{app.view.invokeParent(this,{type:'field',name:'rowaction',method:'_render'});if(this.tplName!=="detail"){return;}
if(this.model.get("following")){mouseoverText=app.lang.get("LBL_UNFOLLOW");mouseoverClass="label-important";}else{mouseoverText=app.lang.get("LBL_FOLLOW");mouseoverClass="label-success";}
this.$("[data-hover=true]").on("mouseover",function(){$(this).text(mouseoverText).attr("class","label").addClass(mouseoverClass);}).on("mouseout",function(){var kls=self.model.get("following")?"label-success":"";$(this).text(self.label).attr("class","label").addClass(kls);});}},toggleFollowing:function(e){var isFollowing=this.model.get("following");if(!_.isUndefined(isFollowing)){var options={alerts:false};if(this.model.follow(!isFollowing,options)===false){app.logger.error('Unable to follow "'+this.model.module+'" record "'+this.model.id);return;}}}})},"fieldset":{"controller":({fields:null,initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.fields=[];},getPlaceholder:function(){var placeholder='<span sfuuid="'+this.sfId+'">';_.each(this.def.fields,function(fieldDef){if(this.def.readonly){fieldDef.readonly=true;}
var field=app.view.createField({def:fieldDef,view:this.view,viewName:this.options.viewName,model:this.model});this.fields.push(field);field.parent=this;placeholder+=field.getPlaceholder();},this);placeholder+='</span>';return new Handlebars.SafeString(placeholder);},showNoData:function(){if(!this.def.readonly){return false;}
return!_.some(this.fields,function(field){return field.name&&field.model.has(field.name);});},_render:function(){this._loadTemplate();if(_.contains(this.fallbackActions,this.action)){this.$el.html(this.template(this)||'');}
if(this.def&&this.def.css_class){this.getFieldElement().addClass(this.def.css_class);}
this.focusIndex=0;this._addViewClass(this.action);return this;},focus:function(){if(this.focusIndex<0||!this.focusIndex){this.focusIndex=0;}
if(this.focusIndex>=this.fields.length){this.focusIndex=-1;return false;}else{if(this.fields[this.focusIndex]&&this.fields[this.focusIndex].isDisabled()){this.focusIndex++;return this.focus();}
if(_.isFunction(this.fields[this.focusIndex].focus)&&this.fields[this.focusIndex].focus()){}else{var field=this.fields[this.focusIndex];var $el=field.$(field.fieldTag+":first");$el.focus().val($el.val());this.focusIndex++;}
return true;}},setDisabled:function(disable){disable=_.isUndefined(disable)?true:disable;app.view.Field.prototype.setDisabled.call(this,disable);_.each(this.fields,function(field){field.setDisabled(disable);},this);},setViewName:function(view){app.view.Field.prototype.setViewName.call(this,view);_.each(this.fields,function(field){field.setViewName(view);},this);},setMode:function(name){this.focusIndex=0;app.view.Field.prototype.setMode.call(this,name);_.each(this.fields,function(field){field.setMode(name);},this);},bindDomChange:function(){},bindDataChange:function(){},unbindDom:function(){},_dispose:function(){_.each(this.fields,function(field){field.parent=null;field.dispose();});this.fields=null;app.view.Field.prototype._dispose.call(this);}})},"selection":{"controller":({events:{'click input.selection':'toggleSelect'},toggleSelect:function(evt){var $el=$(evt.currentTarget).is(":checked");if($el){this.check();}else{this.uncheck();}},check:function(){if(this.model){this.context.set('selection_model',this.model);}},uncheck:function(){if(this.model){this.context.unset('selection_model');}},bindDomChange:function(){}})},"name":{"controller":({plugins:['EllipsisInline'],_render:function(){if(this.view.name==='record'){this.def.link=false;}else if(this.view.name==='preview'){this.def.link=true;}
this._super('_render');}})},"pdfaction":{"controller":({extendsFrom:'RowactionField',events:{'click [data-action=link]':'linkClicked','click [data-action=download]':'downloadClicked','click [data-action=email]':'emailClicked'},templateCollection:null,fetchCalled:false,initialize:function(options){this._super('initialize',[options]);this.templateCollection=app.data.createBeanCollection('PdfManager');},_render:function(){if(this.def.action==='email'&&app.user.getPreference('use_sugar_email_client')!=='true'){this.hide();}else{this._super('_render');}},_fetchTemplate:function(){this.fetchCalled=true;var collection=this.templateCollection;collection.filterDef={'$and':[{'base_module':this.module},{'published':'yes'}]};collection.fetch();},_buildDownloadLink:function(templateId){var urlParams=$.param({'action':'sugarpdf','module':this.module,'sugarpdf':'pdfmanager','record':this.model.id,'pdf_template_id':templateId});return'?'+urlParams;},_buildEmailLink:function(templateId){return'#'+app.bwc.buildRoute(this.module,null,'sugarpdf',{'sugarpdf':'pdfmanager','record':this.model.id,'pdf_template_id':templateId,'to_email':'1'});},linkClicked:function(evt){evt.preventDefault();evt.stopPropagation();if(this.templateCollection.dataFetched){this.fetchCalled=!this.fetchCalled;}else{this._fetchTemplate();}
this.render();},emailClicked:function(evt){var templateId=this.$(evt.currentTarget).data('id');app.router.navigate(this._buildEmailLink(templateId),{trigger:true});},downloadClicked:function(evt){var templateId=this.$(evt.currentTarget).data('id');app.api.fileDownload(this._buildDownloadLink(templateId),{error:function(data){app.error.handleHttpError(data,{});}},{iframe:this.$el});},bindDataChange:function(){this.templateCollection.on('reset',this.render,this);this._super('bindDataChange');},unbindData:function(){this.templateCollection.off(null,null,this);this.templateCollection=null;this._super('unbindData');},hasAccess:function(){var pdfAccess=app.acl.hasAccess('view','PdfManager');return pdfAccess&&this._super('hasAccess');}})},"bool":{"controller":({_render:function(){app.view.Field.prototype._render.call(this);if(this.tplName==='disabled'){this.$(this.fieldTag).attr("disabled","disabled");}},unformat:function(value){value=this.$el.find(".checkbox").prop("checked")?"1":"0";return value;},format:function(value){value=(value=="1")?true:false;return value;}})},"email-text":{"controller":({useSugarEmailClient:false,initialize:function(options){options=options||{};options.def=options.def||{};if(_.isUndefined(options.def.link)){options.def.link=true;}
app.view.Field.prototype.initialize.call(this,options);this.useSugarEmailClient=(app.user.getPreference("use_sugar_email_client")==="true");},format:function(value){if(_.isArray(value)){var primaryEmail=_.find(value,function(email){return email.primary_address&&email.primary_address!=="0";});return primaryEmail?primaryEmail.email_address:'';}
return value;},unformat:function(value){var self=this,emails=this.model.get('email'),changed=false;if(!_.isArray(emails)){emails=[];}
_.each(emails,function(email,index){if(email.primary_address&&email.primary_address!=="0"&&email.email_address!==value)
{changed=true;emails[index].email_address=value;}},this);if(emails.length==0){emails.push({email_address:value,primary_address:"1",hasAnchor:false,_wasNotArray:true});changed=true;}
if(changed){this.model.set(this.name,emails);this.model.trigger('change:'+this.name);}
return emails;}})},"range":{"controller":({fieldTag:'.rangeSlider',_sliderTypeSettings:{single:{handles:1,connect:false},upper:{handles:1,connect:'upper'},lower:{handles:1,connect:'lower'},'double':{handles:2,connect:false},connected:{handles:2,connect:true}},_render:function(value){app.view.Field.prototype._render.call(this);this._setupSlider(this.$el.find(this.fieldTag));},unformat:function(value){var sliderType=this.def.sliderType||'single';switch(sliderType){case'single':return _.first(value);case'upper':return{min:_.first(value),max:this.def.maxRange||100};case'lower':return{min:this.def.minRange||0,max:_.last(value)};case'double':return[_.isNaN(_.first(value))?this.def.minRange||0:_.first(value),_.isNaN(_.last(value))?this.def.maxRange||100:_.last(value)];case'connected':default:return{min:_.isNaN(_.first(value))?this.def.minRange||0:_.first(value),max:_.isNaN(_.last(value))?this.def.maxRange||100:_.last(value)};}},format:function(value){var sliderType=this.def.sliderType||'single';switch(sliderType){case'single':return[value||this.def.rangeMin||0];case'upper':return[value.min||this.def.rangeMin||0];case'lower':return[value.max||this.def.rangeMax||100];case'double':return value;case'connected':default:if(value){return[value.min||this.def.rangeMin||0,value.max||this.def.rangeMax||100];}}
return[this.def.rangeMin||0,this.def.rangeMax||100];},_setupSlider:function(jqel){jqel.noUiSlider('init',{knobs:this._calculateHandles(),connect:this._setupHandleConnections(this.def.sliderType||'single'),scale:this._setupSliderEndpoints(),start:this._setupSliderStartPositions(),change:this._sliderChange,end:this._sliderChangeComplete,field:this});if(!this.def.hideStyle){this._addStyle(jqel);}
if(this.def.enabled==false||this.def.view!='edit'){jqel.noUiSlider('disable');}},_addStyle:function(jqel){var start=this._setupSliderStartPositions(),endpoints=this._setupSliderEndpoints();jqel.append(function(){var html="",segments=11,w=$(this).width(),segmentWidth=w/(segments-1),acum=0;for(i=0;i<segments;i++){acum=(segmentWidth*i)-2;html+="<div class='ticks' style='left:"+acum+"px'></div>";}
return html;}).find('.noUi-handle div').each(function(index){if(i>1){i=0;}
$(this).append('<div class="tooltip fade top in infoBox"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+start[i]+'%'+'</div></div>');i++;});this.$('.noUiSliderEnds').attr('data-content-before',_.first(endpoints)+'%').attr('data-content-after',_.last(endpoints)+'%')},_calculateHandles:function(){var sliderType=this.def.sliderType||'single';return this._sliderTypeSettings[sliderType].handles;},_setupHandleConnections:function(sliderType){var sliderType=this.def.sliderType||'single';return this._sliderTypeSettings[sliderType].connect;},_setupSliderEndpoints:function(){var minRange=this.def.minRange||0,maxRange=this.def.maxRange||100;return[minRange,maxRange];},_setupSliderStartPositions:function(){var value;if(this.model){value=this.model.get(this.name);}
if(_.isUndefined(value)||(_.isArray(value)&&_.isEmpty(value))){return[this.def.minRange||0,this.def.maxRange||100];}
return this.format(value);},getSliderValues:function(jqel){var value=jqel.noUiSlider('value');return this.unformat(value);},_sliderChange:function(type){var field=this.data('api').options.field,values;if(field.def.updateOn&&(field.def.updateOn=='change'||field.def.updateOn=='both')){field.model.set(field.name,field.getSliderValues(this));}
if(!field.def.hideStyle){values=this.noUiSlider('value');this.find('.noUi-lowerHandle .infoBox .tooltip-inner').text(values[0]+"%");this.find('.noUi-upperHandle .infoBox .tooltip-inner').text(values[1]+"%");}
if(type!='move'&&_.isFunction(field.sliderChangeDelegate)){field.sliderChangeDelegate(field.getSliderValues(this));}},_sliderChangeComplete:function(type){var field=this.data('api').options.field;if(field.def.updateOn&&(field.def.updateOn=='done'||field.def.updateOn=='both')){field.model.set(field.name,field.getSliderValues(this));}
if(_.isFunction(field.sliderDoneDelegate)){field.sliderDoneDelegate(field.getSliderValues(this));}}})},"htmleditable_tinymce":{"controller":({fieldSelector:'.htmleditable',_htmleditor:null,_isDirty:false,_saveOnSetContent:true,_render:function(){this.destroyTinyMCEEditor();app.view.Field.prototype._render.call(this);this._getHtmlEditableField().attr('name',this.name);if(this._isEditView()){this._renderEdit(this.options.def.tinyConfig||null);}else{this._renderView();}},bindDataChange:function(){this.model.on('change:'+this.name,function(model,value){if(this._isEditView()){this._saveOnSetContent=false;this.setEditorContent(value);}else{this.setViewContent(value)}},this);},setViewContent:function(value){var editable=this._getHtmlEditableField();if(editable&&!_.isEmpty(editable.get(0).contentDocument)){if(editable.contents().find('body').length>0){editable.contents().find('body').html(value);}}},_renderEdit:function(options){var self=this;this.initTinyMCEEditor(options);this._getHtmlEditableField().on('change',function(){self.model.set(self.name,self._getHtmlEditableField().val());});},_renderView:function(){this.setViewContent(this.value);},_isEditView:function(){return(this._getHtmlEditableField().prop('tagName')==='TEXTAREA');},getTinyMCEConfig:function(){return{script_url:'include/javascript/tiny_mce/tiny_mce.js',theme:"advanced",skin:"sugar7",plugins:"style,table,advhr,advimage,advlink,iespell,inlinepopups,media,searchreplace,print,contextmenu,paste,noneditable,visualchars,nonbreaking,xhtmlxtras",entity_encoding:"raw",theme_advanced_buttons1:"code,|,bold,italic,underline,|,justifyleft,justifycenter,justifyright,justifyfull,fontsizeselect,|,insertlayer,moveforward,movebackward,absolute,|,styleprops,|,cite,abbr,acronym,del,ins,attribs,|,iespell,media,advhr,|,print,|",theme_advanced_buttons2:"cut,copy,paste,|,search,replace,|,bullist,numlist,|,outdent,indent,blockquote,|,undo,redo,|,link,unlink,anchor,image,|,forecolor,backcolor,tablecontrols,|,",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_statusbar_location:"none",theme_advanced_resizing:true,schema:"html5",template_external_list_url:"lists/template_list.js",external_link_list_url:"lists/link_list.js",external_image_list_url:"lists/image_list.js",media_external_list_url:"lists/media_list.js",theme_advanced_path:false,theme_advanced_source_editor_width:500,theme_advanced_source_editor_height:400,inlinepopups_skin:"sugar7modal",relative_urls:false,remove_script_host:false};},initTinyMCEEditor:function(optConfig){var self=this;if(_.isEmpty(this._htmleditor)){var config=optConfig||this.getTinyMCEConfig();var __superSetup__=config.setup;config.setup=function(editor){if(_.isFunction(__superSetup__)){__superSetup__.call(this,editor);}
self._htmleditor=editor;self._htmleditor.onInit.add(function(ed){self.setEditorContent(self.value);$(ed.getWin()).blur(function(e){self._saveEditor();});});self._htmleditor.onDeactivate.add(function(ed){self._saveEditor();});self._htmleditor.onSetContent.add(function(ed){if(self._saveOnSetContent){self._saveEditor(true);}
self._saveOnSetContent=true;});self._htmleditor.onChange.add(function(ed,l){self._isDirty=true;});};config.oninit=function(inst){self.context.trigger('tinymce:oninit',inst);};$('.htmleditable').tinymce(config);}},destroyTinyMCEEditor:function(){if(!_.isNull(this._htmleditor)){this._saveEditor(true);this._htmleditor.remove();this._htmleditor.destroy();this._htmleditor=null;}},_saveEditor:function(force){var save=force|this._isDirty;if(save){this.model.set(this.name,this.getEditorContent(),{silent:true});this._isDirty=false;}},_getHtmlEditableField:function(){return this.$el.find(this.fieldSelector);},setEditorContent:function(value){if(_.isEmpty(value)){value="";}
if(this._isEditView()&&this._htmleditor&&this._htmleditor.dom){this._htmleditor.setContent(value);}},getEditorContent:function(){return this._htmleditor.getContent();},_dispose:function(){this.destroyTinyMCEEditor();app.view.Field.prototype._dispose.call(this);}})},"textarea":{"controller":({fieldTag:"textarea",maxDisplayLength:450,isTruncated:false,lastMode:null,plugins:['EllipsisInline'],events:{'click .show-more-text':'toggleMoreText'},format:function(value){return this.value||value||'';},_render:function(){this.def.css_class=this.def.css_class||'textarea-text';var value=this.model.get(this.name);if((!_.isUndefined(value))&&(value.length>this.maxDisplayLength)){this.isTooLong=true;}else{this.isTooLong=false;this.lastMode=null;this.value=value;}
if(this.lastMode&&this.tplName==='edit'){if(this.lastMode==='more'){this.showMore();return;}
this.showLess();return;}
app.view.Field.prototype._render.call(this);this.$el.addClass(this.def.css_class);if(this._notListView()){if(this.tplName!=='edit'){if(this.isTooLong){this.showLess();}
if(this.tplName==='disabled'){this.$(this.fieldTag).attr("disabled","disabled");}}else{this.value=value;app.view.Field.prototype._render.call(this);}}},_notListView:function(){if(this.view.name!=='list'||(this.view.meta&&this.view.meta.type!=='list')){return true;}
return false;},toggleMoreText:function(){if(this.isTruncated){this.showMore();}else{this.showLess();}},showMore:function(){this._toggleTextLength('more');},showLess:function(){this._toggleTextLength('less');},_toggleTextLength:function(mode){var displayValue,newLinkLabel,originalValue;originalValue=this.model.get(this.name);if(mode==="more"){displayValue=originalValue.trim()+'...';this.isTruncated=false;newLinkLabel=app.lang.get('LBL_LESS',this.module).toLocaleLowerCase();}else{displayValue=originalValue.substring(0,this.maxDisplayLength).trim()+'...';this.isTruncated=true;newLinkLabel=app.lang.get('LBL_MORE',this.module).toLocaleLowerCase();}
this.value=displayValue;this.$el.empty();app.view.Field.prototype._render.call(this);this.$('.show-more-text').text(newLinkLabel);this.lastMode=mode;}})},"fullname":{"controller":({extendsFrom:'FieldsetField',plugins:['EllipsisInline'],formatMap:{'first_name':'f','last_name':'l','salutation':'s'},initialize:function(options){var formatPlaceholder=app.user.getPreference('default_locale_name_format')||'';options.def.fields=_.sortBy(options.def.fields,function(field){return formatPlaceholder.indexOf(this.formatMap[field.name]);},this);this._super('initialize',[options]);},_loadTemplate:function(){this._super('_loadTemplate');if(this.def.link){var action=this.def.route&&this.def.route.action?this.def.route.action:'';this.href='#'+app.router.buildRoute(this.module||this.context.get('module'),this.model.id,action,this.def.bwcLink);}
this.template=app.template.getField(this.type,this.view.name+'-'+this.tplName,this.model.module)||this.template;},getPlaceholder:function(){return app.view.Field.prototype.getPlaceholder.call(this);},_render:function(){_.each(this.fields,function(field){field.dispose();delete this.view.fields[field.sfId];},this);this.fields=[];app.view.Field.prototype._render.call(this);_.each(this.fields,function(field){field.setElement(this.$("span[sfuuid='"+field.sfId+"']"));field.render();},this);return this;},format:function(name){return app.utils.formatNameLocale({first_name:this.model.get('first_name'),last_name:this.model.get('last_name'),salutation:this.model.get('salutation')});},bindDataChange:function(){if(this.model){this.model.on("change:"+this.name,function(){if(this.fields.length===0){this.render();}},this);_.each(this.def.fields,function(field){this.model.on("change:"+field.name,this.updateValue,this);},this);}},updateValue:function(){this.model.set(this.name,this.format());},setMaxWidth:function(width){this.$('.record-cell').css({'max-width':width});},getCellPadding:function(){var padding=0,$cell=this.$('.record-cell');if(!_.isEmpty($cell)){padding=parseInt($cell.css('padding-left'),10)+parseInt($cell.css('padding-right'),10);}
return padding;}})},"relate":{"controller":({allow_single_deselect:true,minChars:1,fieldTag:'input.select2',plugins:['QuickSearchFilter','EllipsisInline'],initialize:function(options){this.minChars=options.def.minChars||this.minChars;app.view.Field.prototype.initialize.call(this,options);var populateMetadata=app.metadata.getModule(this.getSearchModule());if(_.isEmpty(populateMetadata)){return;}
_.each(this.def.populate_list,function(target,source){if(_.isUndefined(populateMetadata.fields[source])){app.logger.error('Fail to populate the related attributes: attempt to access undefined key - '+
this.getSearchModule()+'::'+source);}},this);},bindKeyDown:function(callback){this.$('input').on("keydown.record",{field:this},callback);},focus:function(){if(this.action!=='disabled'){this.$(this.fieldTag).select2('open');}},_render:function(){var self=this;var result=app.view.Field.prototype._render.call(this);if(this.tplName==='edit'){var inList=this.view.name==='recordlist'?true:false;var cssClasses=(inList?'select2-narrow':'')+(this.type==='parent'?' select2-parent':'');this.$(this.fieldTag).select2({width:inList?'off':'100%',dropdownCssClass:cssClasses,containerCssClass:cssClasses,initSelection:function(el,callback){var $el=$(el),id=$el.data('id'),text=$el.val();callback({id:id,text:text});},formatInputTooShort:function(){return'';},formatSearching:function(){return app.lang.get("LBL_LOADING",self.module);},placeholder:this.getPlaceHolder(),allowClear:self.allow_single_deselect,minimumInputLength:self.minChars,query:_.bind(this.search,this)}).on("open",function(){var plugin=$(this).data('select2');if(!plugin.searchmore){var $content=$('<li class="select2-result">').append($('<div/>').addClass('select2-result-label').html(app.lang.get('LBL_SEARCH_FOR_MORE',self.module))).mousedown(function(){plugin.opts.element.trigger($.Event("searchmore"));plugin.close();});plugin.searchmore=$('<ul class="select2-results">').append($content);plugin.dropdown.append(plugin.searchmore);}}).on("searchmore",function(){$(this).select2("close");app.drawer.open({layout:'selection-list',context:{module:self.getSearchModule(),fields:_.union(['id','name'],_.keys(self.def.populate_list||{}))}},_.bind(self.setValue,self));}).on("change",function(e){var id=e.val,plugin=$(this).data('select2'),value=(id)?plugin.selection.find("span").text():$(this).data('id'),collection=plugin.context,attributes={};if(collection){var model=collection.get(id);attributes.id=model.id;attributes.value=model.get('name');_.each(model.attributes,function(value,field){if(app.acl.hasAccessToModel('view',model,field)){attributes[field]=attributes[field]||model.get(field);}});}else if(e.currentTarget.value&&value){attributes.id=value;attributes.value=e.currentTarget.value;}else{attributes.id='';attributes.value='';}
self.setValue(attributes);});}else if(this.tplName==='disabled'){this.$(this.fieldTag).select2({width:'100%',initSelection:function(el,callback){var $el=$(el),id=$el.data('id'),text=$el.val();callback({id:id,text:text});},formatInputTooShort:function(){return'';},formatSearching:function(){return app.lang.get("LBL_LOADING",self.module);},placeholder:this.getPlaceHolder(),allowClear:self.allow_single_deselect,minimumInputLength:self.minChars,query:_.bind(this.search,this)});this.$(this.fieldTag).select2('disable');}
return result;},buildRoute:function(module,id){var oldModule=module;if(module==='Users'&&this.context.get('module')!=='Users'){module='Employees';}
if(_.isEmpty(module)||(!_.isUndefined(this.def.link)&&!this.def.link)){return;}
var action=(this.def.link&&this.def.route)?this.def.route.action:"view";if(app.acl.hasAccess(action,oldModule)){this.href='#'+app.router.buildRoute(module,id);}},_buildRoute:function(){this.buildRoute(this.getSearchModule(),this._getRelateId());},_getRelateId:function(){return this.model.get(this.def.id_name);},format:function(value){this._buildRoute();return value;},unformat:function(value){return this.model.get(this.def.id_name);},setValue:function(model){if(!model){return;}
var silent=model.silent||false;var values={};values[this.def.id_name]=model.id;values[this.def.name]=model.value;this.model.set(values,{silent:silent});var newData={},self=this;_.each(this.def.populate_list,function(target,source){source=_.isNumber(source)?target:source;if(!_.isUndefined(model[source])&&app.acl.hasAccessToModel('edit',this.model,target)){newData[target]=model[source];}},this);if(_.isEmpty(newData)){return;}
if(!_.isUndefined(this.def.auto_populate)&&this.def.auto_populate==true){if(!_.isUndefined(newData.currency_id)){this.model.set({currency_id:newData.currency_id})
delete newData.currency_id;}
this.model.set(newData);return;}
var messageTplKey=app.lang.get(this.def.populate_confirm_label||'TPL_OVERWRITE_POPULATED_DATA_CONFIRM'),messageTpl=Handlebars.compile(app.lang.get(messageTplKey,this.getSearchModule())),fieldMessageTpl=Handlebars.compile(app.lang.get('TPL_ALERT_OVERWRITE_POPULATED_DATA_FIELD',this.getSearchModule())),messages=[],alert_view=null;_.each(newData,function(value,field){var def=this.model.fields[field];messages.push(fieldMessageTpl({before:this.model.get(field),after:value,field_label:app.lang.get(def.label||def.vname||field,this.module)}));},this);app.alert.show('overwrite_confirmation',{level:'confirmation',messages:messageTpl({values:messages.join(', ')})+'<br><br>',onConfirm:function(){if(!_.isUndefined(newData.currency_id)){this.model.set({currency_id:newData.currency_id})
delete newData.currency_id;}
self.model.set(newData);}});alert_view=app.alert.get('overwrite_confirmation');if(alert_view){alert_view.$('[rel="tooltip"]').on('mouseenter',function(e){if(_.isFunction($(this).tooltip)){$(this).tooltip({placement:"bottom"}).tooltip("show");}});alert_view.$('[rel="tooltip"]').on('mouseleave',function(e){if(_.isFunction($(this).tooltip)){$(this).tooltip("hide");}})}},bindDomChange:function(){},getSearchModule:function(){return this.def.module;},getPlaceHolder:function(){var module,moduleString=app.lang.getAppListStrings('moduleListSingular');if(!moduleString[this.getSearchModule()]){app.logger.error("Module '"+this.getSearchModule()+"' doesn't have singular translation.");module=this.getSearchModule().toLocaleLowerCase();}else{module=moduleString[this.getSearchModule()].toLocaleLowerCase();}
return app.lang.get('LBL_SEARCH_SELECT_MODULE',this.module,{module:module});},search:_.debounce(function(query){var term=query.term||'',self=this,searchCollection,filterDef,searchModule=this.getSearchModule(),params={},limit=self.def.limit||5;searchCollection=query.context||app.data.createBeanCollection(searchModule);if(query.context){params.offset=searchCollection.next_offset;}
filterDef=self.getFilterDef(searchModule,term);params.filter=app.utils.deepCopy(filterDef);searchCollection.fetch({showAlerts:false,update:true,remove:_.isUndefined(params.offset),fields:_.union(['id','name'],_.keys(this.def.populate_list||{})),context:self,params:params,limit:limit,success:function(data){var fetch={results:[],more:data.next_offset>0,context:searchCollection};if(fetch.more){var fieldEl=self.$(self.fieldTag),plugin=(fieldEl.length>1)?$(fieldEl.get(self.currentIndex)).data("select2"):fieldEl.data("select2"),height=plugin.searchmore.children("li:first").children(":first").outerHeight(),maxHeight=height*(limit-.2);plugin.results.css("max-height",maxHeight);}
_.each(data.models,function(model,index){if(params.offset&&index<params.offset){return;}
fetch.results.push({id:model.id,text:model.get('name')});});query.callback(fetch);},error:function(){query.callback({results:[]});app.logger.error("Unable to fetch the bean collection.");}});},app.config.requiredElapsed||500),unbindDom:function(){this.$(this.fieldTag).select2('destroy');app.view.Field.prototype.unbindDom.call(this);}})},"file":{"controller":({fieldTag:'input[type=file]',supportedImageExtensions:{'image/jpeg':'jpg','image/png':'png','image/gif':'gif'},events:{'click [data-action=download]':'startDownload','click [data-action=delete]':'deleteFile'},fileUrl:'',plugins:['File','EllipsisInline'],_duplicateModuleId:null,duplicateFromModel:function(modelId){this._duplicateModuleId=modelId;},deleteFile:function(e){var self=this;app.alert.show('delete_file_confirmation',{level:'confirmation',messages:app.lang.get('LBL_FILE_DELETE_CONFIRM',self.module),onConfirm:function(){var data={module:self.module,id:self.model.id,field:self.name},callbacks={success:function(){self.model.set(self.name,'');self.model.save({},{showAlerts:{'process':true,'success':{messages:app.lang.get('LBL_FILE_DELETED',self.module)}},fields:[self.name]});if(self.disposed){return;}
self.render();},error:function(data){app.error.handleHttpError(data,{});}};app.api.file('delete',data,null,callbacks,{htmlJsonFormat:false});}});},_loadTemplate:function(){this._super('_loadTemplate');if(this.view.name==='merge-duplicates'){this.template=app.template.getField(this.type,'merge-duplicates-'+this.tplName,this.module,this.tplName)||app.template.empty;this.tplName='list';}},_render:function(){this.model=this.model||this.view.model;app.view.Field.prototype._render.call(this);return this;},format:function(value){var attachments=[];if(_.isArray(value)){_.each(value,function(file){var fileObj={name:file.name,url:file.uri};attachments.push(fileObj);},this);}else if(value){var isImage=this._isImage(this.model.get('file_mime_type')),forceDownload=!isImage,mimeType=isImage?'image':'',fileObj={name:value,mimeType:mimeType,url:app.api.buildFileURL({module:this.module,id:this.model.id,field:this.name},{htmlJsonFormat:false,passOAuthToken:false,cleanCache:true,forceDownload:forceDownload})};attachments.push(fileObj);}
return(this.tplName==="list")?_.first(attachments):attachments;},startDownload:function(e){var uri=this.$(e.currentTarget).data('url');app.api.fileDownload(uri,{error:function(data){app.error.handleHttpError(data,{});}},{iframe:this.$el});},bindDataChange:function(){if(!this.model){return;}
this.model.on('change:'+this.name,function(){if(_.isUndefined(this.options.viewName)||this.options.viewName!=='edit'){this.render();}else if(this.view.name==='merge-duplicates'&&this.options.viewName&&this.options.viewName==='edit'){this.render();}
this.duplicateFromModel(null);},this);this.model.on('duplicate:field',this._onDuplicate,this);this.model.on('duplicate:field:'+this.name,this._onDuplicate,this);this.model.on('data:sync:start',function(method,options){if(!_.isNull(this._duplicateModuleId)&&(method=='update'||method=='create')){options.params=options.params||{};options.params[this.name+'_duplicateModuleId']=this._duplicateModuleId;}},this);},_onDuplicate:function(model){if(model instanceof Backbone.Model){this.duplicateFromModel(model.get('id'));}},unformat:function(value){return value.split('/').pop().split('\\').pop();},_isImage:function(mimeType){return!!this.supportedImageExtensions[mimeType];}})},"copy":{"controller":({'events':{'click input[type=checkbox]':'toggle','click button':'copyOnce'},_initialValues:null,_fields:null,_inSync:false,initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this._initialValues={};this._fields={};if(_.isUndefined(this.def.sync)){this.def.sync=true;}
this.before('render',function(){this.setDisabled(!this.hasAccess());return true;},this);},toggle:function(evt){this.sync($(evt.currentTarget).is(':checked'));},sync:function(enable){enable=_.isUndefined(enable)||enable;if(this._inSync===enable){return;}
this._inSync=enable;if(!enable){this.syncCopy(false);this.restore();return;}
_.each(this.def.mapping,function(target,source){this.copy(source,target);var field=this.getField(target);if(!_.isUndefined(field)){field.setDisabled(true);}},this);this.syncCopy(true);},copyOnce:function(evt){_.each(this.def.mapping,function(target,source){this.copy(source,target);},this);},copy:function(from,to){if(!this.model.has(from)){return;}
if(_.isUndefined(this._initialValues[to])){this._initialValues[to]=this.model.get(to);}
if(app.acl.hasAccessToModel('edit',this.model,to)){this.model.set(to,this.model.get(from));}},restore:function(){_.each(this._initialValues,function(value,field){this.model.set(field,value);},this);_.each(this.def.mapping,function(target,source){var field=this.getField(target);if(!_.isUndefined(field)){field.setDisabled(false);}},this);this._initialValues={};},syncCopy:function(enable){if(!this.def.sync){return;}
if(!enable){this.model.off(null,this.copyChanged);return;}
var events=_.map(_.keys(this.def.mapping),function(field){return'change:'+field;});this.model.on(events.join(' '),this.copyChanged,this);},copyChanged:function(model,value){_.each(model.changedAttributes(),function(newValue,field){model.set(this.def.mapping[field],model.get(field));},this);},getField:function(name){if(_.isUndefined(this._fields[name])){this._fields[name]=_.find(this.view.fields,function(field){return field.name==name;});}
return this._fields[name];},unformat:function(value){return null;},format:function(value){if(_.isNull(value)){return this._inSync;}
return value;},bindDataChange:function(){if(this.model&&this.def.sync){var inSync=_.all(this.def.mapping,function(target,source){return this.model.get(source)===this.model.get(target);},this);this.sync(inSync);}},hasAccess:function(){return _.some(this.def.mapping||[],function(toField,fromField){return app.acl.hasAccessToModel('read',this.model,fromField)&&app.acl.hasAccessToModel('edit',this.model,toField);},this);}})},"iframe":{"controller":({_render:function(){app.view.Field.prototype._render.call(this);if(this.tplName==='disabled'){this.$(this.fieldTag).attr("disabled","disabled");}},unformat:function(value){value=(value!==''&&value!='http://')?value.trim():"";return value;},format:function(value){if(_.isEmpty(value)){value=_.isString(this.def['default'])?this.def['default']:undefined;}
if(_.isString(value)&&!value.match(/^(http|https):\/\//)){value="http://"+value.trim();}
if(this.def.gen=="1"){var regex=/{(.+?)}/;var result=null;do{result=regex.exec(value);if(result){value=value.replace(result[0],this.model.get(result[1]));}}while(result);}
return value;}})},"base":{"controller":({plugins:['EllipsisInline','Tooltip'],_render:function(){var action="view";if(this.def.link&&this.def.route){action=this.def.route.action;}
if(!app.acl.hasAccessToModel(action,this.model)){this.def.link=false;}
if(this.def.link){this.href=this.buildHref();}
app.view.Field.prototype._render.call(this);},buildHref:function(){var defRoute=this.def.route?this.def.route:{},module=this.model.module||this.context.get('module');return'#'+app.router.buildRoute(module,this.model.id,defRoute.action,this.def.bwcLink);},unformat:function(value){return _.isString(value)?value.trim():value;}})},"favorite":{"controller":({showNoData:false,'events':{'click .icon-favorite':'toggle'},plugins:['Tooltip'],initialize:function(options){options.def.readonly=true;app.view.Field.prototype.initialize.call(this,options);},_render:function(){if(!this.model.get('id')){return null;}
if(!app.metadata.getModule(this.model.module).favoritesEnabled){app.logger.error("Trying to use favorite field on a module that doesn't support it: '"+this.model.module+"'.");return null;}
return app.view.Field.prototype._render.call(this);},toggle:function(evt){var self=this,star=$(evt.currentTarget);var options={silent:true,alerts:false};if(self.view&&self.view.action==='list'){options.success=function(){self._refreshListView();};}
if(this.model.favorite(!this.model.isFavorite(),options)===false){app.logger.error("Unable to set '"+this.model.module+"' record '"+this.model.id+"' as favorite");return;}
if(this.model.isFavorite()){star.addClass('active');this.model.trigger("favorite:active");}
else{star.removeClass('active');}},format:function(){return this.model.isFavorite();},_refreshListView:function(){var filterPanelLayout=this.view;while(filterPanelLayout&&filterPanelLayout.name!=='filterpanel'){filterPanelLayout=filterPanelLayout.layout;}
if(filterPanelLayout&&!filterPanelLayout.disposed&&this.collection){filterPanelLayout.applyLastFilter(this.collection,'favorite');}}})},"radioenum":{"controller":({extendsFrom:'ListeditableField',_render:function(){app.view.invokeParent(this,{type:'field',name:'enum',method:'loadEnumOptions',args:[false,function(){if(!this.disposed){this.render();}}]});app.view.Field.prototype._render.call(this);if(this.tplName==='list-edit'){app.view.invokeParent(this,{type:'field',name:'enum',method:'_render'});}},bindDomChange:function(){if(this.tplName==='list-edit'){app.view.invokeParent(this,{type:'field',name:'enum',method:'bindDomChange'});}else{if(!(this.model instanceof Backbone.Model))return;var self=this;var el=this.$el.find(this.fieldTag);el.on("change",function(){self.model.set(self.name,self.unformat(self.$(self.fieldTag+":radio:checked").val()));});}},format:function(value){if(this.tplName==='list-edit'){return app.view.invokeParent(this,{type:'field',name:'enum',method:'format',args:[value]});}else{return app.view.Field.prototype.format.call(this,value);}},unformat:function(value){if(this.tplName==='list-edit'){return app.view.invokeParent(this,{type:'field',name:'enum',method:'unformat',args:[value]});}else{return app.view.Field.prototype.unformat.call(this,value);}},_loadTemplate:function(){app.view.invokeParent(this,{type:'field',name:'listeditable',method:'_loadTemplate'});},getSelect2Options:function(optionKeys){return app.view.invokeParent(this,{type:'field',name:'enum',method:'getSelect2Options',args:[optionKeys]});},_query:function(query){return app.view.invokeParent(this,{type:'field',name:'enum',method:'_query',args:[query]});},_initSelection:function($ele,callback){app.view.invokeParent(this,{type:'field',name:'enum',method:'_initSelection',args:[$ele,callback]});},decorateError:function(errors){if(this.tplName==='list-edit'){return app.view.invokeParent(this,{type:'field',name:'enum',method:'decorateError',args:[errors]});}else{var errorMessages=[],$tooltip;this.$el.closest('.record-cell').addClass('error');this.$el.addClass('error');_.each(errors,function(errorContext,errorName){errorMessages.push(app.error.getErrorString(errorName,errorContext));});this.$(this.fieldTag).last().closest('p').append(this.exclamationMarkTemplate(errorMessages));$tooltip=this.$('.error-tooltip');if(_.isFunction($tooltip.tooltip)){var tooltipOpts={container:'body',placement:'top',trigger:'click'};$tooltip.tooltip(tooltipOpts);}}},clearErrorDecoration:function(){if(this.tplName==='list-edit'){return app.view.invokeParent(this,{type:'field',name:'enum',method:'clearErrorDecoration'});}else{var ftag=this.fieldTag||'';this.$('.add-on').remove();this.$el.removeClass(ftag);this.$el.removeClass("error");this.$el.closest('.record-cell').removeClass("error");}},unbindDom:function(){this.$(this.fieldTag).select2('destroy');app.view.Field.prototype.unbindDom.call(this);}})},"button":{"controller":({tagName:"span",fieldTag:"a",plugins:['Tooltip','MetadataEventDriven'],initialize:function(options){var self=this;this.events=_.extend({},this.events,options.def.events,{'click .disabled':'preventClick'});app.view.Field.prototype.initialize.call(this,options);this.before("render",function(){if(self.hasAccess()){this._show();return true;}
else{this.hide();return false;}});},_render:function(){this.fullRoute=_.isString(this.def.route)?this.def.route:null;app.view.Field.prototype._render.call(this);},getFieldElement:function(){return this.$(this.fieldTag);},setDisabled:function(disable){disable=_.isUndefined(disable)?true:disable;var orig_css=this.def.css_class||'';this.def.css_class=orig_css;var css_class=this.def.css_class.split(' ');if(disable){css_class.push('disabled');}else{css_class=_.without(css_class,'disabled');}
this.def.css_class=_.unique(_.compact(css_class)).join(' ');app.view.Field.prototype.setDisabled.call(this,disable);this.def.css_class=orig_css;},preventClick:function(evt){if(this.isDisabled()){return false;}},_show:function(){if(this.isHidden!==false){if(!this.triggerBefore("show")){return false;}
this.getFieldElement().removeClass("hide").show();this.isHidden=false;this.trigger('show');}},show:function(){if(this.hasAccess()){this._show();}else{this.isHidden=true;}},hide:function(){if(this.isHidden!==true){if(!this.triggerBefore("hide")){return false;}
this.getFieldElement().addClass("hide").hide();this.isHidden=true;this.trigger('hide');}},isVisible:function(){return!this.isHidden;},bindDomChange:function(){},bindDataChange:function(){},hasAccess:function(){var acl_module=this.def.acl_module,acl_action=this.def.acl_action;if(_.isBoolean(this.def.allow_bwc)&&!this.def.allow_bwc){var isBwc=app.metadata.getModule(acl_module||this.module).isBwcEnabled;if(isBwc){return false;}}
if(!acl_module){return app.acl.hasAccessToModel(acl_action,this.model,this);}else{return app.acl.hasAccess(acl_action,acl_module);}}})},"badge":{"controller":({showNoData:false,initialize:function(options){options.def.readonly=true;app.view.Field.prototype.initialize.call(this,options);}})},"dashletaction":{"controller":({events:{'click [data-dashletaction]':'actionClicked'},extendsFrom:'ButtonField',actionClicked:function(evt){if(this.preventClick(evt)===false){return;}
var action=$(evt.currentTarget).data('dashletaction');this._runAction(evt,action);},_runAction:function(evt,action){if(!action){return;}
var dashlet=this.view.layout?_.first(this.view.layout._components):null;if(dashlet&&_.isFunction(dashlet[action])){dashlet[action](evt,this.def.params);}else if(_.isFunction(this.view[action])){this.view[action](evt,this.def.params);}}})},"quickcreate":{"controller":({events:{'click .actionLink[data-event="true"]':'_handleActionLink'},plugins:['LinkedModel'],initialize:function(options){app.view.Field.prototype.initialize.call(this,options);app.events.on("create:model:changed",this.createModelChanged,this);},createHasChanges:false,createModelChanged:function(hasChanged){this.createHasChanges=hasChanged;},_handleActionLink:function(evt){var $actionLink=$(evt.currentTarget),module=$actionLink.data('module'),moduleMeta=app.metadata.getModule(this.context.get('module'));this.actionLayout=$actionLink.data('layout');if(this.createHasChanges){app.alert.show('send_confirmation',{level:'confirmation',messages:'LBL_WARN_UNSAVED_EDITS',onConfirm:_.bind(function(){app.drawer.reset(false);this.createRelatedRecord(module);},this)});}else if(moduleMeta&&moduleMeta.isBwcEnabled){this.createRelatedRecord(module);}else{app.drawer.reset();this.createRelatedRecord(module);}},routeToBwcCreate:function(module){var context=this.getRelatedContext(module);if(context){app.bwc.createRelatedRecord(module,this.context.get('model'),context.link);}else{var route=app.bwc.buildRoute(module,null,'EditView');app.router.navigate(route,{trigger:true});}},getRelatedContext:function(module){var meta=app.metadata.getModule(module),context;if(meta&&meta.menu.quickcreate.meta.related){var parentModel=this.context.get('model');if(parentModel.isNew()){return;}
context=_.find(meta.menu.quickcreate.meta.related,function(metadata){return metadata.module===parentModel.module;});}
return context;},openCreateDrawer:function(module){var relatedContext=this.getRelatedContext(module),model=null;if(relatedContext){model=this.createLinkModel(this.context.get('model'),relatedContext.link);}
app.drawer.open({layout:this.actionLayout||'create-actions',context:{create:true,module:module,model:model}},_.bind(function(refresh,model){if(refresh){if(model&&!model.id){app.router.refresh();return;}
if(model&&relatedContext){this.context.trigger('panel-top:refresh',relatedContext.link);return;}
this._loadContext(app.controller.context,module);if(app.controller.context.children){_.each(app.controller.context.children,function(context){this._loadContext(context,module);},this);}}},this));},_loadContext:function(context,module){var collection=context.get('collection');if(collection&&collection.module===module){var options={showAlerts:false};collection.resetPagination();context.resetLoadFlag(false);context.set('skipFetch',false);options=_.extend(options,context.get('collectionOptions'));context.loadData(options);}}})},"invitation-actions":{"controller":({plugins:['Tooltip'],events:{'click [data-action]':'toggleStatus'},toggleStatus:function(evt){var attr={};attr[this.name]=$(evt.currentTarget).data('action');this.model.save(attr,{relate:true});}})},"attachments":{"controller":({fieldSelector:'.attachments',fileInputSelector:'.fileinput',$node:null,fileCounter:0,initialize:function(options){var launchUploadEvent=options.def.uploadEvent||'attachment:upload';this.events=_.extend({},this.events,options.def.events,{'change .fileinput':'uploadFile'});app.view.Field.prototype.initialize.call(this,options);this.context.on('attachment:add',this.addAttachment,this);this.context.on(launchUploadEvent,this.launchFilePicker,this);this.context.on('attachment:upload:remove',this.removeUploadedAttachment,this);this.context.on('attachments:remove-by-tag',this.removeAttachmentsByTag,this);this.context.on('attachments:remove-by-id',this.removeAttachmentsById,this);this.clearUserAttachmentCache();},_keyHandler:function(e){if((event.keyCode==8||event.keyCode==46)){return true;}
return false;},_render:function(){var result=app.view.Field.prototype._render.call(this);this.$node=this.$(this.fieldSelector);this.$node.select2({allowClear:true,multiple:true,containerCssClass:'select2-choices-pills-close',containerCss:{'width':'100%'},tags:[],formatSelection:this.formatSelection,width:'off',escapeMarkup:function(m){return m;}});var inp=this.$el.find('.attachments.select2-container .select2-choices .select2-search-field .select2-input');if(inp&&inp[0]){$(inp[0]).keypress(this._keyHandler);$(inp[0]).keyup(this._keyHandler);$(inp[0]).keydown(this._keyHandler);}
this.refreshFromModel();return result;},addAttachment:function(attachment){this.addAttachmentToContainer(attachment);this.updateModel();},addAttachmentToContainer:function(attachment){var attachments=this.getDisplayedAttachments();if(attachment.replaceId){attachments=_.map(attachments,function(existing){return(existing.id==attachment.replaceId)?attachment:existing;});delete attachment.replaceId;}else{attachments.push(attachment);}
this.setDisplayedAttachments(attachments);},bindDomChange:function(){this.$node=this.$(this.fieldSelector);this.$node.on("change",_.bind(this.handleChange,this));this.$node.on("opening",function(event){event.preventDefault();});},clearUserAttachmentCache:function(){var clearCacheUrl=app.api.buildURL('Mail/attachment',"cache");app.api.call('delete',clearCacheUrl);},formatSelection:function(attachment){var item='<span data-id="'+attachment.id+'">'+attachment.nameForDisplay+'</span>';if(attachment.showProgress){item+=' <i class="icon-refresh icon-spin"></i>';}
return item;},getDisplayedAttachments:function(){return this.$node.select2('data');},handleChange:function(event){this.updateModel();if(event&&event.removed&&event.removed.type){this.notifyAttachmentRemoved(event.removed);}
this.notifyAttachmentsChanged();},notifyAttachmentRemoved:function(attachment){this.context.trigger('attachment:'+attachment.type+':remove',attachment);},notifyAttachmentsChanged:function(attachments){attachments=attachments||this.getDisplayedAttachments();this.context.trigger('attachments:updated',attachments);},launchFilePicker:function(){this.$(this.fileInputSelector).click();},refreshFromModel:function(){var attachments=[];if(this.model.has(this.name)){attachments=this.model.get(this.name);}
this.setDisplayedAttachments(attachments);},removeAttachmentsByIterator:function(iterator){var attachments=this.getDisplayedAttachments();attachments=_.reject(attachments,iterator);this.setDisplayedAttachments(attachments);this.updateModel();},removeAttachmentsById:function(id){this.removeAttachmentsByIterator(_.bind(function(attachment){if(attachment.id&&attachment.id===id){this.notifyAttachmentRemoved(attachment);return true;}},this));},removeAttachmentsByTag:function(tag){this.removeAttachmentsByIterator(_.bind(function(attachment){if(attachment.tag&&attachment.tag===tag){this.notifyAttachmentRemoved(attachment);return true;}},this));},removeUploadedAttachment:function(attachment){var deleteUrl=app.api.buildURL('Mail/attachment',"delete",{id:attachment.id});app.api.call('delete',deleteUrl);},setDisplayedAttachments:function(attachments){this.$node.select2('data',attachments);this.notifyAttachmentsChanged(attachments);},updateModel:function(){this.model.set(this.name,this.getDisplayedAttachments());},uploadFile:function(){var $fileInput=this.$(this.fileInputSelector),ajaxParams={files:$fileInput,iframe:true},fileId;if(_.isEmpty(this.getFileInputVal())){return;}
this.fileCounter++;fileId='upload'+this.fileCounter;this.addAttachmentToContainer({id:fileId,nameForDisplay:this.getFileInputVal().split('\\').pop(),showProgress:true});var myURL=app.api.buildURL('Mail/attachment',null,null,{oauth_token:app.api.getOAuthToken()});app.api.call('create',myURL,null,{success:_.bind(function(result){if(this.disposed===true)return;if(!result.guid){this.handleUploadError(fileId);app.logger.error('Attachment Upload Failed - no guid returned from API');return;}
result.id=result.guid;delete result.guid;result.type='upload';result.replaceId=fileId;this.context.trigger('attachment:add',result);$fileInput.val(null);},this),error:_.bind(function(e){if(this.disposed===true)return;this.handleUploadError(fileId);app.logger.error('Attachment Upload Failed: '+e);},this)},ajaxParams);},getFileInputVal:function($fileInput){$fileInput=$fileInput||this.$(this.fileInputSelector);if(_.isUndefined($fileInput)){return null;}
return $fileInput.val();},handleUploadError:function(fileId){var errorMessage=app.lang.getAppString('LBL_EMAIL_ATTACHMENT_UPLOAD_FAILED');this.context.trigger('attachments:remove-by-id',fileId);app.alert.show('upload_error',errorMessage);},bindDataChange:$.noop,_dispose:function(){this.$node.select2('destroy');app.view.Field.prototype._dispose.call(this);}})},"rowaction":{"controller":({extendsFrom:'ButtonField',initialize:function(options){this.options.def.events=_.extend({},this.options.def.events,{'click .rowaction':'rowActionSelect'});app.view.invokeParent(this,{type:'field',name:'button',method:'initialize',args:[options]});},rowActionSelect:function(evt){if(this.isDisabled()){return;}
if(this.preventClick(evt)!==false){if($(evt.currentTarget).data('event')){this.view.context.trigger($(evt.currentTarget).data('event'),this.model);}}}})},"link-action":{"controller":({extendsFrom:'StickyRowactionField',events:{'click a[name=select_button]':'openSelectDrawer'},openSelectDrawer:function(){if(this.isDisabled()){return;}
var parentModel=this.context.get("parentModel"),linkModule=this.context.get("module"),link=this.context.get("link"),self=this;app.drawer.open({layout:'link-selection',context:{module:linkModule}},function(model){if(!model){return;}
var relatedModel=app.data.createRelatedBean(parentModel,model.id,link),options={showAlerts:true,relate:true,success:function(model){self.context.resetLoadFlag();self.context.set('skipFetch',false);self.context.loadData();},error:function(error){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false});}};relatedModel.save(null,options);});},isDisabled:function(){if(app.view.invokeParent(this,{type:'field',name:'sticky-rowaction',method:'isDisabled'})){return true;}
var link=this.context.get("link");var parentModule=this.context.get("parentModule");var required=app.utils.isRequiredLink(parentModule,link);return required;}})},"image":{"controller":({showNoData:false,events:{"click .delete":"delete","change input[type=file]":"selectImage"},plugins:['File'],initialize:function(options){app.view.Field.prototype.initialize.call(this,options);if(!this.model.hasImageRequiredValidator){this.model.hasImageRequiredValidator=true;this.model.addValidationTask('image_required',_.bind(this._doValidateImageField,this));}},_dispose:function(){this.model.hasImageRequiredValidator=false;this.model._validationTasks=_.omit(this.model._validationTasks,'image_required');app.view.Field.prototype._dispose.call(this);},_render:function(){this.model.fileField=this.name;app.view.Field.prototype._render.call(this);if(this.tplName==='list'){this.width=this.height=this.$el.parent().innerHeight()||42;this.def.width=this.def.height=undefined;}else{this.width=parseInt(this.def.width||this.def.height,10)||50;this.height=parseInt(this.def.height,10)||this.width;}
this.resizeWidth(this.width);this.resizeHeight(this.height);this.$('.image_field').removeClass('hide');this.$('img').addClass('hide').on('load',$.proxy(this.resizeWidget,this));return this;},format:function(value){if(value){value=this.buildUrl()+"&_hash="+value;}
return value;},bindDataChange:function(){var viewType=this.view.name||this.options.viewName;var ignoreViewType=["edit","create","create-actions"];if(_.indexOf(ignoreViewType,viewType)<0&&this.view.action!=="edit"){app.view.Field.prototype.bindDataChange.call(this);}},bindDomChange:function(){},selectImage:function(e){var self=this,$input=self.$('input[type=file]');self.preview=true;self.clearErrorDecoration();self.model.uploadFile(self.name,$input,{field:self.name,success:function(rsp){var fileId=(rsp[self.name])?rsp[self.name]['guid']:null;var url=app.api.buildFileURL({module:self.module,id:'temp',field:self.name,fileId:fileId});var image=$('<img>').addClass('hide').attr('src',url).on('load',$.proxy(self.resizeWidget,self));self.$('.image_preview').html(image);self.model.trigger("change","image");},error:function(error){var fieldError={},errors={};fieldError[error.responseText]={};errors[self.name]=fieldError;self.model.trigger('error:validation:'+this.field,fieldError);self.model.trigger('error:validation',errors);}},{temp:true});},'delete':function(e){var self=this;if(this.preview===true){self.preview=false;self.clearErrorDecoration();self.render();}else{var confirmMessage=app.lang.get('LBL_IMAGE_DELETE_CONFIRM',self.module);if(confirm(confirmMessage)){app.api.call('delete',self.buildUrl({htmlJsonFormat:false}),{},{success:function(){self.model.unset(self.name);self.model.set(self.name,null);if(!self.disposed)self.render();},error:function(data){app.error.handleHttpError(data,{});}});}}},buildUrl:function(options){return app.api.buildFileURL({module:this.module,id:this.model.id,field:this.name},options);},resizeWidget:function(){var image=this.$('.image_preview img, .image_detail img');if(!image[0])return;var isDefHeight=!_.isUndefined(this.def.height)&&this.def.height>0,isDefWidth=!_.isUndefined(this.def.width)&&this.def.width>0;if(isDefWidth){image.css('width',this.width);}
if(isDefHeight){image.css('height',this.height);}
if(!isDefHeight&&!isDefWidth)
image.css({'height':this.height,'width':this.width});this.resizeHeight(image.height());if(isDefHeight&&!isDefWidth){var newWidth=Math.floor((this.height/image[0].naturalHeight)*image[0].naturalWidth);image.css('width',newWidth);this.resizeWidth(newWidth);}
image.removeClass('hide');this.$('.delete').remove();var icon=this.preview===true?'remove':'trash';image.closest('label, a').after('<span class="image_btn delete icon-'+icon+' " />');},formatPX:function(size){size=parseInt(size,10);return size+'px';},resizeHeight:function(height){var $image_field=this.$('.image_field'),isEditAndIcon=this.$('.icon-plus').length>0;if(isEditAndIcon){var $image_btn=$image_field.find('.image_btn');var edit_btn_height=parseInt($image_btn.css('height'),10);var previewHeight=parseInt(height,10);previewHeight-=edit_btn_height?edit_btn_height:0;previewHeight=this.formatPX(previewHeight);$image_field.find('.icon-plus').css({lineHeight:previewHeight});}
var totalHeight=this.formatPX(height);$image_field.css({'height':totalHeight,minHeight:totalHeight,lineHeight:totalHeight});$image_field.find('label').css({lineHeight:totalHeight});},resizeWidth:function(width){var $image_field=this.$('.image_field'),width=this.formatPX(width),isInHeaderpane=$(this.el).closest('.headerpane').length>0,isInRowFluid=$(this.el).closest('.row-fluid').closest('.record').length>0;if(isInHeaderpane||!isInRowFluid){$image_field.css({'width':width});}else{$image_field.css({'maxWidth':width});}},_doValidateImageField:function(fields,errors,callback){var $input=this.$('input[type=file]');if(this.def.required&&(_.isEmpty($input)||_.isEmpty($input.val()))){errors[this.name]=errors[this.name]||{};errors[this.name].required=true;}
callback(null,fields,errors);},handleValidationError:function(errors){var errorMessages=[],$tooltip;if(this.action==='detail'){this.setMode('edit');}
this.$('.image_preview').html('<i class="icon-remove"></i>');this.$('label').after('<span class="image_btn delete icon-remove" />');this.$el.closest('.record-cell').addClass("error");this.$el.addClass('input-append error');_.each(errors,function(errorContext,errorName){errorMessages.push(app.error.getErrorString(errorName,errorContext));});this.$('.image_field').append(this.exclamationMarkTemplate(errorMessages));$tooltip=this.$('.error-tooltip');if(_.isFunction($tooltip.tooltip)){var tooltipOpts={container:'body',placement:'right',trigger:'click'};$tooltip.tooltip(tooltipOpts);}},clearErrorDecoration:function(){this.$('.delete').remove();this.$('.error-tooltip').remove();this.$el.closest('.record-cell').removeClass('error');this.$el.removeClass('input-append error');}})}}},"views":{"base":{"wizard-page":{"controller":({plugins:['GridBuilder','ErrorDecoration'],events:{'click [name=previous_button]:not(.disabled)':'previous','click [name=next_button]:not(.disabled)':'next'},progress:null,areAllRequiredFieldsNonEmpty:false,initialize:function(options){this.fieldsToValidate=this._fieldsToValidate(options.meta);Handlebars.registerPartial("wizard-page.header",app.template.get("wizard-page.header"));Handlebars.registerPartial("wizard-page.footer",app.template.get("wizard-page.footer"));app.view.View.prototype.initialize.call(this,options);},_render:function(){this._buildGridsFromPanelsMetadata(this.meta.panels);this.progress=this.layout.getProgress();this.percentComplete=this._getPercentageComplete();this.wizardCompleted=(this.progress.page===this.progress.lastPage)?true:false;app.view.View.prototype._render.call(this);this.checkIfPageComplete();},bindDataChange:function(){var self=this;if(this.model){this.listenTo(this.model,"sync",function(){self.checkIfPageComplete();});_.each(this.fieldsToValidate,function(field){if(field&&field.required){self.listenTo(self.model,'change:'+field.name,function(){self.checkIfPageComplete();});}});}},_buildGridsFromPanelsMetadata:function(panels){_.each(panels,function(panel){if(_.isFunction(this.getGridBuilder)){var options={fields:panel.fields,columns:panel.columns,labels:panel.labels,labelsOnTop:panel.labelsOnTop},gridResults=this.getGridBuilder(options).build();panel.grid=gridResults.grid;}},this);},_getPercentageComplete:function(){return Math.floor(this.progress.page/this.progress.lastPage*100);},updateButtons:function(){var prevBtn=this.getField("previous_button");if(prevBtn){if(this.progress&&this.progress.page>1){prevBtn.show();}else{prevBtn.hide();}}
var nextBtn=this.getField("next_button");if(nextBtn){nextBtn.setDisabled(!this.isPageComplete());}},showPage:function(){return app.acl.hasAccessToModel(this.action,this.model);},isPageComplete:function(){return true;},checkIfPageComplete:function(evt){var self=this;this.areAllRequiredFieldsNonEmpty=true;_.each(this.fields,function(field){if(!field.def.required)return;var value=field.$(field.fieldTag+".required").val();var invalid=app.validation.requiredValidator(field.def,field.name,field.model,value);if(invalid){self.areAllRequiredFieldsNonEmpty=false;}});this.updateButtons();},_fieldsToValidate:function(meta){meta=meta||{};var fields={};_.each(_.flatten(_.pluck(meta.panels,"fields")),function(field){fields[field.name]=field;});return fields;},next:function(){var self=this;if(this.progress.page!==this.progress.lastPage){this.beforeNext(function(success){if(success){self.progress=self.layout.nextPage();}else{app.logger.debug("There was an unknown issue after calling beforeNext from wizard");}});}else{this.beforeFinish(function(success){if(success){self.finish();}else{app.logger.debug("There was an unknown issue after calling beforeFinish from wizard");}});}},beforeNext:function(callback){app.logger.debug("wizard's beforeNext called directly. Derived controllers should have overridden this!");callback(true);},beforeFinish:function(callback){app.logger.debug("wizard's beforeFinish called directly. Derived controller should have overridden this!");callback(true);},previous:function(){this.progress=this.layout.previousPage();},finish:function(){this.layout.finished();}})},"activitystream":{"controller":({events:{'change div[data-placeholder]':'checkPlaceholder','keydown div[data-placeholder]':'checkPlaceholder','keypress div[data-placeholder]':'checkPlaceholder','input div[data-placeholder]':'checkPlaceholder','click .reply':'showAddComment','click .reply-btn':'addComment','click .preview-btn:not(.disabled)':'previewRecord','click .comment-btn':'toggleReplyBar','click .more':'fetchComments'},tagName:"li",className:"activitystream-posts-comments-container",plugins:['Timeago','FileDragoff','QuickSearchFilter','Taggable','Tooltip'],cacheNamePrefix:"user:avatars:",cacheNameExpire:":expiry",expiryTime:36000000,_unformattedPost:null,_unformattedComments:{},urlRegExp:/\b((?:https?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:\'".,<>?                ]))/ig,initialize:function(options){this.opts={params:{}};this.readonly=!!options.readonly;app.view.View.prototype.initialize.call(this,options);var lastComment=this.model.get("last_comment");this.commentsCollection=app.data.createRelatedCollection(this.model,"comments");if(lastComment&&!_.isUndefined(lastComment.id)){this.commentsCollection.reset([lastComment]);}
this.model.set("comments",this.commentsCollection);var count=parseInt(this.model.get('comment_count'),10);this.remaining_comments=0;this.more_tpl="TPL_MORE_COMMENT";if(count){this.remaining_comments=count-1;if(count>2){this.more_tpl+="S";}}
this.preview=this.getPreviewData();var data=this.model.get('data');var activity_type=this.model.get('activity_type');this.tpl="TPL_ACTIVITY_"+activity_type.toUpperCase();switch(activity_type){case'post':if(!data.value){this.tpl=null;}
break;case'update':data.updateStr=this.processUpdateActivityTypeMessage(data.changes);this.model.set('data',data);break;case'attach':var url,urlAttributes={module:'Notes',id:data.noteId,field:'filename'};if(data.mimetype&&data.mimetype.indexOf("image/")===0){url=app.api.buildFileURL(urlAttributes,{htmlJsonFormat:false,passOAuthToken:false,cleanCache:true,forceDownload:false});data.embeds=[{type:"image",src:url}];}else{url=app.api.buildFileURL(urlAttributes);}
data.url=url;this.$el.data(data);this.model.set('data',data);this.model.set('display_parent_type','Files');break;}
this.processEmbed();this.resizeVideo=_.bind(_.throttle(this.resizeVideo,500),this);$(window).on('resize.'+this.cid,this.resizeVideo);this.setTaggableRecord(this.model.get('parent_type'),this.model.get('parent_id'));},processUpdateActivityTypeMessage:function(changes){var updateTpl=Handlebars.compile(app.lang.get('TPL_ACTIVITY_UPDATE_FIELD','Activities')),parentType=this.model.get("parent_type"),fields=app.metadata.getModule(parentType).fields,self=this,updateStr;updateStr=_.reduce(changes,function(memo,changeObj){var fieldMeta=fields[changeObj.field_name],field=app.view.createField({def:fieldMeta,view:self,model:self.model,viewName:'detail'});changeObj.before=field.format(changeObj.before);changeObj.after=field.format(changeObj.after);changeObj.field_label=app.lang.get(fields[changeObj.field_name].vname,parentType);if(memo){return updateTpl(changeObj)+', '+memo;}
return updateTpl(changeObj);},'');return updateStr;},processEmbed:function(){var data=this.model.get('data');if(!_.isEmpty(data.embeds)){this.embeds=[];_.each(data.embeds,function(embed){var typeParts=embed.type.split('.'),type=typeParts.shift(),embedTpl;_.each(typeParts,function(part){type=type+part.charAt(0).toUpperCase()+part.substr(1);});embedTpl=app.template.get(this.name+'.'+type+'Embed');if(embedTpl){this.embeds.push(embedTpl(embed));}},this);}},fetchComments:function(){var self=this;this.commentsCollection.fetch({showAlerts:false,relate:true,success:function(collection){self.remaining_comments=0;self.render();}});},showAddComment:function(e){var currentTarget=this.$(e.currentTarget);currentTarget.closest('li').find('.activitystream-comment').toggle();currentTarget.closest('li').find('.activitystream-comment').find('.sayit').focus();e.preventDefault();},addComment:function(event){var self=this,parentId=this.model.id,payload={parent_id:parentId,data:{}},bean;payload.data=this.getComment();if(payload.data.value&&(payload.data.value.length>0)){bean=app.data.createRelatedBean(this.model,null,'comments');bean.save(payload,{relate:true,success:_.bind(self.addCommentCallback,self)});}},addCommentCallback:function(model){var template,data;this.$('div.reply').empty().trigger('change');this.commentsCollection.add(model);this.toggleReplyBar();template=app.template.getView('activitystream.comment');data=model.get('data');data.value=this.formatTags(data.value);data.value=this.formatLinks(data.value);this.processAvatars();this.$('.comments').prepend(template(model.attributes));if($.fn.timeago){this.$("span.relativetime").timeago({logger:SUGAR.App.logger,date:SUGAR.App.date,lang:SUGAR.App.lang,template:SUGAR.App.template});}
this.initializeAllPluginTooltips();this.context.trigger('activitystream:post:prepend',this.model);},previewRecord:function(event){var el=this.$(event.currentTarget),data=el.data(),module=data.module,id=data.id;if(module&&id){var model=app.data.createBean(module),collection=this.context.get("collection");model.set("id",id);app.events.trigger("preview:module:update",this.context.get("module"));app.events.trigger("preview:render",model,collection,true,this.cid);}
event.preventDefault();},_renderHtml:function(model){var isReplyBarOpen=this.$(".comment-btn").hasClass("active")&&this.$(".comment-btn").is(":visible"),replyVal=this.$(".reply").html();this.processAvatars();this.formatAllTagsAndLinks();app.view.View.prototype._renderHtml.call(this);this.resizeVideo();if(isReplyBarOpen){this.toggleReplyBar();this.$(".reply").html(replyVal);}},formatAllTagsAndLinks:function(){var post=this.model.get('data');this.unformatAllTagsAndLinks();if(post){this._unformattedPost=post.value;post.value=this.formatLinks(post.value);post.value=this.formatTags(post.value);}
this.commentsCollection.each(function(model){var data=model.get('data');this._unformattedComments[model.get('id')]=data.value;data.value=this.formatLinks(data.value);data.value=this.formatTags(data.value);},this);},unformatAllTagsAndLinks:function(){var post=this.model.get('data');if(post){post.value=this._unformattedPost||post.value;}
this.commentsCollection.each(function(model){var data=model.get('data');data.value=this._unformattedComments[model.get('id')]||data.value;},this);},formatLinks:function(post){var formattedPost='';if(post&&(post.length>0)){formattedPost=post.replace(this.urlRegExp,function(url){var href=url;if((url.indexOf('http://')!==0)&&(url.indexOf('https://')!==0)){href='http://'+url;}
return'<a href="'+href+'" target="_blank">'+url+'</a>';});}
return formattedPost;},resizeVideo:function(){var data=this.model.get('data'),$embed=this.$('.embed'),$iframes=$embed.find('iframe'),videoCount=0,embedWidth;if(_.isArray(data.embeds)){embedWidth=$embed.width();_.each(data.embeds,function(embed){var $iframe,iframeWidth,iframeHeight;if(((embed.type==='video')||(embed.type==='rich'))&&($iframes.length>0)){$iframe=$iframes.eq(videoCount);iframeWidth=Math.min(embedWidth,480);iframeHeight=parseInt(embed.height,10)*(iframeWidth/parseInt(embed.width,10));$iframe.prop({width:iframeWidth,height:iframeHeight});videoCount++;}});}},processAvatars:function(){var comments=this.model.get('comments'),postPictureUrl;if(this.model.get('activity_type')==='post'&&!this.model.get('picture_url')){postPictureUrl=this.getAvatarUrlForUser(this.model,'post');this.model.set('picture_url',postPictureUrl);}
if(comments){comments.each(function(comment){var commentPictureUrl=this.getAvatarUrlForUser(comment,'comment');comment.set('picture_url',commentPictureUrl);},this);}},getAvatarUrlForUser:function(model,activityType){var createdBy=model.get('created_by'),isCached,pictureUrl;isCached=this.fetchAndCacheAvatar(model,activityType);pictureUrl=isCached?app.api.buildFileURL({module:'Users',id:createdBy,field:'picture'}):'';return pictureUrl;},fetchAndCacheAvatar:function(model,activityType){var self=this,createdBy=model.get('created_by'),cached=app.cache.get(this.cacheNamePrefix+createdBy),cachedTTL=app.cache.get(this.cacheNamePrefix+createdBy+self.expiryTime),isCached=true;if((_.isUndefined(cached)||cachedTTL<$.now())){var user=app.data.createBean('Users',{id:createdBy});user.fetch({fields:["picture"],success:function(){app.cache.set(self.cacheNamePrefix+createdBy,!_.isEmpty(user.get('picture')));app.cache.set(self.cacheNamePrefix+createdBy+self.cacheNameExpire,$.now()+self.expiryTime);var pictureUrl=app.api.buildFileURL({module:'Users',id:createdBy,field:'picture'});self.$('#avatar-'+activityType+'-'+model.get('id')).html("<img src='"+pictureUrl+"' alt='"+model.get('created_by_name')+"'>");},error:function(){app.cache.set(self.cacheNamePrefix+createdBy,false);app.cache.set(self.cacheNamePrefix+createdBy+self.cacheNameExpire,$.now()+self.expiryTime);}});isCached=false;}
return isCached;},toggleReplyBar:function(){this.$(".comment-btn").toggleClass("active");this.$(".reply-area").toggleClass("hide");},getComment:function(){return this.unformatTags(this.$('div.reply'));},getPreviewData:function(){var parentModel,preview={enabled:true,label:'LBL_PREVIEW'};if(this.model.get("activity_type")==='attach'){preview.enabled=false;preview.label='LBL_PREVIEW_DISABLED_ATTACHMENT';}else if(_.isEmpty(this.model.get('display_parent_id'))||_.isEmpty(this.model.get('display_parent_type'))){preview.enabled=false;preview.label='LBL_PREVIEW_DISABLED_NO_RECORD';}else if(!app.acl.hasAccess("view",this.model.get('display_parent_type'))){preview.enabled=false;preview.label='LBL_PREVIEW_DISABLED_NO_ACCESS';}else if(this.model.get('preview_enabled')===false){preview.enabled=false;preview.label=this.model.get('preview_disabled_reason');}else{parentModel=this._getParentModel('record',this.context);if(parentModel&&parentModel.module==this.model.get('display_parent_type')&&parentModel.id===this.model.get('display_parent_id')){preview.enabled=false;preview.label='LBL_PREVIEW_DISABLED_SAME_RECORD';}}
return preview;},_getParentModel:function(layoutName,context){if(context){if(context.get('layout')===layoutName){return context.get('model');}else{return this._getParentModel(layoutName,context.parent);}}else{return null;}},checkPlaceholder:function(e){var el=e.currentTarget;if(el.textContent){el.setAttribute('data-hide-placeholder','true');}else{el.removeAttribute('data-hide-placeholder');}},bindDataChange:function(){if(this.commentsCollection){this.commentsCollection.on("add",function(){this.model.set('comment_count',this.model.get('comment_count')+1);},this);}
app.view.View.prototype.bindDataChange.call(this);},unbindData:function(){if(this.commentsCollection){this.commentsCollection.off();}
app.view.View.prototype.unbindData.call(this);},_dispose:function(){$(window).off('resize.'+this.cid);app.view.View.prototype._dispose.call(this);this.commentsCollection=null;this.opts=null;}})},"active-tasks":{"controller":({extendsFrom:'TabbedDashletView',plugins:['LinkedModel','Dashlet','Timeago'],initialize:function(options){options.meta=options.meta||{};options.meta.template='tabbed-dashlet';this._super('initialize',[options]);},_initTabs:function(){app.view.invokeParent(this,{type:'view',name:'tabbed-dashlet',method:'_initTabs',platform:'base'});var today=new Date();today.setHours(23,59,59);today.toISOString();_.each(_.pluck(_.pluck(this.tabs,'filters'),'date_due'),function(filter){_.each(filter,function(value,operator){if(value==='today'){filter[operator]=today;}});});},createRecord:function(event,params){this.createRelatedRecord(params.module,params.link);},_renderHtml:function(){if(this.meta.config){this._super('_renderHtml');return;};var tab=this.tabs[this.settings.get('activeTab')];if(tab.overdue_badge){this.overdueBadge=tab.overdue_badge;}
_.each(this.collection.models,function(model){var pictureUrl=app.api.buildFileURL({module:'Users',id:model.get('assigned_user_id'),field:'picture'});model.set('picture_url',pictureUrl);},this);this._super('_renderHtml');}})},"tutorial":{"controller":({extendsFrom:app.view.TutorialView,className:'',initialize:function(options){this.resizeCallback=_.debounce(_.bind(function(){this.highlightItem(this.index);},this),400);$(window).on('resize',this.resizeCallback);this.keyupCallback=_.bind(this.processKeyCode,this);$(document).on('keyup',this.keyupCallback);app.view.TutorialView.prototype.initialize.call(this,options);},processKeyCode:function(e){switch(e.which){case 37:this.back(e);break;case 39:this.next(e);break;case 27:this.hide(e);break;default:return;}
e.preventDefault();},remove:function(){$(window).off('resize',this.resizeCallback);$(document).off('keyup',this.keyupCallback);app.view.TutorialView.prototype.remove.call(this);}})},"interactionschart":{"controller":({plugins:['Dashlet'],events:{'click .interactions-chart':'switchChart'},legend:{},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.dataset={};this.params={list:'all',limit:0};this.legend={calls:app.lang.getAppString('LBL_CALLS'),emailsSent:app.lang.getAppString('LBL_EMAILS')+' ('+app.lang.getAppString('LBL_EMAIL_SENT')+')',emailsRecv:app.lang.getAppString('LBL_EMAILS')+' ('+app.lang.getAppString('LBL_EMAIL_RECV')+')',meetings:app.lang.getAppString('LBL_MEETINGS')};this.on("data-changed",function(){this.updateChart();},this);this.settings.on("change:filter_duration",this.changeFilter,this);},bindDataChange:function(){if(!this.meta.config){this.model.on("change",this.loadData,this);}},updateChart:function(){var self=this;nv.addGraph(function(){var canvas=self.$el.find("svg"),chart=nv.models.multiBarChart().tooltips(false).showControls(false).reduceXTicks(false).noData(app.lang.getAppString('LBL_CHART_NO_DATA')).showLegend(self.params.list=="all").stacked(true);canvas.children().remove();chart.xAxis.tickFormat(d3.format(',r'));chart.yAxis.tickFormat(d3.format(',i'));d3.select(canvas[0]).datum(self.dataset).transition().duration(500).call(chart);return chart;});},evaluateGroupResult:function(data){var self=this,users=_.chain(data).pluck('data').toArray().flatten().map(function(record){return _.pick(record,'assigned_user_id','assigned_user_name')}).uniq(function(o){return o.assigned_user_id}).sortBy(function(o){return o.assigned_user_id;}).value(),countById=_.object(_.pluck(users,'assigned_user_id'),_.map(users,function(){return 0;})),preparedData=_.chain(data).map(function(c,k){return{key:self.legend[k],type:'bar',color:self.meta.ui.colors[k],values:_.chain(c.data).countBy(function(record){return record.assigned_user_id;}).defaults(countById).map(function(count,uid){return{x:uid,y:count}}).sortBy(function(o){return o.x;}).value()};}).sortBy(function(o){return _.toArray(self.legend).indexOf(o.key);}).value(),userNames=_.map(users,function(u){return{l:u.assigned_user_name};});this.dataset={data:preparedData,properties:{labels:userNames}};},evaluatePersonalResult:function(data){var total=_.reduce(data,function(total,collection){return total+collection.count;},0),preparedData=[{type:'bar',color:this.meta.ui.colors['default'],values:[]}],labels=_.toArray(this.legend);if(total)
{_.each(this.legend,function(l,k){preparedData[0].values.push({y:parseInt(data[k].count),x:labels.indexOf(l)});});}
this.dataset={data:preparedData,properties:{labels:_.map(labels,function(label){return{l:label};})}};},loadData:function(options){var self=this,params=_.extend({"id":app.controller.context.get("model").id},this.params),url=app.api.buildURL(this.model.module,"interactions",params);var querystring=$.param(this.params);if(querystring.length>0){url+="?"+querystring;}
app.api.call("read",url,null,{success:function(data){if(self.params.list=="all"){self.evaluateGroupResult(data);}else{self.evaluatePersonalResult(data);}
self.trigger("data-changed");},complete:(options)?options.complete:null});},changeFilter:function(){this.params.filter=this.model.get("filter_duration");this.loadData();},switchChart:function(e){if(this.params.list==e.currentTarget.value)return;this.params.list=e.currentTarget.value;this.loadData();},_dispose:function(){this.model.off("change",null,this);this.on("data-changed",null,this);app.view.View.prototype._dispose.call(this);}})},"dupecheck-filter-dropdown":{"controller":({extendsFrom:'FilterFilterDropdownView',getTranslatedSelectionText:function(isAllRecords,label){if(isAllRecords){return app.lang.get('LBL_DUPECHECK_FILTER_DEFAULT',this.module);}
return this._super('getTranslatedSelectionText',[isAllRecords,label]);}})},"modal-header":{"controller":({events:{'click .close':'close'},close:function(){this.layout.hide();},setTitle:function(title){this.title=title;},setButton:function(buttons){this.buttons=buttons;}})},"filter-module-dropdown":{"controller":({tagName:"span",initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this._select2formatSelectionTemplate=app.template.get("filter-module-dropdown.selection-partial");this._select2formatResultTemplate=app.template.get("filter-module-dropdown.result-partial");this.listenTo(this.layout,"filter:change:module",this.handleChange);this.listenTo(this.layout,"filter:render:module",this._render);},_render:function(){app.view.View.prototype._render.call(this);if(this.layout.showingActivities){this.filterList=this.getModuleListForActivities();}else if(this.layout.layoutType==="record"){this.filterList=this.getModuleListForSubpanels();}else{this.$el.hide();return this;}
this._renderDropdown(this.filterList);},_renderDropdown:function(data){var self=this;this.filterNode=this.$(".related-filter");this.filterNode.select2({data:data,multiple:false,minimumResultsForSearch:7,formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-related-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},width:'off'});if(this.layout.layoutType!=="record"||this.layout.showingActivities){this.filterNode.select2("disable");}
this.filterNode.off("change");this.filterNode.on("change",function(e){var linkModule=e.val;if(self.layout.layoutType==="record"&&linkModule!=="all_modules"){linkModule=app.data.getRelatedModule(self.module,linkModule);}
self.layout.trigger("filter:change:module",linkModule,e.val);});},handleChange:function(linkModuleName,linkName,silent){if(linkName==="all_modules"){this.layout.trigger("subpanel:change");app.cache.cut("subpanels:last:"+this.module);}else if(linkName&&linkName!=='all_modules'){this.layout.trigger("filter:create:close");this.layout.trigger("subpanel:change",linkName);app.cache.set("subpanels:last:"+app.controller.context.get('module'),linkName);}
if(this.filterNode){this.filterNode.select2("val",linkName||linkModuleName);}
if(!silent){this.layout.layout.trigger("filter:change",linkModuleName,linkName);this.layout.trigger("filter:get",linkModuleName,linkName);this.layout.trigger('filter:clear:quicksearch');}},getModuleListForSubpanels:function(){var filters=[];filters.push({id:"all_modules",text:app.lang.get("LBL_TABGROUP_ALL")});var subpanels=this.pullSubpanelRelationships();subpanels=this._pruneHiddenModules(subpanels);_.each(subpanels,function(value,key){var module=app.data.getRelatedModule(this.module,value);if(app.acl.hasAccess("list",module)){filters.push({id:value,text:app.lang.get(key,this.module)});}},this);return filters;},getModuleListForActivities:function(){var filters=[],label;if(this.module=="Activities"){label=app.lang.get("LBL_TABGROUP_ALL");}else{label=app.lang.get('LBL_MODULE_NAME',this.module);}
filters.push({id:'Activities',text:label});return filters;},pullSubpanelRelationships:function(){return app.utils.getSubpanelList(this.module);},_pruneHiddenModules:function(subpanels){var hiddenSubpanels=_.map(app.metadata.getHiddenSubpanels(),function(subpanel){return subpanel.toLowerCase();});var pruned=_.reduce(subpanels,function(obj,value,key){var relatedModule=app.data.getRelatedModule(this.module,value);if(!_.contains(hiddenSubpanels,relatedModule.toLowerCase())){obj[key]=value;}
return obj;},{},this);return pruned;},initSelection:function(el,callback){var selection,label;if(el.val()==="all_modules"){label=(this.layout.layoutType==="record")?app.lang.get("LBL_TABGROUP_ALL"):app.lang.get("LBL_MODULE_NAME",this.module);selection={id:"all_modules",text:label};}else if(_.findWhere(this.filterList,{id:el.val()})){selection=_.findWhere(this.filterList,{id:el.val()});}else if(this.filterList&&this.filterList.length>0){selection=this.filterList[0];}
callback(selection);},formatSelection:function(item){var selectionLabel,safeString;safeString=Handlebars.Utils.escapeExpression(item.text);this.$('.choice-related').html(safeString);if(this.layout.layoutType!=="record"||this.layout.showingActivities){selectionLabel=app.lang.get("LBL_MODULE");}else{selectionLabel=app.lang.get("LBL_RELATED")+'<i class="icon-caret-down"></i>';}
return this._select2formatSelectionTemplate(selectionLabel);},formatResult:function(option){return this._select2formatResultTemplate(option.text);},_dispose:function(){if(!_.isEmpty(this.filterNode)){this.filterNode.select2('destroy');}
app.view.View.prototype._dispose.call(this);}})},"bubblechart":{"controller":({plugins:['Dashlet','Tooltip'],events:{'click .toggle-control':'switchChart'},filterAssigned:null,dateRange:[],dataset:{},params:{},chart:{},tooltiptemplate:{},initialize:function(options){app.view.View.prototype.initialize.call(this,options);var self=this,fields=['id','name','account_name','likely_case','base_rate','currency_id','assigned_user_name','date_closed','probability','account_id','sales_stage','commit_stage'];this.params={'fields':fields.join(','),'max_num':10,'order_by':'likely_case:desc'};this.tooltiptemplate=app.template.getView(this.name+'.tooltiptemplate');},initDashlet:function(view){this.filterAssigned=this.settings.get('filter_assigned');this.setDateRange();this.chart=nv.models.bubbleChart().x(function(d){return d3.time.format('%Y-%m-%d').parse(d.x);}).y(function(d){return d.y;}).tooltipContent(function(key,x,y,e,graph){e.point.close_date=d3.time.format('%x')(d3.time.format('%Y-%m-%d').parse(e.point.x));e.point.amount=e.point.currency_symbol+d3.format(',.2d')(e.point.base_amount);return self.tooltiptemplate(e.point).replace(/(\r\n|\n|\r)/gm,"");}).showTitle(false).tooltips(true).showLegend(true).bubbleClick(function(e){self.chart.dispatch.tooltipHide(e);app.router.navigate(app.router.buildRoute('RevenueLineItems',e.point.id),{trigger:true});}).colorData('class',{step:2}).groupBy(function(d){return(self.filterAssigned==='my')?d.sales_stage_short:d.assigned_user_name;}).filterBy(function(d){return d.probability;});this.on('data-changed',function(){this.updateChart();},this);this.settings.on('change:filter_duration',this.changeFilter,this);app.events.on('app:toggle:sidebar',function(state){if(state=='open'){this.chart.render();}},this);},updateChart:function(){if(this.meta.config){return;}
if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.render);d3.select('svg#'+this.cid).select('.nvd3').remove();}
if(this.dataset.data.length>0){this.$('.nv-chart').toggleClass('hide',false);this.$('.block-footer').toggleClass('hide',true);d3.select('svg#'+this.cid).datum(this.dataset).transition().duration(500).call(this.chart);nv.utils.windowResize(this.chart.render);nv.utils.resizeOnPrint(this.chart.render);}else{this.$('.nv-chart').toggleClass('hide',true);this.$('.block-footer').toggleClass('hide',false);}},evaluateResult:function(data){var salesStageMap={'Negotiation/Review':'Negotiat./Review','Perception Analysis':'Percept. Analysis','Proposal/Price Quote':'Proposal/Quote','Id. Decision Makers':'Id. Deciders'};this.dataset={data:data.records.map(function(d){return{id:d.id,x:d.date_closed,y:Math.round(parseInt(d.likely_case,10)/parseFloat(d.base_rate)),shape:'circle',account_name:d.account_name,assigned_user_name:d.assigned_user_name,sales_stage:d.sales_stage,sales_stage_short:salesStageMap[d.sales_stage]||d.sales_stage,probability:parseInt(d.probability,10),base_amount:parseInt(d.likely_case,10),currency_symbol:app.currency.getCurrencySymbol(d.currency_id)};}),properties:{title:app.lang.getAppString('LBL_DASHLET_TOP10_SALES_OPPORTUNITIES_NAME'),value:data.records.length}};},render:function(){app.view.invokeParent(this,{type:'view',name:'view',method:'render'});if(this.chart&&!_.isEmpty(this.dataset)){this.updateChart();}},loadData:function(options){var self=this,_filter=[{'date_closed':{'$gte':self.dateRange.begin}},{'date_closed':{'$lte':self.dateRange.end}}];if(this.filterAssigned==='my'){_filter.push({'$owner':''});}
var _local=_.extend({'filter':_filter},this.params);var url=app.api.buildURL('RevenueLineItems',null,null,_local,this.params);app.api.call('read',url,null,{success:function(data){self.evaluateResult(data);self.trigger('data-changed');},complete:options?options.complete:null});},setDateRange:function(){var now=new Date(),duration=parseInt(this.settings.get('filter_duration'),10),startMonth=Math.floor(now.getMonth()/3)*3,startDate=new Date(now.getFullYear(),(duration===12?0:startMonth+duration),1),endDate=new Date(now.getFullYear(),(duration===12?12:startDate.getMonth()+3),0);this.dateRange={'begin':app.date.format(startDate,'Y-m-d'),'end':app.date.format(endDate,'Y-m-d')};},changeFilter:function(){this.setDateRange();this.loadData();},switchChart:function(e){if(this.filterAssigned===e.currentTarget.value){return;}
this.filterAssigned=e.currentTarget.value;this.loadData();},_dispose:function(){this.on('data-changed',null,this);if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.render);nv.utils.unResizeOnPrint(this.chart.render);}
app.view.View.prototype._dispose.call(this);}})},"passwordmodal":{"controller":({extendsFrom:'BaseeditmodalView',fallbackFieldTemplate:'edit',initialize:function(options){app.view.View.prototype.initialize.call(this,options);if(this.layout){this.layout.on("app:view:password:editmodal",function(){this.model=this.context.get('model');this.render();this.$('.modal').modal('show');this.model.on("error:validation",function(){this.resetButton();},this);},this);}
this.bindDataChange();},_renderHtml:function(){this.saveButtonWasClicked=false;this.events=_.clone(this.events);_.extend(this.events,{"focusin input[name=new_password]":"verifyCurrentPassword","focusin input[name=confirm_password]":"verifyCurrentPassword"});app.view.View.prototype._renderHtml.call(this);},verifyCurrentPassword:function(){var self=this,currentPassword;currentPassword=self.$('[name=current_password]').val();if(currentPassword&&currentPassword.length&&!self.saveButtonWasClicked){app.api.verifyPassword(currentPassword,{success:function(data){if(!self.checkUpdatePassWorked(data)){app.alert.show('pass_verification_failed',{level:'error',title:app.lang.get('LBL_PASSWORD',self.module),messages:app.lang.get('ERR_PASSWORD_MISMATCH',self.module),autoClose:true});self.$('[name=current_password]').val('');self.$('[name=current_password]').focus();}else{app.alert.dismiss('pass_verification_failed');}},error:function(error){app.error.handleHttpError(error,self);self.resetButton();}});}},handleCustomValidationError:function(field,errorMsg){field=field.parents('.control-group')
field.addClass('error');field.find('.help-block').html("");field.find('.help-block').append(errorMsg);field.find('.add-on').remove();field.find('input:last').after('<span class="add-on"><i class="icon-exclamation-sign"></i></span>');},setLoading:function(){this.$('[name=save_button]').attr('data-loading-text',app.lang.get('LBL_LOADING'));this.$('[name=save_button]').button('loading');},verify:function(){var self=this,currentPassword,password,confirmPassword,confirmPasswordField,isError=false,passwordField,maxLen,currentPasswordField;self.setLoading();currentPasswordField=this.$('[name=current_password]');currentPassword=currentPasswordField.val();passwordField=this.$('[name=new_password]');password=passwordField.val();confirmPasswordField=this.$('[name=confirm_password]');confirmPassword=confirmPasswordField.val();if(!currentPassword){self.handleCustomValidationError(currentPasswordField,app.lang.get('ERR_ENTER_OLD_PASSWORD',self.module));isError=true;}
if(!password){self.handleCustomValidationError(passwordField,app.lang.get('ERR_ENTER_NEW_PASSWORD',self.module));isError=true;}
if(!confirmPassword){self.handleCustomValidationError(confirmPasswordField,app.lang.get('ERR_ENTER_CONFIRMATION_PASSWORD',self.module));isError=true;}
if(password!==confirmPassword){self.setLoading();self.handleCustomValidationError(confirmPasswordField,app.lang.get('ERR_REENTER_PASSWORDS'),self.module);isError=true;}
var passwordField=self.context.get('passwordField'),mod=app.metadata.getModule(self.module);maxLen=mod[passwordField]?parseInt(mod[passwordField].len,10):0;if(maxLen>0&&confirmPassword.length>maxLen){self.handleCustomValidationError(confirmPasswordField,app.error.getErrorString('ERROR_MAX_FIELD_LENGTH',maxLen));isError=true;}
return!isError;},saveButton:function(){if(this.verify()){this.saveModel();}else{this.resetButton();}},saveModel:function(){var self=this,oldPass=self.model.get('current_password'),newPass=self.model.get('new_password');this.saveButtonWasClicked=true;app.alert.show('passreset',{level:'process',title:app.lang.get('LBL_PASSWORD',self.module),messages:app.lang.get('LBL_PROCESSING',self.module),autoClose:false});app.api.updatePassword(oldPass,newPass,{success:function(data){app.alert.dismiss('passreset');if(self.checkUpdatePassWorked(data)){self.saveComplete();}else{app.alert.show('pass_update_failed',{level:'error',title:app.lang.get('LBL_PASSWORD',self.module),messages:app.lang.get('LBL_CANNOT_SEND_PASSWORD'),autoClose:true});self.$('.modal').modal().find('input:text, input:password').val('');self.resetButton();}},error:function(error){app.alert.dismiss('passreset');app.error.handleHttpError(error,self);self.resetButton();}});},checkUpdatePassWorked:function(data){if(!data||!data.valid){app.logger.error("Failed to update password.");return false;}
return true;},saveComplete:function(){var self=this;self.model.unset('current_password',{silent:true});self.model.unset('confirm_password',{silent:true});self.model.unset('new_password',{silent:true});self.$('.modal').modal('hide').find('form').get(0).reset();self.resetButton();app.alert.show('pass_successfully_changes',{level:'success',title:app.lang.get('LBL_PASSWORD',self.module),messages:app.lang.get('LBL_NEW_USER_PASSWORD_1',self.module),autoClose:true});}})},"activitystream-bottom":{"controller":({extendsFrom:'ListBottomView',showMoreRecords:function(evt){var self=this,options=this.context.get('collectionOptions')||{};options.add=true;options.limit=this.limit;options.success=function(){if(!self.disposed){self.render();}};this.collection.paginate(options);},bindDataChange:function(){if(this.collection){this.listenTo(this.collection,"add reset sync",function(){this.render();});}}})},"massaddtolist-progress":{"controller":({extendsFrom:'MassupdateProgressView',_labelSet:{'update':{PROGRESS_STATUS:'TPL_MASSADDTOLIST_PROGRESS_STATUS',DURATION_FORMAT:'TPL_MASSADDTOLIST_DURATION_FORMAT',FAIL_TO_ATTEMPT:'TPL_MASSADDTOLIST_FAIL_TO_ATTEMPT',WARNING_CLOSE:'TPL_MASSADDTOLIST_WARNING_CLOSE',WARNING_INCOMPLETE:'TPL_MASSADDTOLIST_WARNING_INCOMPLETE',SUCCESS:'TPL_MASSADDTOLIST_SUCCESS',TITLE:'TPL_MASSADDTOLIST_TITLE'}}})},"modal-confirm":{"controller":({events:{'click [name=close_button]':'close','click [name=ok_button]':'ok'},initialize:function(options){this.message=options.layout.confirmMessage;app.view.View.prototype.initialize.call(this,options);},close:function(evt){this.layout.context.trigger("modal:close");},ok:function(evt){this.layout.context.trigger("modal:callback");}})},"planned-activities":{"controller":({extendsFrom:'HistoryView',_initEvents:function(){this.events=_.extend(this.events,{'click [data-action=date-switcher]':'dateSwitcher'});return this;},_initTabs:function(){app.view.invokeParent(this,{type:'view',name:'tabbed-dashlet',method:'_initTabs',platform:'base'});_.each(this.tabs,function(tab){if(!tab.invitation_actions){return;}
tab.invitations=this._createInvitationsCollection(tab);},this);return this;},_createInvitationsCollection:function(tab){return app.data.createBeanCollection(tab.module,null,{link:{name:tab.module.toLowerCase(),bean:app.data.createBean('Users',{id:app.user.get('id')})}});},_getRecordsTemplate:function(module){this._recordsTpl=this._recordsTpl||{};if(!this._recordsTpl[module]){this._recordsTpl[module]=app.template.getView(this.name+'.records',module)||app.template.getView(this.name+'.records',this.module)||app.template.getView(this.name+'.records')||app.template.getView('history.records',this.module)||app.template.getView('history.records')||app.template.getView('tabbed-dashlet.records',this.module)||app.template.getView('tabbed-dashlet.records');}
return this._recordsTpl[module];},_getFilters:function(index){var todayDate=new Date(),today=app.date.format(todayDate,'Y-m-d');var tab=this.tabs[index],filter={},filters=[],defaultFilters={today:{$lte:today},future:{$gt:today}};filter[tab.filter_applied_to]=defaultFilters[this.settings.get('date')];filters.push(filter);return filters;},dateSwitcher:function(event){var date=this.$(event.currentTarget).val();if(date===this.settings.get('date')){return;}
this.settings.set('date',date);this.layout.loadData();},loadData:function(){if(this.disposed||this.meta.config){return;}
var tab=this.tabs[this.settings.get('activeTab')];if(tab.invitations){tab.invitations.dataFetched=false;}
this._super('loadData');},showMore:function(){var tab=this.tabs[this.settings.get('activeTab')];if(tab.invitations){tab.invitations.dataFetched=false;}
this._super('showMore');},_fetchInvitationActions:function(tab){this.invitationActions=tab.invitation_actions;tab.invitations.filterDef={'id':{'$in':this.collection.pluck('id')}};var self=this;tab.invitations.fetch({relate:true,success:function(collection){if(self.disposed){return;}
_.each(collection.models,function(invitation){var model=this.collection.get(invitation.get('id'));model.set('invitation',invitation);},self);self.render();},complete:function(){tab.invitations.dataFetched=true;}});},_renderHtml:function(){if(this.meta.config){app.view.View.prototype._renderHtml.call(this);return;}
var tab=this.tabs[this.settings.get('activeTab')];if(tab.overdue_badge){this.overdueBadge=tab.overdue_badge;}
if(!this.collection.length||!tab.invitations||tab.invitations.dataFetched){this._super('_renderHtml');return;}
this._fetchInvitationActions(tab);}})},"themerollerpreview":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.customTheme="default";this.context.on("change:colors",this.reloadIframeBootstrap,this);},reloadIframeBootstrap:function(){var self=this;var params={preview:new Date().getTime(),platform:app.config.platform,themeName:this.customTheme};_.extend(params,this.context.attributes.colors);var cssLink=app.api.buildURL('css/preview','',{},params);$('iframe#previewTheme').hide();self.$(".ajaxLoading").show();$.get(cssLink).success(function(data){$('iframe#previewTheme').contents().find('style').html(data);self.$(".ajaxLoading").hide();$('iframe#previewTheme').show();});$('iframe').contents().find('body').css("backgroundColor","transparent");},_renderHtml:function(){if(!app.acl.hasAccess('admin','Administration')){return;}
this._super('_renderHtml');}})},"subdetail":{"controller":({fallbackFieldTemplate:'detail',events:{'click [data-toggle=tab]':'closeSubdetail'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);},render:function(){},bindDataChange:function(){if(this.model){this.model.on("change",function(){this._render();},this);}},closeSubdetail:function(){this.model.clear();$('.nav-tabs').find('li').removeClass('on');this.$el.empty();}})},"audit-headerpane":{"controller":({events:{'click a[name=close_button]':'close'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.title=app.lang.get(this.meta.title,this.module);},close:function(){app.drawer.close();}})},"raw":{"controller":({className:'raw-view'})},"baseeditmodal":{"controller":({events:{'click [name=save_button]':'saveButton','click [name=cancel_button]':'cancelButton'},saveButton:function(){var self=this,createModel=this.context.get('createModel');self.$('[name=save_button]').attr('data-loading-text',app.lang.get('LBL_LOADING'));self.$('[name=save_button]').button('loading');createModel.set('portal_flag',true);createModel.save(null,{relate:true,fieldsToValidate:this.getFields(this.module),success:function(){var view=_.extend({},self,{model:createModel});app.file.checkFileFieldsAndProcessUpload(view,{success:function(){self.saveComplete();}});},error:function(){self.resetButton();}});},cancelButton:function(){this.$('.modal').modal('hide').find('form').get(0).reset();if(this.context.has('createModel')){this.context.get('createModel').clear();}},saveComplete:function(){this.$('.modal').modal('hide').find('form').get(0).reset();this.resetButton();this.collection.fetch({relate:true});},resetButton:function(){this.$('[name=save_button]').button('reset');}})},"subnav":{"controller":({events:{'click [name=save_button]':'save','click [name=cancel_button]':'cancel','click [name=edit_button]':'edit'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.context.set('subnavModel',new Backbone.Model());this.subnavModel=this.context.get('subnavModel');$(window).on("resize.subnav",_.bind(this.resize,this));if(this.meta&&this.meta.label){this.title=app.lang.get(this.meta.label,this.context.module);}
this.context.on("subnav:set:title",function(title){this.title=title;this.render();},this);},_render:function(){var next,newMarginTop;app.view.View.prototype._render.call(this);next=this.$el.next();newMarginTop=parseInt(next.css('margin-top'),10)+this.$el.find('.subnav').height();next.css('margin-top',newMarginTop+'px');},save:function(){this.context.trigger("subnav:save");},cancel:function(){window.history.back();},edit:function(){app.navigate(this.context,this.model,"edit",{trigger:true});},bindDataChange:function(){var self=this;if(this.meta.field){this.model.on("change:"+this.meta.field,function(){self.title=self.model.get(this.meta.field);self.render();},this);}},_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);this.resize();},resize:function(){var self=this;if(self.resizeDetectTimer){clearTimeout(this.resizeDetectTimer);}
self.resizeDetectTimer=setTimeout(function(){var $el=self.$('h1');if($el[0].offsetWidth<$el[0].scrollWidth){$el.attr({'data-original-title':$el.text(),'rel':'tooltip'}).tooltip({placement:"bottom"});}
else{$el.removeAttr('data-original-title rel');}},250);},_dispose:function(){$(window).off("resize.subnav");app.view.View.prototype._dispose.call(this);}})},"dupecheck-list":{"controller":({extendsFrom:'FlexListView',plugins:['ListColumnEllipsis','ListDisableSort','ListRemoveLinks'],collectionSync:null,displayFirstNColumns:4,additionalTableClasses:null,initialize:function(options){var dupeListMeta=app.metadata.getView(options.module,'dupecheck-list')||{};options.meta=_.extend({},dupeListMeta,options.meta||{});this._super('initialize',[options]);this.context.on('dupecheck:fetch:fire',this.fetchDuplicates,this);},bindDataChange:function(){this.collection.on('reset',function(){this.context.trigger('dupecheck:collection:reset');},this);this._super('bindDataChange');},_renderHtml:function(){var classesToAdd='duplicates highlight';app.view.invokeParent(this,{type:'view',name:'flex-list',method:'_renderHtml'});if(this.additionalTableClasses){classesToAdd=classesToAdd+' '+this.additionalTableClasses;}
this.$('table.table-striped').addClass(classesToAdd);},fetchDuplicates:function(model,options){this.collection.dupeCheckModel=model;this.collection.fetch(options);}})},"preview":{"controller":({plugins:['ToggleMoreLess'],fallbackFieldTemplate:'detail',switching:false,hiddenPanelExists:false,initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.action='detail';app.events.on("preview:render",this._renderPreview,this);app.events.on("preview:collection:change",this.updateCollection,this);app.events.on("preview:close",this.closePreview,this);app.events.on("preview:module:update",this.updatePreviewModule,this);if(this.layout){this.layout.on("preview:pagination:fire",this.switchPreview,this);}
this.collection=app.data.createBeanCollection(this.module);},updateCollection:function(collection){if(this.collection){this.collection.reset(collection.models);this.showPreviousNextBtnGroup();}},updatePreviewModule:function(module){this.previewModule=module;},filterCollection:function(){this.collection.remove(_.filter(this.collection.models,function(model){return!app.acl.hasAccessToModel("view",model);},this),{silent:true});},_renderHtml:function(){this.showPreviousNextBtnGroup();app.view.View.prototype._renderHtml.call(this);},showPreviousNextBtnGroup:function(){if(!this.model||!this.layout||!this.collection){return;}
var collection=this.collection;if(!collection.size()){this.layout.hideNextPrevious=true;}
var recordIndex=collection.indexOf(collection.get(this.model.id));this.layout.previous=collection.models[recordIndex-1]?collection.models[recordIndex-1]:undefined;this.layout.next=collection.models[recordIndex+1]?collection.models[recordIndex+1]:undefined;this.layout.hideNextPrevious=_.isUndefined(this.layout.previous)&&_.isUndefined(this.layout.next);this.layout.trigger("preview:pagination:update");},_renderPreview:function(model,collection,fetch,previewId){var self=this;if(app.drawer&&!app.drawer.isActive(this.$el)){return;}
if(this.model&&model&&(this.model.get("id")==model.get("id")&&previewId==this.previewId)){app.events.trigger("list:preview:decorate",false);app.events.trigger('preview:close');return;}
if(app.metadata.getModule(model.module).isBwcEnabled){app.events.trigger('preview:close');app.alert.show('preview_bwc_error',{level:'error',messages:app.lang.getAppString('LBL_PREVIEW_BWC_ERROR'),autoClose:true});return;}
if(model){this.meta=_.extend({},app.metadata.getView(model.module,'record'),app.metadata.getView(model.module,'preview'));this.meta=this._previewifyMetadata(this.meta);}
if(fetch){model.fetch({showAlerts:true,success:function(model){self.renderPreview(model,collection);},fields:this.getFieldNames(model.module)});}else{this.renderPreview(model,collection);}
this.previewId=previewId;},bindUpdates:function(sourceModel){if(this.sourceModel){this.stopListening(this.sourceModel);}
this.sourceModel=sourceModel;this.listenTo(this.sourceModel,'sync',function(model){if(!this.model){return;}
this.model=model;this.renderPreview(this.model);},this);this.listenTo(this.sourceModel,'change',function(){if(!this.model){return;}
this.model.set(this.sourceModel.attributes);},this);this.listenTo(this.sourceModel,'destroy',function(model){if(model&&this.model&&(this.model.get("id")==model.get("id"))){app.events.trigger("list:preview:decorate",false);app.events.trigger('preview:close');return;}},this);},renderPreview:function(model,newCollection){if(newCollection){this.collection.reset(newCollection.models);}
if(model){this.bindUpdates(model);this.model=app.data.createBean(model.module,model.toJSON());this.listenTo(this.model,'change',function(){this.sourceModel.set(this.model.attributes);},this);this.render();if(this.previewModule&&this.previewModule==="Activities"){this.layout.hideNextPrevious=true;this.layout.trigger("preview:pagination:update");}
app.events.trigger("preview:open",this);app.events.trigger("list:preview:decorate",this.model,this);if(!this.$el.is(":visible")){this.context.trigger("openSidebar",this);}}},_previewifyMetadata:function(meta){this.hiddenPanelExists=false;_.each(meta.panels,function(panel){if(panel.header){panel.header=false;panel.fields=_.filter(panel.fields,function(field){return field.type!='favorite'&&field.type!='follow';});}
if(!this.hiddenPanelExists&&panel.hide){this.hiddenPanelExists=true;}},this);return meta;},switchPreview:function(data,index,id,module){var self=this,currID=id||this.model.get("id"),currIndex=index||_.indexOf(this.collection.models,this.collection.get(currID));if(this.switching||this.collection.models.length<2){return;}
this.switching=true;if(data.direction==="left"&&(currID===_.first(this.collection.models).get("id"))||data.direction==="right"&&(currID===_.last(this.collection.models).get("id"))){this.switching=false;return;}else{data.direction==="left"?currIndex-=1:currIndex+=1;var currModule=module||this.collection.models[currIndex].module;var moduleMeta=app.metadata.getModule(currModule);this.model=app.data.createBean(currModule);this.bindUpdates(this.collection.models[currIndex]);this.model.set("id",this.collection.models[currIndex].get("id"));this.model.fetch({showAlerts:true,success:function(model){model.module=currModule;self.model=null;app.events.trigger("preview:render",model,null,false);self.switching=false;}});}},closePreview:function(){if(_.isUndefined(app.drawer)||app.drawer.isActive(this.$el)){this.switching=false;delete this.model;this.collection.reset();this.$el.empty();}},bindDataChange:function(){if(this.collection){this.collection.on("reset",this.filterCollection,this);this.collection.on("remove",function(model){if(model&&this.model&&(this.model.get("id")==model.get("id"))){app.events.trigger("list:preview:decorate",false);app.events.trigger('preview:close');}},this);}}})},"convert-results":{"controller":({associatedModels:null,events:{'click .preview-list-item':'previewRecord'},plugins:['Tooltip'],initialize:function(options){app.view.View.prototype.initialize.call(this,options);app.events.on("list:preview:decorate",this.decorateRow,this);this.associatedModels=app.data.createMixedBeanCollection();},bindDataChange:function(){this.model.on("change",this.populateResults,this);},populateResults:function(){this.associatedModels.reset();app.view.View.prototype.render.call(this);},previewRecord:function(e){var $el=this.$(e.currentTarget),data=$el.data(),model=app.data.createBean(data.module,{id:data.id});model.fetch({showAlerts:true,success:_.bind(function(model){model.module=data.module;app.events.trigger("preview:render",model,this.associatedModels);},this)});},decorateRow:function(model){this.$("tr.highlighted").removeClass("highlighted current above below");if(model){var rowName=model.module+"_"+model.get("id");var curr=this.$("tr[name='"+rowName+"']");curr.addClass("current highlighted");curr.prev("tr").addClass("highlighted above");curr.next("tr").addClass("highlighted below");}}})},"casessummary":{"controller":({plugins:['Dashlet'],className:'cases-summary-wrapper',chart:{},total:0,initialize:function(o){app.view.View.prototype.initialize.call(this,o);},_render:function(){app.view.View.prototype._render.call(this);if(this.viewName==="config"||this.total===0){return;}
this.chart=nv.models.pieChart().x(function(d){return d.key;}).y(function(d){return d.value;}).margin({top:10,right:10,bottom:15,left:10}).donut(true).donutLabelsOutside(true).donutRatio(0.4).hole(self.totalCases).showTitle(false).showLegend(false).colorData('class').tooltipContent(function(key,x,y,e,graph){return'<p><b>'+key+' '+parseInt(y,10)+'</b></p>';});d3.select('svg#'+this.cid).datum(this.chartData).transition().duration(500).call(this.chart);app.events.on('app:toggle:sidebar',function(state){if(state=='open'){this.chart.update();}},this);nv.utils.windowResize(this.chart.update);nv.utils.resizeOnPrint(this.chart.update);},evaluateResult:function(data){this.chartCollection=data;this.closedCases=this.chartCollection.where({status:'Closed'});this.closedCases=this.closedCases.concat(this.chartCollection.where({status:'Rejected'}));this.closedCases=this.closedCases.concat(this.chartCollection.where({status:'Duplicate'}));this.openCases=this.chartCollection.models.length-this.closedCases.length;this.chartData={'data':[]};this.chartData.data.push({key:'Closed Cases',class:'nv-fill-green',value:this.closedCases.length});this.chartData.data.push({key:'Open Cases',class:'nv-fill-red',value:this.openCases});this.total=this.openCases+this.closedCases.length;},loadData:function(options){var self=this,oppID=this.model.get('account_id'),accountBean;if(oppID){accountBean=app.data.createBean('Accounts',{id:oppID});}
var relatedCollection=app.data.createRelatedCollection(accountBean||this.model,'cases');relatedCollection.fetch({relate:true,success:function(resultCollection){self.evaluateResult(resultCollection);self.processCases();self.render();self.addFavs();},complete:options?options.complete:null});},addFavs:function(){var self=this;this.favFields=[];_.each(this.tabData,function(tabGroup){if(tabGroup.models&&tabGroup.models.length>0){_.each(tabGroup.models,function(model){var field=app.view.createField({def:{type:"favorite"},model:model,meta:{view:"detail"},viewName:"detail",view:self});field.setElement(self.$('.favTarget.[data-model-id="'+model.id+'"]'));field.render();self.favFields.push(field);});}});},processCases:function(){var status2css={'Rejected':'label-success','Closed':'label-success','Duplicate':'label-success'};if(!this.chartCollection||this.chartCollection.models.length===0)return;this.tabData=[];var stati=_.uniq(this.chartCollection.pluck('status'));_.each(stati,function(status,index){if(!status2css[status]){this.tabData.push({index:index,status:status,models:this.chartCollection.where({'status':status}),cssClass:status2css[status]?status2css[status]:'label-important'});}},this);this.tabClass=['one','two','three','four','five'][this.tabData.length]||'four';},_dispose:function(){this.favFields=null;this.model.off("change",this.loadData,this);if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.update);nv.utils.unResizeOnPrint(this.chart.update);}
app.view.View.prototype._dispose.call(this);}})},"language-actions":{"controller":({events:{'click #languageList .dropdown-menu a':'setLanguage'},tagName:"span",initialize:function(options){app.events.on("app:sync:complete",this.render,this);app.events.on("app:login:success",this.render,this);app.events.on("app:logout",this.render,this);app.view.View.prototype.initialize.call(this,options);var languages=app.lang.getAppListStrings('available_language_dom');this.languageList=[];for(var languageKey in languages){if(languageKey!=="")
this.languageList.push({key:languageKey,value:languages[languageKey]})}},_renderHtml:function(){this.isAuthenticated=app.api.isAuthenticated();this.currentLang=app.lang.getLanguage()||"en_us";app.view.View.prototype._renderHtml.call(this);this.$('[data-toggle="dropdown"]').dropdown();},setLanguage:function(e){var $li=this.$(e.currentTarget),langKey=$li.data("lang-key");app.alert.show('language',{level:'warning',title:app.lang.getAppString('LBL_LOADING_LANGUAGE'),autoclose:false});app.lang.setLanguage(langKey,function(){app.alert.dismiss('language');});}})},"similar-opportunities":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.collections={};},loadData:function(){var self=this,url=app.api.buildURL(this.module,"similar",{"id":app.controller.context.get("model").id});app.api.call("read",url,null,{success:function(data){_.each(data,function(key,value){data[value]["picture_url"]=data[value]["picture"]?app.api.buildFileURL({module:"Users",id:data[value]["assigned_user_id"],field:"picture"}):"../styleguide/assets/img/profile.png";data[value]['amount']=app.currency.formatAmountLocale(data[value]['amount'],data[value]['currency_id']);});self.collections=data;self.render();}});},bindDataChange:function(){this.model.on("change",this.loadData,this);}})},"filter-quicksearch":{"controller":({events:{'keyup':'throttledSearch','paste':'throttledSearch'},plugins:['QuickSearchFilter'],tagName:'input',className:'search-name',attributes:{'type':'text'},initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this.listenTo(this.layout,'filter:clear:quicksearch',this.clearInput);this.listenTo(this.layout,'filter:change:module',this.updatePlaceholder);},throttledSearch:_.debounce(function(e){var newSearch=this.$el.val();if(this.currentSearch!==newSearch){this.currentSearch=newSearch;this.layout.trigger('filter:apply',newSearch);}},400),getFieldLabels:function(moduleName,fields){var moduleMeta=app.metadata.getModule(moduleName);var labels=[];_.each(fields,function(fieldName){var fieldMeta=moduleMeta.fields[fieldName];labels.push(app.lang.get(fieldMeta.vname,moduleName).toLowerCase());});return labels;},updatePlaceholder:function(linkModuleName,linkModule){var label;this.toggleInput();if(!this.$el.hasClass('hide')&&linkModule!=='all_modules'){var fields=this.getModuleQuickSearchFields(linkModuleName),fieldLabels=this.getFieldLabels(linkModuleName,fields);label=app.lang.get('LBL_SEARCH_BY')+' '+fieldLabels.join(', ')+'...';}else{label=app.lang.get('LBL_BASIC_QUICK_SEARCH');}
this.$el.attr('placeholder',label);},toggleInput:function(){this.$el.toggleClass('hide',!!this.layout.showingActivities);},clearInput:function(){this.toggleInput();this.$el.val('');this.currentSearch='';this.layout.trigger('filter:apply');}})},"agenda":{"controller":({events:{'mouseenter tr':'showActions','mouseleave tr':'hideActions'},initialize:function(options){this.collections={today:app.data.createBeanCollection('Meetings',[]),tomorrow:app.data.createBeanCollection('Meetings',[]),upcoming:app.data.createBeanCollection('Meetings',[])};_.each(this.collections,function(collection){collection.on("change",this.render,this);},this);app.view.View.prototype.initialize.call(this,options);this.loadData();},loadData:function(){var self=this;app.api.call('read',app.api.buildURL('Meetings/Agenda'),null,{success:function(data){var models={'today':[],'tomorrow':[],'upcoming':[]};for(var modelType in models){for(var i=0;i<data[modelType].length;i++){models[modelType][models[modelType].length]=app.data.createBean('Meetings',data[modelType][i]);}
self.collections[modelType].add(models[modelType]);}
self.render();}});},showActions:function(e){this.$(e.currentTarget).children("td").children("span").children(".btn-group").show();},hideActions:function(e){this.$(e.currentTarget).children("td").children("span").children(".btn-group").hide();},unbindData:function(){_.each(this.collections,function(collection){collection.off();});app.view.View.prototype.unbindData.call(this);}})},"saved-reports-chart":{"controller":({plugins:['Dashlet'],reportData:undefined,chartField:undefined,reportOptions:undefined,timerId:undefined,initDashlet:function(view){if(this.meta.config){this.meta.panels=this.dashletConfig.dashlet_config_panels;this.getAllSavedReports();}else{var autoRefresh=+this.settings.get("auto_refresh");if(autoRefresh){if(this.timerId){clearInterval(this.timerId);}
this.timerId=setInterval(_.bind(function(){this.context.resetLoadFlag();this.loadData();},this),autoRefresh*1000*60);}}},initialize:function(options){this.reportData=new Backbone.Model();app.view.View.prototype.initialize.call(this,options);},bindDataChange:function(){if(this.meta.config){this.settings.on('change:saved_report_id',function(model){var reportTitle=this.reportOptions[model.get('saved_report_id')];this.settings.set({label:reportTitle});$('[name="label"]').val(reportTitle)},this);}},loadData:function(options){options=options||{};this.getSavedReportById(this.settings.get('saved_report_id'),options);},getAllSavedReports:function(){var params={has_charts:true},url=app.api.buildURL('Reports/saved_reports',null,null,params);app.api.call('read',url,null,{success:_.bind(this.parseAllSavedReports,this)});},parseAllSavedReports:function(reports){this.reportOptions={};_.each(reports,function(report){this.reportOptions[report.id]=report.name;},this);var reportsField=_.find(this.fields,function(field){return field.name=='saved_report_id';});if(reportsField){reportsField.items=this.reportOptions;reportsField._render();}},getSavedReportById:function(reportId,options){var dt=this.layout.getComponent('dashlet-toolbar');if(dt){this.$("[data-action=loading]").removeClass(dt.cssIconDefault).addClass(dt.cssIconRefresh);}
app.api.call('create',app.api.buildURL('Reports/chart/'+reportId),null,{success:_.bind(function(serverData){this.reportData.set({rawChartData:serverData.chartData});},this),complete:options?options.complete:null});},_render:function(){if(this.meta.config||_.isUndefined(this.chartField)){app.view.View.prototype._render.call(this);}},_renderField:function(field){app.view.View.prototype._renderField.call(this,field);if(_.isUndefined(this.chartField)&&field.name=='chart'){this.chartField=field;}}})},"activitystream-omnibar":{"controller":({events:{'click .addPost':'addPost','keyup .sayit':'_handleContentChange','change div[data-placeholder]':'_handleContentChange','input div[data-placeholder]':'_handleContentChange'},className:"omnibar",plugins:['DragdropAttachments','QuickSearchFilter','Taggable','Tooltip'],initialize:function(options){this.nbspRegExp=new RegExp(String.fromCharCode(160),'g');app.view.View.prototype.initialize.call(this,options);this.user_id=app.user.get('id');this.full_name=app.user.get('full_name');this.picture_url=app.user.get('picture')?app.api.buildFileURL({module:'Users',id:this.user_id,field:'picture'}):'';this.toggleSubmitButton=_.debounce(this.toggleSubmitButton,200);this.on('attachments:add attachments:remove',this.toggleSubmitButton,this);},bindDataChange:function(){if(this.context.parent){this.context.parent.on('change',function(context){var moduleName=context.get('module'),modelId=context.get('model').get('id');this.setTaggableRecord(moduleName,modelId);},this);}
app.view.View.prototype.bindDataChange.call(this);},unbindData:function(){if(this.context.parent){this.context.parent.off(null,null,this);}
app.view.View.prototype.unbindData.call(this);},addPost:function(){var self=this,parentId=this.context.parent.get("model").id,parentType=this.context.parent.get("model").module,attachments=this.$('.activitystream-pending-attachment'),$submitButton=this.$('button.addPost'),payload={activity_type:"post",parent_id:parentId||null,parent_type:parentType!=="Activities"?parentType:null,data:{}},bean;if(!$submitButton.hasClass('disabled')){payload.data=this.getPost();if(payload.data.value&&(payload.data.value.length>0)){$submitButton.addClass('disabled');bean=app.data.createBean('Activities');bean.save(payload,{success:function(model){self.$('div.sayit').empty().trigger('change').focus();model.set('picture',app.user.get('picture'));self.collection.add(model);self.context.trigger('activitystream:post:prepend',model);},complete:function(){$submitButton.removeClass('disabled');},showAlerts:true});}
this.trigger("attachments:process");}},getPost:function(){var post=this.unformatTags(this.$('div.sayit'));post.value=post.value.replace(this.nbspRegExp,' ');return post;},toggleSubmitButton:function(){var post=this.getPost(),attachments=this.getAttachments();if((post.value.length===0)&&(_.size(attachments)===0)){this.$('.addPost').addClass('disabled');}else{this.$('.addPost').removeClass('disabled');}},_handleContentChange:function(e){var el=e.currentTarget;if(el.textContent){el.setAttribute('data-hide-placeholder','true');}else{el.removeAttribute('data-hide-placeholder');}
this.toggleSubmitButton();}})},"leaderboard":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.results=[];this.guid=_.uniqueId("leaderboard");this.loadData();},_render:function(){var self=this;$("#"+this.guid+" svg").css("width",$("#"+this.guid).width());$("#"+this.guid+" svg").css("min-height","300px");},loadData:function(){var self=this,url=app.api.buildURL('CustomReport/OpportunityLeaderboard');app.api.call('GET',url,null,{success:function(o){self.results={properties:{title:'Opportunity Leaderboard'},data:[]};for(i=0;i<o.length;i++){self.results.data.push({key:o[i]['user_name'],value:parseInt(o[i]['amount'],10)});}
app.view.View.prototype._render.call(self);nv.addGraph(function(){var chart=nv.models.pieChart().x(function(d){return d.label;}).y(function(d){return d.value;});d3.select("#"+self.guid+" svg").datum(self.results).transition().duration(1200).call(chart);return chart;});}});}})},"dashlet-row-empty":{"controller":({events:{'click .add-dashlet':'layoutClicked','click .add-row.empty':'addClicked'},originalTemplate:null,columnOptions:[],initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.model=this.layout.context.get("model");this.model.on("setMode",this.setMode,this);this.originalTemplate=this.template;this.setMode(this.model.mode);this.columnOptions=[];_.times(this.model.maxRowColumns,function(index){var n=index+1;this.columnOptions.push({index:n,label:(n>1)?app.lang.get('LBL_DASHBOARD_ADD_'+n+'_COLUMNS',this.module):app.lang.get('LBL_DASHBOARD_ADD_'+n+'_COLUMN',this.module)});},this);},addClicked:function(evt){var self=this;this._addRowTimer=setTimeout(function(){self.addRow(1);},100);},layoutClicked:function(evt){var columns=$(evt.currentTarget).data('value');var addRow=_.bind(this.addRow,this);_.delay(addRow,0,columns);},addRow:function(columns){this.layout.addRow(columns);if(this._addRowTimer){clearTimeout(this._addRowTimer);}},setMode:function(model){if(model==='edit'){this.template=this.originalTemplate;}else{this.template=app.template.empty;}
this.render();},_dispose:function(){this.model.off("setMode",null,this);app.view.View.prototype._dispose.call(this);}})},"error":{"controller":({className:'error-page',initialize:function(options){app.metadata.set(this._metadata);app.data.declareModels();app.controller.context.prepare(true);this.options.meta=this._metadata.modules[this.options.module].views[this.options.name].meta;app.view.View.prototype.initialize.call(this,options);},_render:function(){if(this.context.get('errorType')){var attributes=this.getErrorAttributes();this.model.set(attributes);}
app.view.View.prototype._render.call(this);},getErrorAttributes:function(){var attributes={};if(this.context.get('errorType')==='404'){attributes={title:'ERR_HTTP_404_TITLE',type:'ERR_HTTP_404_TYPE',message:'ERR_HTTP_404_TEXT'};}else if(this.context.get('errorType')==='500'){attributes={title:'ERR_HTTP_500_TITLE',type:'ERR_HTTP_500_TYPE',message:'ERR_HTTP_500_TEXT'};}else{var error=this.context.get('error')||{};var title=null;if(error.status&&error.errorThrown){title='HTTP: '+error.status+' '+error.errorThrown;}
attributes={title:title||'ERR_HTTP_DEFAULT_TITLE',type:error.status||'ERR_HTTP_DEFAULT_TYPE',message:error.message||'ERR_HTTP_DEFAULT_TEXT'};}
return attributes;},_metadata:{"modules":{"Error":{"views":{"error":{"meta":{}}},"layouts":{"error":{"meta":{"type":"simple","components":[{view:"error"}]}}}}}}})},"profileactions":{"controller":({plugins:['Dropdown','Tooltip'],initialize:function(options){app.view.View.prototype.initialize.call(this,options);app.events.on("app:sync:complete",this.setCurrentUserData,this);app.user.on("change:picture",this.setCurrentUserData,this);app.user.on("change:full_name",this.setCurrentUserData,this);},_renderHtml:function(){if(!app.router||!app.api.isAuthenticated()||app.config.appStatus==='offline'){return;}
this.showAdmin=app.acl.hasAccess('admin','Administration')||app.acl.hasAccessToAny('admin')||app.acl.hasAccessToAny('developer');app.view.View.prototype._renderHtml.call(this);},setCurrentUserData:function(){this.fullName=app.user.get("full_name");this.userName=app.user.get("user_name");this.userId=app.user.get('id');var picture=app.user.get("picture");this.pictureUrl=picture?app.api.buildFileURL({module:"Users",id:app.user.get("id"),field:"picture"}):'';this.render();},_dispose:function(){if(app.user)app.user.off(null,null,this);app.view.Component.prototype._dispose.call(this);}})},"merge-duplicates-progress":{"controller":({extendsFrom:'MassupdateProgressView',plugins:['editable'],_labelSet:{TITLE:'LBL_MERGE_DUPLICATES_TITLE',PROGRESS_STATUS:'TPL_MERGE_DUPLICATES_PROGRESS_STATUS',FAIL_TO_ATTEMPT:'TPL_MERGE_DUPLICATES_FAIL_TO_ATTEMPT',FAIL:'TPL_MERGE_DUPLICATES_FAIL'},processedCount:0,failsCount:0,initLabels:function(){this.LABELSET=this._labelSet;},reset:function(){this.processedCount=0;this.failsCount=0;this.totalRecord=0;},checkAvailable:function(){return true;},getEstimate:function(){return 0;},setTotalRecords:function(total){this.totalRecord=total;},getTotalRecords:function(){return this.totalRecord;},getRemainder:function(){return'';},setProgressSize:function(count){this.processedCount;},incrementProgressSize:function(){this.processedCount=this.processedCount+1;},getProgressSize:function(){return this.processedCount;},checkError:function(context){if(_.isUndefined(context)||_.isUndefined(context.attempt)){return;}
if(context.attempt===0||context.attempt>(context.maxAllowAttempt||3)){return;}
app.alert.dismiss('check_error_message');app.alert.show('check_error_message',{level:'warning',messages:app.lang.get(this.LABELSET['FAIL_TO_ATTEMPT'],this.module,{objectName:context.objectName||'',num:context.attempt,total:(context.maxAllowAttempt||3)}),autoClose:true,autoCloseDelay:8000});},_onDrawerReset:function(){this.showProgress();return false;},showProgress:function(){app.drawer.before('reset',this._onDrawerReset,this,true);this._super('showProgress');},pauseProgress:function(){var stopButton=this.getField('btn-stop');if(stopButton){stopButton.setDisabled(true);}
this.$holders.bar.removeClass('active');this.model.trigger('massupdate:pause:completed');},resumeProgress:function(){var stopButton=this.getField('btn-stop');if(stopButton){stopButton.setDisabled(false);}
this.model.trigger('massupdate:resume:completed');},stopProgress:function(){this.model.trigger('massupdate:stop:completed');},hideProgress:function(){app.drawer.offBefore('reset',this._onDrawerReset,this);this.hide();app.alert.dismiss('stop_confirmation');app.alert.dismiss('check_error_message');this.model.trigger('massupdate:end:completed');},onItemProcessed:function(){this.incrementProgressSize();this.updateProgress();this.model.trigger('massupdate:item:processed:completed');},onNextAttept:function(context){this.checkError(context);this.model.trigger('massupdate:item:attempt:completed');},onItemFail:function(context){this.failsCount=this.failsCount+1;this.$holders.bar.removeClass('progress-info').addClass('progress-danger');app.alert.dismiss('fail_message');app.alert.show('fail_message',{level:'error',messages:app.lang.get(this.LABELSET['FAIL'],this.module,{objectName:context.objectName||''}),autoClose:true,autoCloseDelay:8000});this.model.trigger('massupdate:item:fail:completed');},bindDataChange:function(){if(!this.model){return;}
this.on('render',this.initHolders,this);this.before('start',this.checkAvailable,this,true);this.model.on('massupdate:always',this.updateProgress,this);this.model.on('massupdate:start',this.showProgress,this);this.model.on('massupdate:end',this.hideProgress,this);this.model.on('massupdate:fail',this.checkError,this);this.model.on('massupdate:resume',this.resumeProgress,this);this.model.on('massupdate:pause',this.pauseProgress,this);this.model.on('massupdate:stop',this.stopProgress,this);this.model.on('massupdate:item:processed',this.onItemProcessed,this);this.model.on('massupdate:item:attempt',this.onNextAttept,this);this.model.on('massupdate:item:fail',this.onItemFail,this);}})},"influencers":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.collections={};},loadData:function(){var self=this,url=app.api.buildURL(this.module,"influencers",{"id":app.controller.context.get("model").id});app.api.call("read",url,null,{success:function(data){_.each(data,function(key,value){data[value]["picture_url"]=data[value]["picture"]?app.api.buildFileURL({module:"Users",id:data[value]["id"],field:"picture"}):"../styleguide/assets/img/profile.png";});self.collections=data;self.render();}});}})},"audit-footer":{"controller":({initialize:function(options){this._super('initialize',[options]);if(this.context.parent){var baseModule=this.context.parent.get('module');this.auditedFields=this._getAuditedFields(baseModule);}},_getAuditedFields:function(baseModule){return _.chain(app.metadata.getModule(baseModule,'fields')).filter(function(o){return o.audited;}).map(function(o){return app.lang.get(o.vname,baseModule);}).value();}})},"vcard-import-headerpane":{"controller":({extendsFrom:'HeaderpaneView',events:{'click [name=vcard_finish_button]':'initiateFinish','click [name=vcard_cancel_button]':'initiateCancel'},initiateFinish:function(){this.context.trigger('vcard:import:finish');},initiateCancel:function(){app.drawer.close();}})},"subpanel-list":{"controller":({extendsFrom:'RecordlistView',fallbackFieldTemplate:'list',plugins:['ErrorDecoration','Editable'],contextEvents:{"list:editall:fire":"toggleEdit","list:editrow:fire":"editClicked","list:unlinkrow:fire":"warnUnlink"},initialize:function(options){app.view.invokeParent(this,{type:'view',name:'recordlist',method:'initialize',args:[options]});if(app.config.maxSubpanelResult){var options={limit:app.config.maxSubpanelResult};var collectionOptions=this.context.has('collectionOptions')?this.context.get('collectionOptions'):{};this.context.set('collectionOptions',_.extend(collectionOptions,options));}
this.layout.on("hide",this.toggleList,this);this.listenTo(this.layout.layout,'filter:change',this.renderOnFilterChanged);app.routing.before("route",this.beforeRouteUnlink,this,true);$(window).on("beforeunload.unlink"+this.cid,_.bind(this.warnUnlinkOnRefresh,this));},renderOnFilterChanged:function(){this.collection.trigger('reset');this.render();},_initializeMetadata:function(){return _.extend({},app.metadata.getView(null,'subpanel-list',true),app.metadata.getView(this.options.module,'record-list',true),app.metadata.getView(this.options.module,'subpanel-list',true));},unlinkModel:function(){var self=this,model=this._modelToUnlink;model.destroy({showAlerts:{'process':true,'success':{messages:self.getUnlinkMessages(self._modelToUnlink).success}},relate:true,success:function(){var redirect=self._targetUrl!==self._currentUrl;self._modelToUnlink=null;self.collection.remove(model,{silent:redirect});if(redirect){self.unbindBeforeRouteUnlink();app.router.navigate(self._targetUrl,{trigger:true});return;}
self.collection.trigger('reset');self.render();}});},toggleList:function(show){this.$el[show?'show':'hide']();},beforeRouteUnlink:function(){if(this._modelToUnlink){this.warnUnlink(this._modelToUnlink);return false;}
return true;},getUnlinkMessages:function(model){var messages={},name=model.get('name')||(model.get('first_name')+' '+model.get('last_name'))||'',context=app.lang.get('LBL_MODULE_NAME_SINGULAR',model.module).toLowerCase()+' '+name.trim();messages.confirmation=app.lang.get('NTC_UNLINK_CONFIRMATION')+context+'?';messages.success=app.lang.get('NTC_UNLINK_SUCCESS')+context+'.';return messages;},warnUnlink:function(model){var self=this;this._modelToUnlink=model;self._targetUrl=Backbone.history.getFragment();if(self._targetUrl!==self._currentUrl){app.router.navigate(this._currentUrl,{trigger:false,replace:true});}
app.alert.show('unlink_confirmation',{level:'confirmation',messages:self.getUnlinkMessages(model).confirmation,onConfirm:_.bind(self.unlinkModel,self),onCancel:function(){self._modelToUnlink=null;}});},warnUnlinkOnRefresh:function(){if(this._modelToUnlink){return this.getUnlinkMessages(this._modelToUnlink).confirmation;}},unbindBeforeRouteUnlink:function(){app.routing.offBefore("route",this.beforeRouteUnlink,this);$(window).off("beforeunload.unlink"+this.cid);},_dispose:function(){this.unbindBeforeRouteUnlink();this._super('_dispose');}})},"property-table":{"controller":({})},"list-headerpane":{"controller":({extendsFrom:'HeaderpaneView'})},"news":{"controller":({plugins:['Dashlet'],initDashlet:function(){if(this.meta.config){var limit=this.settings.get("limit")||"5";this.settings.set("limit",limit);}},loadData:function(options){var name,limit;if(_.isUndefined(this.model)){return;}
var name=this.model.get("account_name")||this.model.get('name')||this.model.get('full_name'),limit=parseInt(this.settings.get('limit')||5,10);if(_.isEmpty(name)){return;}
$.ajax({url:'https://ajax.googleapis.com/ajax/services/search/news?v=1.0&q='+
name.toLowerCase()+'&rsz='+limit,dataType:'jsonp',success:function(data){if(this.disposed){return;}
_.extend(this,data);this.render();},context:this,complete:options?options.complete:null});}})},"user-locale-wizard-page":{"controller":({extendsFrom:"UserWizardPageView",TIME_ZONE_KEY:'timezone',TIME_PREF_KEY:'timepref',DATE_PREF_KEY:'datepref',NAME_FORMAT_KEY:'default_locale_name_format',initialize:function(options){var self=this;options.template=app.template.getView("wizard-page");app.view.invokeParent(self,{type:'view',name:'user-wizard-page',method:'initialize',args:[options]});if(this.model){this.model.set(this.TIME_ZONE_KEY,(app.user.getPreference(this.TIME_ZONE_KEY)||''));this.model.set(this.TIME_PREF_KEY,(app.user.getPreference(this.TIME_PREF_KEY)||''));this.model.set(this.DATE_PREF_KEY,(app.user.getPreference(this.DATE_PREF_KEY)||''));this.model.set(this.NAME_FORMAT_KEY,(app.user.getPreference(this.NAME_FORMAT_KEY)||''));}},_render:function(){var self=this;this._prepareFields(function(){if(!self.disposed){self.fieldsToValidate=self._fieldsToValidate(self.meta);app.view.invokeParent(self,{type:'view',name:'user-wizard-page',method:'_render'});}});},_prepareFields:function(callback){var self=this;app.user.loadLocale(function(localeOptions){_.each(self.meta.panels[0].fields,function(fieldDef){var opts=localeOptions[fieldDef.name];if(opts){fieldDef.options=opts;}});callback();});},beforeNext:function(callback){this.getField("next_button").setDisabled(true);this.model.doValidate(this.fieldsToValidate,_.bind(function(isValid){var self=this;if(isValid){var payload=this._prepareRequestPayload();app.alert.show('wizardlocale',{level:'process',title:app.lang.getAppString('LBL_LOADING'),autoClose:false});payload['ut']=true;app.user.updatePreferences(payload,function(err){app.alert.dismiss('wizardlocale');self.updateButtons();if(err){app.logger.debug("Wizard locale update failed: "+err);callback(false);}else{callback(true);}});}else{callback(false);}},this));}})},"audit":{"controller":({extendsFrom:'FilteredListView',fallbackFieldTemplate:'list-header',initialize:function(options){this.action='list';if(options.context.parent){this.baseModule=options.context.parent.get('module');this.baseRecord=options.context.parent.get('modelId');}
this._super('initialize',[options]);if(!this.collection){this._initCollection();}},_initCollection:function(){var AuditCollection=app.BeanCollection.extend({module:'audit',baseModule:this.baseModule,baseRecordId:this.baseRecord,buildURL:function(params){params=params||{};var parts=[],url;parts.push(app.api.serverUrl);parts.push(this.baseModule);parts.push(this.baseRecordId);parts.push(this.module);url=parts.join('/');params=$.param(params);if(params.length>0){url+='?'+params;}
return url;},sync:function(method,model,options){var url=this.buildURL(options.params),callbacks=app.data.getSyncCallbacks(method,model,options);app.api.call(method,url,options.attributes,callbacks);}});this.collection=new AuditCollection();},loadData:function(){if(this.collection.dataFetched){return;}
this.collection.fetch();}})},"dashlet-cell-empty":{"controller":({events:{'click .widget.empty':'addClicked'},originalTemplate:null,initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.model=this.layout.context.get("model");this.model.on("setMode",this.setMode,this);this.originalTemplate=this.template;this.setMode(this.model.mode);},addClicked:function(evt){var self=this;app.drawer.open({layout:'dashletselect',context:this.layout.context},function(model){if(!model)return;var conf=model.toJSON(),dash={context:{module:model.get("module"),link:model.get("link")}},type=conf.componentType;delete conf.config;delete conf.componentType;if(_.isEmpty(dash.context.module)&&_.isEmpty(dash.context.link)){delete dash.context;}
dash[type]=conf;self.layout.addDashlet(dash);});},setMode:function(type){if(type==='edit'){this.template=this.originalTemplate;}else if(type==='drag'){this.template=app.template.getView(this.name+'.drop')||this.originalTemplate;}else{this.template=app.template.getView(this.name+'.empty')||app.template.empty;}
this.render();},_dispose:function(){this.model.off("setMode",null,this);app.view.View.prototype._dispose.call(this);}})},"logout":{"controller":({events:{"click [name=login_button]":"login","click [name=login_form_button]":"login_form",},_render:function(){this.logoUrl=app.metadata.getLogoUrl();app.view.View.prototype._render.call(this);this.refreshAddtionalComponents();return this;},refreshAddtionalComponents:function(){_.each(app.additionalComponents,function(component){component.render();});},login:function(){app.router.login();},login_form:function(){app.controller.loadView({module:"Login",layout:"login",create:true});}})},"editmodal":{"controller":({extendsFrom:'BaseeditmodalView',fallbackFieldTemplate:'edit',initialize:function(options){app.view.View.prototype.initialize.call(this,options);if(this.layout){this.layout.on("app:view:activity:editmodal",function(){this.context.set('createModel',app.data.createRelatedBean(app.controller.context.get('model'),null,"notes",{}));this.render();this.$('.modal').modal({backdrop:"static"});this.$('.modal').modal('show');this.context.get('createModel').on("error:validation",function(){this.resetButton();},this);},this);}
this.bindDataChange();}})},"dupecheck-list-select":{"controller":({extendsFrom:'DupecheckListView',additionalTableClasses:'duplicates-singleselect'})},"globalsearch":{"controller":({id:'searchForm',preTag:'<strong>',postTag:'</strong>',plugins:['Dropdown'],searchModules:[],events:{'click .typeahead a':'clearSearch','click [data-action=search]':'showResults','click [data-advanced=options]':'persistMenu','click [data-action="select-module"]':'selectModule'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);app.events.on('app:sync:complete',this.populateModules,this);},selectModule:function(event){var module=this.$(event.currentTarget).data('module'),searchAll=this.$('input:checkbox[data-module="all"]'),searchAllLabel=searchAll.closest('label'),checkedModules=this.$('input:checkbox:checked[data-module!="all"]');if(module==='all'){searchAll.attr('checked',true);searchAllLabel.addClass('active');checkedModules.removeAttr('checked');checkedModules.closest('label').removeClass('active');}else{var currentTarget=this.$(event.currentTarget),currentTargetLabel=currentTarget.closest('label');currentTarget.attr('checked')?currentTargetLabel.addClass('active'):currentTargetLabel.removeClass('active');if(checkedModules.length){searchAll.removeAttr('checked');searchAllLabel.removeClass('active');}
else{searchAll.attr('checked',true);searchAllLabel.addClass('active');}}
event.stopPropagation();},populateModules:function(){if(this.disposed){return;}
this.searchModules=[];var modules=app.metadata.getModules()||{};this.searchModules=this.populateSearchableModules({modules:modules,acl:app.acl,checkFtsEnabled:true,checkGlobalSearchEnabled:true});this.render();},populateSearchableModules:function(options){var modules=options.modules,moduleNames=options.moduleNames||null,acl=options.acl,searchModules=[];_.each(modules,function(meta,module){var goodToAdd=true;if(moduleNames&&!_.contains(moduleNames,module)){goodToAdd=false;}
if(goodToAdd&&acl.hasAccess.call(acl,'view',module)){if(options.checkGlobalSearchEnabled&&!meta.globalSearchEnabled){goodToAdd=false;}
if(goodToAdd&&options.checkFtsEnabled&&!meta.ftsEnabled){goodToAdd=false;}
if(goodToAdd){searchModules.push(module);}}},this);return searchModules;},_renderHtml:function(){if(!app.api.isAuthenticated()||app.config.appStatus=='offline')return;app.view.View.prototype._renderHtml.call(this);var self=this,menuTemplate=app.template.getView(this.name+'.result');this.$('.search-query').searchahead({request:function(term){self.fireSearchRequest.call(self,term,this);},compiler:menuTemplate,throttleMillis:(app.config.requiredElapsed||500),throttle:function(callback,millis){if(!self.debounceFunction){self.debounceFunction=_.debounce(function(){callback();},millis||500);}
self.debounceFunction();},onEnterFn:function(hrefOrTerm,isHref){if(isHref&&this.$menu.is(':visible')){app.router.navigate(hrefOrTerm,{trigger:true});}else{var term=$.trim(self.$('.search-query').attr('value'));if(!_.isEmpty(term)){self.fireSearchRequest.call(self,term,this);}}}});this.$('.navbar-search').submit(function(){return false;});},_escapeSearchResults:function(html){var highlightedSpanRe=/<strong>.*?<\/strong>/g,higlightSpanTagsRe=/(<strong>)|(<\/strong>)/g,escape=Handlebars.Utils.escapeExpression,result=escape(html),highlightedSpan=html.match(highlightedSpanRe),highlightedContent,self=this;_.each(highlightedSpan,function(part){highlightedContent=part.replace(higlightSpanTagsRe,'');highlightedContent=escape(highlightedContent);result=result.replace(escape(part),self.preTag+highlightedContent+self.postTag);});return new Handlebars.SafeString(result);},_getSearchModuleNames:function(){if(this.$('input:checkbox[data-module="all"]').attr('checked')){return[];}
else{var searchModuleNames=[],checkedModules=this.$('input:checkbox:checked[data-module!="all"]');_.each(checkedModules,function(val,index){searchModuleNames.push(val.getAttribute('data-module'));},this);return searchModuleNames;}},fireSearchRequest:function(term,plugin){var searchModuleNames=this._getSearchModuleNames(),moduleList=searchModuleNames.join(','),self=this,maxNum=app.config&&app.config.maxSearchQueryResult?app.config.maxSearchQueryResult:5,params={q:term,fields:'name, id',module_list:moduleList,max_num:maxNum};app.api.search(params,{success:function(data){var formattedRecords=[];_.each(data.records,function(record){if(!record.id){return;}
var formattedRecord={id:record.id,name:record.name,module:record._module,link:'#'+app.router.buildRoute(record._module,record.id)};if((record._search.highlighted)){_.each(record._search.highlighted,function(val,key){var safeString=self._escapeSearchResults(val.text);if(key!=='name'){formattedRecord.field_name=app.lang.get(val.label,val.module);formattedRecord.field_value=safeString;}else{formattedRecord.name=safeString;}});}
formattedRecords.push(formattedRecord);});plugin.provide({next_offset:data.next_offset,records:formattedRecords,module_list:moduleList});},error:function(error){app.error.handleHttpError(error,plugin);app.logger.error("Failed to fetch search results in search ahead. "+error);}});},showResults:function(evt){var $searchBox=this.$('[data-provide=typeahead]');if(!$searchBox.is(':visible')){this.$el.addClass('active');$('body').on('click.globalsearch.data-api',_.bind(function(event){if(!$.contains(this.el,event.target)){this.$el.removeClass('active');$('body').off('click.globalsearch.data-api');}},this));$searchBox.focus();return;}
var e=jQuery.Event('keyup',{keyCode:$.ui.keyCode.ENTER});$searchBox.focus();$searchBox.trigger(e);},clearSearch:function(){this.$('.search-query').val('');},persistMenu:function(e){e.stopPropagation();},unbind:function(){$('body').off('click.globalsearch.data-api');this._super('unbind');}})},"notifications":{"controller":({plugins:['Dropdown','Timeago','EllipsisInline','Tooltip'],collection:null,_alertsCollections:{},_intervals:{},_intervalId:null,_defaultOptions:{delay:5,limit:4,severity_css:{alert:'label-important',information:'label-info',other:'label-inverse',success:'label-success',warning:'label-warning'}},initialize:function(options){options.module='Notifications';this._super('initialize',[options]);app.events.on('app:sync:complete',this._bootstrap,this);app.events.on('app:logout',this.stopPulling,this);},_bootstrap:function(){this._initOptions();this._initCollection();this._initReminders();this.startPulling();return this;},_initOptions:function(){var options=_.extend(this._defaultOptions,this.meta||{});this.delay=options.delay*60*1000;this.limit=options.limit;this.severityCss=options.severity_css;return this;},_initCollection:function(){this.collection=app.data.createBeanCollection(this.module);this.collection.options={params:{order_by:'date_entered:desc'},limit:this.limit,myItems:true,fields:['date_entered','id','name','severity']};this.collection.sync=_.wrap(this.collection.sync,function(sync,method,model,options){options=options||{};options.endpoint=function(method,model,options,callbacks){var url=app.api.buildURL(model.module,'pull',{},options.params);return app.api.call('read',url,{},callbacks);};sync(method,model,options);});return this;},_initReminders:function(){var timeOptions=_.keys(app.lang.getAppListStrings('reminder_time_options')),max=_.max(timeOptions,function(key){return parseInt(key,10);});this.reminderMaxTime=parseInt(max,10)+this.delay/1000;_.each(['Calls','Meetings'],function(module){this._alertsCollections[module]=app.data.createBeanCollection(module);this._alertsCollections[module].options={limit:this.meta.remindersLimit,fields:['date_start','id','name','reminder_time','location']};this._intervals[module]={};},this);return this;},getSeverityLabel:function(severity){var list=app.lang.getAppListStrings('notifications_severity_list');return list[severity]||severity;},getSeverityCss:function(severity){return this.severityCss[severity]||'';},startPulling:function(){if(!_.isNull(this._intervalId)){return this;}
var self=this;this.pull();this._pullReminders();this._intervalId=window.setInterval(function(){if(!app.api.isAuthenticated()){self.stopPulling();return;}
self.pull();self._pullReminders();},this.delay);return this;},stopPulling:function(){if(!_.isNull(this._intervalId)){window.clearInterval(this._intervalId);this._intervalId=null;}
return this;},pull:function(){if(this.disposed||this.isOpened()){return this;}
var self=this;this.collection.fetch({success:function(){if(self.disposed||self.isOpened()){return this;}
self.render();}});return this;},_pullReminders:function(){if(this.disposed){return this;}
var date=new Date(),startDate=date.toISOString(),endDate;date.setTime(date.getTime()+this.reminderMaxTime*1000);endDate=date.toISOString();_.each(['Calls','Meetings'],function(module){this._alertsCollections[module].filterDef=_.extend({},this.meta.remindersFilterDef||{},{'date_start':{'$dateBetween':[startDate,endDate]},'users.id':{'$equals':app.user.get('id')}});this._alertsCollections[module].fetch({silent:true,merge:true,apiOptions:{skipMetadataHash:true},success:_.bind(function(data){if(!this.disposed){this._parseReminders(data);}},this)});},this);return this;},_parseReminders:function(data){if(!data.length){return this;}
var deadIds=_.difference(_.keys(this._intervals[data.module]),data.pluck('id'));_.each(deadIds,function(id){this._clearReminders(data.module,id);},this);data.each(function(model){this._parseReminder(model);},this);return this;},_parseReminder:function(model){var hasChanged=!_.has(this._intervals[model.module],model.id)||!!model.changedAttributes(this._intervals[model.module][model.id].prevAttr);if(!hasChanged){return this;}
var diff=new Date(model.get('date_start'))-new Date(),delay=diff-parseInt(model.get('reminder_time'),10)*1000;if(delay<0){return this;}
this._clearReminders(model.module,model.id);this._intervals[model.module][model.id]={timer:setTimeout(_.bind(function(){this._showReminderAlert(model);},this),delay),prevAttr:_.pick(model.attributes,'reminder_time','date_start')};return this;},_clearReminders:function(module,id){if(id){if(_.has(this._intervals[module],id)){clearTimeout(this._intervals[module][id].timer);delete this._intervals[module][id];}
return;}
_.each(this._intervals[module],function(data){clearTimeout(data.timer);},this);this._intervals[module]={};},_showReminderAlert:function(model){var url=app.router.buildRoute(model.module,model.id),dateFormat=app.user.getPreference('datepref')+' '+app.user.getPreference('timepref'),dateValue=app.date.format(new Date(model.get('date_start')),dateFormat),template=app.template.getView('notifications.notifications-alert'),message=template({title:app.lang.get('LBL_REMINDER_TITLE',model.module),module:model.module,model:model,location:model.get('location'),description:model.get('description'),dateStart:dateValue});_.defer(function(){if(confirm(message)){app.router.navigate(url,{trigger:true});}});delete this._intervals[model.module][model.id];},isOpened:function(){return this.$('.notification-list').hasClass('open');},_renderHtml:function(){if(!app.api.isAuthenticated()||app.config.appStatus==='offline'){return;}
if(!_.isObject(this.collection)){this._super('_renderHtml');return;}
_.each(this.collection.models,function(model){model.set('severityCss',this.getSeverityCss(model.get('severity')));model.set('severityLabel',this.getSeverityLabel(model.get('severity')));},this);this._super('_renderHtml');},_dispose:function(){this.stopPulling();_.each(this._alertsCollections,function(collection,module){this._clearReminders(module);collection.off();},this);this._alertsCollections={};this._super('_dispose');}})},"merge-duplicates-headerpane":{"controller":({extendsFrom:'HeaderpaneView',events:{'click a[name=cancel_button]':'cancel','click a[name=save_button]':'save'},initialize:function(options){app.view.invokeParent(this,{type:'view',name:'headerpane',method:'initialize',args:[options]});var records=options.context.get('selectedDuplicates');this.title=app.lang.get('TPL_MERGING_RECORDS',this.module,{mergeCount:records.length});},cancel:function(){app.drawer.close();},save:function(){this.layout.trigger('mergeduplicates:save:fire');}})},"results":{"controller":({_meta:{"buttons":[{"name":"show_more_button","type":"button","label":"Show More","class":"loading wide"}]},fallbackFieldTemplate:"detail",events:{'click [name=name]':'gotoDetail','click .icon-eye-open':'loadPreview','click [name=show_more_button]':'showMoreResults'},initialize:function(options){this.options.meta=this._meta;app.view.View.prototype.initialize.call(this,options);},_render:function(){var self=this;self.lastQuery=self.context.get('query');self.fireSearchRequest(function(collection){$('.search-query').searchahead('hide');if(collection&&collection.length){app.view.View.prototype._render.call(self);self.renderSubnav();}else{self.renderSubnav(app.lang.getAppString('LNK_SEARCH_NO_RESULTS'));}});},renderSubnav:function(overrideMessage){if(this.context.get('subnavModel')){this.context.get('subnavModel').set({'title':overrideMessage||app.utils.formatString(app.lang.get('LBL_PORTAL_SEARCH_RESULTS_TITLE'),{'query':this.lastQuery})});}},fireSearchRequest:function(cb,offset){var mlist=null,self=this,options;mlist=app.metadata.getModuleNames(true);options={showAlerts:true,query:self.lastQuery,success:function(collection){cb(collection);},module_list:mlist,error:function(error){cb(null);}};if(offset)options.offset=offset;this.collection.fetch(options);},showMoreResults:function(){var self=this,options={};options.add=true;options.showAlerts=true;options.success=function(){app.view.View.prototype._render.call(self);window.scrollTo(0,document.body.scrollHeight);};this.collection.paginate(options);},gotoDetail:function(evt){var href=this.$(evt.currentTarget).parent().parent().attr('href');window.location=href;},loadPreview:function(e){var localGGrandparent,correspondingResultId,model;localGGrandparent=this.$(e.currentTarget).parent().parent().parent();$(localGGrandparent).parent().find('li').removeClass('on');$(localGGrandparent).addClass("on");correspondingResultId=$(localGGrandparent).find('p a').attr('href').split('/')[1];model=this.collection.get(correspondingResultId);this.layout.layout.trigger("search:preview",model);}})},"record":{"controller":({inlineEditMode:false,createMode:false,plugins:['SugarLogic','ErrorDecoration','GridBuilder','Editable','Audit','FindDuplicates','ToggleMoreLess'],enableHeaderButtons:true,enableHeaderPane:true,events:{'click .record-edit-link-wrapper':'handleEdit','click a[name=cancel_button]':'cancelClicked','click [data-action=scroll]':'paginateRecord'},buttons:null,STATE:{EDIT:'edit',VIEW:'view'},currentState:null,noEditFields:null,_containerWidth:0,initialize:function(options){_.bindAll(this);options.meta=_.extend({},app.metadata.getView(null,'record'),options.meta);app.view.View.prototype.initialize.call(this,options);this.buttons={};this.createMode=this.context.get("create")?true:false;this.action='detail';this.context.on("change:record_label",this.setLabel,this);this.context.set("viewed",true);this.model.on("duplicate:before",this.setupDuplicateFields,this);this.on("editable:keydown",this.handleKeyDown,this);this.on("editable:mousedown",this.handleMouseDown,this);app.routing.before("route",this.beforeRouteDelete,this,true);$(window).on("beforeunload.delete"+this.cid,_.bind(this.warnDeleteOnRefresh,this));this.delegateButtonEvents();if(this.createMode){this.model.isNotEmpty=true;}
this.noEditFields=[];this.MORE_LESS_KEY=app.user.lastState.key(this.MORE_LESS_KEY,this);this.adjustHeaderpane=_.bind(_.debounce(this.adjustHeaderpane,50),this);$(window).on('resize.'+this.cid,this.adjustHeaderpane);},hasUnsavedChanges:function(){if(this.resavingAfterMetadataSync)
return false;var changedAttributes=this.model.changedAttributes(this.model.getSyncedAttributes());if(_.isEmpty(changedAttributes)){return false;}
var formFields=_.compact(_.pluck(this.editableFields,'name')),unsavedFields=_.intersection(_.keys(changedAttributes),formFields);return!_.isEmpty(unsavedFields);},setupDuplicateFields:function(prefill){},setLabel:function(context,value){this.$(".record-label[data-name="+value.field+"]").text(value.label);},validationComplete:function(isValid){if(isValid){this.setButtonStates(this.STATE.VIEW);this.handleSave();}},delegateButtonEvents:function(){this.context.on('button:edit_button:click',this.editClicked,this);this.context.on('button:save_button:click',this.saveClicked,this);this.context.on('button:delete_button:click',this.deleteClicked,this);this.context.on('button:duplicate_button:click',this.duplicateClicked,this);},_render:function(){this._buildGridsFromPanelsMetadata(this.meta.panels);app.view.View.prototype._render.call(this);var record_label=this.context.get("record_label");if(record_label){this.setLabel(this.context,record_label);}
_.each(this.fields,function(field){var toggleLabel=_.bind(function(){this.toggleLabelByField(field);},this);field.off('render',toggleLabel);if(field.$el.closest('.headerpane').length>0){field.on('render',toggleLabel);}
if(field.def.readonly&&field.name&&-1==_.indexOf(this.noEditFields,field.name)){this.$('.record-edit-link-wrapper[data-name='+field.name+']').remove();}},this);this.toggleHeaderLabels(this.createMode);this.initButtons();this.setButtonStates(this.STATE.VIEW);this.setEditableFields();if(this.createMode){this.toggleFields(this.editableFields,true);}},setEditableFields:function(){delete this.editableFields;this.editableFields=[];var previousField,firstField;_.each(this.fields,function(field,index){if(field.def.readonly||_.indexOf(this.noEditFields,field.def.name)>=0||field.parent||(field.name&&this.buttons[field.name])){return;}
if(previousField){previousField.nextField=field;field.prevField=previousField;}else{firstField=field;}
previousField=field;this.editableFields.push(field);},this);if(previousField){previousField.nextField=firstField;firstField.prevField=previousField;}},initButtons:function(){if(this.options.meta&&this.options.meta.buttons){_.each(this.options.meta.buttons,function(button){this.registerFieldAsButton(button.name);if(button.buttons){var dropdownButton=this.getField(button.name);if(!dropdownButton){return;}
_.each(dropdownButton.fields,function(ddButton){this.buttons[ddButton.name]=ddButton;},this);}},this);}},showPreviousNextBtnGroup:function(){var listCollection=this.context.get('listCollection')||new app.data.createBeanCollection(this.module);var recordIndex=listCollection.indexOf(listCollection.get(this.model.id));if(listCollection&&listCollection.models&&listCollection.models.length<=1){this.showPrevNextBtnGroup=false;}else{this.showPrevNextBtnGroup=true;}
if(this.collection&&listCollection.length!==0){this.showPrevious=listCollection.hasPreviousModel(this.model);this.showNext=listCollection.hasNextModel(this.model);}},registerFieldAsButton:function(buttonName){var button=this.getField(buttonName);if(button){this.buttons[buttonName]=button;}},_renderHtml:function(){this.showPreviousNextBtnGroup();app.view.View.prototype._renderHtml.call(this);this.adjustHeaderpane();},bindDataChange:function(){this.model.on("change",function(fieldType){if(this.inlineEditMode){this.setButtonStates(this.STATE.EDIT);}
if(this.model.isNotEmpty!==true&&fieldType!=='image'){this.model.isNotEmpty=true;if(!this.disposed){this.render();}}},this);},duplicateClicked:function(){var self=this,prefill=app.data.createBean(this.model.module);prefill.copy(this.model);self.model.trigger("duplicate:before",prefill);prefill.unset("id");app.drawer.open({layout:'create-actions',context:{create:true,model:prefill}},function(context,newModel){if(newModel&&newModel.id){app.router.navigate("#"+self.model.module+"/"+newModel.id,{trigger:true});}});},editClicked:function(){this.setButtonStates(this.STATE.EDIT);this.toggleEdit(true);},saveClicked:function(){this.model.doValidate(this.getFields(this.module),_.bind(this.validationComplete,this));},cancelClicked:function(){this.handleCancel();this.setButtonStates(this.STATE.VIEW);this.clearValidationErrors(this.editableFields);},deleteClicked:function(){this.warnDelete();},toggleEdit:function(isEdit){this.$('.record-edit-link-wrapper').toggle(!isEdit);this.$('.headerpane .record-label').toggle(isEdit);this.toggleFields(this.editableFields,isEdit);this.toggleViewButtons(isEdit);this.adjustHeaderpane();},handleEdit:function(e,cell){var target,cellData,field;if(e){target=this.$(e.target);cell=target.parents(".record-cell");}
cellData=cell.data();field=this.getField(cellData.name);this.inlineEditMode=true;this.setButtonStates(this.STATE.EDIT);this.toggleField(field);if(cell.closest('.headerpane').length>0){this.toggleViewButtons(true);this.adjustHeaderpaneFields();}},toggleHeaderLabels:function(isEdit){this.$('.headerpane .record-label').toggle(isEdit);this.toggleViewButtons(isEdit);this.adjustHeaderpane();},toggleViewButtons:function(isEdit){this.$('.headerpane span[data-type="badge"]').toggleClass('hide',isEdit);this.$('.headerpane span[data-type="favorite"]').toggleClass('hide',isEdit);this.$('.headerpane span[data-type="follow"]').toggleClass('hide',isEdit);this.$('.headerpane .btn-group-previous-next').toggleClass('hide',isEdit);},toggleLabelByField:function(field){if(field.action==='edit'){field.$el.closest('.record-cell').addClass('edit').find('.record-label').show();}else{field.$el.closest('.record-cell').removeClass('edit').find('.record-label').hide();}},handleSave:function(){var self=this;self.inlineEditMode=false;var options={showAlerts:true,success:_.bind(function(){_.each(this.context.children,function(child){if(!_.isUndefined(child.attributes)&&!_.isUndefined(child.attributes.isSubpanel)){if(child.attributes.isSubpanel&&!child.attributes.hidden){child.attributes.collection.fetch();}}});if(this.createMode){app.navigate(this.context,this.model);}else if(!this.disposed){this.render();}},this),error:_.bind(function(error){if(error.status==412&&!error.request.metadataRetry){this.handleMetadataSyncError(error);}
else{this.editClicked();}},this),viewed:true};options=_.extend({},options,self.getCustomSaveOptions(options));app.file.checkFileFieldsAndProcessUpload(self,{success:function(){self.model.save({},options);}},{deleteIfFails:false});self.$('.record-save-prompt').hide();if(!self.disposed){self.render();}},handleMetadataSyncError:function(error){var self=this;self.resavingAfterMetadataSync=true;app.once("app:sync:complete",function(){error.request.metadataRetry=true;self.model.once("sync",function(){self.resavingAfterMetadataSync=false;app.router.refresh();});error.request.execute(null,app.api.getMetadataHash());});},getCustomSaveOptions:function(options){return{};},handleCancel:function(){this.model.revertAttributes();this.toggleEdit(false);this.inlineEditMode=false;},beforeRouteDelete:function(){if(this._modelToDelete){this.warnDelete();return false;}
return true;},getDeleteMessages:function(){var messages={},model=this.model,name=model.get('name')||(model.get('first_name')+' '+model.get('last_name'))||'',context=app.lang.get('LBL_MODULE_NAME_SINGULAR',model.module).toLowerCase()+' '+name.trim();messages.confirmation=app.lang.get('NTC_DELETE_CONFIRMATION')+context+'?';messages.success=app.lang.get('NTC_DELETE_SUCCESS')+context+'.';return messages;},warnDelete:function(){var self=this;this._modelToDelete=true;self._targetUrl=Backbone.history.getFragment();if(self._targetUrl!==self._currentUrl){app.router.navigate(self._currentUrl,{trigger:false,replace:true});}
app.alert.show('delete_confirmation',{level:'confirmation',messages:self.getDeleteMessages().confirmation,onConfirm:_.bind(self.deleteModel,self),onCancel:function(){self._modelToDelete=false;}});},warnDeleteOnRefresh:function(){if(this._modelToDelete){return this.getDeleteMessages().confirmation;}},deleteModel:function(){var self=this;self.model.destroy({showAlerts:{'process':true,'success':{messages:self.getDeleteMessages().success}},success:function(){var redirect=self._targetUrl!==self._currentUrl;self._modelToDelete=false;self.context.trigger("record:deleted");if(redirect){self.unbindBeforeRouteDelete();app.router.navigate(self._targetUrl,{trigger:true});return;}
app.router.navigate("#"+self.module,{trigger:true});}});},handleKeyDown:function(e,field){if(e.which===9){e.preventDefault();field.$(field.fieldTag).trigger("change");var direction=e.shiftKey?'prevField':'nextField',nextField=field[direction];if(!nextField){return;}
var hasHiddenPanel=nextField.$el.closest('.panel_hidden').hasClass('hide')&&_.isFunction(this.toggleMoreLess);if(hasHiddenPanel){this.toggleMoreLess();}
this.toggleField(field,false);this.toggleField(nextField,true);if(nextField.isDisabled()){var curField=nextField;while(curField.isDisabled()){if(curField[direction]){this.toggleField(curField[direction],true);curField=curField[direction];}else{break;}}}
this.adjustHeaderpane();}},handleMouseDown:function(){this.toggleViewButtons(false);this.adjustHeaderpaneFields();},setButtonStates:function(state){this.currentState=state;_.each(this.buttons,function(field){var showOn=field.def.showOn;if(_.isUndefined(showOn)||(showOn===state)){field.show();}else{field.hide();}},this);},setTitle:function(title){var $title=this.$('.headerpane .module-title');if($title.length>0){$title.text(title);}else{this.$('.headerpane h1').prepend('<div class="record-cell"><span class="module-title">'+title+'</span></div>');}},unbindBeforeRouteDelete:function(){app.routing.offBefore("route",this.beforeRouteDelete,this);$(window).off("beforeunload.delete"+this.cid);},_dispose:function(){this.unbindBeforeRouteDelete();_.each(this.editableFields,function(field){field.nextField=null;field.prevField=null;});this.buttons=null;this.editableFields=null;this.off("editable:keydown",this.handleKeyDown,this);$(window).off('resize.'+this.cid);app.view.View.prototype._dispose.call(this);},_buildGridsFromPanelsMetadata:function(panels){var lastTabIndex=0;this.noEditFields=[];_.each(panels,function(panel){_.each(panel.fields,function(field,index){if(_.isString(field)){panel.fields[index]=field={name:field};}
if(field.type==="fieldset"){if(field.readonly||_.every(field.fields,function(field){return!app.acl.hasAccessToModel('edit',this.model,field.name);},this)){this.noEditFields.push(field.name);}}else if(field.readonly||!app.acl.hasAccessToModel('edit',this.model,field.name)){this.noEditFields.push(field.name);}},this);if(panel.hide){this.hiddenPanelExists=true;}
if(_.isUndefined(panel.labels)){panel.labels=true;}
if(_.isFunction(this.getGridBuilder)){var options={fields:panel.fields,columns:panel.columns,labels:panel.labels,labelsOnTop:panel.labelsOnTop,tabIndex:lastTabIndex},gridResults=this.getGridBuilder(options).build();panel.grid=gridResults.grid;lastTabIndex=gridResults.lastTabIndex;}},this);},paginateRecord:function(evt){var el=$(evt.currentTarget),data=el.data();if(data.id){var list=this.context.get('listCollection'),model=list.get(data.id);switch(data.actionType){case'next':list.getNext(model,this.navigateModel);break;case'prev':list.getPrev(model,this.navigateModel);break;default:this._disablePagination(el);}}},navigateModel:function(model,actionType){if(model&&model.id){app.router.navigate(app.router.buildRoute(this.module,model.id),{trigger:true});}else{var el=this.$el.find('[data-action=scroll][data-action-type='+actionType+']');this._disablePagination(el);}},_disablePagination:function(el){app.logger.error('Wrong data for record pagination. Pagination is disabled.');el.addClass('disabled');el.data('id','');},adjustHeaderpane:function(){this.setContainerWidth();this.adjustHeaderpaneFields();},getContainerWidth:function(){return this._containerWidth;},setContainerWidth:function(){this._containerWidth=this._getParentLayoutWidth(this.layout);},_getParentLayoutWidth:function(layout){if(!layout){return 0;}else if(_.isFunction(layout.getPaneWidth)){return layout.getPaneWidth(this);}
return this._getParentLayoutWidth(layout.layout);},adjustHeaderpaneFields:function(){if(!this.disposed&&!_.isEmpty($recordCells)&&this.getContainerWidth()>0){var ellipsisCellWidth,$recordCells=this.$('.headerpane h1').children('.record-cell, .btn-toolbar'),$ellipsisCell=$(this._getCellToEllipsify($recordCells));if(!_.isEmpty($ellipsisCell)){if($ellipsisCell.hasClass('edit')){$ellipsisCell.css({'width':'100%'});}else{ellipsisCellWidth=this._calculateEllipsifiedCellWidth($recordCells,$ellipsisCell);this._setMaxWidthForEllipsifiedCell($ellipsisCell,ellipsisCellWidth);this._widenLastCell($recordCells);}}}},_getCellToEllipsify:function($cells){var fieldTypesToEllipsify=['fullname','name','text','base','enum','url','dashboardtitle'];return _.find($cells,function(cell){return(_.indexOf(fieldTypesToEllipsify,$(cell).data('type'))!==-1);});},_calculateEllipsifiedCellWidth:function($cells,$ellipsisCell){var width=this.getContainerWidth();_.each($cells,function(cell){var $cell=$(cell);if($cell.is($ellipsisCell)){width-=(parseInt($ellipsisCell.css('padding-left'),10)
+parseInt($ellipsisCell.css('padding-right'),10));}else if($cell.is(':visible')){$cell.css({'width':'auto'});width-=$cell.outerWidth();}
$cell.css({'width':''});});return width;},_setMaxWidthForEllipsifiedCell:function($ellipsisCell,width){var ellipsifiedCell,fieldType=$ellipsisCell.data('type');if(fieldType==='fullname'||fieldType==='dashboardtitle'){ellipsifiedCell=this.getField($ellipsisCell.data('name'));width-=ellipsifiedCell.getCellPadding();ellipsifiedCell.setMaxWidth(width);}else{$ellipsisCell.css({'max-width':width});}},_widenLastCell:function($cells){var $cellToWiden;_.each($cells,function(cell){var $cell=$(cell);if($cell.hasClass('record-cell')&&(!$cell.hasClass('hide')||$cell.is(':visible'))){$cellToWiden=$cell;}});if($cellToWiden){$cellToWiden.css({'width':'100%'});}},getFieldNames:function(module){var fields=app.view.View.prototype.getFieldNames.call(this,module);var favorite=_.find(this.meta.panels,function(panel){return _.find(panel.fields,function(field){return field.type==='favorite';});});if(favorite){fields=_.union(fields,['my_favorite']);}
return fields;}})},"modulelist":{"controller":({className:'module-list',recentRowTemplate:Handlebars.compile('{{#each models}}<li><a tabindex="-1" class="recentLink actionLink" href="#{{buildRoute model=this}}" data-route="#{{buildRoute model=this}}"><i class="icon-time active"></i>{{getFieldValue this "name"}}</a></li>{{/each}}'),plugins:['Dropdown'],events:{'click [data-toggle=dropdown]':'getRecentlyViewedAndFavoriteRecords','click .actionLink':'handleMenuEvent',"click a[data-route]":"handleRouteEvent"},handleRouteEvent:function(event){var currentFragment,currentTarget=this.$(event.currentTarget),route=currentTarget.data("route");if(route){if((!_.isUndefined(event.button)&&event.button!==0)||event.ctrlKey||event.metaKey){event.stopPropagation();window.open(route,'_blank');return false;}
event.preventDefault();currentFragment=Backbone.history.getFragment();if(("#"+currentFragment)===route){app.router.refresh();}else{app.router.navigate(route,{trigger:true});}}},handleMenuEvent:function(evt){var $currentTarget=this.$(evt.currentTarget);if($currentTarget.data('event')){var module=$currentTarget.closest('li.dropdown').data('module');app.events.trigger($currentTarget.data('event'),module,evt);}},initialize:function(options){this.activeModule=this._setActiveModule(this);app.events.on("app:sync:complete",this.render,this);app.events.on("app:view:change",this.handleViewChange,this);app.view.View.prototype.initialize.call(this,options);if(this.layout){this.layout.on("view:resize",this.resize,this);}},_dispose:function(){app.view.View.prototype._dispose.call(this);},handleViewChange:function(){this.activeModule.set(app.controller.context.get("module"));this.layout.trigger("header:update:route");},getRecentlyViewedAndFavoriteRecords:function(event){var $currentTarget=$(event.currentTarget),module=$currentTarget.parent().parent().data('module'),moduleMeta=app.metadata.getModule(module);if(!$currentTarget.parent().parent().hasClass('more-drop-container')&&!$currentTarget.hasClass('actionLink')){if(module=='Home'){this.populateDashboards();}
else if(moduleMeta&&moduleMeta.fields&&!_.isArray(moduleMeta.fields)){this.clearFavoritesRecents(module);if(moduleMeta.favoritesEnabled){this.populateFavorites(module);}
this.populateRecents(module);}}},clearFavoritesRecents:function(module){this.$('[data-module='+module+'] .recentContainer').html('');this.$('[data-module='+module+'] .favoritesContainer').html('');},populateFavorites:function(module,populateCallback){var self=this;var filter={"filter":[{"$favorite":""}],"max_num":3};var url=app.api.buildURL(module,'read',{id:"filter"});app.api.call('create',url,filter,{limit:3,success:function(data){if(data.records&&data.records.length>0){if(_.isFunction(populateCallback)){populateCallback();}
var beans=[];_.each(data.records,function(recordData){beans.push(app.data.createBean(module,recordData));});var collection=app.data.createBeanCollection(module,beans);self.$('[data-module='+module+'] .favoritesAnchor').show();var favoritesTemplate=app.template.getView('modulelist.favorites',module)||app.template.getView('modulelist.favorites');self.$('[data-module='+module+'] .favoritesContainer').show().html(favoritesTemplate(collection));}}});},populateRecents:function(module,populateCallback){var self=this;var filter={"filter":[{"$tracker":"-7 DAY"}],"max_num":3};var url=app.api.buildURL(module,'read',{id:"filter"});app.api.call('create',url,filter,{success:function(data){if(data.records&&data.records.length>0){if(_.isFunction(populateCallback)){populateCallback();}
var beans=[];_.each(data.records,function(recordData){beans.push(app.data.createBean(module,recordData));});var collection=app.data.createBeanCollection(module,beans);self.$('[data-module='+module+'] .recentAnchor').show();self.$('[data-module='+module+'] .recentContainer').show().html(self.recentRowTemplate(collection));}}});},populateDashboards:function(){var self=this,sync=function(method,model,options){options=app.data.parseOptionsForSync(method,model,options);var callbacks=app.data.getSyncCallbacks(method,model,options);app.api.records(method,this.apiModule,model.attributes,options.params,callbacks);},Dashboard=app.Bean.extend({sync:sync,apiModule:'Dashboards',module:'Home'}),DashboardCollection=app.BeanCollection.extend({sync:sync,apiModule:'Dashboards',module:'Home',model:Dashboard});var dashCollection=new DashboardCollection();dashCollection.fetch({showAlerts:false,success:function(data){var pattern=/^(LBL|TPL|NTC|MSG)_(_|[a-zA-Z0-9])*$/;_.each(dashCollection.models,function(model){if(pattern.test(model.get('name'))){model.set('name',app.lang.get(model.get('name'),dashCollection.module||null));}});self.$('[data-module=Home] .dashboardContainer').html(self.recentRowTemplate(dashCollection));}});},_renderHtml:function(){if(!app.api.isAuthenticated()||app.config.appStatus=='offline')return;if(!(_.isEmpty(app.metadata.getStrings("mod_strings")))){var self=this;this.module_list={};if(app.metadata.getModuleNames(true,"read")){_.each(app.metadata.getModuleNames(true,"read"),function(val){self.module_list[val]=val;});}
this.module_list=this.completeMenuMeta(this.module_list);app.view.View.prototype._renderHtml.call(this);this.resetMenu();this.activeModule.set(app.controller.context.get("module"));}},completeMenuMeta:function(module_list){var actions,meta,returnList=[],self=this,listLength,fullModuleList=app.metadata.getFullModuleList();_.each(module_list,function(value,key){if(!_.isString(fullModuleList[value])){return;}
actions={label:app.lang.get('LBL_MODULE_NAME',value),name:key};meta=app.metadata.getModule(key);if(meta&&meta.menu&&meta.menu.header){actions.menu=self.filterAvailableMenuActions(meta.menu.header.meta);}else{actions.menu=[];}
listLength=returnList.push(actions);actions.menuIndex=listLength-1;});return returnList;},filterAvailableMenuActions:function(menuMeta){var result=[];_.each(menuMeta,function(menuItem){if(app.acl.hasAccess(menuItem.acl_action,menuItem.acl_module)){result.push(menuItem);}});return result;},resetMenu:function(){this.$('.more').before(this.$('#module_list .more-drop-container').children());},resize:function(width){if(width<=0){return;}
this.activeModule.set(app.controller.context.get("module"));var $activeInMore=this.$('.more').find('.dropdown.active');if($activeInMore.length>0){$activeInMore.find('.btn-group').show();$activeInMore.find('.moreLink').hide();this.$el.find('.dropdown.more').before($activeInMore);}
var $moduleList=this.$el.find('#module_list'),$moduleListClone=$moduleList.clone(),$cloneContainer=$('<div></div>');$cloneContainer.css({position:'absolute',top:'-9999px',display:'block'}).append($moduleListClone);this.$el.append($cloneContainer);if($moduleListClone.outerWidth(true)>=width){this.removeModulesFromList($moduleListClone,width);}else{this.addModulesToList($moduleListClone,width);}
$moduleList.remove();this.$el.append($moduleListClone);$cloneContainer.remove();},addModulesToList:function($modules,width){var $dropdown=$modules.find('.more-drop-container'),$moduleToInsert=$dropdown.children("li:first"),$more=$modules.find('.more'),$lastModuleInList,$nextModule,currentWidth=$modules.outerWidth(true);while((currentWidth<width)&&($dropdown.children().length>0)){$nextModule=$moduleToInsert.next();$moduleToInsert.find('.btn-group').show();$moduleToInsert.find('.moreLink').hide();$lastModuleInList=$more.prev();if(this.activeModule.isActive($lastModuleInList)&&!this.activeModule.isNext($moduleToInsert)){$lastModuleInList.before($moduleToInsert);}else{$more.before($moduleToInsert);}
currentWidth=$modules.outerWidth(true);$moduleToInsert=$nextModule;if(currentWidth>=width){this.removeModulesFromList($modules,width);break;}}
if($dropdown.children().length===0&&$modules.find('.dropdown').is(":visible")){this.$('.more').hide();}},removeModulesFromList:function($modules,width){var $dropdown=$modules.find('.more-drop-container'),$module=$modules.find('.more').prev(),$next,currentWidth=$modules.outerWidth(true),persistentTabs=this.activeModule.isActive($module)?3:2;while(currentWidth>=width&&($modules.children().length-persistentTabs)>0){if(this.activeModule.isActive($module)||$module.hasClass('Home')){$module=$module.prev();}
$next=$module.prev();$dropdown.prepend($module);$module.find('.btn-group').hide();$module.find('.moreLink').show();currentWidth=$modules.outerWidth(true);$module=$next;}
if($dropdown.children().length!==0&&$modules.find('.dropdown').is(":visible")){this.$('.more').show();}},_setActiveModule:function(parent){return{_class:'active',_next:null,_moduleList:parent,set:function(module){var $modules,$module,$next,updateNav=true,mapped;if(app.controller&&app.controller.layout&&app.controller.layout.meta&&!_.isUndefined(app.controller.layout.meta.updateNav)){updateNav=app.controller.layout.meta.updateNav;}
if(module){this.reset();$modules=this._moduleList.$('#module_list');$module=$modules.find("[data-module='"+module+"']");if($module.length<1){mapped=app.metadata.getTabMappedModule(module);if(mapped!==module){$module=$modules.find("[data-module='"+mapped+"']");updateNav=$module.length===0;}
if(updateNav){module=mapped;var moduleList={};moduleList[module]=app.metadata.getFullModuleList()[module];var meta=this._moduleList.completeMenuMeta(moduleList);if(!_.isUndefined(meta[0])){meta[0].menuIndex=-1;var singleMenuTemplate=app.template.get(this._moduleList.name+'.singlemenuPartial');this._moduleList.$el.find('.dropdown.more').before(singleMenuTemplate(meta[0]));$module=$modules.find("[data-module='"+module+"']");}}}
$module.addClass(this._class);if(!this._next){$next=$module.next();if($next.hasClass('more')){$next=$modules.find('.more-drop-container li:first');}
this._next=$next.attr('class');}}},isActive:function($module){return $module.hasClass(this._class);},isNext:function($module){return(this._next===$module.attr('class'));},reset:function(){this.resetActive();this._next=null;this._moduleList.$('.dropdown.'+this._class).removeClass(this._class);},resetActive:function(){var $activeNode=this._moduleList.$('.dropdown.'+this._class);if($activeNode.length<1)return;var beforeIndex=$activeNode.prev().data('menuindex');var activeIndex=$activeNode.data('menuindex');var $afterNode=this._moduleList.$('[data-menuindex='+(activeIndex+1)+']');if(activeIndex==-1){$activeNode.remove();}
if(beforeIndex!=activeIndex-1&&activeIndex!==1){$afterNode.before($activeNode);if($activeNode.parents().hasClass('more')){$activeNode.find('.btn-group').hide();$activeNode.find('.moreLink').show();$activeNode.find('.moreLink').css('display','block');}}}};}})},"vcard-import":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.context.off("vcard:import:finish",null,this);this.context.on("vcard:import:finish",this.importVCard,this);},_renderField:function(field){app.view.View.prototype._renderField.call(this,field);if(field.name==='vcard_import'){field.setMode('edit');}},importVCard:function(){var self=this,vcardFile=$('[name=vcard_import]');if(_.isEmpty(vcardFile.val())){app.alert.show('error_validation_vcard',{level:'error',messages:'LBL_EMPTY_VCARD',autoClose:false});}else{app.file.checkFileFieldsAndProcessUpload(self,{success:function(data){var route=app.router.buildRoute(self.module,data.vcard_import);app.router.navigate(route,{trigger:true});app.alert.show('vcard-import-saved',{level:'success',messages:app.lang.get('LBL_IMPORT_VCARD_SUCCESS',self.module),autoClose:true});}},{deleteIfFails:true,htmlJsonFormat:false});}}})},"detail":{"controller":({toggled:false,fieldsToDisplay:app.config.fieldsToDisplay||5,events:{'click .more':'toggleMoreLess','click .less':'toggleMoreLess'},_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);var fieldsArray=this.$("span[sfuuid]")||[];if(fieldsArray.length>this.fieldsToDisplay){_.each(fieldsArray,function(field,i){if(i>this.fieldsToDisplay-1){$(field).parent().parent().hide();}},this);this.$(".more").removeClass("hide");}
if(this.toggled){this.toggleMoreLess();}},toggleMoreLess:function(){this.toggled=!this.toggled;var fieldsArray=this.$("span[sfuuid]")||[];var that=this;_.each(fieldsArray,function(field,i){if(i>that.fieldsToDisplay-1){$(field).parent().parent().toggle();}});this.$(".less").toggleClass("hide");this.$(".more").toggleClass("hide");},bindDataChange:function(){if(this.model){this.model.on("change",function(){this.render();},this);}}})},"treemap":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.treeCollection=app.data.createBeanCollection(this.model.module);this.treeCollection.fetch({showAlerts:false});},margin:{top:20,right:0,bottom:0,left:0},width:0,height:0,root:null,_render:function(){app.view.View.prototype._render.call(this);this.width=parseInt(this.$(".opportunities-treemap").width(),10);this.height=parseInt(this.$(".opportunities-treemap"+" svg").css('max-height'),10);},renderTree:function(){var self=this;var transitioning,x=d3.scale.linear().domain([0,this.width]).range([0,this.width]),y=d3.scale.linear().domain([0,this.height]).range([0,this.height]),treemap=d3.layout.treemap().children(function(d,depth){return depth?null:d.children;}).sort(function(a,b){return a.value-b.value;}).round(false),svg=d3.select(".opportunities-treemap svg").attr("width",this.width+this.margin.left+this.margin.right).attr("height",this.height+this.margin.bottom+this.margin.top).style("margin-left",-this.margin.left+"px").style("margin-right",-this.margin.right+"px").append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")").style("shape-rendering","crispEdges"),grandparent=svg.append("g").attr("class","grandparent"),nodes=[];if(!this.root){return;}
grandparent.append("rect").attr("y",-this.margin.top).attr("width",this.width).attr("height",this.margin.top);grandparent.append("text").attr("x",6).attr("y",6-this.margin.top).attr("dy",'.75em');function initialize(root){root.x=root.y=0;root.dx=self.width;root.dy=self.height;root.depth=0;}
function accumulate(d){nodes.push(d);if(d.children){return d.value=d.children.reduce(function(p,v){return p+accumulate(v);},0);}
return d.value;}
function layout(d){if(d.children){treemap.nodes({children:d.children});d.children.forEach(function(c){c.x=d.x+c.x*d.dx;c.y=d.y+c.y*d.dy;c.dx*=d.dx;c.dy*=d.dy;c.parent=d;layout(c);});}}
function display(d){grandparent.datum(d.parent).on("click",transition).select("text").text(name(d));var g1=svg.insert("g",".grandparent").datum(d).attr("class","depth");var g=g1.selectAll("g").data(d.children).enter().append("g");g.filter(function(d){return d.children;}).classed("children",true).on("click",transition);g.filter(function(d){return!(d.children);}).on("click",navigate);var child_rects=g.selectAll(".child").data(function(d){return d.children||[d];}).enter().append("rect").attr("class","child").call(rect);var parent_rect=g.append("rect").attr("class","parent").call(rect).append("text").text(function(d){return d.name;});var label=g.append("text").attr("dy",".75em").text(function(d){return d.name;}).call(text);function navigate(d){var model=app.data.createBean(self.module);model.set("id",d.id);model.fetch();app.navigate(self.context,model);}
function transition(d){if(transitioning||!d)return;transitioning=true;var g2=display(d),t1=g1.transition().duration(750),t2=g2.transition().duration(750);x.domain([d.x,d.x+d.dx]);y.domain([d.y,d.y+d.dy]);svg.style("shape-rendering",null);svg.selectAll(".depth").sort(function(a,b){return a.depth-b.depth;});g2.selectAll("text").style("fill-opacity",0);t1.selectAll("text").call(text).style("fill-opacity",0);t2.selectAll("text").call(text).style("fill-opacity",1);t1.selectAll("rect").call(rect);t2.selectAll("rect").call(rect);t1.remove().each("end",function(){svg.style("shape-rendering","crispEdges");transitioning=false;});}
return g;}
function text(t){t.attr("x",function(d){return x(d.x)+6;}).attr("y",function(d){return y(d.y)+6;});}
function rect(r){r.attr("x",function(d){return x(d.x);}).attr("y",function(d){return y(d.y);}).attr("width",function(d){return x(d.x+d.dx)-x(d.x);}).attr("height",function(d){return y(d.y+d.dy)-y(d.y);}).attr("class",function(d){if(d3.select(this).classed(d.className)){return d3.select(this).attr('class');}
return d3.select(this).attr('class')+" "+d.className;});}
function name(d){if(d.parent){return name(d.parent)+" / "+d.name;}
return d.name;}
initialize(this.root);accumulate(this.root);layout(this.root);display(this.root);},processData:function(){var day_ms=1000*60*60*24,today=new Date(),d1=new Date(today.getTime()+31*day_ms),data;today.setUTCHours(0,0,0,0);if(this.treeCollection){data=this.treeCollection.filter(function(model){var d2=new Date(model.get("date_closed")||"1970-01-01");return(d2-d1)/day_ms<=30;});data=_.groupBy(data,function(m){return m.get("assigned_user_name");});_.each(data,function(value,key,list){list[key]=_.groupBy(value,function(m){return m.get("sales_stage");});});}
this.root={name:"Opportunities",children:[]};_.each(data,function(value1,key1){var child=[];_.each(value1,function(value2,key2){_.each(value2,function(record){record.className='stage_'+record.get("sales_stage").toLowerCase().replace(' ','');record.value=parseInt(record.get("amount_usdollar"),10);record.name=record.get("name");});child.push({name:key2,className:'stage_'+key2.toLowerCase().replace(' ',''),children:value2});});this.root.children.push({name:key1,children:child},this);},this);this.renderTree();},bindDataChange:function(){this.treeCollection.on("reset",this.processData,this);},unbindData:function(){this.treeCollection.off();this.treeCollection=null;app.view.View.prototype.unbindData.call(this);}})},"massupdate-progress":{"controller":({plugins:['Editable'],events:{'click [name=btn-stop]':'pauseUpdate'},totalRecord:0,_startTime:0,_velocity:0,$holders:{},_labelSet:{'update':{PROGRESS_STATUS:'TPL_MASSUPDATE_PROGRESS_STATUS',DURATION_FORMAT:'TPL_MASSUPDATE_DURATION_FORMAT',FAIL_TO_ATTEMPT:'TPL_MASSUPDATE_FAIL_TO_ATTEMPT',WARNING_CLOSE:'TPL_MASSUPDATE_WARNING_CLOSE',WARNING_INCOMPLETE:'TPL_MASSUPDATE_WARNING_INCOMPLETE',SUCCESS:'TPL_MASSUPDATE_SUCCESS',TITLE:'TPL_MASSUPDATE_TITLE'},'delete':{PROGRESS_STATUS:'TPL_MASSDELETE_PROGRESS_STATUS',DURATION_FORMAT:'TPL_MASSDELETE_DURATION_FORMAT',FAIL_TO_ATTEMPT:'TPL_MASSDELETE_FAIL_TO_ATTEMPT',WARNING_CLOSE:'TPL_MASSDELETE_WARNING_CLOSE',WARNING_INCOMPLETE:'TPL_MASSDELETE_WARNING_INCOMPLETE',SUCCESS:'TPL_MASSDELETE_SUCCESS',TITLE:'TPL_MASSDELETE_TITLE'}},hasUnsavedChanges:function(){return(this.totalRecord>0);},initCollection:function(collection){this.unbindData();this.collection=collection;this.hide();this.bindDataChange();},initLabels:function(){this.LABELSET=this._labelSet[this.collection.method||this.collection.defaultMethod];},initHolders:function(){var self=this;self.$holders={};this.$('[data-holder]').each(function(holder){var $el=$(this);self.$holders[$el.data('holder')]=$el;});},unbindData:function(){this.offBefore('start');this.off('render',null,this);app.view.View.prototype.unbindData.call(this);},bindDataChange:function(){if(!this.collection){return;}
this.on('render',this.initHolders,this);this.before('start',this.checkAvailable,this,true);this.collection.on('massupdate:always',this.updateProgress,this);this.collection.on('massupdate:start',this.showProgress,this);this.collection.on('massupdate:end',this.hideProgress,this);this.collection.on('massupdate:fail',this.checkError,this);this.collection.on('massupdate:resume',this.resumeProcess,this);this.collection.on('massupdate:pause',this.pauseProcess,this);},checkAvailable:function(){if(this.collection.chunks.length===this.collection.length){this.unbindData();this.collection.on('massupdate:end',this.hideProgress,this);return false;}
return true;},checkError:function(){if(this.collection.attempt===0){this.$holders.bar.addClass('progress-info').removeClass('progress-danger');return;}else if(this.collection.attempt>this.collection.maxAllowAttempt){return;}
this.$holders.bar.removeClass('progress-info').addClass('progress-danger');app.alert.dismiss('stop_confirmation');app.alert.show('stop_confirmation',{level:'error',messages:app.lang.get(this.LABELSET['FAIL_TO_ATTEMPT'],this.module,{num:this.collection.attempt,total:this.collection.maxAllowAttempt}),autoClose:true,autoCloseDelay:8000});},getEstimate:function(){if(!this.collection.chunks){return 0;}
var chunkSize=this.collection.chunks.length,remainSize=this.collection.length,duration=(new Date().getTime()-this._startTime)/1000;this._startTime=new Date().getTime();this._velocity=chunkSize/duration;return parseInt(remainSize/this._velocity,10);},getRelativeTime:function(elapsed){var msPerMinute=60,msPerHour=msPerMinute*60,msPerDay=msPerHour*24,unitString='',relateTime=0;if(elapsed<=0){return'';}
if(elapsed<msPerMinute){relateTime=elapsed;unitString=app.lang.get('LBL_DURATION_SECONDS');}else if(elapsed<msPerHour){relateTime=Math.round(elapsed/msPerMinute);unitString=app.lang.get('LBL_DURATION_MINUTES');}else if(elapsed<msPerDay){relateTime=Math.round(elapsed/msPerHour);unitString=app.lang.get('LBL_DURATION_HOUR');}else{return'';}
return app.lang.get(this.LABELSET['DURATION_FORMAT'],this.collection.baseModule,{time:relateTime,unit:unitString});},getTotalRecords:function(){return this.collection.length;},getRemainder:function(){var chunkSize=_.isEmpty(this.collection.chunks)?0:this.collection.chunks.length,size=_.min([this.collection.models.length,this.collection.length+chunkSize]);return size;},getProgressSize:function(){var chunkSize=_.isEmpty(this.collection.chunks)?0:this.collection.chunks.length,size=_.min([this.totalRecord,this.totalRecord-this.collection.length+chunkSize]);return size;},getCompleteRecords:function(){return this.totalRecord-this.collection.length;},resumeUpdate:function(){this.collection.resumeFetch();},pauseUpdate:function(){var stopButton=this.getField('btn-stop');stopButton.setDisabled(true);this.collection.pauseFetch();},pauseProcess:function(){this.$holders.bar.removeClass('active');app.alert.dismiss('stop_confirmation');app.alert.show('stop_confirmation',{level:'confirmation',messages:app.lang.get(this.LABELSET['WARNING_CLOSE'],this.module,{num:this.getRemainder()}),onConfirm:_.bind(this.hideProgress,this),onCancel:_.bind(this.resumeUpdate,this),autoClose:false});},resumeProcess:function(){this.$holders.bar.addClass('active');var stopButton=this.getField('btn-stop');stopButton.setDisabled(false);},showProgress:function(){this.initLabels();this.totalRecord=this.getTotalRecords();if(this.triggerBefore('start')===false){return false;}
this._startTime=new Date().getTime();var stopButton=this.getField('btn-stop');if(stopButton){stopButton.setDisabled(false);}
var title=app.lang.get(this.LABELSET.TITLE,this.module,{module:this.module});this.$holders.title.text(title);this.updateProgress();this.show();},hideProgress:function(){var size=this.getCompleteRecords(),discardSize=this.collection.discards.length;if(discardSize>0){var message=app.lang.get(this.LABELSET['SUCCESS'],this.module,{num:this.totalRecord-discardSize});message+=app.lang.get('TPL_MASSUPDATE_WARNING_PERMISSION',this.module,{remain:discardSize});app.alert.show('massupdate_final_notice',{level:'warning',messages:message,autoClose:true,autoCloseDelay:8000});}else if(this.totalRecord!==size){app.alert.show('massupdate_final_notice',{level:'warning',messages:app.lang.get(this.LABELSET['WARNING_INCOMPLETE'],this.module,{num:this.getRemainder()}),autoClose:true,autoCloseDelay:8000});}else{app.alert.show('massupdate_final_notice',{level:'success',messages:app.lang.get(this.LABELSET['SUCCESS'],this.module,{num:size}),autoClose:true,autoCloseDelay:8000});}
this.totalRecord=0;this.collection.resetProgress();this.hide();},updateProgress:function(){if(!this.collection||this.collection.length===0){return;}
var estimate=this.getEstimate(),estimateMessage=this.getRelativeTime(estimate),size=this.getProgressSize(),percent=(size*100/this.totalRecord),message=app.lang.get(this.LABELSET['PROGRESS_STATUS'],this.module,{num:size,percent:Math.round(percent),total:this.totalRecord});if(!_.isEmpty(estimateMessage)){this.$holders.estimate.text(estimateMessage);}
this.checkError();this.$holders.message.text(message);this.$holders.progressbar.css({'width':percent+'%'});}})},"dashletselect":{"controller":({extendsFrom:'FilteredListView',initialize:function(options){var meta=app.metadata.getView(null,'dashletselect')||{};options.meta=_.extend({},meta,options.meta||{});this._super('initialize',[options]);this.context=_.extend(_.clone(this.context),{resetLoadFlag:function(){return;}});this.context.on('dashletlist:select-and-edit',function(model,collection){this.selectDashlet(model.get('metadata'));},this);this.context.on('dashletlist:preview:fire',function(model,collection){this.previewDashlet(model.get('metadata'));},this);},previewDashlet:function(metadata){var layout=this.layout,previewLayout;while(layout){if(layout.getComponent('preview-pane')){previewLayout=layout.getComponent('preview-pane').getComponent('dashlet-preview');previewLayout.showPreviewPanel();break;}
layout=layout.layout;}
if(previewLayout){if(!metadata.preview){metadata.preview=metadata.config;}
var previousComponent=_.last(previewLayout._components);if(previousComponent.name!=='dashlet-preview'){var index=previewLayout._components.length-1;previewLayout._components[index].dispose();previewLayout.removeComponent(index);}
var contextDef,component={label:app.lang.get(metadata.name,metadata.preview.module),name:metadata.type,preview:true};if(metadata.preview.module||metadata.preview.link){contextDef={skipFetch:false,forceNew:true,module:metadata.preview.module,link:metadata.preview.link};}else if(metadata.module){contextDef={module:metadata.module};}
component.view=_.extend({module:metadata.module},metadata.preview,component);if(contextDef){component.context=contextDef;}
previewLayout._addComponentsFromDef([{layout:{type:'dashlet',label:app.lang.get(metadata.preview.label||metadata.name,metadata.preview.module),preview:true,components:[component]}}],this.context.parent);previewLayout.loadData();previewLayout.render();}},selectDashlet:function(metadata){app.drawer.load({layout:{name:'dashletconfiguration',components:[{view:_.extend({},metadata.config,{label:app.lang.get(metadata.name,metadata.config.module),name:metadata.type,config:true,module:metadata.config.module||metadata.module})}]},context:{module:metadata.config.module||metadata.module,forceNew:true,skipFetch:true}});},getFilteredList:function(dashlets){var parentModule=app.controller.context.get('module'),parentView=app.controller.context.get('layout');return _.chain(dashlets).filter(function(dashlet){var filter=dashlet.filter;if(_.isUndefined(filter)){return true;}
var filterModules=filter.module||[parentView],filterViews=filter.view||[parentView];if(_.isString(filterModules)){filterModules=[filterModules];}
if(_.isString(filterViews)){filterViews=[filterViews];}
return _.contains(filterModules,parentModule)&&_.contains(filterViews,parentView);}).value();},_getDashlets:function(type,name,module,meta){var dashlets=[],hadDashlet=meta&&meta.dashlets&&app.view.componentHasPlugin({type:type,name:name,module:module,plugin:'Dashlet'});if(!hadDashlet){return dashlets;}
_.each(meta.dashlets,function(dashlet){if(!dashlet.config){return;}
var description=app.lang.get(dashlet.description,dashlet.config.module);if(!app.acl.hasAccess('access',module||dashlet.config.module)){return;}
dashlets.push({type:name,filter:dashlet.filter,metadata:_.extend({component:name,module:module,type:name},dashlet),title:app.lang.get(dashlet.name,dashlet.config.module),description:description});},this);return dashlets;},_addBaseViews:function(){var components=[];_.each(app.metadata.getView(),function(view,name){var dashlets=this._getDashlets('view',name,null,view.meta);if(!_.isEmpty(dashlets)){components=_.union(components,dashlets);}},this);return components;},_addModuleViews:function(){var components=[];_.each(app.metadata.getModuleNames(),function(module){_.each(app.metadata.getView(module),function(view,name){var dashlets=this._getDashlets('view',name,module,view.meta);if(!_.isEmpty(dashlets)){components=_.union(components,dashlets);}},this);},this);return components;},loadData:function(){if(this.collection.length){this.filteredCollection=this.collection.models;return;}
var dashletCollection=_.union(this._addBaseViews(),this._addModuleViews()),filteredDashletCollection=this.getFilteredList(dashletCollection);this.collection.add(filteredDashletCollection);this.collection.dataFetched=true;this._renderData();},getFields:function(){return _.flatten(_.pluck(this.meta.panels,'fields'));}})},"list":{"controller":({className:'list-view',events:{'click [class*="orderBy"]':'setOrderBy'},defaultLayoutEvents:{"list:search:fire":"fireSearch","list:paginate:success":"paginateSuccess","list:filter:toggled":"filterToggled","list:alert:show":"showAlert","list:alert:hide":"hideAlert","list:sort:fire":"sort"},defaultContextEvents:{},_previewed:null,_leftActions:[],_rowActions:[],_fields:{},initialize:function(options){var listViewMeta=app.metadata.getView(options.module,'list')||{};options.meta=_.extend({},listViewMeta,options.meta||{});options.meta.type=options.meta.type||'list';options.meta.action='list';options=this.parseFieldMetadata(options);app.view.View.prototype.initialize.call(this,options);this.attachEvents();this.orderByLastStateKey=app.user.lastState.key('order-by',this);this.orderBy=_.extend({field:'',direction:'desc'},listViewMeta.orderBy,app.user.lastState.get(this.orderByLastStateKey)||{});if(this.collection){this.collection.orderBy=this.orderBy;}
this.limit=this.context.has('limit')?this.context.get('limit'):null;},parseFieldMetadata:function(options){_.each(options.meta.panels,function(panel,panelIdx){_.each(panel.fields,function(field,fieldIdx){if(!_.isUndefined(field.align)){var alignClass='';if(_.contains(['left','center','right'],field.align)){alignClass='t'+field.align;}
options.meta.panels[panelIdx].fields[fieldIdx].align=alignClass;}
if(!_.isUndefined(field.width)){var parts=field.width.toString().match(/^(\d{0,3})\%$/);var widthValue='';if(parts){if(parseInt(parts[1])<100){widthValue=parts[0];}}
options.meta.panels[panelIdx].fields[fieldIdx].width=widthValue;}},this);},this);return options;},attachEvents:function(){this.layoutEventsMap=_.extend(this.defaultLayoutEvents,this.layoutEvents);this.contextEventsMap=_.extend(this.defaultContextEvents,this.contextEvents);if(this.layout){_.each(this.layoutEventsMap,function(callback,event){this.layout.on(event,this[callback],this);},this);}
if(this.context){_.each(this.contextEventsMap,function(callback,event){this.context.on(event,this[callback],this);},this);}},paginateSuccess:function(){app.events.trigger("preview:collection:change",this.collection);if(!this.disposed)this.render();},sort:function(){app.events.trigger("preview:close");},parseFields:function(viewMeta){this._fields={"default":[],"available":{"visible":[],"all":[]}};_.each(viewMeta.panels,function(panel){_.each(panel.fields,function(fieldMeta,i){if(fieldMeta["default"]===false){this._fields["available"].all.push(fieldMeta.name);}else{this._fields["default"].push(fieldMeta.name);}},this);},this);return viewMeta;},showAlert:function(message){this.$(".alert .container").html(message);this.$(".alert").removeClass("hide");},hideAlert:function(){this.$(".alert").addClass("hide");},filterToggled:function(isOpened){this.filterOpened=isOpened;},fireSearch:function(term){term=term||"";var options={limit:this.limit||null,query:term};this.context.get("collection").resetPagination();this.context.resetLoadFlag(false);this.context.set('skipFetch',false);this.context.loadData(options);},setOrderBy:function(event){var collection,options,eventTarget,orderBy;var self=this;collection=self.collection;eventTarget=self.$(event.currentTarget);orderBy=eventTarget.data('orderby');if(!orderBy){orderBy=eventTarget.data('fieldname');}
if(orderBy===self.orderBy.field){self.orderBy.direction=self.orderBy.direction==='desc'?'asc':'desc';}else{self.orderBy.field=orderBy;self.orderBy.direction='desc';}
collection.orderBy=self.orderBy;options=self.getSortOptions(collection);if(this.orderByLastStateKey){app.user.lastState.set(this.orderByLastStateKey,self.orderBy);}
self.context.resetLoadFlag(false);self.context.set('skipFetch',false);self.context.loadData(options);},getSortOptions:function(collection){var self=this,options={};options=self.filterOpened?self.getSearchOptions():{};options.showAlerts=true;options.limit=self.limit||null;options.success=function(collection,response,options){self.layout.trigger("list:sort:fire",collection,self);if(!self.disposed)collection.reset(response);};if(collection.offset){options.limit=collection.offset;options.offset=0;}
return options;},getSearchOptions:function(){var collection,options,previousTerms,term='';collection=this.context.get('collection');if(app.cache.has('previousTerms')){previousTerms=app.cache.get('previousTerms');if(previousTerms){term=previousTerms[this.module];}}
options={params:{},fields:collection.fields?collection.fields:this.collection};if(term){options.params.q=term;}
if(this.context.get('link')){options.relate=true;}
return options;},bindDataChange:function(){if(this.collection){this.collection.on("reset",this.render,this);}},_dispose:function(){this._fields=null;app.view.View.prototype._dispose.call(this);}})},"link-moduleselect":{"controller":({linkModules:[],events:{'click label[for=relationship]':'setFocus'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.linkModules=this.context.get("linkModules");},setFocus:function(e){this.$("#relationship").select2("open");},_renderHtml:function(ctx,options){var self=this;app.view.View.prototype._renderHtml.call(this,ctx,options);this.$(".select2").select2({width:'100%',allowClear:true,placeholder:app.lang.get("LBL_SEARCH_SELECT")}).on("change",function(e){if(_.isEmpty(e.val)){self.context.trigger("link:module:select",null);}else{var meta=self.linkModules[e.val];self.context.trigger("link:module:select",{link:meta.link,module:meta.module});}});},_dispose:function(){this.$(".select2").select2('destroy');app.view.View.prototype._dispose.call(this);}})},"dashablelist":{"controller":({extendsFrom:'ListView',plugins:['Dashlet'],_defaultSettings:{limit:5,my_items:'1',favorites:'0'},moduleBlacklist:['Home'],_availableModules:{},_availableColumns:{},initialize:function(options){options.meta=_.extend({},options.meta,{last_state:{id:'dashable-list'}});this._super('initialize',[options]);},initDashlet:function(view){if(this.meta.config){this.settings.on('change:module',function(model,moduleName){var label=(model.get('my_items')=='1')?'TPL_DASHLET_MY_MODULE':'LBL_MODULE_NAME';model.set('label',app.lang.get(label,moduleName,{module:moduleName}));this._updateDisplayColumns();},this);}
this._initializeSettings();if(this.meta.config){this._configureDashlet();}else{this._displayDashlet();}},getLabel:function(){var module=this.settings.get('module')||this.context.get('module');return app.lang.get(this.settings.get('label'),module,{module:module});},_initializeSettings:function(){if(!this.settings.get('limit')){this.settings.set('limit',this._defaultSettings.limit);}
if(!this.settings.get('my_items')){this.settings.set('my_items',this._defaultSettings.my_items);}
if(!this.settings.get('favorites')){this.settings.set('favorites',this._defaultSettings.favorites);}
this._setDefaultModule();if(!this.settings.get('label')){this.settings.set('label','LBL_MODULE_NAME');}},_setDefaultModule:function(){var availableModules=_.keys(this._getAvailableModules()),definedModule=this.settings.get('module'),module=definedModule||this.context.get('module');if(!_.contains(availableModules,module)){module=_.first(availableModules);}
if(definedModule!==module){this.settings.set('module',module);}},_updateDisplayColumns:function(){var availableColumns=this._getAvailableColumns(),columnsFieldName='display_columns',columnsField=this.getField(columnsFieldName);if(columnsField){columnsField.items=availableColumns;}
this.settings.set(columnsFieldName,_.keys(availableColumns));},_configureDashlet:function(){var availableModules=this._getAvailableModules(),availableColumns=this._getAvailableColumns();_.each(this.getFieldMetaForView(this.meta),function(field){switch(field.name){case'module':field.options=availableModules;break;case'display_columns':field.options=availableColumns;break;}});},_getAvailableModules:function(){if(_.isEmpty(this._availableModules)||!_.isObject(this._availableModules)){this._availableModules={};var allowedModules=_.difference(app.user.get('module_list'),this.moduleBlacklist);_.each(allowedModules,function(module){var hasListView=!_.isEmpty(this.getFieldMetaForView(app.metadata.getView(module,'list')));if(hasListView){this._availableModules[module]=app.lang.get('LBL_MODULE_NAME',module);}},this);}
return this._availableModules;},_getListMeta:function(module){var listMeta;if(app.metadata.getModule(module).isBwcEnabled){listMeta=app.bwc.getLegacyMetadata(module,'listviewdefs');}else{listMeta=app.metadata.getView(module,'list');}
return listMeta;},_getAvailableColumns:function(){var columns={},module=this.settings.get('module');if(!module){return columns;}
if(!_.isEmpty(this._availableColumns[module])){return this._availableColumns[module];}
_.each(this.getFieldMetaForView(this._getListMeta(module)),function(field){columns[field.name]=app.lang.get(field.label||field.name,module);});this._availableColumns[module]=columns;return columns;},_displayDashlet:function(){this.context.set('skipFetch',false);this.context.set('limit',this.settings.get('limit'));this._intializeFilter();var columns=this._getColumnsForDisplay();this.meta.panels=[{fields:columns}];this._startAutoRefresh();},_intializeFilter:function(){var filter=[];if(this.settings.get('my_items')==='1'){filter.push({'$owner':''});}
if(this.settings.get('favorites')==='1'){filter.push({'$favorite':''});}
this.context.get('collection').filterDef=(filter.length>1)?{'$and':filter}:filter;},_getColumnsForDisplay:function(){var columns=[],fields=this.getFieldMetaForView(this._getListMeta(this.settings.get('module')));if(!this.settings.get('display_columns')){this._updateDisplayColumns();}
_.each(this.settings.get('display_columns'),function(name){var field=_.find(fields,function(field){return field.name===name;},this);var column=_.extend({name:name,sortable:true},field||{});columns.push(column);},this);return columns;},_startAutoRefresh:function(){var refreshRate=parseInt(this.settings.get('auto_refresh'),10);if(refreshRate){this._stopAutoRefresh();this._timerId=setInterval(_.bind(function(){this.context.resetLoadFlag();this.layout.loadData();},this),refreshRate*1000*60);}},_stopAutoRefresh:function(){if(this._timerId){clearInterval(this._timerId);}},_dispose:function(){this._stopAutoRefresh();this._super('_dispose');},getFieldMetaForView:function(meta){meta=_.isObject(meta)?meta:{};return!_.isUndefined(meta.panels)?_.flatten(_.pluck(meta.panels,'fields')):[];}})},"filter-actions":{"controller":({events:{"change input":"filterNameChanged","keyup input":"filterNameChanged","click a.filter-close":"triggerClose","click a.save_button:not(.disabled)":"triggerSave","click a.delete_button:not(.hide)":"triggerDelete"},tagName:"article",className:"filter-header",rowState:false,initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this.layout.on("filter:create:open",function(model){var self=this,name=model?model.get("name"):'';this.setFilterName(name);if(!name){_.defer(function(){self.$("input").focus();});}},this);this.listenTo(this.layout,"filter:create:rowsValid",this.toggleRowState);this.listenTo(this.layout,"filter:set:name",this.setFilterName);},getFilterName:function(){return this.$("input").val();},setFilterName:function(name){this.$("input").val(name);this.toggleDelete(!name);},filterNameChanged:_.debounce(function(event){this.layout.trigger('filter:create:validate');},400),toggleDelete:function(t){this.$(".delete_button").toggleClass("hide",t);},toggleDisabled:function(){this.$(".save_button").toggleClass('disabled',!(this.getFilterName()&&this.rowState));},toggleRowState:function(t){this.rowState=_.isUndefined(t)?!this.rowState:!!t;this.toggleDisabled();},triggerClose:function(){var id=this.layout.editingFilter.get('id');this.layout.trigger("filter:create:close",true,id);},triggerSave:function(){var filterName=this.getFilterName();this.layout.trigger("filter:create:save",filterName);},triggerDelete:function(){this.layout.trigger("filter:create:delete");}})},"user-wizard-page":{"controller":({extendsFrom:"WizardPageView",initialize:function(options){options.template=app.template.getView("wizard-page");app.view.invokeParent(this,{type:'view',name:'wizard-page',method:'initialize',args:[options]});this.fieldsToValidate=this._fieldsToValidate(this.options.meta);},isPageComplete:function(){return this.areAllRequiredFieldsNonEmpty;},_prepareRequestPayload:function(){var payload={},self=this,fields=_.keys(this.fieldsToValidate);_.each(fields,function(key){payload[key]=self.model.get(key);});return payload;},beforeNext:function(callback){var self=this;this.getField("next_button").setDisabled(true);this.model.doValidate(this.fieldsToValidate,_.bind(function(isValid){var self=this;if(isValid){var payload=self._prepareRequestPayload();app.alert.show('wizardprofile',{level:'process',title:app.lang.getAppString('LBL_LOADING'),autoClose:false});app.user.updateProfile(payload,function(err){app.alert.dismiss('wizardprofile');self.updateButtons();if(err){app.logger.debug("Wizard profile update failed: "+err);callback(false);}else{callback(true);}});}else{callback(false);}},self));}})},"create-actions":{"controller":({extendsFrom:'CreateView'})},"orgchart":{"controller":({events:{'click .zoom-control':'zoomChart','click .toggle-control':'toggleChart'},results:{},plugins:['Dashlet','Tooltip'],nodetemplate:{},reporteesEndpoint:'',currentRootId:'',zoomExtents:{},nodeSize:{},treeData:{},jsTree:{},slider:{},sliderZoomIn:{},sliderZoomOut:{},chart:{},viewName:'',initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.nodetemplate=app.template.getView(this.name+'.orgchartnode');this.reporteesEndpoint=app.api.buildURL('Forecasts','reportees/'+app.user.get('id'),null,{'level':2});this.currentRootId=app.user.get('id');this.zoomExtents={'min':0.25,'max':2};this.nodeSize={'width':124,'height':56};},initDashlet:function(viewName){this.viewName=viewName;},_dispose:function(){if(!_.isEmpty(this.jsTree)){this.jsTree.off();}
if(!_.isEmpty(this.slider)){this.slider.off('move');}
if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.resize);nv.utils.unResizeOnPrint(this.chart.resize);}
app.view.View.prototype._dispose.call(this);},_buildUserUrl:function(id){return'#'+app.router.buildRoute('Users',id);},_renderHtml:function(){if(this.viewName!=="config"&&nv&&nv.models){var self=this,chart=nv.models.tree().duration(300).nodeSize(this.nodeSize).nodeRenderer(function(d){return self.nodetemplate(d.metadata);}).zoomExtents(this.zoomExtents).horizontal(false).getId(function(d){return d.metadata.id;});app.view.View.prototype._renderHtml.call(this);this.slider=this.$('.btn-slider .noUiSlider');this.sliderZoomIn=this.$('.btn-slider i[data-control="zoom-in"]');this.sliderZoomOut=this.$('.btn-slider i[data-control="zoom-out"]');if(!_.isEmpty(this.treeData)){this.jsTree=this.$('div[data-control="org-jstree"]').jstree({'json_data':{'data':this.treeData},'plugins':['json_data','ui','types'],'core':{'animation':0},'ui':{'initially_select':['jstree_node_'+app.user.get("user_name")]}}).on('loaded.jstree',function(e){self.$('div[data-control="org-jstree"]').addClass('jstree-sugar');self.$('div[data-control="org-jstree"] > ul').addClass('list');self.$('div[data-control="org-jstree"] > ul > li > a').addClass('jstree-clicked');}).on('click.jstree',function(e){e.stopPropagation();e.preventDefault();}).on('select_node.jstree',function(event,data){var jsData=data.inst.get_json();chart.filter(jQuery.data(data.rslt.obj[0],'id'));self.$('div[data-control="org-jstree-dropdown"] .jstree-label').text(data.inst.get_text());data.inst.toggle_node(data.rslt.obj);});d3.select('svg#'+this.cid).datum(this.treeData[0]).transition().duration(700).call(chart);this.slider.noUiSlider('init',{start:100,knobs:1,scale:[25,200],connect:false,step:25,change:function(){var values=self.slider.noUiSlider('value'),scale=chart.zoomLevel(values[0]/100);self.sliderZoomIn.toggleClass('disabled',(scale===self.zoomExtents.max));self.sliderZoomOut.toggleClass('disabled',(scale===self.zoomExtents.min));}});self.chart=chart;nv.utils.windowResize(self.chart.resize);nv.utils.resizeOnPrint(self.chart.resize);_.debounce(function(){if(self.disposed){return;}
self.chart.reset();},3000);}}},_postProcessTree:function(data,ctx){var adopt=[],newChild={};_.each(data,function(entry,index){if(!entry.data){return;}
data[index].data=(function(value){return value.replace(/&amp;/gi,'&').replace(/&#039;/gi,'\'').replace(/&quot;/gi,'"');})(entry.data);data[index].metadata.url=ctx._buildUserUrl(entry.metadata.id);data[index].metadata.img=app.api.buildFileURL({module:"Users",id:entry.metadata.id,field:"picture"});if(!entry.children){return;}
adopt=[];_.each(entry.children,function(childEntry,index2){if(entry.metadata.id!==childEntry.metadata.id){newChild=ctx._postProcessTree([childEntry],ctx);if(!_.isEmpty(newChild)){adopt.push(newChild[0]);}}},this);data[index].children=adopt;},this);return data;},zoomChart:function(e){var button=$(e.target),scale=this.chart.zoom(button.data('control')==='zoom-in'?0.25:-0.25);this.sliderZoomIn.toggleClass('disabled',(scale===this.zoomExtents.max));this.sliderZoomOut.toggleClass('disabled',(scale===this.zoomExtents.min));this.slider.noUiSlider('move',{to:scale*100});},toggleChart:function(e){var button=$(e.currentTarget).hasClass('btn')?$(e.currentTarget):$(e.currentTarget).parent('.btn');switch(button.data('control')){case'orientation':this.chart.orientation();button.find('i').toggleClass('icon-arrow-right icon-arrow-down');break;case'show-all-nodes':this.chart.showall();break;case'zoom-to-fit':this.chart.reset();this.slider.noUiSlider('move',{to:100});break;default:}},loadData:function(options){var self=this;app.api.call('get',this.reporteesEndpoint,null,{success:function(data){self.treeData=self._postProcessTree([data],self);self.treeData.ctx=self.context;if(!self.disposed){self.render();}},complete:options?options.complete:null});}})},"inactive-tasks":{"controller":({extendsFrom:'TabbedDashletView',plugins:['LinkedModel','Dashlet','Timeago'],initialize:function(options){options.meta=options.meta||{};options.meta.template='tabbed-dashlet';this._super('initialize',[options]);},createRecord:function(event,params){this.createRelatedRecord(params.module,params.link);},_renderHtml:function(){if(this.meta.config){this._super('_renderHtml');return;};_.each(this.collection.models,function(model){var pictureUrl=app.api.buildFileURL({module:'Users',id:model.get('assigned_user_id'),field:'picture'});model.set('picture_url',pictureUrl);},this);this._super('_renderHtml');}})},"bwc":{"controller":({tagName:'iframe',className:'bwc-frame',id:'bwc-frame',moduleRegex:new RegExp('module=([^&]*)'),idRegex:new RegExp('record=([^&]*)'),actionRegex:new RegExp('action=([^&]*)'),plugins:['Editable'],warnEnabledBwcActions:['editview','config'],initialize:function(options){var url=options.context.get('url');if(url&&(url.search(/module=Home.*action=index/)>-1||url.search(/action=index.*module=Home/)>-1)){app.router.navigate('#Home',{trigger:true});return;}
this.$el.attr('src',app.utils.addIframeMark(options.context.get('url')||'index.php?module='+this.options.module+'&action=index'));app.view.View.prototype.initialize.call(this,options);this.bwcModel=app.data.createBean('bwc');},hasUnsavedChanges:function(){var bwcWindow=this.$el.get(0).contentWindow;if(_.isEmpty(this.bwcModel.attributes)){return false;}
var newAttributes=this.serializeObject(bwcWindow.EditView);return!_.isEmpty(this.bwcModel.changedAttributes(newAttributes));},serializeObject:function(theForm){var formArray=$(theForm).serializeArray();return _.reduce(formArray,function(acc,field){acc[field.name]=field.value;return acc;},{});},_render:function(){if(this.module==='Administration'&&!app.acl.hasAccessToAny('admin')&&!app.acl.hasAccessToAny('developer')){app.logger.info('Current user does not have access to this module view. name: '+
this.name+' module:'+this.module);app.error.handleRenderError(this,'view_render_denied');app.router.navigate('#Home',{trigger:true});return;}
app.view.View.prototype._render.call(this);return this;},_renderHtml:function(){var self=this;app.view.View.prototype._renderHtml.call(this);this.$el.load(function(){self._setModule(this.contentWindow);self._setBwcModel(this.contentWindow);var url='#bwc/index.php'+this.contentWindow.location.search;self._setCurrentUrl(url);if(this.contentWindow.$===undefined){return;}
self._rewriteLinksForSidecar(this.contentWindow);self._rewriteNewWindowLinks(this.contentWindow);self._cloneBodyClasses(this.contentWindow);self._resizeIframe(this.contentWindow);});},_cloneBodyClasses:function(contentWindow){contentWindow.$('html').addClass($('html').prop('class'));},_setModule:function(contentWindow){var module=this.moduleRegex.exec(contentWindow.location.search);module=(_.isArray(module))?module[1]:null;if(!module){if(contentWindow.$&&contentWindow.$('input[name="module"]')&&contentWindow.$('input[name="module"]').val()){module=contentWindow.$('input[name="module"]').val();}else{return;}}
if(module==='Import'){var importModule=/import_module=([^&]*)/.exec(contentWindow.location.search);if(!_.isNull(importModule)&&!_.isEmpty(importModule[1])){module=importModule[1];}}
var app=window.parent.SUGAR.App;app.controller.context.set('module',module);app.events.trigger('app:view:change',this.layout,{module:module});},_resizeIframe:function(contentWindow){if(Modernizr.touch){$('.bwc-frame').css('height',contentWindow.$("#main").height());}},_setBwcModel:function(contentWindow){var action=this.actionRegex.exec(contentWindow.location.search);action=(_.isArray(action))?action[1].toLowerCase():null;if(contentWindow.EditView){action='editview';}
var attributes={};if(_.contains(this.warnEnabledBwcActions,action)){attributes=this.serializeObject(contentWindow.EditView);}
this.resetBwcModel(attributes);},_setCurrentUrl:function(url){url=app.utils.rmIframeMark(url);this._currentUrl=url;window.parent.location.hash=url;},revertBwcModel:function(){var bwcWindow=this.$el.get(0).contentWindow;var newAttributes=this.serializeObject(bwcWindow.EditView);this.resetBwcModel(newAttributes);},resetBwcModel:function(attr){this.bwcModel.clear({silent:true}).set(attr);},convertToSidecarUrl:function(href){var module=this.moduleRegex.exec(href),id=this.idRegex.exec(href),action=this.actionRegex.exec(href);module=(_.isArray(module))?module[1]:null;if(!module){return'';}
if(app.metadata.getModule(module).isBwcEnabled){href=href.replace(/^.\//,'');return"bwc/"+href;}
id=(_.isArray(id))?id[1]:null;action=(_.isArray(action))?action[1]:'';if(action.toLowerCase()==='detailview'){action='';}
if(!id&&action.toLowerCase()==='editview'){action='create';}
return app.router.buildRoute(module,id,action);},convertToSidecarLink:function(elem){elem=$(elem);var baseUrl=app.config.siteUrl||window.location.pathname;var href=elem.attr('href');var module=this.moduleRegex.exec(href);var dataSidecarRewrite=elem.attr('data-sidecar-rewrite');var action=this.actionRegex.exec(href);if(!_.isArray(module)||_.isEmpty(module[1])||_.isUndefined(app.metadata.getModule(module[1]))||module[1]==="Administration"||href.indexOf("javascript:")===0||dataSidecarRewrite==='false'||(_.isArray(action)&&action[1]==='sugarpdf')){return;}
var sidecarUrl=this.convertToSidecarUrl(href);elem.attr('href',baseUrl+'#'+sidecarUrl);elem.data('sidecarProcessed',true);if(elem.attr('target')==='_blank'){return;}
elem.click(function(e){if(e.button!==0||e.ctrlKey||e.metaKey){return;}
e.stopPropagation();parent.SUGAR.App.router.navigate(sidecarUrl,{trigger:true});return false;});},_rewriteLinksForSidecar:function(frame){var self=this;frame.$('a[href*="module="]').each(function(i,elem){self.convertToSidecarLink(elem);});},_rewriteNewWindowLinks:function(frame){var baseUrl=app.config.siteUrl||window.location.origin+window.location.pathname,$links=frame.$('a[target="_blank"]').not('[href^="http"]').not('[href*="entryPoint=download"]');$links.each(function(i,elem){var $elem=$(elem);if($elem.data('sidecarProcessed')){return;}
$elem.attr('href',baseUrl+'#bwc/'+$elem.attr('href'));});},_dispose:function(){this.bwcModel.off();this.bwcModel=null;app.view.View.prototype._dispose.call(this);}})},"massaddtolist":{"controller":({extendsFrom:'MassupdateView',addToListFieldName:'prospect_lists',listModule:'ProspectLists',massUpdateViewName:'massaddtolist-progress',initialize:function(options){var additionalEvents={};additionalEvents['click .btn[name=create_button]']='createAndSelectNewList';this.events=_.extend({},this.events,additionalEvents);app.view.invokeParent(this,{type:'view',name:'massupdate',method:'initialize',args:[options]});},delegateListFireEvents:function(){this.layout.on("list:massaddtolist:fire",this.show,this);this.layout.on("list:massaction:hide",this.hide,this);},setMetadata:function(options){var moduleMetadata=app.metadata.getModule(options.module);var addToListField=_.find(moduleMetadata.fields,function(field){return field.name===this.addToListFieldName;},this);if(addToListField){addToListField=app.utils.deepCopy(addToListField);addToListField.id_name=this.addToListFieldName+'_id';addToListField.name=this.addToListFieldName+'_name';addToListField.label=addToListField.label||addToListField.vname;addToListField.type='relate';addToListField.required=true;this.addToListField=addToListField;}},_render:function(){var result=app.view.invokeParent(this,{type:'view',name:'massupdate',method:'_render'});if(_.isUndefined(this.addToListField)){this.hide();}
return result;},setDefault:function(){this.defaultOption=this.addToListField;},getAttributes:function(){var attributes={};attributes[this.addToListFieldName]=[this.model.get(this.addToListField.id_name)];return attributes;},buildSaveSuccessMessages:function(massUpdateModel){var doneLabel='TPL_MASS_ADD_TO_LIST_SUCCESS',queuedLabel='TPL_MASS_ADD_TO_LIST_QUEUED',listName=this.model.get(this.addToListField.name),listId=this.model.get(this.addToListField.id_name),listUrl='#'+app.router.buildRoute(this.listModule,listId);return{done:app.lang.get(doneLabel,null,{listName:listName,listUrl:listUrl}),queued:app.lang.get(queuedLabel,null,{listName:listName,listUrl:listUrl})};},createAndSelectNewList:function(){app.drawer.open({layout:'create-nodupecheck',context:{create:true,module:this.listModule}},_.bind(this.selectNewlyCreatedList,this));},selectNewlyCreatedList:function(context,model){var relateField=this.getField('prospect_lists_name');if(relateField){model.value=model.get('name');relateField.setValue(model);}}})},"list-bottom":{"controller":({filterOpened:false,events:{'click [data-action="show-more"]':'showMoreRecords'},initialize:function(opts){opts.meta=_.extend({},{showMoreLabel:"LBL_SHOW_MORE_MODULE"},opts.meta||{});app.view.View.prototype.initialize.call(this,opts);this.showMoreLabel=app.lang.get(this.options.meta.showMoreLabel,this.module,{module:app.lang.get('LBL_MODULE_NAME',this.module).toLowerCase()});},_renderHtml:function(){if(this.context.get('limit')){this.limit=this.context.get('limit');}
app.view.View.prototype._renderHtml.call(this);this.layout.off("list:filter:toggled",null,this);this.layout.on("list:filter:toggled",this.filterToggled,this);},filterToggled:function(isOpened){this.context.set('filterOpened',isOpened);},showMoreRecords:function(evt){var self=this,options;_.each(this.collection.models,function(model){model.old=true;});var screenPosition=$('html').offset().top;options=this.context.get('filterOpened')?self.getSearchOptions():{};options.showAlerts=true;options.add=true;options.success=function(){self.layout.trigger("list:paginate:success");if(!self.disposed){self.render();window.scrollTo(0,-1*screenPosition);self.layout.$('tr.new').animate({opacity:1},500,function(){$(this).removeAttr('style class');});}};if(this.limit){options.limit=this.limit;}
options=_.extend({},this.context.get('collectionOptions'),options);this.collection.paginate(options);},getSearchOptions:function(){var collection,options,previousTerms,term='';collection=this.context.get('collection');if(app.cache.has('previousTerms')){previousTerms=app.cache.get('previousTerms');if(previousTerms){term=previousTerms[this.module];}}
options={params:{q:term},fields:collection.fields?collection.fields:this.collection};return options;},bindDataChange:function(){if(this.collection){this.collection.on("reset sync",function(){this.render();},this);}}})},"recordlist":{"controller":({extendsFrom:'FlexListView',plugins:['ListColumnEllipsis','ErrorDecoration','Editable','MergeDuplicates'],toggledModels:null,rowFields:{},contextEvents:{"list:editall:fire":"toggleEdit","list:editrow:fire":"editClicked","list:deleterow:fire":"warnDelete"},initialize:function(options){var recordListMeta=this._initializeMetadata();options.meta=_.extend({},recordListMeta,options.meta||{});app.view.invokeParent(this,{type:'view',name:'flex-list',method:'initialize',args:[options]});this.events=_.extend({},this.events,{'click [name=inline-cancel]':'resize'});this.on('list:toggle:column',this.resize,this);this.on('mergeduplicates:complete',this.refreshCollection,this);if(this.layout){this.layout.on('list:mergeduplicates:fire',this.mergeDuplicatesClicked,this);}
this.toggledModels={};this.context._recordListFields=this.getFieldNames();this._currentUrl=Backbone.history.getFragment();app.routing.before("route",this.beforeRouteDelete,this,true);$(window).on("beforeunload.delete"+this.cid,_.bind(this.warnDeleteOnRefresh,this));},_initializeMetadata:function(){return app.metadata.getView(null,'recordlist')||{};},refreshCollection:function(){this.collection.fetch();},addActions:function(){if(this.actionsAdded)return;app.view.invokeParent(this,{type:'view',name:'flex-list',method:'addActions'});if(_.isUndefined(this.leftColumns[0])){this.leftColumns.push({'type':'fieldset','label':'','sortable':false,'fields':[]});}
this.addFavorite();var firstLeftColumn=this.leftColumns[0];if(firstLeftColumn&&_.isArray(firstLeftColumn.fields)){firstLeftColumn.fields.push({type:'editablelistbutton',label:'LBL_CANCEL_BUTTON_LABEL',name:'inline-cancel',css_class:'btn-link btn-invisible inline-cancel'});this.leftColumns[0]=firstLeftColumn;}
var firstRightColumn=this.rightColumns[0];if(firstRightColumn&&_.isArray(firstRightColumn.fields)){firstRightColumn.css_class='overflow-visible';firstRightColumn.fields.push({type:'editablelistbutton',label:'LBL_SAVE_BUTTON_LABEL',name:'inline-save',css_class:'btn-primary'});this.rightColumns[0]=firstRightColumn;}
this.actionsAdded=true;},addFavorite:function(){var favoritesEnabled=app.metadata.getModule(this.module,"favoritesEnabled");if(favoritesEnabled!==false&&this.meta.favorite&&this.leftColumns[0]&&_.isArray(this.leftColumns[0].fields)){this.leftColumns[0].fields.push({type:'favorite'});}},_render:function(){app.view.invokeParent(this,{type:'view',name:'flex-list',method:'_render'});this.rowFields={};_.each(this.fields,function(field){if(field.model.id&&_.isUndefined(field.parent)){this.rowFields[field.model.id]=this.rowFields[field.model.id]||[];this.rowFields[field.model.id].push(field);}},this);},deleteModel:function(){var self=this,model=this._modelToDelete;model.destroy({showAlerts:{'process':true,'success':{messages:self.getDeleteMessages(self._modelToDelete).success}},success:function(){var redirect=self._targetUrl!==self._currentUrl;self._modelToDelete=null;self.collection.remove(model,{silent:redirect});if(redirect){self.unbindBeforeRouteDelete();app.router.navigate(self._targetUrl,{trigger:true});return;}
app.events.trigger("preview:close");if(!self.disposed){self.render();}
self.layout.trigger("list:record:deleted",model);}});},beforeRouteDelete:function(){if(this._modelToDelete){this.warnDelete(this._modelToDelete);return false;}
return true;},getDeleteMessages:function(model){var messages={},name=model.get('name')||(model.get('first_name')+' '+model.get('last_name'))||'',context=app.lang.get('LBL_MODULE_NAME_SINGULAR',model.module).toLowerCase()+' '+name.trim();messages.confirmation=app.lang.get('NTC_DELETE_CONFIRMATION')+context+'?';messages.success=app.lang.get('NTC_DELETE_SUCCESS')+context+'.';return messages;},warnDelete:function(model){var self=this;this._modelToDelete=model;self._targetUrl=Backbone.history.getFragment();if(self._targetUrl!==self._currentUrl){app.router.navigate(self._currentUrl,{trigger:false,replace:true});}
app.alert.show('delete_confirmation',{level:'confirmation',messages:self.getDeleteMessages(model).confirmation,onConfirm:_.bind(self.deleteModel,self),onCancel:function(){self._modelToDelete=null;}});},warnDeleteOnRefresh:function(){if(this._modelToDelete){return this.getDeleteMessages(this._modelToDelete).confirmation;}},hasUnsavedChanges:function(){var firstKey=_.first(_.keys(this.rowFields)),formFields=[];_.each(this.rowFields[firstKey],function(field){if(field.name){formFields.push(field.name);}
if(field.def.fields){formFields=_.chain(field.def.fields).pluck('name').compact().union(formFields).value();}},this);return _.some(_.values(this.toggledModels),function(model){var changedAttributes=model.changedAttributes(model.getSyncedAttributes());if(_.isEmpty(changedAttributes)){return false;}
var unsavedFields=_.intersection(_.keys(changedAttributes),formFields);return!_.isEmpty(unsavedFields);},this);},mergeDuplicatesClicked:function(){this.mergeDuplicates(this.context.get('mass_collection'));},editClicked:function(model){this.toggleRow(model.id,true);this.resize();},toggleRow:function(modelId,isEdit){if(isEdit){this.toggledModels[modelId]=this.collection.get(modelId);}else{delete this.toggledModels[modelId];}
this.$('tr[name='+this.module+'_'+modelId+']').toggleClass('tr-inline-edit',isEdit);this.toggleFields(this.rowFields[modelId],isEdit);},toggleEdit:function(isEdit){var self=this;this.viewName=isEdit?'edit':'list';_.each(this.rowFields,function(editableFields,modelId){_.defer(function(modelId){self.toggleRow(modelId,isEdit);},modelId);},this);},unbindBeforeRouteDelete:function(){app.routing.offBefore("route",this.beforeRouteDelete,this);$(window).off("beforeunload.delete"+this.cid);},_dispose:function(){this.unbindBeforeRouteDelete();this._super('_dispose');this.rowFields=null;},getFieldNames:function(module){var fields=app.view.View.prototype.getFieldNames.call(this,module);if(this.meta.favorite){fields=_.union(fields,['my_favorite']);}
return fields;}})},"baseedit":{"controller":({clearValidationError:function(model,fields){var self=this;if(!_.isEmpty(fields.changes)){_.each(fields.changes,function(num,key){var field=self.getField(key);if(field){var controlGroup=field.$el.parents('.control-group:first');if(controlGroup){controlGroup.removeClass("error");controlGroup.find('.add-on').remove();controlGroup.find('.help-block').html("");}}});}},handleValidationError:function(errors){var self=this;_.each(errors,function(fieldErrors,fieldName){var field=self.getField(fieldName);var ftag=this.fieldTag||'';if(field){var controlGroup=field.$el.parents('.control-group:first');if(controlGroup){controlGroup.addClass("error");controlGroup.find('.add-on').remove();controlGroup.find('.help-block').html("");if(field.$el.parent().parent().find('.input-append').length>0){field.$el.unwrap()}
field.$el.wrap('<div class="input-append  '+ftag+'">');_.each(fieldErrors,function(errorContext,errorName){controlGroup.find('.help-block').append(app.error.getErrorString(errorName,errorContext));});$('<span class="add-on"><i class="icon-exclamation-sign"></i></span>').insertBefore(controlGroup.find('.help-block'));}}});}})},"forecastdetails":{"controller":({plugins:['Dashlet','EllipsisInline'],likelyTotal:0,bestTotal:0,worstTotal:0,shouldRollup:false,selectedUser:{},isForecastSetup:false,isForecastAdmin:false,subDetailsTpl:{},detailsMsgTpl:{},detailsDataSet:{},forecastConfig:{},showTimeperiod:true,forecastsConfigOK:false,serverData:{},currentModule:'',spanCSS:'',initDataLoaded:false,events:{'click #forecastsProgressDisplayOptions div.datasetOptions label.radio':'changeDisplayOptions'},oldTotals:{},quotaCollection:undefined,noDataAccessTemplate:undefined,fieldDataAccess:{},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.currentModule=app.controller.context.get("module");this.forecastConfig=app.metadata.getModule('Forecasts','config');this.isForecastSetup=this.forecastConfig.is_setup;this.forecastsConfigOK=app.utils.checkForecastConfig();if(this.isForecastSetup&&this.forecastsConfigOK){this.serverData=new Backbone.Model();var aclModule=this.forecastConfig.forecast_by,likelyFieldName=(aclModule=='RevenueLineItems')?'likely_case':'amount';this.fieldDataAccess={likely:app.acl.hasAccess('read',aclModule,app.user.get('id'),likelyFieldName),best:app.acl.hasAccess('read',aclModule,app.user.get('id'),'best_case'),worst:app.acl.hasAccess('read',aclModule,app.user.get('id'),'worst_case')};var hasAccess=(this.fieldDataAccess.likely&&this.fieldDataAccess.best&&this.fieldDataAccess.worst);if(hasAccess===false){this.noDataAccessTemplate=app.template.getField('base','noaccess')(this);}
this.resetModel();this.context.get('model').module='Forecasts';this.selectedUser=app.user.toJSON();if(this.currentModule!='Home'){this.shouldRollup=this.isManagerView();}else{this.shouldRollup=this.selectedUser.is_manager;}
this.isForecastAdmin=_.isUndefined(app.user.getAcls()['Forecasts'].admin);this.subDetailsTpl=app.template.getView('forecastdetails.sub-details');this.detailsMsgTpl=app.template.getView('forecastdetails.details-msg');this.detailsDataSet=this.setUpShowDetailsDataSet(this.forecastConfig);this.checkSpanCSS();}},checkSpanCSS:function(){var ct=0;_.each([this.forecastConfig.show_worksheet_likely,this.forecastConfig.show_worksheet_best,this.forecastConfig.show_worksheet_worst],function(val)
{if(val){ct++;}});switch(ct){case 3:this.spanCSS='4';break;case 2:this.spanCSS='6';break;case 1:this.spanCSS='12';break;case 0:this.spanCSS='';break;}
this.model.set({spanCSS:this.spanCSS},{silent:true});},setUpShowDetailsDataSet:function(cfg){var ds=app.metadata.getStrings('app_list_strings')['forecasts_options_dataset']||[];var returnDs={};_.each(ds,function(value,key){if(cfg['show_worksheet_'+key]==1){returnDs[key]=value}},this);return returnDs;},resetModel:function(){var model={opportunities:0,closed_amount:undefined,quota_amount:undefined,deficit_amount:undefined,worst_details:undefined,likely_details:undefined,best_details:undefined,show_details_likely:this.forecastConfig.show_worksheet_likely,show_details_best:this.forecastConfig.show_worksheet_best,show_details_worst:this.forecastConfig.show_worksheet_worst,spanCSS:this.spanCSS,quota_amount_str:undefined,closed_amount_str:undefined,deficit_class:undefined,deficit_amount_str:undefined,isForecastSetup:this.isForecastSetup,isForecastAdmin:this.isForecastAdmin};if(this.context.get('model')){this.context.get('model').set(model)}else{this.model.set(model);}},getProjectedURL:function(){var method=this.shouldRollup?"progressManager":"progressRep",url='Forecasts/'+this.model.get('selectedTimePeriod')+'/'+method+'/'+this.selectedUser.id;return app.api.buildURL(url,'create');},bindDataChange:function(){if(this.meta.config){return;}
var ctx=this.model;if(this.currentModule=='Forecasts'){ctx=this.context.parent||this.context;this.showTimeperiod=false;}
ctx.on('change:selectedTimePeriod',function(model){if(this.currentModule=='Forecasts'){this.updateDetailsForSelectedTimePeriod(model.get('selectedTimePeriod'));}
this.loadData({});},this);if(this.currentModule=='Forecasts'){this.quotaCollection=app.utils.getSubpanelCollection(ctx,'ForecastManagerWorksheets');this.quotaCollection.on('reset',this.processQuotaCollection,this);this.quotaCollection.on('change:quota',function(data){var oldQuota=(this.getOldTotalFromCollectionById(data.get('id')))?this.getOldTotalFromCollectionById(data.get('id')).quota:0,newQuota=data.get('quota'),diff=app.math.sub(data.get('quota'),oldQuota),newQuotaTotal=app.math.add(this.serverData.get('quota_amount'),diff);this.setOldTotalFromCollectionById(data.get('id'),{quota:newQuota});this.calculateData({quota_amount:newQuotaTotal});},this);this.processQuotaCollection();ctx.on('change:selectedUser',function(model){this.updateDetailsForSelectedUser(model.get('selectedUser'));this.loadData({});},this);ctx.on('forecasts:worksheet:totals',function(data){this.calculateData(this.mapAllTheThings(data,true),true);},this);if(!_.has(ctx.attributes,'lhsData')){ctx.set({lhsData:{quotas:this.oldTotals}});}}},unbindData:function(){var ctx;if(this.currentModule&&this.currentModule=='Forecasts'){ctx=this.context.parent||this.context;}else{ctx=this.model;}
if(ctx){ctx.off(null,null,this);}
if(this.currentModule=='Forecasts'&&this.quotaCollection){this.quotaCollection.off();}
app.view.View.prototype.unbindData.call(this);},loadData:function(options){if(this.meta.config){return;}
if(!this.initDataLoaded){this.getInitData(options);}
if(!_.isEmpty(this.model.get('selectedTimePeriod'))){var url=this.getProjectedURL(),cb={context:this,success:this.handleNewDataFromServer,complete:options?options.complete:null};app.api.call('read',url,null,null,cb);}},getInitData:function(options){app.api.call('GET',app.api.buildURL('TimePeriods/current'),null,{success:_.bind(function(o){if(this.model){this.initDataLoaded=true;this.model.set({selectedTimePeriod:o.id},{silent:true});this.loadData();}},this),complete:options?options.complete:null});},processQuotaCollection:function(){var model=this.context.get('model')||this.model,newQuota=0,oldQuota=model.get('quota_amount'),quota=0;this.oldTotals.models=new Backbone.Model();_.each(this.quotaCollection.models,function(model){quota=model.get('quota');newQuota=app.math.add(newQuota,quota);this.setOldTotalFromCollectionById(model.get('id'),{quota:quota});},this);if(oldQuota!==newQuota){this.calculateData({quota_amount:newQuota});}},getOldTotalFromCollectionById:function(id){return this.oldTotals.models.get(id);},setOldTotalFromCollectionById:function(id,totals){this.oldTotals.models.set(id,totals);},_render:function(){app.view.View.prototype._render.call(this);this.renderSubDetails();},renderSubDetails:function(){if(this.$el&&this.subDetailsTpl){var subEl=this.$el.find('.forecast-details'),model=this.context.get('model')||this.model;if(!_.isUndefined(model.get('closed_amount'))&&!_.isUndefined(model.get('quota_amount'))){subEl.html(this.subDetailsTpl(model.toJSON()));this.renderCSSChanges(model);}else{subEl.html('');}}},renderCSSChanges:function(model){model=model||this.context.get('model')||this.model;var isDeficit=model.get('is_deficit');if(isDeficit){this.$el.find('.deficitRow').addClass(this.getClassBasedOnAmount(0,1,'color'));}else{this.$el.find('.deficitRow').addClass(this.getClassBasedOnAmount(1,0,'color'));}
this.checkPropertySetCSS('worst',model);this.checkPropertySetCSS('likely',model);this.checkPropertySetCSS('best',model);},checkPropertySetCSS:function(prop,model){model=model||this.context.get('model')||this.model;if(this.forecastConfig['show_worksheet_'+prop]&&(this.shouldRollup||(!this.shouldRollup&&this.fieldDataAccess[prop]))){var css=this.getClassBasedOnAmount(app.math.add(this.serverData.get(prop),this.serverData.get('closed_amount')),model.get('quota_amount'),'background-color');this.$el.find('#forecast_details_'+prop+'_feedback').addClass(css);}},mapAllTheThings:function(data,fromModel){if(this.shouldRollup){data.likely=data.likely_adjusted;data.best=data.best_adjusted;data.worst=data.worst_adjusted;}else{if(fromModel){data.likely=data.likely_case;}else{data.likely=data.amount;}
data.best=data.best_case;data.worst=data.worst_case;data.closed_amount=data.won_amount;if(_.isUndefined(data.closed_amount)){delete data.closed_amount;}}
if(fromModel){data.worst=app.math.sub(data.worst,(data.closed_amount||0));data.likely=app.math.sub(data.likely,(data.closed_amount||0));data.best=app.math.sub(data.best,(data.closed_amount||0));}
return data;},handleNewDataFromServer:function(data){if(this.currentModule=='Forecasts'&&this.context&&this.shouldRollup){var lhsData=this.context.get('lhsData');if(!lhsData&&_.has(this.context,'parent')&&!_.isNull(this.context.parent)){lhsData=this.context.parent.get('lhsData');}
if(lhsData&&!_.isEmpty(lhsData.quotas.models.attributes)){var lhsTotal=0;_.each(lhsData.quotas.models.attributes,function(val,key){lhsTotal=app.math.add(lhsTotal,val.quota);},this);if(lhsTotal!=parseFloat(data.quota_amount)){data.quota_amount=app.math.sub(data.quota_amount,app.math.sub(data.quota_amount,lhsTotal));}}}
this.calculateData(this.mapAllTheThings(data,false));},calculateData:function(data,fromModel){fromModel=fromModel||false;this.serverData.set(data);var d=_.extend({},data,this.serverData.toJSON());this.likelyTotal=d.likely;this.bestTotal=d.best;this.worstTotal=d.worst;d.quota_amount_str=app.currency.formatAmountLocale(d.quota_amount);d.closed_amount_str=app.currency.formatAmountLocale(d.closed_amount);d.deficit_amount=Math.abs(app.math.sub(d.quota_amount,d.closed_amount));d.deficit_amount_str=app.currency.formatAmountLocale(d.deficit_amount);d.is_deficit=(parseFloat(d.quota_amount)>parseFloat(d.closed_amount));var deficitLabelKey=(d.is_deficit)?'LBL_FORECAST_DETAILS_DEFICIT':'LBL_FORECAST_DETAILS_SURPLUS';d.deficit_label=app.lang.get(deficitLabelKey,'Forecasts');d.worst_details=this.detailsMsgTpl(this.getDetailsForCase('worst',this.worstTotal,d.quota_amount,d.closed_amount,fromModel));d.likely_details=this.detailsMsgTpl(this.getDetailsForCase('likely',this.likelyTotal,d.quota_amount,d.closed_amount,fromModel));d.best_details=this.detailsMsgTpl(this.getDetailsForCase('best',this.bestTotal,d.quota_amount,d.closed_amount,fromModel));if(this.shouldRollup){d.quota_label=app.lang.get('LBL_QUOTA_ADJUSTED','Forecasts');}else{d.quota_label=app.lang.get('LBL_QUOTA','Forecasts');}
if(this.context||this.model){var model=this.context.get('model')||this.model;if(model){model.set(d);this.renderSubDetails();}}},getDetailsForCase:function(caseStr,caseValue,stageValue,closedAmt,fromModel){var params={},caseValueN=app.math.add(caseValue,closedAmt),stageValueN=parseFloat(stageValue),openPipeline=0,calcValue=0;params.label=app.lang.get('LBL_'+caseStr.toUpperCase(),'Forecasts');params.spanCSS=this.spanCSS;params.case=caseStr;params.shortOrExceed='&nbsp;';params.openPipeline='&nbsp;';params.feedbackLn1='';params.feedbackLn2='';var hasAccess=true;if(!this.shouldRollup&&!this.fieldDataAccess[caseStr]){hasAccess=false;}
if(hasAccess)
{params.amount=app.currency.formatAmountLocale(caseValue);params.labelAmount=params.label+': '+params.amount.toString();if(caseValueN==0&&stageValueN==0){params.amount=app.lang.get('LBL_FORECAST_DETAILS_NO_DATA',"Forecasts");}else if(caseValueN!=0&&stageValueN!=0&&caseValueN==stageValueN){params.shortOrExceed=app.lang.get('LBL_FORECAST_DETAILS_MEETING_QUOTA',"Forecasts");}else{if(caseValueN>stageValueN){params.shortOrExceed=app.lang.get('LBL_FORECAST_DETAILS_EXCEED',"Forecasts");calcValue=app.math.sub(caseValueN,stageValueN);}else{params.shortOrExceed=app.lang.get('LBL_FORECAST_DETAILS_SHORT',"Forecasts");calcValue=app.math.sub(stageValueN,caseValueN);}
params.percent=this.getPercent(calcValue,stageValueN);params.openPipeline='('+app.currency.formatAmountLocale(calcValue)+')';}
params.feedbackLn1=params.shortOrExceed;if(params.percent){params.feedbackLn1+=' '+params.percent;}
params.feedbackLn2=params.openPipeline;}else{params.amount=this.noDataAccessTemplate;params.labelAmount=params.label+': '+app.lang.get('LBL_NO_FIELD_ACCESS');}
return params;},getAbsDifference:function(caseValue,stageValue){return app.currency.formatAmountLocale(Math.abs(stageValue-caseValue));},getClassBasedOnAmount:function(caseValue,stageValue,type){var cssClass='';caseValue=parseFloat(caseValue);stageValue=parseFloat(stageValue);if(type=='color'){if(caseValue==stageValue){}else if(caseValue>stageValue){cssClass='font-green';}else{cssClass='font-red'}}else if(type=='background-color'){if(caseValue==stageValue){cssClass='grayLight';}else if(caseValue>stageValue){cssClass='green';}else{cssClass='red';}}
return cssClass;},getPercent:function(caseValue,stageValue){var percent=0,calcValue=caseValue;if(stageValue>0&&caseValue>0){percent=(calcValue/stageValue)*100;if(percent>1){percent=Math.round(percent);}else{percent=Math.round(percent*100)/100;}}
return Math.abs(percent)+'%';},isManagerView:function(){var isMgrView=false;if(this.currentModule=='Forecasts'&&this.selectedUser.isManager==true&&(this.selectedUser.showOpps==undefined||this.selectedUser.showOpps===false))
{isMgrView=true;}
return isMgrView;},updateDetailsForSelectedTimePeriod:function(timePeriod){this.model.set({selectedTimePeriod:timePeriod});},updateDetailsForSelectedUser:function(selectedUser){this.selectedUser.last_name=selectedUser.last_name;this.selectedUser.first_name=selectedUser.first_name;this.selectedUser.full_name=selectedUser.full_name;this.selectedUser.id=selectedUser.id;this.selectedUser.isManager=selectedUser.isManager;this.selectedUser.reportees=selectedUser.reportees;this.selectedUser.showOpps=selectedUser.showOpps;this.selectedUser.user_name=selectedUser.user_name;this.shouldRollup=this.isManagerView();this.model.set({selectedUser:selectedUser});},changeDisplayOptions:function(evt){evt.preventDefault();this.handleOptionChange(evt);},handleOptionChange:function(evt){var $el=$(evt.currentTarget),changedSegment=$el.attr('data-set');if($el.hasClass('checked')){$el.removeClass('checked');$('div .projected_'+changedSegment).hide();}else{$el.addClass('checked');$('div .projected_'+changedSegment).show();}}})},"tabbed-dashlet":{"controller":({plugins:['Dashlet','Timeago'],events:{'click [data-action=show-more]':'showMore','click [data-action=tab-switcher]':'tabSwitcher','click [data-action=visibility-switcher]':'visibilitySwitcher'},initDashlet:function(){if(this.meta.config){return;}
this.collection=new Backbone.Collection();this._initMaxHeightTarget();this._initEvents();this._initTabs();this._initTemplates();},_initMaxHeightTarget:function(){this.maxHeightTarget=this.meta.max_height_target||'div.tab-content';return this;},_initEvents:function(){this.settings.on('change:filter',this.loadData,this);return this;},_initTabs:function(){this.tabs=[];_.each(this.dashletConfig.tabs,function(tab,index){if(tab.active){this.settings.set('activeTab',index);}
var collection=this._createCollection(tab);if(_.isNull(collection)){return;}
this.tabs[index]=tab;this.tabs[index].collection=collection;this.tabs[index].relate=_.isObject(collection.link);this.tabs[index].record_date=tab.record_date||'date_entered';if(tab.include_child_items){this.tabs[index].include_child_items=this.module==='Accounts'&&_.contains(['Calls','Meetings'],tab.module);}},this);return this;},_initTemplates:function(){this._tabsTpl=app.template.getView(this.name+'.tabs',this.module)||app.template.getView(this.name+'.tabs')||app.template.getView('tabbed-dashlet.tabs',this.module)||app.template.getView('tabbed-dashlet.tabs');this._toolbarTpl=app.template.getView(this.name+'.toolbar',this.module)||app.template.getView(this.name+'.toolbar')||app.template.getView('tabbed-dashlet.toolbar',this.module)||app.template.getView('tabbed-dashlet.toolbar');return this;},_getRecordsTemplate:function(module){this._recordsTpl=this._recordsTpl||{};if(!this._recordsTpl[module]){this._recordsTpl[module]=app.template.getView(this.name+'.records',module)||app.template.getView(this.name+'.records',this.module)||app.template.getView(this.name+'.records')||app.template.getView('tabbed-dashlet.records',this.module)||app.template.getView('tabbed-dashlet.records');}
return this._recordsTpl[module];},_createCollection:function(tab){if(this.context.parent){var module=this.context.parent.get('module');}else{var module=this.module;}
var meta=app.metadata.getModule(module);if(_.isUndefined(meta)){return null;}
var options={};if(meta.fields[tab.link]&&meta.fields[tab.link].type==='link'){options={link:{name:tab.link,bean:this.model}};}
var collection=app.data.createBeanCollection(tab.module,null,options);return collection;},_getCollectionOptions:function(index){var tab=this.tabs[index],options={limit:this.settings.get('limit'),offset:0,params:{order_by:tab.order_by||null,include_child_items:tab.include_child_items||null}};if(tab.module!='Meetings'&&tab.module!='Calls'){options.myItems=this.settings.get('visibility')==='user';}
return options;},_getCollectionFilters:function(index){var tab=this.tabs[index],filters=[];_.each(tab.filters,function(condition,field){var filter={};filter[field]=condition;filters.push(filter);});if((tab.module==='Meetings'||tab.module==='Calls')&&this.settings.get('visibility')==='user'){filters.push({"$or":[{"assigned_user_id":app.user.id},{"users.id":app.user.id}]});}
return filters;},_getFilters:function(index){return[];},loadData:function(options){options=options||{};if(this.disposed||this.meta.config){return;}
var self=this,totalFetches=0;_.each(this.tabs,function(tab,index){tab.collection.options=this._getCollectionOptions(index);tab.collection.filterDef=_.union(this._getCollectionFilters(index),this._getFilters(index));tab.collection.fetch({relate:tab.relate,complete:function(){totalFetches++;tab.collection.dataFetched=true;if(self.disposed||totalFetches<_.size(self.tabs)){return;}
self.collection=self.tabs[self.settings.get('activeTab')].collection;self.render();if(_.isFunction(options.complete)){options.complete.call(this);}}});},this);},showMore:function(){var self=this;this.collection.paginate({limit:this.settings.get('limit'),add:true,success:function(){if(!self.disposed){self.render();}}});},tabSwitcher:function(event){var index=this.$(event.currentTarget).data('index');if(index===this.settings.get('activeTab')){return;}
this.settings.set('activeTab',index);this.collection=this.tabs[index].collection;this.render();},visibilitySwitcher:function(event){var visibility=this.$(event.currentTarget).val();if(visibility===this.settings.get('visibility')){return;}
this.settings.set('visibility',visibility);this.layout.loadData();},_renderHtml:function(){if(this.meta.config){this._super('_renderHtml');return;}
var tab=this.tabs[this.settings.get('activeTab')];_.each(this.collection.models,function(model){model.set('record_date',model.get(tab.record_date));},this);var recordsTpl=this._getRecordsTemplate(tab.module);this.toolbarHtml=this._toolbarTpl(this);this.tabsHtml=this._tabsTpl(this);this.recordsHtml=recordsTpl(this);this._super('_renderHtml');},_dispose:function(){_.each(this.tabs,function(tab){tab.collection.off(null,null,this);});this._super('_dispose');}})},"selection-headerpane":{"controller":({extendsFrom:'HeaderpaneView',initialize:function(options){var moduleMeta=app.metadata.getModule(options.module),isBwcEnabled=(moduleMeta&&moduleMeta.isBwcEnabled),additionalEvents={};if(isBwcEnabled){options=this._removeCreateButton(options);}else{additionalEvents['click .btn[name=create_button]']='createAndSelect';this.events=_.extend({},this.events,additionalEvents);}
app.view.invokeParent(this,{type:'view',name:'headerpane',method:'initialize',args:[options]});},_renderHtml:function(){var titleTemplate=Handlebars.compile(app.lang.getAppString("LBL_SEARCH_AND_SELECT")),moduleName=app.lang.get("LBL_MODULE_NAME",this.module);this.title=titleTemplate({module:moduleName});app.view.invokeParent(this,{type:'view',name:'headerpane',method:'_renderHtml'});this.layout.on('selection:closedrawer:fire',function(){app.drawer.close();},this);},createAndSelect:function(){app.drawer.open({layout:'create-nodupecheck',context:{module:this.module,create:true}},_.bind(function(context,model){if(model){this.context.trigger('selection-list:select',model);}},this));},_removeCreateButton:function(options){if(options&&options.meta&&options.meta.buttons){options.meta.buttons=_.filter(options.meta.buttons,function(button){return(button.name!=='create_button');});}
return options;}})},"massupdate":{"controller":({events:{'click .add':'addItem','click .remove':'removeItem','click .btn[name=update_button]':'saveClicked','click .btn.cancel_button':'cancelClicked'},visible:false,fieldOptions:null,fieldValues:null,defaultOption:null,fieldPlaceHolderTag:'[name=fieldPlaceHolder]',massUpdateViewName:'massupdate-progress',_defaultSettings:{maxRecordsToMerge:5},initialize:function(options){this.fieldValues=[{}];this.setMetadata(options);app.view.View.prototype.initialize.call(this,options);this.setDefault();this.delegateListFireEvents();this.before('render',this.isVisible);app.routing.before("route",this.beforeRouteDelete,this,true);$(window).on("beforeunload.delete"+this.cid,_.bind(this.warnDeleteOnRefresh,this));},delegateListFireEvents:function(){this.layout.on("list:massupdate:fire",this.show,this);this.layout.on("list:massaction:hide",this.hide,this);this.layout.on("list:massdelete:fire",this.warnDelete,this);this.layout.on("list:massexport:fire",this.massExport,this);},setMetadata:function(options){options.meta.panels=options.meta.panels||[{fields:[]}];if(_.size(options.meta.panels[0].fields)===0){var moduleMetadata=app.metadata.getModule(options.module),massFields=[];_.each(moduleMetadata.fields,function(field){if(field.massupdate){var cloneField=app.utils.deepCopy(field);cloneField.label=field.label||field.vname;if(!cloneField.label)delete cloneField.label;if(cloneField.name==='team_name'){cloneField.type='teamset';cloneField.css_class='span9';cloneField={type:'fieldset',name:'team_name',label:cloneField.label,css_class:'row-fluid',fields:[cloneField,{'name':'team_name_type','type':'bool','text':'LBL_SELECT_APPEND_TEAMS','css_class':'span3'}]};}
if(cloneField.type==='bool'){cloneField.type='enum';cloneField.options='checkbox_dom';}
massFields.push(cloneField);}});options.meta.panels[0].fields=massFields;}},_render:function(){var result=app.view.View.prototype._render.call(this),self=this;if(this.$(".select2.mu_attribute")){this.$(".select2.mu_attribute").select2({width:'100%',minimumResultsForSearch:5}).on("change",function(evt){var $el=$(this),name=$el.select2('val'),index=$el.data('index');var option=_.find(self.fieldOptions,function(field){return field.name==name;});self.replaceUpdateField(option,index);self.placeField($el);});this.$(".select2.mu_attribute").each(function(){self.placeField($(this));});}
if(this.fields.length==0){this.hide();}
return result;},isVisible:function(){return this.visible;},placeField:function($el){var name=$el.select2('val'),index=$el.data('index'),fieldEl=this.getField(name).$el;if($el.not(".disabled")&&fieldEl){var holder=this.$(this.fieldPlaceHolderTag+"[index="+index+"]");this.$("#fieldPlaceHolders").append(holder.children());holder.html(fieldEl);}},addItem:function(evt){if(!$(evt.currentTarget).hasClass("disabled")){this.addUpdateField();this.render();}},removeItem:function(evt){var index=$(evt.currentTarget).data('index');this.removeUpdateField(index);this.render();},addUpdateField:function(){this.fieldValues.splice(this.fieldValues.length-1,0,this.defaultOption);this.defaultOption=null;this.setDefault();},removeUpdateField:function(index){var fieldValue=this.fieldValues[index];if(fieldValue){if(fieldValue.name){this.model.unset(fieldValue.name);this.fieldValues.splice(index,1);}else{var removed=this.fieldValues.splice(index-1,1);this.defaultOption=removed[0];}
this.setDefault();}},replaceUpdateField:function(selectedOption,targetIndex){var fieldValue=this.fieldValues[targetIndex];if(fieldValue.name){this.model.unset(fieldValue.name);this.fieldOptions.push(fieldValue);this.fieldValues[targetIndex]=selectedOption;}else{this.model.unset(this.defaultOption.name);this.fieldOptions.push(this.defaultOption);this.defaultOption=selectedOption;}},setDefault:function(){var assignedValues=_.pluck(this.fieldValues,'name');if(this.defaultOption){assignedValues=assignedValues.concat(this.defaultOption.name);}
this.fieldOptions=(this.meta)?_.reject(_.flatten(_.pluck(this.meta.panels,'fields')),function(field){return(field)?_.contains(assignedValues,field.name):false;}):[];this.defaultOption=this.defaultOption||this.fieldOptions.splice(0,1)[0];},getProgressView:function(){var progressView=this.layout.getComponent(this.massUpdateViewName);if(!progressView){progressView=app.view.createView({context:this.context,name:this.massUpdateViewName,layout:this.layout});this.layout._components.push(progressView);this.layout.$el.append(progressView.$el);}
progressView.render();return progressView;},getMassUpdateModel:function(baseModule){var massModel=this.context.get('mass_collection'),chunkSize=app.config.maxQueryResult,progressView=this.getProgressView(),massCollection=massModel?_.extend({},massModel,{defaultMethod:'update',module:'MassUpdate',baseModule:baseModule,maxAllowAttempt:3,chunks:null,discards:[],attempt:0,paused:false,resetProgress:function(){massModel.reset();this.length=0;},updateProgress:function(){this.remove(this.chunks.splice(0));massModel.length=this.length;},updateChunk:function(){if(!this.chunks){this.chunks=this.slice(0,chunkSize);this.trigger('massupdate:start');}
if(_.isEmpty(this.chunks)){this.chunks=this.slice(0,chunkSize);}},resumeFetch:function(){if(!this._pauseOptions){return;}
this.paused=false;this.trigger('massupdate:resume');this.fetch(this._pauseOptions);},pauseFetch:function(){this.paused=true;},sync:function(default_method,model,options){if(model.paused){this._pauseOptions=options;this.trigger('massupdate:pause');return;}
this.method=options.method;this.updateChunk();var callbacks={success:function(data,response){model.attempt=0;model.updateProgress();model.trigger('massupdate:done');if(model.length===0){model.trigger('massupdate:end');if(_.isFunction(options.success)){options.success(model,data,response);}}else{model.fetch(options);}},error:function(xhr,status,error){model.attempt++;model.trigger('massupdate:fail');if(model.attempt<=model.maxAllowAttempt){model.fetch(options);}else if(_.isFunction(options.error)){model.trigger('massupdate:end');options.error(xhr,status,error);}},complete:function(xhr,status){model.trigger('massupdate:always');if(_.isFunction(options.complete)){options.complete(xhr,status);}}},method=options.method||this.defaultMethod,data=this.getAttributes(options.attributes,method),url=app.api.buildURL(baseModule,this.module,data,options.params);app.api.call(method,url,data,callbacks);},getAttributes:function(attributes,action){return{massupdate_params:_.extend({'uid':(this.entire)?null:this.getAvailableList(action),'entire':this.entire,'filter':(this.entire)?this.filterDef:null},attributes)};},getAvailableList:function(action){var action2permission={'update':'edit','delete':'delete'},list=[];_.each(this.chunks,function(model){if(app.acl.hasAccessToModel(action2permission[action],model)!==false){list.push(model.id);}else{this.discards.push(model.id);}},this);return list;}}):null;progressView.initCollection(massCollection);return massCollection;},warnDelete:function(){var self=this;this._modelsToDelete=self.getMassUpdateModel(self.module);self._targetUrl=Backbone.history.getFragment();if(self._targetUrl!==self._currentUrl){app.router.navigate(self._currentUrl,{trigger:false,replace:true});}
self.hideAll();app.alert.show('delete_confirmation',{level:'confirmation',messages:app.lang.get('NTC_DELETE_CONFIRMATION_MULTIPLE'),onConfirm:_.bind(self.deleteModels,self),onCancel:function(){self._modelsToDelete=null;}});},warnDeleteOnRefresh:function(){if(this._modelsToDelete){return app.lang.get('NTC_DELETE_CONFIRMATION_MULTIPLE');}},deleteModels:function(){var self=this,collection=self._modelsToDelete;var lastSelectedModels=_.clone(collection.models);if(collection){collection.fetch({showAlerts:false,method:'delete',error:function(){app.alert.show('error_while_mass_update',{level:'error',title:app.lang.getAppString('ERR_INTERNAL_ERR_MSG'),messages:app.lang.getAppString('ERR_HTTP_500_TEXT'),autoClose:true});},success:function(data,response){self.layout.trigger("list:records:deleted",lastSelectedModels);var redirect=self._targetUrl!==self._currentUrl;if(response.status=='done'){self.layout.context.reloadData({showAlerts:false});}else if(response.status=='queued'){app.alert.show('jobqueue_notice',{level:'success',title:app.lang.getAppString('LBL_MASS_UPDATE_JOB_QUEUED'),autoClose:true});}
self._modelsToDelete=null;if(redirect){self.unbindBeforeRouteDelete();app.router.navigate(self._targetUrl,{trigger:true});}}});}},beforeRouteDelete:function(){if(this._modelsToDelete){this.warnDelete(this._modelsToDelete);return false;}
return true;},massExport:function(evt){this.hideAll();var massExport=this.context.get("mass_collection");var exportOptions;if(massExport){app.alert.show('massexport_loading',{level:'process',title:app.lang.getAppString('LBL_PORTAL_LOADING')});exportOptions=app.data.parseOptionsForSync("read",massExport).params;app.api.exportRecords({module:this.module,uid:(massExport.entire)?null:massExport.pluck('id'),entire:massExport.entire,filter:(massExport.entire)?exportOptions.filter:null},this.$el,{complete:function(data){app.alert.dismiss('massexport_loading');}});}},save:function(){var massUpdate=this.getMassUpdateModel(this.module),attributes=this.getAttributes(),self=this;this.once('massupdate:validation:complete',function(validate){var errors=validate.errors,emptyValues=validate.emptyValues,confirmMessage=app.lang.getAppString('LBL_MASS_UPDATE_EMPTY_VALUES');this.$(".fieldPlaceHolder .error").removeClass("error");this.$(".fieldPlaceHolder .help-block").hide();if(_.isEmpty(errors)){confirmMessage+='<br>['+emptyValues.join(',')+']<br>'+app.lang.getAppString('LBL_MASS_UPDATE_EMPTY_CONFIRM')+'<br>';if(massUpdate){var fetchMassupdate=_.bind(function(){var successMessages=this.buildSaveSuccessMessages(massUpdate);massUpdate.fetch({showAlerts:true,attributes:attributes,error:function(){app.alert.show('error_while_mass_update',{level:'error',title:app.lang.getAppString('ERR_INTERNAL_ERR_MSG'),messages:app.lang.getAppString('ERR_HTTP_500_TEXT'),autoClose:true});},success:function(data,response){self.hide();if(response.status=='done'){self.collection.fetch({showAlerts:false,relate:!!self.layout.collection.link});}else if(response.status=='queued'){app.alert.show('jobqueue_notice',{level:'success',messages:successMessages[response.status],autoClose:true});}}});},this);if(emptyValues.length==0){fetchMassupdate.call(this);}else{app.alert.show('empty_confirmation',{level:'confirmation',messages:confirmMessage,onConfirm:fetchMassupdate});}}}else{this.handleValidationError(errors);}},this);this.checkValidationError();},buildSaveSuccessMessages:function(massUpdateModel){return{done:app.lang.getAppString('LBL_MASS_UPDATE_SUCCESS'),queued:app.lang.getAppString('LBL_MASS_UPDATE_JOB_QUEUED')};},getAttributes:function(){var values=[this.defaultOption].concat(this.fieldValues),attributes=[],fieldFilter=function(field){return field&&field.name;};values=_.chain(values).union(_.chain(values).pluck("fields").compact().flatten().value()).uniq(fieldFilter).filter(fieldFilter).value();_.each(values,function(value){attributes=_.union(attributes,_.values(_.pick(value,'name','id_name')));if(value.name==='parent_name'){attributes.push('parent_id','parent_type');}},this);return _.pick(this.model.attributes,attributes);},checkValidationError:function(){var self=this,emptyValues=[],errors={},validator={},fields=_.initial(this.fieldValues).concat(this.defaultOption),i=0;var fieldsToValidate=_.filter(fields,function(f){return f.name;});if(_.size(fieldsToValidate)){_.each(fieldsToValidate,function(field){i++;validator={};validator[field.name]=field;field.required=(_.isBoolean(field.required)&&field.required)||(field.required&&field.required=='true')||false;var value=this.model.get(field.name);if(!value){emptyValues.push(app.lang.get(field.label,this.model.module));this.model.set(field.name,'',{silent:true});if(field.id_name){this.model.set(field.id_name,'',{silent:true});}}
this.model._doValidate(validator,errors,function(didItFail,fields,errors,callback){if(i===_.size(fieldsToValidate)){self.trigger('massupdate:validation:complete',{errors:errors,emptyValues:emptyValues});}});},this);}else{this.trigger('massupdate:validation:complete',{errors:errors,emptyValues:emptyValues});}
return;},handleValidationError:function(errors){var self=this;_.each(errors,function(fieldErrors,fieldName){var fieldEl=self.getField(fieldName).$el,errorEl=fieldEl.find(".help-block");fieldEl.addClass("error");if(errorEl.length==0){errorEl=$("<span>").addClass("help-block");errorEl.appendTo(fieldEl);}
errorEl.show().html("");_.each(fieldErrors,function(errorContext,errorName){errorEl.append(app.error.getErrorString(errorName,errorContext));});});},show:function(){this.hideAll();this.visible=true;this.defaultOption=null;this.model.clear();this.setDefault();var massModel=this.context.get('mass_collection');massModel.off(null,null,this);massModel.on('add remove reset massupdate:estimate',this.setDisabled,this);massModel.on('massupdate:start massupdate:end',this.setDisabledOnUpdate,this);this.$el.show();this.render();},hideAll:function(){this.layout.trigger("list:massaction:hide");},hide:function(){if(this.disposed){return;}
this.visible=false;this.$el.hide();},setDisabledOnUpdate:function(){var massUpdate=this.context.get('mass_collection');if(massUpdate.length==0){this.$('.btn[name=update_button]').removeClass('disabled');}else{this.$('.btn[name=update_button]').addClass('disabled');}},setDisabled:function(){var massUpdate=this.context.get('mass_collection');if(massUpdate.length==0||massUpdate.entire==true){this.$('.btn[name=update_button]').addClass('disabled');}else{this.$('.btn[name=update_button]').removeClass('disabled');}},saveClicked:function(evt){if(this.$(".btn[name=update_button]").hasClass("disabled")===false){this.save();}},cancelClicked:function(evt){this.hide();},unbindData:function(){var massModel=this.context.get("mass_collection");if(massModel){massModel.off(null,null,this);}
app.view.View.prototype.unbindData.call(this);},unbindBeforeRouteDelete:function(){app.routing.offBefore("route",this.beforeRouteDelete,this);$(window).off("beforeunload.delete"+this.cid);},_dispose:function(){this.unbindBeforeRouteDelete();this.$('.select2.mu_attribute').select2('destroy');app.view.View.prototype._dispose.call(this);}})},"alert":{"controller":({extendsFrom:app.view.AlertView,className:'alert-wrapper',events:{'click [data-action=cancel]':'cancelClicked','click [data-action=confirm]':'confirmClicked','click a':'linkClick'},LEVEL:{PROCESS:'process',SUCCESS:'success',WARNING:'warning',INFO:'info',ERROR:'error',CONFIRMATION:'confirmation'},initialize:function(options){this.onConfirm=options.onConfirm;this.onCancel=options.onCancel;this.onLinkClick=options.onLinkClick;this.alertLevel=options.level;this.templateOptions=options.templateOptions;this.name='alert';},render:function(options){if(_.isUndefined(options)){return this;}
var template=this.getAlertTemplate(options.level,options.messages,options.title,this.templateOptions);this.$el.html(template);this.$el.after('<br>');this.show(options.level);},show:function(level){this.$el.show();},close:function(){this.$el.fadeOut().remove();},cancel:function(){app.alert.dismiss(this.key);},cancelClicked:function(){if(_.isFunction(this.onCancel)){this.onCancel();}
this.cancel();},confirmClicked:function(){if(_.isFunction(this.onConfirm)){this.onConfirm();}
this.cancel();},linkClick:function(event){if(_.isFunction(this.onLinkClick)){this.onLinkClick(event);}},getAlertTemplate:function(level,messages,title,templateOptions){var template,alertClasses=this.getAlertClasses(level);title=title?title:this.getDefaultTitle(level);switch(level){case this.LEVEL.PROCESS:title=title.substr(-3)==='...'?title.substr(0,title.length-3):title;template=app.template.getView(this.name+'.process');break;case this.LEVEL.SUCCESS:case this.LEVEL.WARNING:case this.LEVEL.INFO:case this.LEVEL.ERROR:template=app.template.getView(this.name+'.error');break;case this.LEVEL.CONFIRMATION:template=app.template.getView(this.name+'.confirmation');break;default:template=app.template.empty;}
var seed=_.extend({},{alertClass:alertClasses,title:this.getTranslatedLabels(title),messages:this.getTranslatedLabels(messages)},templateOptions);return template(seed);},getAlertClasses:function(level){switch(level){case this.LEVEL.PROCESS:return'alert-process';case this.LEVEL.SUCCESS:return'alert-success';case this.LEVEL.WARNING:return'alert-warning';case this.LEVEL.INFO:return'alert-info';case this.LEVEL.ERROR:return'alert-danger';case this.LEVEL.CONFIRMATION:return'alert-warning';default:return'';}},getDefaultTitle:function(level){switch(level){case this.LEVEL.PROCESS:return'LBL_ALERT_TITLE_LOADING';case this.LEVEL.SUCCESS:return'LBL_ALERT_TITLE_SUCCESS';case this.LEVEL.WARNING:return'LBL_ALERT_TITLE_WARNING';case this.LEVEL.INFO:return'LBL_ALERT_TITLE_NOTICE';case this.LEVEL.ERROR:return'LBL_ALERT_TITLE_ERROR';case this.LEVEL.CONFIRMATION:return'LBL_ALERT_TITLE_WARNING';default:return'';}},getTranslatedLabels:function(stringOrArray){var result;if(_.isArray(stringOrArray)){result=_.map(stringOrArray,function(text){return app.lang.getAppString(text);});}else{result=app.lang.getAppString(stringOrArray);}
return result;},close:function(){this.$el.next('br').remove();this._super('close');},bindDataChange:function(){}})},"access-denied":{"controller":({className:'access-denied tcenter',cubeOptions:{spin:false},events:{'click .sugar-cube':'spinCube'},spinCube:function(){this.cubeOptions.spin=!this.cubeOptions.spin;this.render();}})},"history":{"controller":({extendsFrom:'TabbedDashletView',plugins:['LinkedModel','Dashlet','Timeago'],initialize:function(options){options.meta=options.meta||{};options.meta.template='tabbed-dashlet';app.view.invokeParent(this,{type:'view',name:'tabbed-dashlet',method:'initialize',platform:'base',args:[options]});},_getFilters:function(index){var filterDate=new Date();filterDate.setDate(filterDate.getDate()-this.settings.get('filter'));var filterStr=app.date.format(filterDate,'Y-m-d');var tab=this.tabs[index],filter={},filters=[];filter[tab.filter_applied_to]={$gte:filterStr};filters.push(filter);return filters;},createRecord:function(event,params){var bwcExceptions=['Emails'],meta=app.metadata.getModule(params.module)||{};if(meta.isBwcEnabled&&!_.contains(bwcExceptions,params.module)){this._createBwcRecord(params.module,params.link);return;}
this.createRelatedRecord(params.module,params.link);},_createBwcRecord:function(module,link){if(this.module!=='Home'){app.bwc.createRelatedRecord(module,this.model,link);return;}
var params={return_module:this.module,return_id:this.model.id};var route=app.bwc.buildRoute(module,null,'EditView',params);app.router.navigate(route,{trigger:true});},_openCreateDrawer:function(module,layout){layout=layout||'create-actions';app.drawer.open({layout:layout,context:{create:true,module:module,prepopulate:this._prePopulateDrawer(module)}},_.bind(function(context,newModel){if(newModel&&newModel.id){this.layout.loadData();}},this));},_prePopulateDrawer:function(module){var data={related:this.model};if(module==='Emails'){data['to_addresses']=this.model;}
return data;},_renderHtml:function(){if(this.meta.config){app.view.View.prototype._renderHtml.call(this);return;}
_.each(this.collection.models,function(model){var pictureUrl=app.api.buildFileURL({module:'Users',id:model.get('assigned_user_id'),field:'picture'});model.set('picture_url',pictureUrl);},this);app.view.invokeParent(this,{type:'view',name:'tabbed-dashlet',method:'_renderHtml',platform:'base'});},_dispose:function(){this.$('.select2').select2('destroy');app.view.invokeParent(this,{type:'view',name:'tabbed-dashlet',method:'_dispose',platform:'base'});}})},"dashlet-toolbar":{"controller":({className:'widget-header',cssIconDefault:'icon-cog',cssIconRefresh:'icon-refresh icon-spin',defaultActions:{'dashlet:edit:clicked':'editClicked','dashlet:refresh:clicked':'refreshClicked','dashlet:delete:clicked':'removeClicked','dashlet:toggle:clicked':'toggleMinify'},plugins:['Tooltip'],initialize:function(options){_.extend(options.meta,app.metadata.getView(null,'dashlet-toolbar'),options.meta.toolbar);app.view.View.prototype.initialize.call(this,options);},refreshClicked:function(){var $el=this.$("[data-action=loading]"),self=this,options={};if($el.length>0){$el.removeClass(this.cssIconDefault).addClass(this.cssIconRefresh);options.complete=function(){if(self.disposed){return;}
$el.removeClass(self.cssIconRefresh).addClass(self.cssIconDefault);};}
this.layout.reloadDashlet(options);},removeClicked:function(evt){this.layout.removeDashlet();},editClicked:function(evt){this.layout.editDashlet();},toggleClicked:function(evt){var $btn=$(evt.currentTarget),expanded=_.isUndefined($btn.data('expanded'))?true:$btn.data('expanded'),label=expanded?'LBL_DASHLET_MAXIMIZE':'LBL_DASHLET_MINIMIZE';$btn.html(app.lang.get(label,this.module));this.layout.collapse(expanded);$btn.data('expanded',!expanded);},toggleMinify:function(evt){var $el=this.$('.dashlet-toggle > i'),collapsed=$el.is('.icon-chevron-up');this.layout.collapse(collapsed);}})},"edit":{"controller":({extendsFrom:'BaseeditView',events:{'click [name=save_button]':'saveModel'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.context.off("subnav:save",null,this);this.context.on("subnav:save",this.saveModel,this);this.model.on("error:validation",this.handleValidationError,this);},saveModel:function(){var self=this,deleteIfFails=_.isUndefined(self.model.id);this.model.save(null,{success:function(){app.alert.dismiss('save_edit_view');app.file.checkFileFieldsAndProcessUpload(self,{success:function(){app.navigate(self.context,self.model,'detail');}},{deleteIfFails:false});},fieldsToValidate:this.getFields(this.module)});},checkFileFieldsAndProcessUpload:function(model,callbacks){callbacks=callbacks||{};var $files=_.filter($(":file"),function(file){var $file=$(file);return($file.val()&&$file.attr("name")&&$file.attr("name")!=="")?$file.val()!=="":false;});var filesToUpload=$files.length;if(filesToUpload>0){app.alert.show('upload',{level:'process',title:'LBL_UPLOADING',autoclose:false});for(var file in $files){var $file=$($files[file]),fileField=$file.attr("name");model.uploadFile(fileField,$file,{field:fileField,success:function(){filesToUpload--;if(filesToUpload===0){app.alert.dismiss('upload');if(callbacks.success)callbacks.success();}},error:function(error){filesToUpload--;if(filesToUpload===0){app.alert.dismiss('upload');}
var errors={};errors[error.responseText]={};model.trigger('error:validation:'+this.field,errors);model.trigger('error:validation');}});}}
else{if(callbacks.success)callbacks.success();}},_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);if(!this.model.id){this.context.trigger('subnav:set:title',app.lang.get('LBL_NEW_FORM_TITLE',this.module));}}})},"headerpane":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);if(this.meta&&this.meta.title){this.title=this.meta.title;}
this.context.on("headerpane:title",function(title){this.title=title;if(!this.disposed)this.render();},this);},_renderHtml:function(){var title=this.title||this.module;this.title=app.lang.get(title,this.module);app.view.View.prototype._renderHtml.call(this);}})},"filtered-list":{"controller":({extendsFrom:'ListView',filteredCollection:[],searchTerm:'',_patternToReg:{startsWith:'^(term)',endsWith:'(term)$',contains:'(term)'},_initFilter:function(){var filter=this._filter||_.chain(this.getFields()).filter(function(field){return field.filter;}).map(function(field){return{name:field.name,label:app.lang.get(field.label,this.module),filter:field.filter};},this).value();this.context.trigger('filteredlist:filter:set',_.pluck(filter,'label'));if(_.isEmpty(filter)){return;}
this._filter=filter;},filterCollection:function(){var term=this.searchTerm,filter=this._filter;if(!_.isEmpty(term)&&_.isString(term)){this.filteredCollection=this.collection.filter(function(model){return _.some(filter,function(params){var pattern=this._patternToReg[params.filter].replace('term',term),tester=new RegExp(pattern,'i');return tester.test(model.get(params.name));},this);},this);}},setSearchTerm:function(term){this.searchTerm=term;this._renderData();},setOrderBy:function(event){this._super('setOrderBy',[event]);this.collection.comparator=function(model){return model.get(this.orderBy.field);};if(this.orderBy.direction==='desc'){this.collection.sort({silent:true});this.collection.models.reverse();this.collection.trigger('sort',this.collection);}else{this.collection.sort();}},bindDataChange:function(){this.on('render',this._initFilter,this);if(this.collection){this.collection.on('reset sort',this._renderData,this);}
this.context.on('filteredlist:search:fired',this.setSearchTerm,this);},_renderData:function(){this.filteredCollection=this.collection.models;this.filterCollection();this.render();}})},"dashletconfiguration-headerpane":{"controller":({events:{"click a[name=cancel_button]":"close","click a[name=save_button]":"save"},save:function(){app.drawer.close(this.model);},close:function(){app.drawer.close();},_renderHtml:function(){var label;this.model=this.layout.context.get("model");label=app.lang.get(this.model.get('label'),this.model.get('module')||this.module,this.model.attributes);this.model.set('label',label);app.view.View.prototype._renderHtml.call(this);}})},"dashletselect-headerpane":{"controller":({events:{"click a[name=cancel_button]":"close"},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.title=app.lang.get(this.meta.title,this.module);},close:function(){app.drawer.close();}})},"preview-header":{"controller":({className:'preview-headerbar',events:{'click [data-direction]':'triggerPagination','click .preview-headerbar .closeSubdetail':'triggerClose'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);if(this.layout){this.layout.off("preview:pagination:update",null,this);this.layout.on("preview:pagination:update",this.render,this);}},triggerPagination:function(e){var direction=this.$(e.currentTarget).data();this.layout.trigger("preview:pagination:fire",direction);},triggerClose:function(){app.events.trigger("list:preview:decorate",null,this);app.events.trigger("preview:close");}})},"filter-rows":{"controller":({events:{'click a.addme':'addRow','click a.removeme':'removeRow','change .filter-field input[type=hidden]':'handleFieldSelected','change .filter-operator input[type=hidden]':'handleOperatorSelected'},className:'filter-definition-container',filterFields:[],lastFilterDef:[],fieldTypeMap:{'datetime':'date','datetimecombo':'date'},initialize:function(opts){this.formRowTemplate=app.template.get("filter-rows.filter-row-partial");this.filterOperatorMap=app.lang.getAppListStrings("filter_operators_dom");app.view.View.prototype.initialize.call(this,opts);this.listenTo(this.layout,"filterpanel:change:module",this.handleFilterChange);this.listenTo(this.layout,"filter:create:open",this.openForm);this.listenTo(this.layout,"filter:create:close",this.render);this.listenTo(this.layout,"filter:create:save",this.saveFilter);this.listenTo(this.layout,"filter:create:delete",this.deleteFilter);this.listenTo(this.layout,"filter:create:validate",this.validateRows);},handleFilterChange:function(moduleName){var moduleMeta=app.metadata.getModule(moduleName);if(!moduleMeta){return;}
this.fieldList=this.getFilterableFields(moduleName);this.filterFields={};this.moduleName=moduleName;_.each(this.fieldList,function(value,key){var text=app.lang.get(value.vname,moduleName);var type=this.fieldTypeMap[value.type]||value.type;if((this.filterOperatorMap[type]||value.predefined_filter===true)&&!_.isUndefined(text)){this.filterFields[key]=text;}},this);},openForm:function(filterModel){if(!filterModel.get('filter_definition')){this.render();this.addRow();}else{this.populateFilter();}},saveFilter:function(name){var self=this,obj={filter_definition:this.buildFilterDef(),name:name,module_name:this.moduleName};this.layout.editingFilter.save(obj,{success:function(model){self.layout.trigger("filter:add",model);self.layout.trigger("filter:create:rowsValid",false);},alerts:{'success':{title:app.lang.get("LBL_EMAIL_SUCCESS")+":",messages:app.lang.get("LBL_FILTER_SAVE")+" "+name}}});this.layout.trigger('filter:create:close');},deleteFilter:function(){var self=this,name=this.layout.editingFilter.get('name');this.layout.editingFilter.destroy({success:function(model){self.layout.trigger("filter:remove",model);},alerts:{'success':{title:app.lang.get('LBL_EMAIL_SUCCESS')+':',message:app.lang.get('LBL_DELETED')+' '+name}}});this.layout.trigger('filter:create:close');},getFilterableFields:function(moduleName){var moduleMeta=app.metadata.getModule(moduleName),fieldMeta=moduleMeta.fields,fields={};if(moduleMeta.filters){_.each(moduleMeta.filters,function(templateMeta){if(templateMeta.meta&&templateMeta.meta.fields){fields=_.extend(fields,templateMeta.meta.fields);}});}
_.each(fields,function(fieldFilterDef,fieldName){if(_.isEmpty(fieldFilterDef)){fields[fieldName]=fieldMeta[fieldName]||{};}else{fields[fieldName]=_.extend({name:fieldName},fieldFilterDef,fieldMeta[fieldName]);}
delete fields[fieldName]['readonly'];});return fields;},createField:function(model,def){var obj={meta:{view:"edit"},def:def,model:model,context:app.controller.context,viewName:"edit",view:this};var field=app.view.createField(obj);return field;},addRow:function(e){var $row,model,field,$fieldValue,$fieldContainer;if(e){$row=this.$(e.currentTarget).parents('.filter-body');$row.after(this.formRowTemplate());$row=$row.next();}else{$row=$(this.formRowTemplate()).appendTo(this.$el);}
model=app.data.createBean(this.moduleName);field=this.createField(model,{type:'enum',options:this.filterFields});$fieldValue=$row.find('.filter-field');$fieldContainer=$(field.getPlaceholder().string);$fieldContainer.appendTo($fieldValue);$row.data('nameField',field);this._renderField(field);this.layout.trigger("filter:create:rowsValid",false);return $row;},removeRow:function(e){var $row=this.$(e.currentTarget).parents('article.filter-body'),fieldOpts=[{'field':'nameField','value':'name'},{'field':'operatorField','value':'operator'},{'field':'valueField','value':'value'}];this._disposeFields($row,fieldOpts);$row.remove();this.validateRows();if(this.$('article.filter-body').length===0){this.addRow();}},validateRows:function(){var isValid=true,$rows=this.$('article.filter-body');_.each($rows,function(row){if(!isValid)return false;isValid=this.validateRow($(row));},this);this.layout.trigger("filter:create:rowsValid",isValid);return isValid;},validateRow:function($row){var data=$row.data();if(data.isDateRange||data.isPredefinedFilter){return true;}
var needTwoValues=['$between','$dateBetween'];if(_.indexOf(needTwoValues,data.operator)>-1){if(_.isArray(data.value)&&data.value.length===2){if(data.operator==="$between"){return _.isNumber(data.value[0])&&_.isNumber(data.value[1]);}
if(data.operator==="$dateBetween"){return!_.isUndefined(data.value[0])&&!_.isUndefined(data.value[1]);}}else{return false;}}
return _.isNumber(data.value)||!_.isEmpty(data.value);},populateFilter:function(){var filterDef=this.layout.editingFilter.get("filter_definition"),name=this.layout.editingFilter.get("name");this.render();this.layout.trigger("filter:set:name",name);_.each(filterDef,function(row){this.populateRow(row);},this);this.lastFilterDef=this.buildFilterDef();},populateRow:function(rowObj){var $row=this.addRow();_.each(rowObj,function(value,key){if(key==="$or"){var keys=_.reduce(value,function(memo,obj){return memo.concat(_.keys(obj));},[]);key=_.find(_.keys(this.fieldList),function(key){if(_.has(this.fieldList[key],'dbFields')){return _.isEqual(this.fieldList[key].dbFields.sort(),keys.sort());}},this);value=_.values(value[0])[0];}
if(!this.fieldList[key]){var relate=_.find(this.fieldList,function(field){return field.id_name===key;});key=relate.name;}
$row.find('.filter-field input[type=hidden]').select2('val',key).trigger('change');if(_.isString(value)){value={"$equals":value};}
_.each(value,function(value,operator){$row.data('value',value);$row.find('.filter-operator input[type=hidden]').select2('val',operator==='$dateRange'?value:operator).trigger('change');});},this);},handleFieldSelected:function(e){var $el=this.$(e.currentTarget),$row=$el.parents('.filter-body'),$fieldWrapper=$row.find('.filter-operator'),data=$row.data(),fieldName=$el.val(),fieldOpts=[{'field':'operatorField','value':'operator'},{'field':'valueField','value':'value'}];this._disposeFields($row,fieldOpts);data['name']=fieldName;if(!fieldName){return;}
data.id_name=this.fieldList[fieldName].id_name;if(this.fieldList[fieldName].predefined_filter===true){data.isPredefinedFilter=true;this.fireSearch();return;}
var fieldType=this.fieldTypeMap[this.fieldList[fieldName].type]||this.fieldList[fieldName].type,payload={},types=_.keys(this.filterOperatorMap[fieldType]);$fieldWrapper.removeClass('hide').empty();$row.find('.filter-value').addClass('hide').empty();_.each(types,function(operand){payload[operand]=this.filterOperatorMap[fieldType][operand];},this);var model=app.data.createBean(this.moduleName);var field=this.createField(model,{type:'enum',searchBarThreshold:9999,options:payload}),$field=$(field.getPlaceholder().string);$field.appendTo($fieldWrapper);data['operatorField']=field;this._renderField(field);},handleOperatorSelected:function(e){var $el=this.$(e.currentTarget),$row=$el.parents('.filter-body'),data=$row.data(),operation=$el.val(),fieldOpts=[{'field':'valueField','value':'value'}];this._disposeFields($row,fieldOpts);data['operator']=operation;if(!operation){return;}
var moduleName=this.moduleName,module=app.metadata.getModule(moduleName),fields=app.metadata._patchFields(moduleName,module,app.utils.deepCopy(this.fieldList));var fieldName=$row.find('.filter-field input[type=hidden]').select2('val'),fieldType=this.fieldTypeMap[this.fieldList[fieldName].type]||this.fieldList[fieldName].type,fieldDef=fields[fieldName];switch(fieldType){case'enum':fieldDef.isMultiSelect=true;fieldDef.searchBarThreshold=9999;break;case'bool':fieldDef.type='enum';fieldDef.searchBarThreshold=9999;break;case'int':fieldDef.auto_increment=false;break;case'teamset':fieldDef.type='relate';break;case'datetimecombo':case'date':fieldDef.type='date';data.isDate=true;if(operation.charAt(0)!=='$'){data.isDateRange=true;this.fireSearch();return;}
break;case'relate':fieldDef.auto_populate=true;break;}
data.isRequired=fieldDef.required;var model=app.data.createBean(moduleName);var $fieldValue=$row.find('.filter-value');$fieldValue.removeClass('hide').empty();var _keyUpCallback=function(e){if($(e.currentTarget).is(".select2-input")){return;}
this.value=$(e.currentTarget).val();model.set(this.name,this.unformat($(e.currentTarget).val()),{silent:true});model.trigger('change');};if(operation==='$between'||operation==='$dateBetween'){var minmax=[],value=$row.data('value')||[];model.set(fieldName+'_min',value[0]||'');model.set(fieldName+'_max',value[1]||'');minmax.push(this.createField(model,_.extend({},fieldDef,{name:fieldName+'_min'})));minmax.push(this.createField(model,_.extend({},fieldDef,{name:fieldName+'_max'})));if(operation==='$dateBetween'){minmax[0].label=app.lang.get('LBL_FILTER_DATEBETWEEN_FROM');minmax[1].label=app.lang.get('LBL_FILTER_DATEBETWEEN_TO');}else{minmax[0].label=app.lang.get('LBL_FILTER_BETWEEN_FROM');minmax[1].label=app.lang.get('LBL_FILTER_BETWEEN_TO');}
data['valueField']=minmax;_.each(minmax,function(field){var fieldContainer=$(field.getPlaceholder().string);$fieldValue.append(fieldContainer);this.listenTo(field,'render',function(){field.$('input, select, textarea').addClass('inherit-width');field.$('.input-append').prepend('<span class="add-on">'+field.label+'</span>');field.$('.input-append').addClass('input-prepend');field.$('.input-append').removeClass('date');field.$('input, textarea').on('keyup',_.debounce(_.bind(_keyUpCallback,field),400));});this._renderField(field);},this);}else{model.set(fieldDef.id_name||fieldName,$row.data('value'));var field=this.createField(model,_.extend({},fieldDef,{name:fieldName})),fieldContainer=$(field.getPlaceholder().string);$fieldValue.append(fieldContainer);data['valueField']=field;this.listenTo(field,'render',function(){field.$('input, select, textarea').addClass('inherit-width');field.$('.input-append').removeClass('date');field.$('input, textarea').on('keyup',_.debounce(_.bind(_keyUpCallback,field),400));});if(fieldType==='relate'&&$row.data('value')){var self=this,findRelatedName=app.data.createBeanCollection(fieldDef.module);findRelatedName.fetch({fields:[fieldDef.rname],params:{filter:[{'id':$row.data('value')}]},complete:function(){if(!self.disposed){if(findRelatedName.first()){model.set(fieldName,findRelatedName.first().get(fieldDef.rname),{silent:true});}
self._renderField(field);}}});}else{this._renderField(field);}}
this.listenTo(model,"change",function(){this._updateFilterData($row);this.fireSearch();});var modelValue=model.get(fieldDef.id_name||fieldName);if(!_.isEmpty(modelValue)&&modelValue!==$row.data('value')){model.trigger('change');}},_updateFilterData:function($row){var data=$row.data(),field=data['valueField'],name=data['name'],valueForFilter;if(this.fieldList[name]&&this.fieldList[name].id_name){name=this.fieldList[name].id_name;}
if(_.isArray(field)){valueForFilter=[];_.each(field,function(field){var value=!field.disposed&&field.model.has(field.name)?field.model.get(field.name):'';value=$row.data('isDate')?app.date.stripIsoTimeDelimterAndTZ(value):value;valueForFilter.push(value);});}else{var value=!field.disposed&&field.model.has(name)?field.model.get(name):'';valueForFilter=$row.data('isDate')?app.date.stripIsoTimeDelimterAndTZ(value):value;}
$row.data("value",valueForFilter);},fireSearch:_.debounce(function(){var filterDef=this.buildFilterDef();if(_.isEqual(this.lastFilterDef,filterDef)){return;}
this.validateRows();this.lastFilterDef=filterDef;this.layout.trigger('filter:apply',null,filterDef);},400),buildFilterDef:function(){var $rows=this.$('article.filter-body'),filter=[];_.each($rows,function(row){var rowFilter=this.buildRowFilterDef($(row));if(rowFilter){filter.push(rowFilter);}},this);return filter;},buildRowFilterDef:function($row){var data=$row.data();if(!this.validateRow($row)){return;}
var operator=data['operator'],value=data['value'],name=data['id_name']||data['name'],filter={};if(data.isPredefinedFilter){filter[name]="";return filter;}else{if(this.fieldList[name]&&_.has(this.fieldList[name],'dbFields')){var subfilters=[];_.each(this.fieldList[name].dbFields,function(dbField){var filter={};filter[dbField]={};filter[dbField][operator]=value;subfilters.push(filter);});filter["$or"]=subfilters;}else{if(operator==="$equals"){filter[name]=value;}else if(data.isDateRange){filter[name]={};filter[name].$dateRange=operator;}else if(operator==="$in"||operator==="$not_in"){filter[name]={};filter[name][operator]=_.isArray(value)?value:[value];}else{filter[name]={};filter[name][operator]=value;}}
return filter;}},_disposeFields:function($row,opts){var data=$row.data(),model;if(_.isObject(data)&&_.isArray(opts)){_.each(opts,function(val){if(data[val.field]){var fields=_.isArray(data[val.field])?data[val.field]:[data[val.field]];data[val.value]="";_.each(fields,function(field){model=field.model;if(val.field==="valueField"&&model){model.clear({silent:true});this.stopListening(model);}
field.dispose();field=null;},this);}},this);}
data.isDate=false;data.isDateRange=false;data.isPredefinedFilter=false;$row.data(data);this.fireSearch();}})},"create":{"controller":({extendsFrom:'RecordView',editAllMode:false,SAVEACTIONS:{SAVE_AND_CREATE:'saveAndCreate',SAVE_AND_VIEW:'saveAndView'},enableDuplicateCheck:false,dupecheckList:null,saveButtonName:'save_button',cancelButtonName:'cancel_button',saveAndCreateButtonName:'save_create_button',saveAndViewButtonName:'save_view_button',restoreButtonName:'restore_button',initialize:function(options){var createViewEvents={};createViewEvents['click a[name='+this.saveButtonName+']']='save';createViewEvents['click a[name='+this.cancelButtonName+']']='cancel';createViewEvents['click a[name='+this.saveAndCreateButtonName+']']='saveAndCreate';createViewEvents['click a[name='+this.saveAndViewButtonName+']']='saveAndView';createViewEvents['click a[name='+this.restoreButtonName+']']='restoreModel';this.events=_.extend({},this.events,createViewEvents);this.plugins=_.union(this.plugins||[],['FindDuplicates']);this.STATE=_.extend({},this.STATE,{CREATE:'create',SELECT:'select',DUPLICATE:'duplicate'});app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this.model.off("change",null,this);this.context.lastSaveAction=null;this.context.on('list:dupecheck-list-select-edit:fire',this.editExisting,this);this.meta=_.extend({},app.metadata.getView(this.module,'record'),this.meta);var moduleMetadata=app.metadata.getModule(this.module);this.enableDuplicateCheck=(moduleMetadata&&moduleMetadata.dupCheckEnabled)||false;var fields=(moduleMetadata&&moduleMetadata.fields)?moduleMetadata.fields:[];this.model.relatedAttributes=this.model.relatedAttributes||{};_.each(fields,function(field){var userId,userName,isDuplicate;if(((field.name&&field.name==='assigned_user_id')||(field.id_name&&field.id_name==='assigned_user_id'))&&(field.type&&field.type==='relate')){isDuplicate=this.model.has('assigned_user_id')&&this.model.has('assigned_user_name');userId=isDuplicate?this.model.get('assigned_user_id'):app.user.id;userName=isDuplicate?this.model.get('assigned_user_name'):app.user.attributes.full_name;this.model.set('assigned_user_id',userId);this.model.set('assigned_user_name',userName);this.model.relatedAttributes.assigned_user_id=app.user.id;this.model.relatedAttributes.assigned_user_name=app.user.attributes.full_name;}},this);this.model.on("error:validation",function(){this.alerts.showInvalidModel();},this);},hasUnsavedChanges:function(){if(this.resavingAfterMetadataSync)
return false;return this.model.isNew()&&this.model.hasChanged();},handleSync:function(){},delegateButtonEvents:function(){},_render:function(){app.view.invokeParent(this,{type:'view',name:'record',method:'_render'});this.setButtonStates(this.STATE.CREATE);this.renderDupeCheckList();app.events.trigger('create:model:changed',false);this.model.on('change',function(){app.events.trigger('create:model:changed',this.hasUnsavedChanges());},this);},save:function(){switch(this.context.lastSaveAction){case this.SAVEACTIONS.SAVE_AND_CREATE:this.saveAndCreate();break;case this.SAVEACTIONS.SAVE_AND_VIEW:this.saveAndView();break;default:this.saveAndClose();}},saveAndClose:function(){this.initiateSave(_.bind(function(){if(!this.model.id){this.alerts.showSuccessButDeniedAccess();}
if(app.drawer){app.drawer.close(this.context,this.model);}},this));},cancel:function(){if(app.drawer){app.drawer.close(this.context);}},saveAndCreate:function(){this.context.lastSaveAction=this.SAVEACTIONS.SAVE_AND_CREATE;this.initiateSave(_.bind(function(){if(this.model.id){this.clear();this.model.set(this.model.relatedAttributes);this.resetDuplicateState();}else if(app.drawer){this.alerts.showSuccessButDeniedAccess();if(app.drawer){app.drawer.close(this.context,this.model);}}},this));},saveAndView:function(){this.context.lastSaveAction=this.SAVEACTIONS.SAVE_AND_VIEW;this.initiateSave(_.bind(function(){if(!this.model.id){this.alerts.showSuccessButDeniedAccess();if(app.drawer){app.drawer.close(this.context,this.model);}}else{app.navigate(this.context,this.model);}},this));},restoreModel:function(){this.model.clear();if(this._origAttributes){this.model.set(this._origAttributes);this.model.isCopied=true;}
this.createMode=true;if(!this.disposed){this.render();}
this.setButtonStates(this.STATE.CREATE);},initiateSave:function(callback){this.disableButtons();async.waterfall([_.bind(this.validateModelWaterfall,this),_.bind(this.dupeCheckWaterfall,this),_.bind(this.createRecordWaterfall,this)],_.bind(function(error){this.enableButtons();if(error&&error.status==412&&!error.request.metadataRetry){this.handleMetadataSyncError(error);}else if(!error&&!this.disposed){this.context.lastSaveAction=null;callback();}},this));},validateModelWaterfall:function(callback){this.model.doValidate(this.getFields(this.module),function(isValid){callback(!isValid);});},dupeCheckWaterfall:function(callback){var success=_.bind(function(collection){if(this.disposed){callback(true);}
if(collection.models.length>0){this.handleDuplicateFound(collection);callback(true);}else{this.resetDuplicateState();callback(false);}},this),error=_.bind(function(e){if(e.status==412&&!e.request.metadataRetry){this.handleMetadataSyncError(e);}else{this.alerts.showServerError();callback(true);}},this);if(this.skipDupeCheck()||!this.enableDuplicateCheck){callback(false);}else{this.checkForDuplicate(success,error);}},createRecordWaterfall:function(callback){var success=function(){callback(false);},error=_.bind(function(e){if(e.status==412&&!e.request.metadataRetry){this.handleMetadataSyncError(e);}else if(e.status==404){callback();}else{this.alerts.showServerError();callback(true);}},this);this.saveModel(success,error);},checkForDuplicate:function(success,error){var options={showAlerts:true,success:success,error:error};this.context.trigger("dupecheck:fetch:fire",this.model,options);},handleDuplicateFound:function(){this.setButtonStates(this.STATE.DUPLICATE);this.dupecheckList.show();this.skipDupeCheck(true);},resetDuplicateState:function(){this.setButtonStates(this.STATE.CREATE);this.hideDuplicates();this.skipDupeCheck(false);},getCustomSaveOptions:function(options){return{};},saveModel:function(success,error){var self=this,options;success=_.wrap(success,function(func,model){var successMessage=self.buildSuccessMessage(model);app.file.checkFileFieldsAndProcessUpload(self,{success:function(){var successKey='create-success';func();app.alert.show(successKey,{level:'success',messages:successMessage,autoClose:true,autoCloseDelay:10000,onLinkClick:function(){app.alert.dismiss(successKey);}});}},{deleteIfFails:true});});options={success:success,error:error,viewed:true,relate:(self.model.link)?true:null,showAlerts:{'process':true,'success':false,'error':false},lastSaveAction:this.context.lastSaveAction};options=_.extend({},options,self.getCustomSaveOptions(options));self.model.save(null,options);},buildSuccessMessage:function(model){var modelAttributes,successLabel='LBL_RECORD_SAVED_SUCCESS',successMessageContext;if(model&&model.attributes){modelAttributes=model.attributes;}else{modelAttributes={};successLabel='LBL_RECORD_SAVED';}
successMessageContext=_.extend({module:this.module,moduleSingularLower:this.moduleSingular.toLowerCase()},modelAttributes);return app.lang.get(successLabel,this.module,successMessageContext);},skipDupeCheck:function(skip){var skipDupeCheck,saveButton=this.buttons[this.saveButtonName].getFieldElement();if(_.isUndefined(skip)){skipDupeCheck=saveButton.data('skipDupeCheck');if(_.isUndefined(skipDupeCheck)){skipDupeCheck=false;}
return skipDupeCheck;}else{if(skip){saveButton.data('skipDupeCheck',true);}else{saveButton.data('skipDupeCheck',false);}}},clear:function(){this.model.clear();if(!this.disposed){this.render();}},editExisting:function(model){var origAttributes=this.saveFormData(),skipDupeCheck=this.skipDupeCheck();this.model.clear();this.model.set(this.extendModel(model,origAttributes));this.createMode=false;if(!this.disposed){this.render();}
this.toggleEdit(true);this.hideDuplicates();this.skipDupeCheck(skipDupeCheck);this.setButtonStates(this.STATE.SELECT);},extendModel:function(newModel,origAttributes){var modelAttributes=_.clone(newModel.attributes);_.each(modelAttributes,function(value,key){if(_.isUndefined(value)||_.isNull(value)||((_.isObject(value)||_.isArray(value)||_.isString(value))&&_.isEmpty(value))){delete modelAttributes[key];}});return _.extend({},origAttributes,modelAttributes);},saveFormData:function(){this._origAttributes=_.clone(this.model.attributes);return this._origAttributes;},setDupeCheckType:function(type){this.context.set('dupelisttype',type);},renderDupeCheckList:function(){this.setDupeCheckType('dupecheck-list-edit');this.context.set('collection',this.createDuplicateCollection(this.model));if(_.isNull(this.dupecheckList)){this.dupecheckList=app.view.createLayout({context:this.context,name:'create-dupecheck',module:this.module});this.addToLayoutComponents(this.dupecheckList);}
this.$('.headerpane').after(this.dupecheckList.$el);this.dupecheckList.hide();this.dupecheckList.render();},addToLayoutComponents:function(component){this.layout._components.push(component);},hideDuplicates:function(){this.dupecheckList.hide();},setButtonStates:function(state){app.view.invokeParent(this,{type:'view',name:'record',method:'setButtonStates',args:[state]});var $saveButtonEl=this.buttons[this.saveButtonName];if($saveButtonEl){switch(state){case this.STATE.CREATE:case this.STATE.SELECT:$saveButtonEl.getFieldElement().text(app.lang.get('LBL_SAVE_BUTTON_LABEL',this.module));break;case this.STATE.DUPLICATE:$saveButtonEl.getFieldElement().text(app.lang.get('LBL_IGNORE_DUPLICATE_AND_SAVE',this.module));break;}}},disableButtons:function(){this.toggleButtons(false);},enableButtons:function(){this.toggleButtons(true);},toggleButtons:function(enable){_.each(this.buttons,function(button){switch(button.type){case'button':case'rowaction':button.getFieldElement().toggleClass('disabled',!enable);break;case'actiondropdown':button.$('a.dropdown-toggle').toggleClass('disabled',!enable);break;}});},alerts:{showInvalidModel:function(){app.alert.show('invalid-data',{level:'error',messages:'ERR_RESOLVE_ERRORS',autoClose:true});},showServerError:function(){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false});},showSuccessButDeniedAccess:function(){app.alert.show('invalid-data',{level:'warning',messages:'LBL_RECORD_SAVED_ACCESS_DENIED',autoClose:true,autoCloseDelay:9000});}}})},"opportunity-metrics":{"controller":({plugins:['Dashlet'],className:'opportunity-metrics-widget',metricsCollection:{},chartCollection:{},chart:{},_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);if(this.viewName==="config"||_.isEmpty(this.chartCollection)){return;}
this.chart=nv.models.pieChart().x(function(d){return d.key;}).y(function(d){return d.value;}).margin({top:5,right:20,bottom:20,left:20}).donut(true).donutLabelsOutside(true).donutRatio(0.4).hole(this.chartCollection.properties.label).showTitle(false).tooltips(false).showLegend(false).colorData('class');d3.select('svg#'+this.cid).datum(this.chartCollection).transition().duration(500).call(this.chart);app.events.on('app:toggle:sidebar',function(state){if(state=='open'){this.chart.update();}},this);nv.utils.windowResize(this.chart.update);nv.utils.resizeOnPrint(this.chart.update);},evaluateResult:function(data){var total=0;_.each(data,function(value,key){data[key].formattedAmount=app.currency.formatAmountLocale(value.amount_usdollar,null,0).replace(/\.[0-9]*/,'');data[key].icon=key==='won'?'caret-up':(key==='lost'?'caret-down':'minus');data[key].cssClass=key==='won'?'won':(key==='lost'?'lost':'active');data[key].dealLabel=key;data[key].stageLabel=app.lang.getAppListStrings("opportunity_metrics_dom")[key];total+=value.count;});this.metricsCollection=data;this.chartCollection={data:_.map(this.metricsCollection,function(value,key){return{'key':value.stageLabel,'value':value.count,'classes':key};}),properties:{title:app.lang.getAppString('LBL_DASHLET_OPPORTUNITY_NAME'),value:3,label:total}};this.total=total;},loadData:function(options){if(this.meta.config){return;}
var self=this,url=app.api.buildURL(this.model.module,'opportunity_stats',{id:this.model.get('id')});app.api.call('read',url,null,{success:function(data){self.evaluateResult(data);if(!self.disposed){self.render();}},complete:(options)?options.complete:null});},_dispose:function(){if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.update);nv.utils.unResizeOnPrint(this.chart.update);}
app.view.View.prototype._dispose.call(this);}})},"find-duplicates-headerpane":{"controller":({extendsFrom:'HeaderpaneView',events:{'click a[name=cancel_button]':'cancel','click a[name=merge_duplicates_button]:not(".disabled")':'mergeDuplicatesClicked'},plugins:['MergeDuplicates'],bindDataChange:function(){app.view.invokeParent(this,{type:'view',name:'headerpane',method:'bindDataChange'});this.on('mergeduplicates:complete',this.mergeComplete,this);this.context.on('change:mass_collection',this.addMassCollectionListener,this);},unbindData:function(){var massCollection=this.context.get('mass_collection');if(massCollection){massCollection.off(null,null,this);}
app.view.View.prototype.unbindData.call(this);},addMassCollectionListener:function(){var massCollection=this.context.get('mass_collection');massCollection.on('add remove',this.toggleMergeButton,this);},toggleMergeButton:function(){var disabled;if(this.context.get('mass_collection').length>0){disabled=false;}else{disabled=true;}
this.$("[name='merge_duplicates_button']").toggleClass('disabled',disabled);},cancel:function(){app.drawer.close();},mergeComplete:function(primaryRecord){app.drawer.closeImmediately(true,primaryRecord);},mergeDuplicatesClicked:function(){this.mergeDuplicates(this.context.get('mass_collection'),this.collection.dupeCheckModel);}})},"forecast-pareto":{"controller":({plugins:['Dashlet','Tooltip'],values:new Backbone.Model(),className:'forecasts-chart-wrapper',displayTimeperiodPivot:true,isManager:false,validChangedFields:['amount','likely_case','best_case','worst_case','assigned_user_id','date_closed','date_closed_timestamp','probability','commit_stage','sales_stage'],initOptions:null,events:{'click button.btn':'handleTypeButtonClick'},initialize:function(options){this.values.clear({silent:true});this.isManager=app.user.get('is_manager');this.initOptions=options;this.forecastConfig=app.metadata.getModule('Forecasts','config');this.isForecastSetup=this.forecastConfig.is_setup;this.forecastsConfigOK=app.utils.checkForecastConfig();if(this.isForecastSetup&&this.forecastsConfigOK){this.initOptions.meta.template=undefined;app.api.call('GET',app.api.buildURL('Forecasts/init'),null,{success:_.bind(this.forecastInitCallback,this),complete:this.initOptions?this.initOptions.complete:null});this.values.module='Forecasts';this.displayTimeperiodPivot=(options.context.get('module')==='Home');}else{this.initOptions.meta.template='forecast-pareto.no-access';}
app.view.View.prototype.initialize.call(this,this.initOptions);},initDashlet:function(){var fieldOptions=app.lang.getAppListStrings(this.dashletConfig.dataset.options),cfg=app.metadata.getModule('Forecasts','config');this.dashletConfig.dataset.options={};if(cfg.show_worksheet_worst&&app.acl.hasAccess('view','ForecastWorksheets',app.user.get('id'),'worst_case')){this.dashletConfig.dataset.options['worst']=fieldOptions['worst'];}
if(cfg.show_worksheet_likely){this.dashletConfig.dataset.options['likely']=fieldOptions['likely'];}
if(cfg.show_worksheet_best&&app.acl.hasAccess('view','ForecastWorksheets',app.user.get('id'),'best_case')){this.dashletConfig.dataset.options['best']=fieldOptions['best'];}},forecastInitCallback:function(initData){var defaultOptions={user_id:app.user.get('id'),display_manager:!!this.isManager,selectedTimePeriod:initData.defaultSelections.timeperiod_id.id,timeperiod_id:initData.defaultSelections.timeperiod_id.id,timeperiod_label:initData.defaultSelections.timeperiod_id.label,dataset:initData.defaultSelections.dataset,group_by:initData.defaultSelections.group_by,ranges:_.keys(app.lang.getAppListStrings(this.forecastConfig.buckets_dom))};if(!this.displayTimeperiodPivot&&this.model.has('date_closed_timestamp')&&this.model.get('date_closed_timestamp'!=0)){defaultOptions.timeperiod_id=this.model.get('date_closed_timestamp');}
this.values.set(defaultOptions);},loadData:function(options){},_render:function(){app.view.invokeParent(this,{type:'view',name:'parent',method:'_render'});var chartField=this.getField('paretoChart');if(!_.isUndefined(chartField)){chartField.renderChart();chartField.once('chart:pareto:rendered',function(){this.addRowToChart();},this);}},toggleRepOptionsVisibility:function(){var mgrToggleOffset;if(this.values.get('display_manager')===true){mgrToggleOffset=6;this.$el.find('div.groupByOptions').addClass('hide');}else{mgrToggleOffset=3;this.$el.find('div.groupByOptions').removeClass('hide');}
if(this.displayTimeperiodPivot){mgrToggleOffset=mgrToggleOffset-3;}
if(this.isManager){var el=this.$el.find('#'+this.cid+'-mgr-toggle');if(el.length>0){var classes=el.attr("class").split(" ").filter(function(item){return item.indexOf("offset")===-1?item:"";});if(mgrToggleOffset!=0){classes.push('offset'+mgrToggleOffset);}
el.attr("class",classes.join(" "));}}},handleTypeButtonClick:function(e){var $el=$(e.currentTarget),displayType=$el.data('type');this.values.set({display_manager:(displayType=='team')});},bindDataChange:function(){var meta=this.meta||this.initOptions.meta;if(meta.config){return;}
if(_.isUndefined(this.context)){return;}
if(this.isForecastSetup&&this.forecastsConfigOK){this.on('render',function(){var chartField=this.getField('paretoChart'),dashletToolbar=this.layout.getComponent('dashlet-toolbar');if(chartField&&dashletToolbar){chartField.before('chart:pareto:render',function(){this.$("[data-action=loading]").removeClass(this.cssIconDefault).addClass(this.cssIconRefresh)},{},dashletToolbar);chartField.on('chart:pareto:rendered',function(){this.$("[data-action=loading]").removeClass(this.cssIconRefresh).addClass(this.cssIconDefault)},dashletToolbar);}},this);this.values.on('change:display_manager',this.toggleRepOptionsVisibility,this);this.values.on('change:selectedTimePeriod',function(context,timeperiod){this.values.set({timeperiod_id:timeperiod});},this);if(!this.displayTimeperiodPivot){this.findModelToListen();this.listenModel.on('change',this.handleDataChange,this);}}},findModelToListen:function(){this.listenModel=this.model;},handleDataChange:function(model){model=model||this.model;var changed=model.changed,changedField=_.keys(changed),validChangedFields=_.intersection(this.validChangedFields,_.keys(changed)),changedCurrencyFields=_.intersection(['amount','best_case','likely_case','worst_case'],validChangedFields),assigned_user=model.get('assigned_user_id');if(!_.isEmpty(changedCurrencyFields)){_.each(changedCurrencyFields,function(field){if(parseFloat(model.get(field))==parseFloat(model.previous(field))){validChangedFields=_.without(validChangedFields,field);}});}
if(_.isEmpty(validChangedFields)){return;}
if(this.values.get('display_manager')===false&&assigned_user==app.user.get('id')){var field=this.getField('paretoChart'),serverData=field.getServerData();if(!field.hasServerData()){return;}
if(changedField.length==1&&changedField[0]=='date_closed'){changedField.push('date_closed_timestamp');changed.date_closed_timestamp=Math.round(+app.date.parse(changed.date_closed).getTime()/1000);model.set('date_closed_timestamp',changed.date_closed_timestamp,{silent:true});}
if(_.contains(changedField,'date_closed_timestamp')){if(!(model.get('date_closed_timestamp')>=_.first(serverData['x-axis']).start_timestamp&&model.get('date_closed_timestamp')<=_.last(serverData['x-axis']).end_timestamp)){if(this.listenModel instanceof Backbone.Collection){if(this.listenModel.length>1){this.removeRowFromChart(model);return;}}
field.once('chart:pareto:rendered',function(){this[0].addRowToChart(this[1]);},[this,model]);this.values.set('timeperiod_id',model.get('date_closed_timestamp'));return;}}
if(_.contains(changedField,'amount')){changed.likely=this._convertCurrencyValue(changed.amount,model.get('base_rate'));delete changed.amount;}
if(_.contains(changedField,'likely_case')){changed.likely=this._convertCurrencyValue(changed.likely_case,model.get('base_rate'));delete changed.likely_case;}
if(_.contains(changedField,'best_case')){changed.best=this._convertCurrencyValue(changed.best_case,model.get('base_rate'));delete changed.best_case;}
if(_.contains(changedField,'worst_case')){changed.worst=this._convertCurrencyValue(changed.worst_case,model.get('base_rate'));delete changed.worst_case;}
if(_.contains(changedField,'commit_stage')){changed.forecast=changed.commit_stage;delete changed.commit_stage;}
var record=_.find(serverData.data,function(record,i,list){if(model.get('id')==record.record_id){list[i]=_.extend({},record,changed);return true;}
return false;});if(_.isEmpty(record)){this.addRowToChart(model);}else{field.setServerData(serverData,_.contains(changedField,'probability'));}}else if(_.contains(changedField,'assigned_user_id')){if(assigned_user===app.user.get('id')){this.addRowToChart(model)}else{this.removeRowFromChart(model);}}},addRowToChart:function(model){model=model||this.model;if(model.get('assigned_user_id')==app.user.get('id')&&!this.values.get('display_manager')){var field=this.getField('paretoChart'),serverData=field.getServerData(),found=_.find(serverData.data,function(record){return(record.record_id==model.get('id'));}),base_rate=model.get('base_rate');if(_.isEmpty(found)){serverData.data.push({best:this._convertCurrencyValue(model.get('best_case'),base_rate),likely:this._convertCurrencyValue(model.has('amount')?model.get('amount'):model.get('likely_case'),base_rate),worst:this._convertCurrencyValue(model.get('worst_case'),base_rate),record_id:model.get('id'),date_closed_timestamp:model.get('date_closed_timestamp'),probability:model.get('probability'),sales_stage:model.get('sales_stage'),forecast:model.get('commit_stage')});field.setServerData(serverData,true);}}},_convertCurrencyValue:function(value,base_rate){return app.currency.convertWithRate(value,base_rate);},removeRowFromChart:function(model){model=model||this.model;var field=this.getField('paretoChart'),serverData=field.getServerData();_.find(serverData.data,function(record,i,list){if(model.get('id')==record.record_id){list.splice(i,1);return true;}
return false;});field.setServerData(serverData,true);},unbindData:function(){var ctx=this.context.parent;if(ctx){ctx.off(null,null,this);}
if(this.listenModel)this.listenModel.off(null,null,this);if(this.context)this.context.off(null,null,this);if(this.values)this.values.off(null,null,this);app.view.View.prototype.unbindData.call(this);}})},"footer-actions":{"controller":({events:{'click #tour':'showTutorial','click #feedback':'feedback','click #support':'support','click #help':'help'},tagName:'span',handleViewChange:function(layout,params){var module=params&&params.module?params.module:null;if(app.tutorial.hasTutorial(layout,module)){this.enableTourButton();}else{this.disableTourButton();}},handleRouteChange:function(route,params){this.routeParams={'route':route,'params':params};},enableTourButton:function(){this.$('#tour').removeClass('disabled');this.events['click #tour']='showTutorial';this.undelegateEvents();this.delegateEvents();},disableTourButton:function(){this.$('#tour').addClass('disabled');delete this.events['click #tour'];this.undelegateEvents();this.delegateEvents();},initialize:function(options){app.view.View.prototype.initialize.call(this,options);app.events.on('app:view:change',this.handleViewChange,this);var self=this;app.utils.doWhen(function(){return!_.isUndefined(app.router)},function(){self.listenTo(app.router,'route',self.handleRouteChange);});},_renderHtml:function(){this.isAuthenticated=app.api.isAuthenticated();app.view.View.prototype._renderHtml.call(this);},feedback:function(){window.open('http://www.sugarcrm.com/sugar7survey','_blank');},support:function(){window.open('http://support.sugarcrm.com','_blank');},help:function(){var serverInfo=app.metadata.getServerInfo();var lang=app.lang.getLanguage();var module=app.controller.context.get('module');var route=this.routeParams.route;var url='http://www.sugarcrm.com/crm/product_doc.php?edition='+serverInfo.flavor+'&version='+serverInfo.version+'&lang='+lang+'&module='+module+'&route='+route;if(route=='bwc'){var action=window.location.hash.match(/#bwc.*action=(\w*)/i);if(action&&!_.isUndefined(action[1])){url+='&action='+action[1];}}
app.logger.info("help URL: "+url);window.open(url);},showTutorial:function(){app.tutorial.resetPrefs();app.tutorial.show(app.controller.context.get('layout'),{module:app.controller.context.get('module')});}})},"login":{"controller":({plugins:['ErrorDecoration'],fallbackFieldTemplate:'edit',events:{"click [name=login_button]":"login","keypress":"handleKeypress"},handleKeypress:function(e){if(e.keyCode===13){this.$("input").trigger("blur");this.login();}},_declareModel:function(meta){meta=meta||{};var fields={};_.each(_.flatten(_.pluck(meta.panels,"fields")),function(field){fields[field.name]=field;});app.data.declareModel('Login',{fields:fields});},initialize:function(options){this._declareModel(options.meta);options.context.prepare(true);app.view.View.prototype.initialize.call(this,options);var config=app.metadata.getConfig();if(config&&app.config.forgotpasswordON===true){this.showPasswordReset=true;}},_render:function(){this.logoUrl=app.metadata.getLogoUrl();app.view.View.prototype._render.call(this);this.refreshAddtionalComponents();if(!this._isSupportedBrowser()){app.alert.show('unsupported_browser',{level:'warning',title:'',messages:[app.lang.getAppString('LBL_ALERT_BROWSER_NOT_SUPPORTED'),app.lang.getAppString('LBL_ALERT_BROWSER_SUPPORT')]});}
var config=app.metadata.getConfig();if(config.system_status&&config.system_status.level&&(config.system_status.level=='maintenance'||config.system_status.level=='admin_only')){app.alert.show('admin_only',{level:'warning',title:'',messages:['',app.lang.getAppString(config.system_status.message),]});}
return this;},refreshAddtionalComponents:function(){_.each(app.additionalComponents,function(component){component.render();});},login:function(){var self=this;this.model.doValidate(null,_.bind(function(isValid){if(isValid){app.$contentEl.hide();var args={password:this.model.get("password"),username:this.model.get("username")};app.alert.show('login',{level:'process',title:app.lang.getAppString('LBL_LOADING'),autoClose:false});app.login(args,null,{error:function(){app.$contentEl.show();app.logger.debug("login failed!");},success:function(){app.logger.debug("logged in successfully!");app.events.on('app:sync:complete',function(){app.logger.debug("sync in successfully!");_.defer(_.bind(this.postLogin,this));},self);},complete:function(){app.alert.dismiss('login');}});}},self));},postLogin:function(){if(!app.user.get('show_wizard')){this.refreshAddtionalComponents();if(new Date().getTimezoneOffset()!=(app.user.getPreference('tz_offset_sec')/-60)){var link=new Handlebars.SafeString('<a href="#'+
app.router.buildRoute('Users',app.user.id,'edit')+'">'+
app.lang.get('LBL_TIMEZONE_DIFFERENT_LINK')+'</a>');var message=app.lang.get('TPL_TIMEZONE_DIFFERENT',null,{link:link});app.alert.show('offset_problem',{messages:message,closeable:true,level:'warning'});}}
app.$contentEl.show();},_isSupportedBrowser:function(){var supportedBrowsers={msie:{min:9},mozilla:{min:18},safari:{min:536},chrome:{min:537}};for(var b in supportedBrowsers){if($.browser[b]){var current=parseInt($.browser.version);var supported=supportedBrowsers[b];return current>=supported.min;}}}})},"filtered-search":{"controller":({events:{'keyup [data-searchfield]':'searchFired'},bindDataChange:function(){this.context.on('filteredlist:filter:set',this.setFilter,this);},setFilter:function(filter){var label=app.lang.get('LBL_SEARCH_BY')+' '+filter.join(', ')+'...';this.$('[data-searchfield]').attr('placeholder',label);},searchFired:_.debounce(function(evt){var value=$(evt.currentTarget).val();this.context.trigger('filteredlist:search:fired',value);},100)})},"recommended-experts":{"controller":({events:{"click .find-experts":"getRecommendations","keyup .job-title":"submit"},initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this.getJobTitles();this.collection=app.data.createBeanCollection("Users");},_render:function(){app.view.View.prototype._render.call(this);if(this.$(".job-title")&&this.typeahead_collection){this.$(".job-title").typeahead({source:this.typeahead_collection});}},getJobTitles:function(){var self=this,url=app.api.buildURL(this.module,"expertsTypeahead",{"id":app.controller.context.get("model").id});app.api.call("read",url,null,{success:function(data){self.typeahead_collection=data;if(self.$(".job-title")){self.$(".job-title").typeahead({source:self.typeahead_collection});}}});},submit:function(e){if(this.$(".job-title").val().length&&e.keyCode===13){this.getRecommendations();}},getRecommendations:function(){var self=this;this.jobTitle=this.$(".job-title").val();if(this.jobTitle.length){var url=app.api.buildURL(this.module,"experts",{"id":app.controller.context.get("model").id},{"title":this.jobTitle});app.api.call("read",url,null,{success:function(data){if(self.disposed){return;}
self.collection.reset();if(data.length){_.each(data,function(key,value){data[value]["guid"]=_.uniqueId("recommended-experts-item");data[value]["picture_url"]=data[value]["picture"]?app.api.buildFileURL({module:"Users",id:data[value]["id"],field:"picture"}):"../styleguide/assets/img/profile.png";var model=app.data.createBean("User");model.attributes=data[value];self.collection.add(model);});}
self.render();}});}}})},"filter-filter-dropdown":{"controller":({tagName:"span",events:{"click .choice-filter":"handleEditFilter"},initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this._select2formatSelectionTemplate=app.template.get("filter-filter-dropdown.selection-partial");this._select2formatResultTemplate=app.template.get("filter-filter-dropdown.result-partial");this.listenTo(this.layout,"filter:change:filter",this.handleChange);this.listenTo(this.layout,"filter:change:module",this.handleModuleChange);this.listenTo(this.layout,"filter:render:filter",this._renderHtml);},filterDropdownEnabled:true,_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);this.filterList=this.getFilterList();this._renderDropdown(this.filterList);},getFilterList:function(){var filters=[];this.layout.filters.each(function(model){var isAllRecords=model.id!=="all_records"?false:true;filters.push({id:model.id,text:this.getTranslatedSelectionText(isAllRecords,model.get("name"))});},this);if(this.layout.canCreateFilter()){filters.push({id:"create",text:app.lang.get("LBL_FILTER_CREATE_NEW")});}
return filters;},_renderDropdown:function(data){var self=this;this.filterNode=this.$(".search-filter");this.filterNode.select2({data:data,multiple:false,minimumResultsForSearch:7,formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-filter-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},width:'off'});if(!this.filterDropdownEnabled){this.filterNode.select2("disable");}
this.filterNode.off("change");this.filterNode.on("change",function(e){self.layout.trigger("filter:change:filter",e.val);});},handleChange:function(id){var filter=this.layout.filters.get(id)||this.layout.emptyFilter;if(id==="create"){this.$('.choice-filter').css("cursor","not-allowed");this.layout.trigger("filter:create:open",app.data.createBean('Filters'));}else{if(filter.get("editable")===false){this.layout.trigger("filter:create:close");this.$('.choice-filter').css("cursor","not-allowed");}else{this.$('.choice-filter').css("cursor","pointer");}
if(this.layout.createPanelIsOpen()){this.layout.trigger("filter:create:open",filter);}}
this.filterNode.select2("val",id);},initSelection:function(el,callback){var data,model,val=el.val();if(val!=="create"){model=this.layout.filters.get(val);if(model){if(val!=="all_records"){data={id:model.id,text:this.getTranslatedSelectionText(false,model.get("name"))};}else{data={id:"all_records",text:this.getTranslatedSelectionText(true,model.get("name"))};}}else{data={id:"all_records",text:app.lang.get("LBL_FILTER_ALL_RECORDS")};}
callback(data);}},formatSelection:function(item){var ctx={},safeString;safeString=Handlebars.Utils.escapeExpression(item.text);this.$('.choice-filter').html(safeString);ctx.label=app.lang.get("LBL_FILTER");ctx.enabled=this.filterDropdownEnabled;return this._select2formatSelectionTemplate(ctx);},formatResult:function(option){return this._select2formatResultTemplate(option.text);},handleEditFilter:function(){var filterId=this.filterNode.val(),filterModel=this.layout.filters.get(filterId);if(filterModel&&filterModel.get("editable")!==false){this.layout.trigger("filter:create:open",filterModel);}},handleModuleChange:function(linkModuleName,linkName){this.filterDropdownEnabled=(linkName!=="all_modules"&&!app.metadata.getModule(linkModuleName).isBwcEnabled);},getTranslatedSelectionText:function(isAllRecords,label){var translatedText,moduleName;if(isAllRecords){moduleName=app.lang.get('LBL_MODULE_NAME',this.layout.layout.currentModule);translatedText=app.lang.get(label,null,{'moduleName':moduleName});}
else{translatedText=app.lang.get(label,['Filters',this.layout.layout.currentModule]);}
return translatedText;},_dispose:function(){if(!_.isEmpty(this.filterNode)){this.filterNode.select2('destroy');}
app.view.View.prototype._dispose.call(this);}})},"selection-list":{"controller":({extendsFrom:'FlexListView',plugins:['ListColumnEllipsis','ListRemoveLinks'],displayFirstNColumns:4,initialize:function(options){options.context.set('skipFetch',true);options.meta=options.meta||{};options.meta.selection={type:'single',label:'LBL_LINK_SELECT'};app.view.invokeParent(this,{type:'view',name:'flex-list',method:'initialize',args:[options]});this.initializeEvents();},initializeEvents:function(){this.context.on("change:selection_model",this._selectAndClose,this);this.context.on('selection-list:select',this._selectAndCloseImmediately,this);},_selectAndClose:function(context,selectionModel){if(selectionModel){this.context.unset("selection_model",{silent:true});app.drawer.close(this._getModelAttributes(selectionModel));}},_selectAndCloseImmediately:function(model){if(model){app.drawer.closeImmediately(this._getModelAttributes(model));}},_getModelAttributes:function(model){var attributes={id:model.id,value:model.get('name')};_.each(model.attributes,function(value,field){if(app.acl.hasAccessToModel('view',model,field)){attributes[field]=attributes[field]||model.get(field);}},this);return attributes;},addActions:function(){app.view.invokeParent(this,{type:'view',name:'flex-list',method:'addActions'});if(this.meta.showPreview!==false){this.rightColumns.push({type:'rowaction',css_class:'btn',tooltip:'LBL_PREVIEW',event:'list:preview:fire',icon:'icon-eye-open'});}else{this.rightColumns.push({});}}})},"create-nodupecheck":{"controller":({extendsFrom:'CreateView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'create',method:'initialize',platform:'base',args:[options]});this.enableDuplicateCheck=false;}})},"dupecheck-header":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.context.on('dupecheck:collection:reset',this.updateCount,this);},updateCount:function(){var translatedString=app.lang.get('LBL_DUPLICATES_FOUND',this.module,{'duplicateCount':this.context.get('collection').length});this.$('span.duplicate_count').text(translatedString);}})},"dupecheck-list-edit":{"controller":({extendsFrom:'DupecheckListView',additionalTableClasses:'duplicates-selectedit',addActions:function(){if(this.actionsAdded)return;app.view.invokeParent(this,{type:'view',name:'dupecheck-list',method:'addActions'});var firstRightColumn=this.rightColumns[0];if(firstRightColumn&&_.isArray(firstRightColumn.fields)){firstRightColumn.fields.unshift({type:'rowaction',label:'LBL_LISTVIEW_SELECT_AND_EDIT',css_class:'btn btn-invisible btn-link',event:'list:dupecheck-list-select-edit:fire'});this.rightColumns[0]=firstRightColumn;}
this.actionsAdded=true;}})},"panel-top":{"controller":({className:"subpanel-header",events:{"click":"togglePanel",'click a[name=create_button]:not(".disabled")':'createRelatedClicked',},plugins:['LinkedModel'],initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);var context=this.context;this.parentModule=context.parent.get('module');context.parent.on('panel-top:refresh',function(link){if(context.get('link')===link){context.get('collection').fetch();}});},createRelatedClicked:function(event){this.createRelatedRecord(this.module)},togglePanel:function(e){var toggleSubpanel=!$(e.target).parents("span.actions").length;if(toggleSubpanel){this._toggleSubpanel();}},_toggleSubpanel:function(){var isHidden=this.layout.$(".subpanel").hasClass("closed");this.layout.trigger("panel:toggle",isHidden);},bindDataChange:function(){if(this.collection){this.listenTo(this.collection,'reset',this.render);}}})},"dupecheck-list-multiselect":{"controller":({extendsFrom:'DupecheckListView',additionalTableClasses:'duplicates-multiselect'})},"quickcreate":{"controller":({plugins:['Dropdown','Tooltip'],initialize:function(options){app.events.on("app:sync:complete",this.render,this);app.user.on("change:module_list",this.render,this);app.view.View.prototype.initialize.call(this,options);},_renderHtml:function(){if(!app.api.isAuthenticated()||app.config.appStatus=='offline')return;if(!(_.isEmpty(app.metadata.getStrings("mod_strings")))){var moduleList=app.metadata.getModuleNames(true,"create");this.createMenuItems=this._getMenuMeta(moduleList);app.view.View.prototype._renderHtml.call(this);}},_getMenuMeta:function(moduleList){var meta,menuItem,returnList=[];_.each(moduleList,function(module){meta=app.metadata.getModule(module);if(meta&&meta.menu&&meta.menu.quickcreate){menuItem=meta.menu.quickcreate.meta;if(_.isUndefined(menuItem.visible)||menuItem.visible===true){menuItem.module=module;menuItem.type=menuItem.type||'quickcreate';menuItem.model=app.data.createBean(module);returnList.push(menuItem);}}},this);return returnList;},_dispose:function(){app.user.off("change:module_list",this.render);app.view.View.prototype._dispose.call(this);}})},"dashboard-headerpane":{"controller":({extendsFrom:'RecordView',buttons:null,editableFields:null,className:'preview-headerbar',events:{'click [name=edit_button]':'editClicked','click [name=cancel_button]':'cancelClicked','click [name=save_button]':'saveClicked','click [name=create_button]':'saveClicked','click [name=create_cancel_button]':'createCancelClicked','click [name=delete_button]':'deleteClicked','click [name=add_button]':'addClicked','click [name=collapse_button]':'collapseClicked','click [name=expand_button]':'expandClicked'},initialize:function(options){if(options.context.parent){options.meta=app.metadata.getView(options.context.parent.get("module"),options.name);options.template=app.template.getView(options.name);}
app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this.model.on("change change:layout change:metadata",function(){if(this.inlineEditMode){this.changed=true;}},this);this.model.on("error:validation",this.handleValidationError,this);if(this.context.get("create")){this.changed=true;this.action='edit';this.inlineEditMode=true;}else{this.action='detail';}
this.buttons={};},editClicked:function(evt){this.previousModelState=app.utils.deepCopy(this.model.attributes);this.inlineEditMode=true;this.setButtonStates('edit');this.toggleEdit(true);this.model.trigger("setMode","edit");},cancelClicked:function(evt){this.changed=false;this.clearValidationErrors();this.setButtonStates('view');this.handleCancel();this.model.trigger("setMode","view");},hasUnsavedChanges:function(){if(this.model.isNew()){return this.model.hasChanged();}
return!_.isEmpty(this.model.changedAttributes(this.model.getSyncedAttributes()));},saveClicked:function(evt){this.handleSave();},createCancelClicked:function(evt){if(this.context.parent){this.layout.navigateLayout('list');}else{app.navigate(this.context);}},deleteClicked:function(evt){this.handleDelete();},addClicked:function(evt){if(this.context.parent){this.layout.navigateLayout('create');}else{var route=app.router.buildRoute(this.module,null,'create');app.router.navigate(route,{trigger:true});}},collapseClicked:function(evt){this.context.trigger("dashboard:collapse:fire",true);},expandClicked:function(evt){this.context.trigger("dashboard:collapse:fire",false);},_render:function(){app.view.View.prototype._render.call(this);this.initButtons();this.setButtonStates(this.context.get("create")?'create':'view');this.setEditableFields();},handleSave:function(){this.inlineEditMode=false;var self=this;if(this.changed){this.model.save({},{showAlerts:true,fieldsToValidate:{'name':{required:true},'metadata':{required:true}},success:function(){if(self.context.get("create")){if(self.context.parent){self.layout.navigateLayout(self.model.id);}else{app.navigate(self.context,self.model);}}else{self.changed=false;self.setButtonStates('view');self.model.trigger("setMode","view");self.toggleEdit(false);}},error:function(){app.alert.show('error_while_save',{level:'error',title:app.lang.getAppString('ERR_INTERNAL_ERR_MSG'),messages:app.lang.getAppString('ERR_HTTP_500_TEXT'),autoClose:true});}});}else{this.model.trigger("setMode","view");this.setButtonStates('view');this.toggleEdit(false);}},handleCancel:function(){this.inlineEditMode=false;if(!_.isEmpty(this.previousModelState)){this.model.set(this.previousModelState);}
this.toggleEdit(false);},handleDelete:function(){app.alert.show('delete_confirmation',{level:'confirmation',messages:app.lang.get('LBL_DELETE_DASHBOARD_CONFIRM',this.module),onConfirm:_.bind(function(){var message=app.lang.get('LBL_DELETE_DASHBOARD_SUCCESS',this.module,{name:this.model.get('name')});this.model.destroy({success:_.bind(function(){if(this.disposed){return;}
if(this.context.parent){this.layout.navigateLayout('list');}else{var route=app.router.buildRoute(this.module);app.router.navigate(route,{trigger:true});}},this),error:function(){app.alert.show('error_while_save',{level:'error',title:app.lang.getAppString('ERR_INTERNAL_ERR_MSG'),messages:app.lang.getAppString('ERR_HTTP_500_TEXT'),autoClose:true});},showAlerts:{'process':true,'success':{messages:message}}});},this)});},bindDataChange:function(){},toggleEdit:function(isEdit){this.toggleFields(this.editableFields,isEdit);}})},"merge-duplicates":{"controller":({plugins:['Editable','ErrorDecoration','Tooltip','EllipsisInline'],extendsFrom:'ListView',events:{'click [data-action=more]':'toggleMoreLess','click [data-action=less]':'toggleMoreLess','click [data-mode=preview]':'togglePreview','click [data-action=copy]':'triggerCopy'},_defaultSettings:{queueFetchConcurrency:2,queueFetchTimeout:90000,queueUpdateConcurrency:4,queueUpdateTimeout:90000,relatedLinkFetchLimit:20,maxAllowAttempt:3},mergeFields:[],rowFields:{},primaryRecord:{},toggled:false,isPreviewOpen:false,relatedFieldsMap:['id_name','type_name'],fieldNameBlacklist:['date_entered','date_modified','modified_user_id','created_by','deleted'],fieldTypesBlacklist:['image','currency','email','team_list','teamset','link','id'],relatesBlacklist:['assigned_user_link','modified_user_link','created_by_link','teams','team_link','team_count_link','campaigns','campaign_link','archived_emails','email_addresses','email_addresses_primary','forecastworksheets','currencies'],relatesBlacklistForModule:{Accounts:['revenuelineitems'],Opportunities:['accounts'],Leads:['oldmeetings','oldcalls'],Prospects:['tasks'],Bugs:['project'],RevenueLineItems:['campaign_revenuelineitems']},mergeStat:null,mergeProgressModel:null,validArrayAttributes:[{type:'datetimecombo',source:'db'},{type:'datetime',source:'db'},{type:'varchar',source:'db'},{type:'enum',source:'db'},{type:'multienum',source:'db'},{type:'text',source:'db'},{type:'date',source:'db'},{type:'time',source:'db'},{type:'int',source:'db'},{type:'long',source:'db'},{type:'double',source:'db'},{type:'float',source:'db'},{type:'short',source:'db'},{dbType:'varchar',source:'db'},{dbType:'double',source:'db'},{type:'relate'},{type:'parent'}],flattenFieldTypes:['fieldset','fullname'],initialize:function(options){app.view.View.prototype.initialize.call(this,options);this._initializeMergeFields();this._initializeMergeCollection(this._prepareRecords());this.action='list';this.layout.on('mergeduplicates:save:fire',this.triggerSave,this);},_prepareRecords:function(){var records=this.checkAccessToModels(this.context.get('selectedDuplicates')),primary;primary=(this.context.has('primaryRecord'))?_.findWhere(records,{id:this.context.get('primaryRecord').id}):_.first(records);this.setPrimaryRecord(primary);return[primary].concat(_.without(records,primary));},_initializeMergeFields:function(){var meta=app.metadata.getView(this.module,'record'),fieldDefs=app.metadata.getModule(this.module).fields;this.mergeFields=_.chain(meta.panels).map(function(panel){return this.flattenFieldsets(panel.fields);},this).flatten().filter(function(field){return field.name&&this.validMergeField(fieldDefs[field.name]);},this).value();},_initializeMergeCollection:function(records){var ids=(_.pluck(records,'id'));if(this.collection){this.collection.filterDef=[];this.collection.filterDef.push({'id':{'$in':ids}});this.collection.comparator=function(model){return _.indexOf(ids,model.get('id'));};}},checkAccessToModels:function(models){var result=[];_.each(models,function(model){var hasAccess=_.every(['view','edit','delete'],function(acl){return app.acl.hasAccessToModel(acl,model);});if(hasAccess){result.push(model);}},this);return result;},triggerSave:function(){var self=this,alternativeModels=_.without(this.collection.models,this.primaryRecord),alternativeModelNames=[];_.each(alternativeModels,function(model){alternativeModelNames.push(this._getRecordTitle(model));},this);this.clearValidationErrors(this.getFieldNames());app.alert.show('merge_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_DUPLICATES_CONFIRM')+' '+
alternativeModelNames.join(', ')+'. '+
app.lang.get('LBL_MERGE_DUPLICATES_PROCEED'),onConfirm:_.bind(this._savePrimary,this)});},_savePrimary:function(){var self=this,fields=this.getFieldNames().filter(function(field){return app.acl.hasAccessToModel('edit',this.primaryRecord,field);},this);this.primaryRecord.save({},{fieldsToValidate:fields,success:function(){self.primaryRecord.trigger('mergeduplicates:primary:saved');},showAlerts:true,viewed:true});},_removeMerged:function(){var self=this,models=_.without(this.collection.models,this.primaryRecord);async.forEach(models,function(model,callback){self.collection.remove(model);model.destroy({success:function(){callback.call();}});},function(){self.primaryRecord.trigger('mergeduplicates:primary:merged');});},getFieldNames:function(){var fields=[],fieldDefs=app.metadata.getModule(this.module).fields;_.each(this.mergeFields,function(mergeField){var def=fieldDefs[mergeField.name];_.each(this.relatedFieldsMap,function(relatedField){if(!_.isUndefined(def[relatedField])&&!_.isUndefined((fieldDefs[def[relatedField]].name))){fields.push(fieldDefs[def[relatedField]].name);}});fields.push(fieldDefs[def.name].name);},this);return fields;},_generateMetadata:function(fields,collection,primaryRecord){var hiddenFields=[],visibleFields=[],alternatives=collection.without(primaryRecord);_.each(fields,function(field){if(this._isSimilar(field,primaryRecord,alternatives)){hiddenFields.push(field);}else{visibleFields.push(field);}},this);return{type:'list',panels:[{fields:visibleFields},{hide:true,fields:hiddenFields}]};},_isSimilar:function(field,primary,models){return _.every(models,function(model){return(primary.get(field.name)===model.get(field.name));});},validMergeField:function(fieldDef){if(!fieldDef||fieldDef.auto_increment===true||!this._validMergeFieldName(fieldDef)||!this._validMergeFieldType(fieldDef)||this._isDuplicateMergeDisabled(fieldDef)){return false;}
if(this._isDuplicateMergeEnabled(fieldDef)){return true;}
return this._validMergeFieldAttributes(fieldDef);},_validMergeFieldName:function(defs){return!_.contains(this.fieldNameBlacklist,defs.name);},_validMergeFieldType:function(defs){return!_.contains(this.fieldTypesBlacklist,defs.type);},_isDuplicateMergeDisabled:function(defs){if(!_.isUndefined(defs.duplicate_merge)&&(defs.duplicate_merge==='disabled'||defs.duplicate_merge===false)){return true;}
return false;},_isDuplicateMergeEnabled:function(defs){if(!_.isUndefined(defs.duplicate_merge)&&(defs.duplicate_merge==='enabled'||defs.duplicate_merge===true)){return true;}
return false;},_validMergeFieldAttributes:function(defs){defs.dbType=defs.dbType||defs.type;defs.source=defs.source||'db';return _.some(this.validArrayAttributes,function(o){return _.chain(o).keys().every(function(key){return o[key]===defs[key];}).value();});},flattenFieldsets:function(defs){var fieldsetFilter=function(field){return(field.type&&_.isArray(field.fields)&&_.contains(this.flattenFieldTypes,field.type));},fields=_.reject(defs,fieldsetFilter,this),fieldsets=_.filter(defs,fieldsetFilter,this),sort=_.chain(defs).pluck('name').value()||[],sortTemp=[];while(fieldsets.length){var fieldsNames=_.chain(fieldsets).pluck('fields').flatten().pluck('name').value();sortTemp=[];_.each(sort,function(value){if(value===_.first(fieldsets).name){sortTemp=sortTemp.concat(fieldsNames);}else{sortTemp=sortTemp.concat(value);}},this);sort=sortTemp;fieldsets=_.chain(fieldsets).pluck('fields').flatten().value();fields=fields.concat(_.reject(fieldsets,fieldsetFilter));fieldsets=_.filter(fieldsets,fieldsetFilter);}
fields=_.sortBy(fields,function(value,index){var result=index,name=value;if(!_.isUndefined(value.name)){name=value.name;_.each(sort,function(valueSort,indexSort){if(valueSort==name){result=indexSort;}});}
return result;});return fields;},togglePreview:function(evt){if(this.isPreviewOpen){app.events.trigger('preview:close');}else{this.updatePreviewRecord(this.primaryRecord);}
this.isPreviewOpen=!this.isPreviewOpen;$(evt.currentTarget).toggleClass('on',this.isPreviewOpen);},updatePreviewRecord:function(model){var module=model.module||model.get('module');var previewCollection=app.data.createBeanCollection(module,[model]);app.events.trigger('preview:render',model,previewCollection,false);},toggleMoreLess:function(evt){this.toggled=!this.toggled;this.$('[data-action=less]').toggleClass('hide',!this.toggled);this.$('[data-action=more]').toggleClass('hide',this.toggled);this.$('.col .extra').toggleClass('hide',!this.toggled);},updatePrimaryTitle:function(title){this.$('[data-container=primary-title]').text(title);},_getRecordTitle:function(model){var field=app.view.createField({view:this,def:model.fields['name'],model:model}),title=field.format(model.get('name'));field.dispose();return title;},_renderHtml:function(){this.meta=this._generateMetadata(this.mergeFields,this.collection,this.primaryRecord);app.view.invokeParent(this,{type:'view',name:'list',method:'_renderHtml'});this.rowFields={};_.each(this.fields,function(field){if(field.model.id&&_.isUndefined(field.parent)&&field.type!=='datetimecombo'){this.rowFields[field.model.id]=this.rowFields[field.model.id]||[];this.rowFields[field.model.id].push(field);}},this);this.setPrimaryEditable(this.primaryRecord.id);this.setDraggable();if(this.toggled){this.toggleMoreLess();}
this._showAlertIfIdentical();},_showAlertIfIdentical:function(){if(!this.meta||!this.meta.panels){return;}
if(!this.collection.length){return;}
var self=this,visibleFields=_.first(this.meta.panels);if(_.isEmpty(visibleFields.fields)){app.alert.show('merge_confirmation_identical',{level:'confirmation',messages:app.lang.get('TPL_MERGE_DUPLICATES_IDENTICAL',this.module),onConfirm:function(){self.layout.trigger('mergeduplicates:save:fire');},onLinkClick:function(event){if($(event.currentTarget).hasClass('cancel')){if(!self.toggled){self.toggleMoreLess();}}}});}},setDraggable:function(){var self=this,mergeContainer=this.$('[data-container=merge-container]');mergeContainer.find('[data-container=primary-label]').sortable({connectWith:self.$('[data-container=primary-label]'),appendTo:mergeContainer,axis:'x',disableSelection:true,cursor:'move',placeholder:'primary-lbl-placeholder-span',start:function(event,ui){self.$('[data-container=primary-label]').addClass('primary-lbl-placeholder');},stop:_.bind(self._onStopSorting,self)});},_onStopSorting:function(event,ui){var self=this,droppedTo=ui.item.parents('[data-record-id]');self.$('[data-container=primary-label]').removeClass('primary-lbl-placeholder');if(droppedTo.length===0){self.$('[data-container=primary-label]').sortable('cancel');return;}
if(self.primaryRecord&&self.primaryRecord.id!==droppedTo.data('record-id')){var changedAttributes=self.primaryRecord.changedAttributes(self.primaryRecord.getSyncedAttributes());if(!_.isEmpty(changedAttributes)){app.alert.show('change_primary_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_UNSAVED_CHANGES'),onConfirm:function(){self.primaryRecord.revertAttributes();self.setPrimaryEditable(droppedTo.data('record-id'));},onLinkClick:function(event){if($(event.currentTarget).hasClass('cancel')){self.$('[data-record-id='+self.primaryRecord.get('id')+'] '+'[data-container=primary-label]').sortable('cancel');}}});return;}
self.setPrimaryEditable(droppedTo.data('record-id'));}},checkCopyRadioButtons:function(){if(!this.primaryRecord){return;}
_.each(this.mergeFields,function(field){var model=this.primaryRecord,element=this.$('[data-field-name='+field.name+'][data-record-id='+model.id+']'),elements=this.$('[data-field-name='+field.name+'][data-record-id!='+model.id+']'),editAccess=app.acl.hasAccessToModel('edit',model,field.name);element.prop('disabled',!editAccess);if(!editAccess){elements.prop('disabled',true);return;}
_.each(elements,function(domElement){var el=$(domElement),readAccess=app.acl.hasAccessToModel('read',this.collection.get(el.data('record-id')),field.name);el.prop('disabled',!readAccess);},this);},this);},setPrimaryEditable:function(id){var oldPrimaryRecord=this.primaryRecord,newPrimaryRecord=this.collection.get(id||null);if(!_.isUndefined(newPrimaryRecord)&&newPrimaryRecord!==oldPrimaryRecord){this.setPrimaryRecord(newPrimaryRecord);}
if(!this.primaryRecord){return;}
if(oldPrimaryRecord&&oldPrimaryRecord!==this.primaryRecord){this.toggleFields(this.rowFields[oldPrimaryRecord.id],false);}
this.toggleFields(this.rowFields[this.primaryRecord.id],true);this.updatePrimaryTitle(this._getRecordTitle(this.primaryRecord));if(this.isPreviewOpen){this.updatePreviewRecord(this.primaryRecord);}
this.$('.primary-edit-mode').removeClass('primary-edit-mode');this.$('[data-record-id='+this.primaryRecord.id+']').addClass('primary-edit-mode');this.$('[data-record-id='+this.primaryRecord.id+'] input[type=radio]').attr('checked',true);this.checkCopyRadioButtons();},setPrimaryRecord:function(model){if(this.primaryRecord===model){return;}
if(this.primaryRecord instanceof Backbone.Model){this.primaryRecord.off(null,null,this);}
this.primaryRecord=model;this.primaryRecord.on('change',function(model){this.updatePrimaryTitle(this._getRecordTitle(this.primaryRecord));},this);this.primaryRecord.on('mergeduplicates:primary:saved',function(){this._mergeRelatedRecords();},this);this.primaryRecord.on('mergeduplicates:related:merged',function(){this._onRelatedMerged();},this);this.primaryRecord.on('mergeduplicates:primary:merged',function(){app.alert.dismiss('mergeduplicates_merging');this._showSuccessMessage();app.drawer.close(true,this.primaryRecord);},this);},triggerCopy:function(evt){var recordId=this.$(evt.currentTarget).data('record-id'),fieldName=this.$(evt.currentTarget).data('field-name'),fieldDefs=app.metadata.getModule(this.module).fields,model;if(_.isUndefined(this.primaryRecord)||_.isUndefined(this.primaryRecord.id)||_.isUndefined(recordId)||_.isUndefined(fieldName)||_.isUndefined(fieldDefs[fieldName])){return;}
model=this.collection.get(recordId);if(_.isUndefined(model)){return;}
if(!app.acl.hasAccessToModel('edit',this.primaryRecord,fieldName)||!app.acl.hasAccessToModel('read',model,fieldName)){return;}
if(model===this.primaryRecord){this.revert(fieldName);}else{this.copy(fieldName,model);}},copy:function(fieldName,model){this._setRelatedFields(fieldName,model);this.primaryRecord.set(fieldName,model.get(fieldName));this.primaryRecord.trigger('duplicate:field:'+fieldName,model!==this.primaryRecord?model:null);},revert:function(fieldName){var syncedAttributes=this.primaryRecord.getSyncedAttributes();this._setRelatedFields(fieldName,this.primaryRecord,true);this.primaryRecord.set(fieldName,!_.isUndefined(syncedAttributes[fieldName])?syncedAttributes[fieldName]:this.primaryRecord.get(fieldName));this.primaryRecord.trigger('duplicate:field:'+fieldName,null);},_setRelatedFields:function(fieldName,model,synced){synced=synced||false;var fieldDefs=app.metadata.getModule(this.module).fields,defs=fieldDefs[fieldName],syncedAttributes=synced?model.getSyncedAttributes():{};_.each(this.relatedFieldsMap,function(relatedField){if(_.isUndefined(defs[relatedField])||_.isUndefined(fieldDefs[defs[relatedField]].name)){return;}
this.primaryRecord.set(defs[relatedField],!_.isUndefined(syncedAttributes[defs[relatedField]])?syncedAttributes[defs[relatedField]]:model.get(defs[relatedField]));},this);},_getRelatedLinks:function(){var fieldDefs=app.metadata.getModule(this.module).fields,excludedLinks=this._getExcludedRelatedLinks();return _.filter(fieldDefs,function(field){return!_.isUndefined(field.type)&&field.type==='link'&&!_.contains(excludedLinks,field.name)&&this._isValidRelateLink(field)&&this._isValidRelateLinkType(field);},this);},_getExcludedRelatedLinks:function(){var excludedLinks=[],fieldDefs=app.metadata.getModule(this.module).fields;_.each(this.mergeFields,function(mergeField){var def=fieldDefs[mergeField.name];if(def.type==='relate'&&!_.isUndefined(def.link)){excludedLinks.push(def.link);}},this);return excludedLinks;},_isValidRelateLink:function(link){if(!link||!link.name){return false;}
if(_.contains(this.relatesBlacklist,link.name)){return false;}
if(!_.isUndefined(this.relatesBlacklistForModule[this.module])&&_.contains(this.relatesBlacklistForModule[this.module],link.name)){return false;}
if(!_.isUndefined(link.duplicate_merge)&&(link.duplicate_merge==='disabled'||link.duplicate_merge==='false'||link.duplicate_merge===false)){return false;}
return true;},_isValidRelateLinkType:function(link){if(!_.isUndefined(link.link_type)&&link.link_type==='one'){return false;}
return true;},_mergeRelatedRecords:function(){var self=this,alternativeModels=_.without(this.collection.models,this.primaryRecord),relatedLinks=_.pluck(this._getRelatedLinks(),'name'),progressView,queue,tasks=[];this.mergeStat={records:this.collection.models.length,total:0,total_errors:0,total_fetch_errors:0};this.mergeProgressModel=new Backbone.Model({isStopped:false});if(!alternativeModels||!alternativeModels.length){self.primaryRecord.trigger('mergeduplicates:related:merged');return;}
if(!relatedLinks||!_.isArray(relatedLinks)||!relatedLinks.length){self.primaryRecord.trigger('mergeduplicates:related:merged');return;}
progressView=this._getProgressView();progressView.reset();progressView.setTotalRecords(alternativeModels.length*relatedLinks.length);this.mergeProgressModel.trigger('massupdate:start');_.each(relatedLinks,function(link){_.each(alternativeModels,function(model){tasks.push({collection:self._createRelatedCollection(model,link)});});});queue=async.queue(function(task,callback){if(self.mergeProgressModel.get('isStopped')){callback.call();return;}
self._mergeRelatedCollection(task.collection,callback);},this._defaultSettings.queueFetchConcurrency||4);queue.drain=function(){self.mergeProgressModel.trigger('massupdate:end');if(!self.mergeProgressModel.get('isStopped')){self.primaryRecord.trigger('mergeduplicates:related:merged');}};queue.push(tasks,function(err){});},_onRelatedMerged:function(){var self=this;if(this.mergeStat.total_fetch_errors>0||this.mergeStat.total_errors>0){app.alert.show('final_confirmation',{level:'confirmation',messages:app.lang.get('LBL_MERGE_DUPLICATES_FAIL_PROCESS',this.module),onConfirm:function(){self._onMergeRelatedCompleted();},onCancel:function(){self.mergeProgressModel.trigger('massupdate:end');},autoClose:false});return;}
this._onMergeRelatedCompleted();},_onMergeRelatedCompleted:function(){app.alert.show('mergeduplicates_merging',{level:'process',title:app.lang.get('LBL_SAVING',this.module)});this._removeMerged();},_createRelatedCollection:function(model,link){var relatedCollection=app.data.createRelatedCollection(model,link);return _.extend(relatedCollection,{attempt:0,maxAllowAttempt:this._defaultSettings.maxAllowAttempt||3,objectName:app.data.getRelatedModule(this.primaryRecord.module,link)});},_mergeRelatedCollection:function(collection,callback,offset){if(this.mergeProgressModel.get('isStopped')){callback.call();return;}
offset=offset||0;var self=this,onCollectionMerged=function(){self.mergeProgressModel.trigger('massupdate:item:processed');callback.call();};collection.fetch({relate:true,limit:this._defaultSettings.relatedLinkFetchLimit||20,offset:offset,apiOptions:{timeout:this._defaultSettings.queueFetchTimeout,skipMetadataHash:true},success:function(data,response,options){if(!data||!data.models||!data.models.length){onCollectionMerged.call();return;}
var queue,tasks=[];_.each(data.models,function(model){tasks.push({relatedModel:self._createRelatedModel(model,collection.link.name)});});var queue=async.queue(function(task,callback){self._mergeRelatedModel(task.relatedModel,collection.link.name,callback);},self._defaultSettings.queueUpdateConcurrency||10);queue.drain=function(){if(!_.isUndefined(data.next_offset)&&data.next_offset!==-1){self._mergeRelatedCollection(collection,callback,data.next_offset);}else{onCollectionMerged.call();}};queue.push(tasks,function(err){});},error:function(){collection.attempt=collection.attempt+1;self.mergeProgressModel.trigger('massupdate:item:attempt',collection);if(collection.attempt<=collection.maxAllowAttempt){self._mergeRelatedCollection(collection,callback,offset);}else{self.mergeStat.total_fetch_errors=self.mergeStat.total_fetch_errors+1;self.mergeProgressModel.trigger('massupdate:item:fail',collection);onCollectionMerged.call();}}});},_createRelatedModel:function(model,link){var self=this,relatedModel=app.data.createRelatedBean(this.primaryRecord,model.get('id'),link);return _.extend(relatedModel,{attempt:0,maxAllowAttempt:this._defaultSettings.maxAllowAttempt||3,objectName:app.data.getRelatedModule(self.primaryRecord.module,link)});},_mergeRelatedModel:function(model,link,callback){if(this.mergeProgressModel.get('isStopped')){callback.call();return;}
var self=this;model.save(null,{showAlerts:false,relate:true,apiOptions:{timeout:this._defaultSettings.queueUpdateTimeout,skipMetadataHash:true},success:function(){self.mergeStat.total=self.mergeStat.total+1;callback.call();},error:function(error){model.attempt=model.attempt+1;self.mergeProgressModel.trigger('massupdate:item:attempt',model);if(model.attempt<=model.maxAllowAttempt){self._mergeRelatedModel(model,link,callback);}else{self.mergeStat.total_errors=self.mergeStat.total_errors+1;self.mergeProgressModel.trigger('massupdate:item:fail',model);callback.call();}}});},_getProgressView:function(){var progressView=this.layout.getComponent('merge-duplicates-progress');if(!progressView){progressView=app.view.createView({context:this.context,name:'merge-duplicates-progress',layout:this.layout,model:this.mergeProgressModel});this.layout._components.push(progressView);this.layout.$el.append(progressView.$el);}
progressView.render();return progressView;},_showSuccessMessage:function(){app.alert.show('mergerelated_final_notice',{level:'success',messages:app.lang.get('TPL_MERGE_DUPLICATES_STAT',this.module,{stat:this.mergeStat}),autoClose:true,autoCloseDelay:8000});},bindDataChange:function(){if(!this.collection){return;}
this.collection.on('reset',function(coll){if(coll.length){this.setPrimaryRecord(coll.at(0));}
if(this.disposed){return;}
this.render();},this);},_dispose:function(){if(!_.isEmpty(this.primaryRecord)){this.primaryRecord.off(null,null,this);}
this._super('_dispose');}})},"forgotpassword":{"controller":({plugins:['ErrorDecoration'],events:{'click [name=cancel_button]':'cancel','click [name=forgotPassword_button]':'forgotPassword','change select[name=country]':'render'},_declareModel:function(meta){meta=meta||{};var fields={};_.each(_.flatten(_.pluck(meta.panels,"fields")),function(field){fields[field.name]=field;});app.data.declareModel('Forgotpassword',{fields:fields});},initialize:function(options){this._declareModel(options.meta);options.context.prepare(true);app.view.View.prototype.initialize.call(this,options);this._showResult=false;},_render:function(){if(!(app.config&&app.config.forgotpasswordON===true)){return;}
this.logoUrl=app.metadata.getLogoUrl();app.view.View.prototype._render.call(this);return this;},cancel:function(){app.router.goBack();},forgotPassword:function(){var self=this;self.model.doValidate(null,function(isValid){if(isValid){if(app.config.honeypot_on&&app.config.honeypot_on===true&&(self.$('input[name="first_name"]').val()||self.model.get('first_name')))return;app.$contentEl.hide();app.alert.show('forgotPassword',{level:'process',title:app.lang.getAppString('LBL_LOADING'),autoClose:false});var emails=self.model.get('email');var params={username:self.model.get('username')};if(emails&&emails[0]&&emails[0].email_address){params.email=emails[0].email_address;}
var url=app.api.buildURL('password/request','',{},params);app.api.call('READ',url,{},{success:function(response){self._showSuccess=true;self._showResult=true;self.resultLabel="LBL_PASSWORD_REQUEST_SENT";self.model.clear();if(!self.disposed){self.render();}},error:function(err){self._showSuccess=false;self._showResult=true;self.resultLabel=err.message||'LBL_PASSWORD_REQUEST_ERROR';if(!self.disposed){self.render();}},complete:function(){app.alert.dismiss('forgotPassword');app.$contentEl.show();}})}},self);},_backButton:[{name:'cancel_button',type:'button',label:'LBL_BACK',value:'forgotPassword',primary:false}]})},"attachments":{"controller":({plugins:['LinkedModel','Dashlet','Timeago'],events:{'click [name=show_more_button]':'showMore','click [data-event=create_button]':'createRelatedNote','click [data-event=select_button]':'openSelectDrawer'},_defaultOptions:{limit:5,timer:0},initDashlet:function(viewName){this._initOptions();if(!this.meta.config&&this.context.get('collection')){this.context.set('skipFetch',false);this.context.set('limit',this.limit);}
if(!this.meta.config&&!this.meta.preview){this.context.on('attachment:view:fire',this.previewRecord,this);this.context.on('attachment:unlinkrow:fire',this.unlinkClicked,this);if(this.timer>0){this._disableAutoRefresh();this._enableAutoRefresh(this.timer);}}},_initOptions:function(){var options=_.extend(this._defaultOptions,this.settings.attributes||{});this.timer=parseInt(options['auto_refresh'],10)*60*1000;this.limit=options.limit;return this;},_disableAutoRefresh:function(){if(this.timerId){clearInterval(this.timerId);this.timerId=null;}
return this;},_enableAutoRefresh:function(msec){if(msec<=0){app.logger.error('Invalid interval timer: '+msec);return this;}
if(!_.isEmpty(this.timerId)){app.logger.error('Trying to enable an already enabled auto-refresh dashlet.');return this;}
this.timerId=setInterval(_.bind(function(){this.context.resetLoadFlag();this.layout.loadData();},this),msec);return this;},_renderHtml:function(){var self=this,svgIconTemplate=app.template.get('attachments.svg-icon',this.module)||app.template.get('attachments.svg-icon');app.view.View.prototype._renderHtml.call(this);this.$('[data-mime]').each(function(){var mimeType=$(this).data('mime'),filetype=self.dashletConfig.supportedImageExtensions[mimeType]||self._getFileType(mimeType);$(this).attr('data-filetype',filetype).html(svgIconTemplate());});return this;},_getFileType:function(mimeType){var filetype=mimeType.substr(mimeType.lastIndexOf('/')+1).toUpperCase();return filetype?filetype:this.dashletConfig.defaultType.toUpperCase();},bindDataChange:function(){if(this.collection){this.collection.on('reset',this.render,this);}},showMore:function(){this.collection.paginate({add:true,limit:this.limit,success:_.bind(function(){if(this.disposed){return;}
this.render();},this)});},openSelectDrawer:function(){var parentModel=this.context.get('parentModel'),linkModule=this.context.get('module'),link=this.context.get('link'),self=this;app.drawer.open({layout:'link-selection',context:{module:linkModule}},function(model){if(!model){return;}
var relatedModel=app.data.createRelatedBean(parentModel,model.id,link),options={showAlerts:true,relate:true,success:function(model){self.context.resetLoadFlag();self.context.set('skipFetch',false);self.context.loadData();},error:function(error){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false});}};relatedModel.save(null,options);});},createRelatedNote:function(){var link=this.context.get('link'),parentModel=this.context.get('parentModel');this.createRelatedRecord(app.data.getRelatedModule(parentModel.module,link),link);},unlinkClicked:function(model){var self=this;app.alert.show('unlink_confirmation',{level:'confirmation',messages:app.lang.get('NTC_UNLINK_CONFIRMATION'),onConfirm:function(){model.destroy({showAlerts:true,relate:true,success:function(){if(self.disposed){return;}
self.collection.remove(model).trigger('reset');self.render();}});}});},_dispose:function(){this._disableAutoRefresh();app.view.View.prototype._dispose.call(this);}})},"link-headerpane":{"controller":({extendsFrom:'HeaderpaneView',linkModule:null,link:null,initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('LinkedModel');this.events=_.extend({},this.events||{},{'click [name=create_button]':'createClicked','click [name=cancel_button]':'cancelClicked','click [name=select_button]':'selectClicked'});this.action=options.meta.action;var meta=app.metadata.getView(null,options.name);options.meta=_.extend({type:'headerpane'},options.meta,meta[this.action]);app.view.invokeParent(this,{type:'view',name:'headerpane',method:'initialize',args:[options]});this.context.on("link:module:select",this.setModule,this);},setModule:function(meta){if(meta){this.linkModule=meta.module;this.link=meta.link;}else{this.linkModule=null;this.link=null;}},_dispose:function(){this.context.off("link:module:select",null,this);app.view.invokeParent(this,{type:'view',name:'headerpane',method:'_dispose'});},selectClicked:function(){if(_.isEmpty(this.link)){app.alert.show('invalid-data',{level:'error',messages:app.lang.get('ERROR_EMPTY_LINK_MODULE'),autoClose:true});return;}
var parentModel=this.model,module=app.data.getRelatedModule(this.model.module,this.link),link=this.link,self=this;app.drawer.open({layout:'link-selection',context:{module:module}},function(model){if(!model){return;}
var relatedModel=app.data.createRelatedBean(parentModel,model.id,link),options={showAlerts:true,relate:true,success:function(model){app.drawer.closeImmediately(self.context,model);},error:function(error){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false});}};relatedModel.save(null,options);});},createClicked:function(){if(_.isEmpty(this.link)){app.alert.show('invalid-data',{level:'error',messages:app.lang.get('ERROR_EMPTY_LINK_MODULE'),autoClose:true});return;}
var model=this.createLinkModel(this.model,this.link);app.drawer.open({layout:'create-actions',context:{module:model.module,model:model,create:true}},function(context,model){if(!model){return;}
app.drawer.closeImmediately(context,model);});},cancelClicked:function(){app.drawer.close();}})},"flex-list":{"controller":({extendsFrom:'ListView',className:'flex-list-view',_previewed:null,displayFirstNColumns:null,plugins:['Tooltip'],initialize:function(options){app.view.invokeParent(this,{type:'view',name:'list',method:'initialize',args:[options]});this.template=app.template.getView('flex-list');this.events=_.clone(this.events);this.leftColumns=[];this.rightColumns=[];this.addActions();this.visibleFieldsLastStateKey=app.user.lastState.key('visible-fields',this);this._fields=this.parseFields();this.addPreviewEvents();this.resize=_.bind(_.debounce(this.resize,200),this);this.bindResize();if(this.rightColumns.length){this.events=_.extend({},this.events,{'click.right-actions .actions [data-toggle=dropdown]':'delegateDropdown'});}},delegateDropdown:function(e){var $button=this.$(e.currentTarget).first(),$buttonGroup=$button.parents('.btn-group'),menuHeight=$button.height()+$button.next('ul').height(),windowHeight=$(window).height()-65;var needsDropupClass=function(b){return(windowHeight<b.offset().top+menuHeight);};var resetDropdownDelegate=function(){$(this).tooltip('enable');$(this).parents('.main-pane').off('scroll.right-actions');$(this).off('resetDropdownDelegate.right-actions');};this.$('.actions [data-toggle=dropdown]').trigger('resetDropdownDelegate.right-actions');if(!$buttonGroup.hasClass('open')){$button.tooltip('destroy');$button.tooltip('disable');$buttonGroup.toggleClass('dropup',needsDropupClass($button));$button.on('resetDropdownDelegate.right-actions',resetDropdownDelegate);$button.parents('.main-pane').on('scroll.right-actions',_.bind(_.debounce(function(){if(!$buttonGroup.hasClass('open')){$button.off('resetDropdownDelegate.right-actions');return;}
$buttonGroup.toggleClass('dropup',needsDropupClass($button));},30),this));}},addPreviewEvents:function(){this.context.on("list:preview:fire",function(model){app.events.trigger("preview:render",model,this.collection,true);},this);app.events.on("list:preview:decorate",this.decorateRow,this);if(this.layout){this.layout.on("list:sort:fire",function(){app.events.trigger("preview:close");},this);this.layout.on("list:paginate:success",function(){app.events.trigger("preview:collection:change",this.collection);if(this._previewed){this.decorateRow(this._previewed);}},this);}},parseFields:function(){var catalog={'default':[],'available':[],'visible':[],'options':[]};var visibleFieldsLastState=false;if(this.visibleFieldsLastStateKey){visibleFieldsLastState=app.user.lastState.get(this.visibleFieldsLastStateKey);if(!_.isArray(visibleFieldsLastState)||visibleFieldsLastState.length===0){visibleFieldsLastState=false;}}
_.each(this.meta.panels,function(panel){_.each(panel.fields,function(fieldMeta,i){if(_.isNumber(this.displayFirstNColumns)){fieldMeta['default']=(i<this.displayFirstNColumns);panel.fields[i]=fieldMeta;}
var fieldVisible=(fieldMeta['default']!==false);if(fieldVisible){catalog['default'].push(fieldMeta);}
if(visibleFieldsLastState!==false){fieldVisible=(_.indexOf(visibleFieldsLastState,fieldMeta.name)!==-1);}
if(fieldVisible){catalog.visible.push(fieldMeta);}else{catalog.available.push(fieldMeta);}
catalog.options.push(_.extend({selected:fieldVisible},fieldMeta));},this);},this);return catalog;},addActions:function(){var meta=this.meta;if(_.isObject(meta.selection)){switch(meta.selection.type){case'single':this.addSingleSelectionAction();break;case'multi':this.addMultiSelectionAction();break;default:break;}}
if(meta&&_.isObject(meta.rowactions)){this.addRowActions();}},addSingleSelectionAction:function(){var _generateMeta=function(name,label){return{'type':'selection','name':name,'sortable':false,'label':label||''};};var def=this.meta.selection;this.leftColumns.push(_generateMeta(def.name||this.module+'_select',def.label));},addMultiSelectionAction:function(){var _generateMeta=function(buttons,disableSelectAllAlert){return{'type':'fieldset','fields':[{'type':'actionmenu','buttons':buttons||[],'disable_select_all_alert':!!disableSelectAllAlert}],'value':false,'sortable':false};};var buttons=this.meta.selection.actions,disableSelectAllAlert=!!this.meta.selection.disable_select_all_alert;this.leftColumns.push(_generateMeta(buttons,disableSelectAllAlert));},addRowActions:function(){var _generateMeta=function(label,css_class,buttons){return{'type':'fieldset','fields':[{'type':'rowactions','label':label||'','css_class':css_class,'buttons':buttons||[]}],'value':false,'sortable':false};};var def=this.meta.rowactions;this.rightColumns.push(_generateMeta(def.label,def.css_class,def.actions));},decorateRow:function(model){if(_.isUndefined(app.drawer)||app.drawer.isActive(this.$el)){this._previewed=model;this.$("tr.highlighted").removeClass("highlighted current above below");if(model){var rowName=model.module+"_"+model.get("id");var curr=this.$("tr[name='"+rowName+"']");curr.addClass("current highlighted");curr.prev("tr").addClass("highlighted above");curr.next("tr").addClass("highlighted below");}}},_renderHtml:function(ctx,options){this.colSpan=this._fields.visible.length||0;if(this.leftColumns.length){this.colSpan++;}
if(this.rightColumns.length){this.colSpan++;}
if(this.colSpan<2){this.colSpan=null;}
app.view.View.prototype._renderHtml.call(this,ctx,options);if(this.leftColumns.length){this.$el.addClass('left-actions');}
if(this.rightColumns.length){this.$el.addClass('right-actions');}
this.resize();},unbind:function(){$(window).off("resize.flexlist-"+this.cid);app.view.invokeParent(this,{type:'view',name:'list',method:'unbind'});},bindResize:function(){$(window).on("resize.flexlist-"+this.cid,_.bind(this.resize,this));},resize:function(){if(this.disposed){return;}
var $content=this.$('.flex-list-view-content');if(!$content.length){return;}
var toggle=$content.get(0).scrollWidth>$content.width()+1;this.$el.toggleClass('scroll-width',toggle);},_dispose:function(){this.$('.actions [data-toggle=dropdown]').trigger('resetDropdownDelegate.right-actions');this._super('_dispose');}})},"funnel":{"controller":({initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.funnelCollection=app.data.createBeanCollection(this.module);this.funnelCollection.fetch({showAlerts:false});this.guid=_.uniqueId("funnel");},_render:function(){var self=this;app.view.View.prototype._render.call(this);this.funnelCollection.on("reset",function(){var day_ms=1000*60*60*24;var today=new Date();today.setUTCHours(0,0,0,0);var d1=new Date(today.getTime()+31*day_ms);var data,sum;if(self.funnelCollection){data=self.funnelCollection.filter(function(model){var d2=new Date(model.get("date_closed")||"1970-01-01");return(d2-d1)/day_ms<=30;});sum=_.reduce(data,function(memo,model){return memo+parseInt(model.get('amount_usdollar'),10);},0);data=_.groupBy(data,function(m){return m.get("sales_stage");});}
var stages=["Prospecting","Qualification","Closed Lost","Closed Won"];var scale=1000;var root={properties:{scale:scale,title:"Pipeline",units:"$",total:parseInt(sum/scale,10)},data:[]};var cumulative=0;_.each(stages,function(stage,i){var subtotal=0;if(data&&data[stage]){subtotal=_.reduce(data[stage],function(memo,model){return memo+parseInt(model.get('amount_usdollar'),10);},0)/scale;}
root.data.push({bar:true,key:stage,values:[{series:i,x:0,y:subtotal,y0:cumulative}]});cumulative+=subtotal;});nv.addGraph(function(){var chart=nv.models.funnelChart();chart.yAxis.tickFormat(d3.format(',.1f'));chart.showTitle(false);d3.select('#'+self.guid+' svg').datum(root).transition().duration(500).call(chart);nv.utils.windowResize(chart.update);return chart;});});},unbindData:function(){this.funnelCollection.off();this.funnelCollection=null;app.view.View.prototype.unbindData.call(this);}})},"setup-complete-wizard-page":{"controller":({extendsFrom:"WizardPageView",wizardName:"",initialize:function(options){this.events=_.extend({},this.events,{"click a.thumbnail":"linkClicked","click [name=start_sugar_button]:not(.disabled)":"next"});app.view.invokeParent(this,{type:'view',name:'wizard-page',method:'initialize',args:[options]});this.wizardName=this.context.get("wizardName")||"user";},isPageComplete:function(){return true;},linkClicked:function(ev){var href,redirectUrl,target=this.$(ev.currentTarget);if(this.$(target).attr("target")!=="_blank"){ev.preventDefault();$("#header").show();href=this.$(target).attr("href");if(href.indexOf('#bwc/')===0){redirectUrl=href.split('#bwc/')[1];app.bwc.login(redirectUrl);}else{app.router.navigate($(ev.currentTarget).attr("href"),{trigger:true});}}},_render:function(){this._super('_render');app.user.unset("show_wizard");}})}}},"layouts":{"base":{"activitystream":{"controller":({className:"block filtered activitystream-layout",initialize:function(opts){this.opts=opts;this.renderedActivities={};app.view.Layout.prototype.initialize.call(this,opts);this.setCollectionOptions();this.exposeDataTransfer();this.context.on("activitystream:post:prepend",this.prependPost,this);},setCollectionOptions:function(){var self=this;var endpoint=function(method,model,options,callbacks){var real_module=self.context.parent.get('module'),layoutType=self.context.parent.get('layout'),modelId=self.context.parent.get('modelId'),action=model.module,url;switch(layoutType){case"activities":url=app.api.buildURL(real_module,null,{},options.params);break;case"records":url=app.api.buildURL(real_module,action,{},options.params);break;case"record":url=app.api.buildURL(real_module,"activities",{id:modelId,link:true},options.params);break;}
return app.api.call("read",url,null,callbacks);};this.context.set("collectionOptions",{endpoint:endpoint,success:function(collection){collection.each(function(model){self.renderPost(model);});}});},exposeDataTransfer:function(){jQuery.event.props.push('dataTransfer');},bindDataChange:function(){if(this.collection){this.collection.on('add',function(model){this.renderPost(model);},this);this.collection.on('reset',function(){this.disposeAllActivities();this.collection.each(function(post){this.renderPost(post);},this);},this);}
if(this.context.parent){var model=this.context.parent.get("model");this.listenTo(model,"sync",_.once(function(){this.listenTo(model,"sync",function(){var options=this.context.get("collectionOptions");this.collection.fetch(options);});}));}},prependPost:function(model){var view=this.renderPost(model);view.$el.parent().prepend(view.$el);},loadData:function(options){var parentCol=this.context.parent.get("collection");if(parentCol.isEmpty()){parentCol.once("sync",function(){this._load(options);},this);}else{this._load(options);}},_load:function(options){if(_.isUndefined(this.context.parent.get('layout'))){return;}
options=_.extend({},options,this.context.get('collectionOptions'));this.collection.fetch(options);},renderPost:function(model,readonly){var view;if(_.has(this.renderedActivities,model.id)){view=this.renderedActivities[model.id];}else{view=app.view.createView({context:this.context,name:"activitystream",module:this.module,layout:this,model:model,readonly:readonly});this.addComponent(view);this.renderedActivities[model.id]=view;view.render();}
return view;},_placeComponent:function(component){if(this.disposed)
return;if(component.name==="activitystream"){this.$el.find(".activitystream-list").append(component.el);}else if(component.name==="activitystream-bottom"){this.$el.append(component.el);component.render();}else{this.$el.prepend(component.el);}},unbindData:function(){var model,collection;if(this.context.parent){model=this.context.parent.get("model");collection=this.context.parent.get("collection");if(model){model.off("change sync",null,this);}
if(collection){collection.off("sync",null,this);}}
app.view.Layout.prototype.unbindData.call(this);},disposeAllActivities:function(){var nonActivities=[];_.each(this._components,function(component){if(component.name!=='activitystream'){nonActivities.push(component);}else{component.dispose();}});this._components=nonActivities;this.renderedActivities={};}})},"subpanels":{"controller":({initialize:function(opts){if(!opts.meta)return;app.view.Layout.prototype.initialize.call(this,opts);this.layout.on("subpanel:change",this.showSubpanel,this);this.listenTo(this.layout,'filter:change',function(linkModuleName,linkName){this.trigger('filter:change',linkModuleName,linkName);});},_pruneNoAccessComponents:function(components){var prunedComponents=[];var layoutFromContext=this.context?this.context.get('layout')||this.context.get('layoutName'):null;this.layoutType=layoutFromContext?layoutFromContext:app.controller.context.get('layout');this.aclToCheck=this.aclToCheck||(this.layoutType==='record')?'view':'list';_.each(components,function(component){var relatedModule,link=component.context?component.context.link:null;if(link){relatedModule=app.data.getRelatedModule(this.module,link);if(!relatedModule||relatedModule&&app.acl.hasAccess(this.aclToCheck,relatedModule)){prunedComponents.push(component);}}},this);return prunedComponents;},_pruneHiddenComponents:function(components){var hiddenSubpanels=app.metadata.getHiddenSubpanels();var visibleSubpanels=_.filter(components,function(component){var relatedModule=app.data.getRelatedModule(this.module,component.context.link);return _.isEmpty(_.find(hiddenSubpanels,function(hiddenPanel){return hiddenPanel.toLowerCase()===relatedModule.toLowerCase();}));},this);return visibleSubpanels;},_addComponentsFromDef:function(components,context,module){var allowedComponents=this._pruneHiddenComponents(components);allowedComponents=this._pruneNoAccessComponents(allowedComponents);app.view.Layout.prototype._addComponentsFromDef.call(this,allowedComponents,context,module);this._markComponentsAsSubpanels();this._disableSubpanelToggleButton(allowedComponents);},_disableSubpanelToggleButton:function(allowedComponents){if(!allowedComponents||!allowedComponents.length){this.layout.trigger('filterpanel:change','activitystream',true,true);this.layout.trigger('filterpanel:toggle:button','subpanels',false);}},showSubpanel:function(linkName){var self=this,cacheKey="subpanels:last:"+self.module;if(linkName){app.cache.set(cacheKey,linkName);}
_.each(this._components,function(component){var link=component.context.get('link');if(!linkName||linkName===link){component.context.set("hidden",false);component.show();}else{component.context.set("hidden",true);component.hide();}});},_markComponentsAsSubpanels:function(){_.each(this._components,function(component){component.context.set("isSubpanel",true);});},loadData:function(options){_.each(this._components,function(component){component.loadData(options);});}})},"tabbed-layout":{"controller":({initialize:function(options){this.firstIsActive=false;this.template=app.template.get("l.tabbed-layout");this.renderHtml();app.view.Layout.prototype.initialize.call(this,options);},renderHtml:function(){this.$el.html(this.template(this));},_placeComponent:function(comp,def){var id=_.uniqueId('record-bottom'),nav=$('<li/>').html('<a href="#'+id+'" onclick="return false;" data-toggle="tab">'+app.lang.get(def.layout.name,this.module)+'</a>'),content=$('<div/>').addClass('tab-pane').attr('id',id).html(comp.el);if(!this.firstIsActive){nav.addClass('active');content.addClass('active');}
this.firstIsActive=true;this.$('.tab-content').append(content);this.$('.nav').append(nav);}})},"subpanel":{"controller":({extendsFrom:"PanelLayout",initialize:function(opts){opts.type="panel";if(opts.meta&&opts.def&&opts.def.override_subpanel_list_view){_.each(opts.meta.components,function(def){if(def.view&&def.view=="subpanel-list"){def.view=opts.def.override_subpanel_list_view;}});if(opts.meta.last_state.id){opts.meta.last_state.id=opts.def.override_subpanel_list_view;}}
app.view.invokeParent(this,{type:'layout',name:'panel',method:'initialize',args:[opts]});}})},"footer":{"controller":({_placeComponent:function(component){this.$el.find('.btn-toolbar').append(component.$el);},_render:function(){this.logoUrl=app.metadata.getLogoUrl();this.$el.html(this.template(this));_.each(this._components,function(component){this._placeComponent(component);},this);app.view.Layout.prototype._render.call(this);}})},"togglepanel":{"controller":({events:{"click .toggle-actions a.btn":"toggleView"},plugins:['Tooltip'],initialize:function(opts){this.toggleComponents=[];this.componentsList={};this.processToggles();app.view.Layout.prototype.initialize.call(this,opts);},_render:function(){this._super('_render');this.toggleViewLastStateKey=app.user.lastState.key('toggle-view',this);var lastViewed=app.user.lastState.get(this.toggleViewLastStateKey);if(_.isUndefined(lastViewed)||this.isToggleButtonDisabled(lastViewed)){var enabledToggles=_.filter(this.toggles,function(toggle){return!toggle.disabled;});if(enabledToggles.length>0){lastViewed=_.first(enabledToggles).toggle;}}
this.showComponent(lastViewed);this.$('[data-view="'+lastViewed+'"]').button('toggle');},isToggleButtonDisabled:function(name){var disabled=false,toggleButton;toggleButton=_.find(this.toggles,function(toggle){return toggle.toggle===name;});if(toggleButton){disabled=toggleButton.disabled;}
return disabled;},processToggles:function(){this.toggles=[];var temp={};_.each(this.options.meta.components,function(component){var toggle;if(component.view){toggle=component.view;}else if(component.layout){toggle=(_.isString(component.layout))?component.layout:component.layout.name;}
var availableToggle=_.find(this.options.meta.availableToggles,function(curr){return curr.name===toggle;},this);if(toggle&&availableToggle){var disabled=!!availableToggle.disabled;temp[toggle]={toggle:toggle,title:availableToggle.label,'class':availableToggle.icon,disabled:disabled};}},this);if(this.options.meta.availableToggles){for(var i=0;i<this.options.meta.availableToggles.length;i++){var curr=this.options.meta.availableToggles[i];if(temp[curr.name]){this.toggles.push(temp[curr.name]);}}}},_placeComponent:function(component,def){if(def&&def.targetEl){if(def.position=='prepend'){this.$(def.targetEl).prepend(component.el);return;}else{this.$(def.targetEl).append(component.el);}}else{var toggleAvailable=_.isObject(_.find(this.options.meta.availableToggles,function(curr){return curr.name===component.name;}));if(toggleAvailable){this.toggleComponents.push(component);this.componentsList[component.name]=component;this._components.splice(this._components.indexOf(component),1);}else{component.render();this.$(".main-content").append(component.el);}}},toggleView:function(e){var $el=this.$(e.currentTarget);if($el.attr('disabled')==='disabled'){e.preventDefault();e.stopPropagation();return;}
if(!$el.hasClass("active")){var data=$el.data();app.user.lastState.set(this.toggleViewLastStateKey,data.view);this.showComponent(data.view);this.reloadData(data.view);}},showComponent:function(name){if(!name)return;if(this.componentsList[name]){this.componentsList[name].render();this._components.push(this.componentsList[name]);this.$(".main-content").append(this.componentsList[name].el);}
_.each(this.toggleComponents,function(comp){if(comp.name==name){comp.show();}else{comp.hide();}},this);this.trigger('filterpanel:change',name);},reloadData:function(name){var layout=this.componentsList[name];if(layout){layout.context.resetLoadFlag(true);layout.loadData();}},_dispose:function(){_.each(this.componentsList,function(component){if(component){component.dispose();}});this.componentsList={};this.toggleComponents=null;app.view.Layout.prototype._dispose.call(this);}})},"preview":{"controller":({events:{"click .closeSubdetail":"hidePreviewPanel"},initialize:function(opts){app.view.Layout.prototype.initialize.call(this,opts);app.events.on("preview:open",this.showPreviewPanel,this);app.events.on("preview:close",this.hidePreviewPanel,this);},showPreviewPanel:function(event){if(_.isUndefined(app.drawer)||app.drawer.isActive(this.$el)){var layout=this.$el.parents(".sidebar-content");layout.find(".side-pane").removeClass("active");layout.find(".dashboard-pane").hide();layout.find(".preview-pane").addClass("active");}},hidePreviewPanel:function(event){if(_.isUndefined(app.drawer)||app.drawer.isActive(this.$el)){var layout=this.$el.parents(".sidebar-content");layout.find(".side-pane").addClass("active");layout.find(".dashboard-pane").show();layout.find(".preview-pane").removeClass("active");}}})},"dashletconfiguration":{"controller":({initialize:function(options){var meta=app.metadata.getLayout(options.module,options.name),main_panel;_.each(meta.components,function(component){main_panel=_.find(component.layout.components,function(childComponent){return childComponent.layout&&childComponent.layout.name==='main-pane';},this);},this);if(main_panel){main_panel.layout.components=_.union(main_panel.layout.components,options.meta.components);}
options.meta=meta;app.view.Layout.prototype.initialize.call(this,options);}})},"modal":{"controller":({baseComponents:[{'view':'modal-header'}],initialize:function(options,skipModalJsCheck){var self=this,showEvent=options.meta.showEvent;if(!skipModalJsCheck){if(!_.isFunction(this.$el.modal)){app.logger.error("Unable to load modal.js: Needs bootstrap modal plugin.");}}
this.metaComponents=options.meta.components;options.meta.components=this.baseComponents;if(options.meta.before){_.each(options.meta.before,function(callback,event){self.before(event,callback);});}
app.view.Layout.prototype.initialize.call(this,options);options.meta.components=this.metaComponents;if(showEvent){if(_.isArray(showEvent)){_.each(showEvent,function(evt,index){self._bindShowEvent(evt);});}else{self._bindShowEvent(showEvent);}}},_bindShowEvent:function(event,delegate){var self=this;if(_.isObject(event))
{delegate=event.delegate;event=event.event;}
if(delegate){self.layout.events=self.layout.events||{};self.layout.events[event]=function(params,callback){self.show(params,callback)};self.layout.delegateEvents();}else{self.layout.on(event,function(params,callback){self.show(params,callback);},self);}},getBodyComponents:function(){return _.rest(this._components,this._initComponentSize);},_placeComponent:function(comp,def){if(this.$('.modal:first').length==0){this.$el.append($('<div>',{'class':'modal hide'}).append(this.$body));}
if(def.bodyComponent){if(_.isUndefined(this.$body)){this.$body=$('<div>',{'class':'modal-body'});this.$('.modal:first').append(this.$body);}
this.$body.append(comp.el);}else{this.$('.modal:first').append(comp.el);}},_buildComponentsBeforeShow:function(params,callback){var self=this,params=params||{},buttons=params.buttons||[],message=params.message||'',components=(params.components||this.metaComponents||[]),title=(params.title||this.meta.title)+'';if(message&&components.length==0){this.confirmMessage=message;components.push({view:'modal-confirm'});}
if(components.length==0){app.logger.error("Unable to display modal dialog: no components or message");return false;}
var header_view=self.getComponent('modal-header');if(header_view){header_view.setTitle(title);header_view.setButton(buttons);}
if(self._initComponentSize){for(var i=0;i<self._components.length;i++){self._components[self._components.length-1].$el.remove();self.removeComponent(self._components.length-1);}}else{self._initComponentSize=self._components.length;}
this._addComponentsFromDef(components);self.context.off("modal:callback");self.context.on("modal:callback",function(model){callback(model);self.hide();},self);self.context.off("modal:close");self.context.on("modal:close",self.hide,self);},show:function(params,callback){if(!this.triggerBefore("show")||this.disposed)return false;var self=this;if(params.before){_.each(params.before,function(callback,event){self.offBefore(event);self.before(event,callback);});}
if(this._buildComponentsBeforeShow(params,callback)===false)
return false;this.loadData();this.render();var width=params?params.width:null,options=params?params.options||{}:{},modal_container=this.$(".modal:first");modal_container.attr("style","");if(_.isNumber(width)){modal_container.width(width);modal_container.css('marginLeft',-(width/2)+'px');}
if(!_.isFunction(modal_container.modal)){app.logger.error("Unable to load modal.js: Needs bootstrap modal plugin.");return false;}
modal_container.modal(_.extend({keyboard:false,backdrop:'static'},options.modal));modal_container.modal('show');this.trigger("show");return true;},hide:function(event){if(!this.triggerBefore("hide"))return false;var modal_container=this.$(".modal:first");modal_container.scrollTop(0);if(!_.isFunction(modal_container.modal)){app.logger.error("Unable to load modal.js: Needs bootstrap modal plugin.");return false;}
modal_container.modal('hide');this.trigger("hide");return true;}})},"dashboard":{"controller":({toggled:false,className:'row-fluid',error:{handleNotFoundError:function(error){app.router.redirect("#Home");return false;},handleValidationError:function(error){return false;}},initialize:function(options){var context=options.context,module=context.parent?context.parent.get("module"):context.get("module"),view=context.parent?context.parent.get("layout"):'',sync=function(method,model,options){options=app.data.parseOptionsForSync(method,model,options);var callbacks=app.data.getSyncCallbacks(method,model,options),path=(this.dashboardModule==='Home'||model.id)?this.apiModule:this.apiModule+'/'+this.dashboardModule;if(method==='read'){options.params.view=view;}
app.api.records(method,path,model.attributes,options.params,callbacks);},Dashboard=app.Bean.extend({sync:sync,apiModule:'Dashboards',module:'Home',dashboardModule:module,maxColumns:(module==='Home')?3:1,maxRowColumns:(module==='Home')?3:2}),DashboardCollection=app.BeanCollection.extend({sync:sync,apiModule:'Dashboards',module:'Home',dashboardModule:module,model:Dashboard});if(options.meta&&options.meta.method&&options.meta.method==='record'&&!context.get("modelId")){context.set("create",true);}
var model=new Dashboard();model.set("view",view);if(context.get("modelId")){model.set("id",context.get("modelId"),{silent:true});}
context.set("model",model);context.set("collection",new DashboardCollection());app.view.Layout.prototype.initialize.call(this,options);this.model.on("setMode",function(mode){if(mode==="edit"||mode==="create"){this.$(".dashboard").addClass("edit");}else{this.$(".dashboard").removeClass("edit");}},this);if(module==='Home'){this.on("render",this.toggleSidebar,this);if(context.get('modelId')){var lastVisitedStateKey=this.getLastStateKey();app.user.lastState.set(lastVisitedStateKey,context.get('modelId'));}}},loadData:function(options,setFields){if(this.context.parent&&!this.context.parent.isDataFetched()){var parent=this.context.parent.get("modelId")?this.context.parent.get("model"):this.context.parent.get("collection");parent.once("sync",function(){app.view.Layout.prototype.loadData.call(this,options,setFields);},this);}else{app.view.Layout.prototype.loadData.call(this,options,setFields);}},toggleSidebar:function(){if(!this.toggled){app.controller.context.trigger('toggleSidebar');this.toggled=true;}},_placeComponent:function(component){var dashboardEl=this.$("[data-dashboard]"),css=this.context.get("create")?" edit":"";if(dashboardEl.length===0){dashboardEl=$("<div></div>").attr({'class':'cols row-fluid'});this.$el.append($("<div></div>").addClass('dashboard'+css).attr({'data-dashboard':'true'}).append(dashboardEl));}else{dashboardEl=dashboardEl.children(".row-fluid");}
dashboardEl.append(component.el);},dashboardLayouts:{'record':'record-dashboard','records':'list-dashboard'},bindDataChange:function(){var modelId=this.context.get("modelId");if(!(modelId&&this.context.get("create"))&&this.collection){this.collection.on("reset",this.setDefaultDashboard,this);}},setDefaultDashboard:function(){if(this.disposed){return;}
var self=this;if(this.collection.models.length>0){var model=_.first(this.collection.models),lastVisitedStateKey=this.getLastStateKey(),lastViewed=app.user.lastState.get(lastVisitedStateKey);if(lastViewed){var lastVisitedModel=this.collection.get(lastViewed);if(!_.isEmpty(lastVisitedModel)){app.user.lastState.set(lastVisitedStateKey,'');model=lastVisitedModel;}}
if(this.context.parent){this.navigateLayout(model.id);}else{this.dispose();app.navigate(this.context,model);}}else{var layoutName=this.dashboardLayouts[this.context.parent?this.context.parent.get("layout"):'record'],_initDashboard=app.metadata.getLayout(this.model.dashboardModule,layoutName),params={silent:true,showAlerts:false};if(this.context.parent){params.success=function(model){self.navigateLayout(model.id);};params.error=function(){self.navigateLayout("create");};}else{params.success=function(model){app.navigate(self.context,model);};params.error=function(){var route=app.router.buildRoute(self.module,null,'create');app.router.navigate(route,{trigger:true});};}
if(!_.isEmpty(_initDashboard)&&!_.isEmpty(_initDashboard.metadata)){this.model.set(_initDashboard,{silent:true});this.model.save({},params);}else{params.error();}}},getLastStateKey:function(){if(this._lastStateKey){return this._lastStateKey;}
var model=this.context.get('model'),view=model.get('view'),module=model.dashboardModule,key=module+'.'+view;this._lastStateKey=app.user.lastState.key(key,this);return this._lastStateKey;},navigateLayout:function(id){var layout=this.layout,lastVisitedStateKey=this.getLastStateKey();this.dispose();if(!_.contains(['create','list'],id)){app.user.lastState.set(lastVisitedStateKey,id);}
layout._addComponentsFromDef([{layout:{name:'dashboard',components:[{view:'dashboard-headerpane'},{layout:'dashlet-main'}],last_state:{id:'last-visit'}},context:_.extend({module:'Home',forceNew:true},(id==="create")?{create:true}:(id!=="list")?{modelId:id}:{})}]);layout.removeComponent(0);layout.loadData({},false);layout.render();},unbindData:function(){var model,collection;this.off("render",this.toggleSidebar,this);if(this.collection){this.collection.off("reset",this.setDefaultDashboard,this);}
if(this.context.parent){model=this.context.parent.get("model");collection=this.context.parent.get("collection");if(model){model.off("sync",null,this);}
if(collection){collection.off("sync",null,this);}}
app.view.Layout.prototype.unbindData.call(this);},_dispose:function(){this.dashboardLayouts=null;app.view.Layout.prototype._dispose.call(this);}})},"dashlet-cell":{"controller":({extendsFrom:'DashletRowLayout',tagName:'ul',className:'dashlet-cell rows row-fluid',_placeComponent:function(comp,def){var span='widget-container span'+(def.width||12),self=this;this.$el.append($("<li>",{'class':span}).data("index",function(){var index=def.layout.index.split('').pop();return self.index+''+index;}).append(comp.el));},setMetadata:function(meta){meta.components=meta.components||[];_.each(meta.components,function(component,index){if(!(component.view||component.layout)){meta.components[index]=_.extend({},{layout:{type:'dashlet',index:this.index+''+index,empty:true,components:[{view:'dashlet-cell-empty',context:{module:'Home',create:true}}]}},component);}else{var def=component.view||component.layout;if(!_.isObject(def)){def=component;}
if(component.context){_.extend(component.context,{forceNew:true})}
meta.components[index]={layout:{type:'dashlet',index:this.index+''+index,label:def.label||def.name||"",components:[component]},width:component.width};}},this);return meta;}})},"wizard":{"controller":({_currentIndex:0,_placeComponent:function(component){if(component==this._components[this._currentIndex]){this.$el.append(component.el);}},addComponent:function(component,def){component=this._addButtonsForComponent(component);if(component.showPage()){app.view.Layout.prototype.addComponent.call(this,component,def);}},_addButtonsForComponent:function(component){var buttons=[];component.meta=component.meta||{};_.each(this.meta.components,function(comp,i){if(comp.view===component.name){if(i===0){buttons.push(this.meta.buttons[1]);}else if(i===this.meta.components.length-1){buttons.push(this.meta.buttons[0]);buttons.push(this.meta.buttons[2]);}else{buttons.push(this.meta.buttons[0]);buttons.push(this.meta.buttons[1]);}}},this);component.meta.buttons=buttons;return component;},setPage:function(newIndex){if(newIndex!==this._currentIndex&&(newIndex>=0&&newIndex<this._components.length)){this._components[this._currentIndex].$el.detach();this._currentIndex=newIndex;this.$el.append(this._components[this._currentIndex].el);this._components[this._currentIndex].render();}
return this.getProgress();},_render:function(){if(this._components){this._components[this._currentIndex].render();}},getProgress:function(){return{page:this._currentIndex+1,lastPage:this._components.length};},previousPage:function(){return this.setPage(this._currentIndex-1);},nextPage:function(){return this.setPage(this._currentIndex+1);},finished:function(){var callbacks=this.context.get("callbacks");this.dispose();if(callbacks&&callbacks.complete){callbacks.complete();}}})},"default":{"controller":({className:"row-fluid",initialize:function(opts){app.view.Layout.prototype.initialize.call(this,opts);this.processDef();this.context.on("toggleSidebar",this.toggleSide,this);this.context.on("openSidebar",this.openSide,this);},toggleSide:function(){this.$('.main-pane').toggleClass('span12').toggleClass('span8');this.$('.side').toggle();app.controller.context.trigger("toggleSidebarArrows");},openSide:function(){this.$('.main-pane').addClass('span8').removeClass('span12');this.$('.side').show();app.controller.context.trigger("openSidebarArrows");},processDef:function(){this.$(".main-pane").addClass("span"+this.meta.components[0]["layout"].span);this.$(".side").addClass("span"+this.meta.components[1]["layout"].span);},renderHtml:function(){this.$el.html(this.template(this));},_placeComponent:function(component){if(component.meta.name){this.$("."+component.meta.name).append(component.$el);}},getPaneWidth:function(component){if(!this.$el){return 0;}
var paneSelectors=['.main-pane','.side'],pane=_.find(paneSelectors,function(selector){return($.contains(this.$(selector).get(0),component.el));},this);return this.$(pane).width()||0;}})},"list":{"controller":({_placeComponent:function(comp,def){var size=def.size||12;function createLayoutContainers(self){if(!self.$el.children()[0]){comp.$el.addClass('list');}}
createLayoutContainers(this);this.$el.append(comp.el);}})},"dupecheck-filter":{"controller":({extendsFrom:'FilterLayout',getRelevantContextList:function(){return[this.context];},setLastFilter:function(){return'';},getLastFilter:function(){return'all_records';}})},"bwc":{"controller":({className:'bwc layout',loadData:function(){}})},"drawer":{"controller":({backdropHtml:"<div class='drawer-backdrop'></div>",plugins:['Tooltip'],onCloseCallback:null,scrollTopPositions:[],pixelsFromFooter:60,initialize:function(options){if(!this.$el.is('#drawers')){app.logger.error('Drawer layout can only be included as an Additional Component.');return;}
app.drawer=this;this.onCloseCallback=[];this.name='drawer';app.routing.before("route",this.reset,this,true);app.view.Layout.prototype.initialize.call(this,options);},open:function(layoutDef,onClose){var layout;if(_.isUndefined(onClose)){this.onCloseCallback.push(function(){});}else{this.onCloseCallback.push(onClose);}
if(_.isUndefined(layoutDef.context)){layoutDef.context={};}
if(_.isUndefined(layoutDef.context.forceNew)){layoutDef.context.forceNew=true;}
this._addComponentsFromDef([layoutDef]);layout=_.last(this._components);this._scrollToTop();this._animateOpenDrawer(_.bind(function(){app.trigger("app:view:change",layout.options.name,layout.context.attributes);},this));layout.loadData();layout.render();},close:function(){var self=this,args=Array.prototype.slice.call(arguments,0);if(!Modernizr.csstransitions){this.closeImmediately.apply(this,args);return;}
if(this._components.length>0){this._animateCloseDrawer(function(){var layout;self._components.pop().dispose();layout=_.last(self._components);self._scrollBackToOriginal(layout);if(layout){app.trigger("app:view:change",layout.options.name,layout.context.attributes);}else{app.trigger("app:view:change",app.controller.context.get("layout"),app.controller.context.attributes);}
(self.onCloseCallback.pop()).apply(this,args);});}},closeImmediately:function(){if(this._components.length>0){var args=Array.prototype.slice.call(arguments,0),drawers=this._getDrawers(false),drawerHeight=this._determineDrawerHeight();drawers.$top.removeClass('transition').removeClass('active');drawers.$bottom.removeClass('transition').removeClass('inactive').addClass('active');if(drawers.$next){drawers.$next.removeClass('transition');}
drawers.$bottom.css('top','');if(drawers.$next){drawers.$next.css('top',this._isMainAppContent(drawers.$next)?drawerHeight:drawers.$next.offset().top-drawerHeight);}
this._cleanUpAfterClose(drawers);drawers.$bottom.addClass('transition');if(drawers.$next){drawers.$next.addClass('transition');}
this._components.pop().dispose();this._scrollBackToOriginal(_.last(this._components));(this.onCloseCallback.pop()).apply(window,args);}},load:function(layoutDef){var layout=this._components.pop(),top=layout.$el.css('top'),height=layout.$el.css('height'),drawers;layout.dispose();this._addComponentsFromDef([layoutDef]);drawers=this._getDrawers(true);drawers.$next.addClass('drawer').css({top:top,height:height});this._removeTabAndBackdrop(drawers.$top);this._createTabAndBackdrop(drawers.$next,drawers.$top);layout=_.last(this._components);layout.loadData();layout.render();},count:function(){return this._components.length;},isActive:function(el){return((this.count()===0)||($(el).parents('.drawer.active').length>0));},reset:function(triggerBefore){triggerBefore=triggerBefore===false?false:true;if(triggerBefore&&!this.triggerBefore("reset",{drawer:this})){return false;}
var $main=app.$contentEl.children().first();_.each(this._components,function(component){component.dispose();},this);this._components=[];this.onCloseCallback=[];if($main.hasClass('drawer')){$main.removeClass('drawer').css('top','');this._removeTabAndBackdrop($main);}
$('body').removeClass('noscroll');app.$contentEl.removeClass('noscroll');},_animateOpenDrawer:function(callback){if(this._components.length===0){return;}
var drawers=this._getDrawers(true),drawerHeight=this._determineDrawerHeight();if(this._isMainAppContent(drawers.$top)){drawers.$top.addClass('drawer');$('body').addClass('noscroll');app.$contentEl.addClass('noscroll');}
this._createTabAndBackdrop(drawers.$next,drawers.$top);drawers.$next.addClass('drawer');drawers.$next.css('height',drawerHeight);drawers.$next.css('top',drawers.$top.offset().top-drawerHeight);_.defer(_.bind(function(){if(drawers.$bottom){drawers.$bottom.addClass('transition').css('top',drawers.$bottom.offset().top+drawerHeight);}
drawers.$top.addClass('transition inactive').removeClass('active').css('top',this._isMainAppContent(drawers.$top)?drawerHeight:drawers.$top.offset().top+drawerHeight);drawers.$next.addClass('transition active').css('top','');if(this._components.length===1){$(window).on('resize.drawer',_.bind(this._resizeDrawer,this));}
if(_.isFunction(callback)){callback();}},this));this.trigger('drawer:resize',drawerHeight);},_animateCloseDrawer:function(callback){if(this._components.length===0){return;}
var drawers=this._getDrawers(false),drawerHeight=this._determineDrawerHeight(),transitionEndEvents='webkitTransitionEnd oTransitionEnd otransitionend transitionend msTransitionEnd';drawers.$bottom.one(transitionEndEvents,_.bind(function(){drawers.$bottom.off(transitionEndEvents);this._cleanUpAfterClose(drawers);callback();},this));drawers.$top.removeClass('active').css('top',drawers.$top.offset().top-drawerHeight);drawers.$bottom.removeClass('inactive').addClass('active').css('top','');_.delay(function(){drawers.$bottom.trigger('transitionend');},400);if(drawers.$next){drawers.$next.css('top',this._isMainAppContent(drawers.$next)?drawerHeight:drawers.$next.offset().top-drawerHeight);}},_getDrawers:function(open){var $main=app.$contentEl.children().first(),$nextDrawer,$topDrawer,$bottomDrawer,open=_.isUndefined(open)?true:open,drawerCount=this._components.length;switch(drawerCount){case 0:break;case 1:$nextDrawer=open?this._components[drawerCount-1].$el:undefined;$topDrawer=open?$main:this._components[drawerCount-1].$el;$bottomDrawer=open?undefined:$main;break;case 2:$nextDrawer=open?this._components[drawerCount-1].$el:$main;$topDrawer=open?this._components[drawerCount-2].$el:this._components[drawerCount-1].$el;$bottomDrawer=open?$main:this._components[drawerCount-2].$el;break;default:$nextDrawer=open?this._components[drawerCount-1].$el:this._components[drawerCount-3].$el;$topDrawer=open?this._components[drawerCount-2].$el:this._components[drawerCount-1].$el;$bottomDrawer=open?this._components[drawerCount-3].$el:this._components[drawerCount-2].$el;}
return{$next:$nextDrawer,$top:$topDrawer,$bottom:$bottomDrawer};},_isMainAppContent:function($layout){return!$layout.parent().is(this.$el);},_determineDrawerHeight:function(){var windowHeight=$(window).height(),headerHeight=$('#header .navbar').outerHeight(),footerHeight=$('footer').outerHeight();return windowHeight-headerHeight-footerHeight-this.pixelsFromFooter;},_determineCollapsedHeight:function(){return $(window).height()/2;},_createTabAndBackdrop:function($top,$bottom){var $drawerTab;this.expandTpl=app.template.getLayout(this.name+'.expand');this.expandTabHtml=this.expandTpl();$bottom.append(this.expandTabHtml).append(this.backdropHtml);$drawerTab=$bottom.find('.drawer-tab');this.addPluginTooltips($drawerTab);$drawerTab.on('click',_.bind(function(event){if($('i',event.currentTarget).hasClass('icon-chevron-up')){this._collapseDrawer($top,$bottom);}else{this._expandDrawer($top,$bottom);}
return false;},this));},_removeTabAndBackdrop:function($drawer){var $drawerTab=$drawer.find('.drawer-tab').off('click').remove();this.removePluginTooltips($drawerTab);$drawer.find('.drawer-backdrop').remove();},_cleanUpAfterClose:function(drawers){this._removeTabAndBackdrop(drawers.$bottom);if(this._isMainAppContent(drawers.$bottom)){drawers.$bottom.removeClass('drawer transition active');$('body').removeClass('noscroll');app.$contentEl.removeClass('noscroll');}else{this._expandDrawer(drawers.$bottom,drawers.$next);}
if(this._components.length===1){$(window).off('resize.drawer');}},_expandDrawer:function($top,$bottom){var expandHeight=this._determineDrawerHeight();$top.css('height',expandHeight);if($bottom.closest('#drawers').length>0){$bottom.css('top',expandHeight+$top.offset().top);}else{$bottom.css('top',expandHeight);}
$bottom.find('.drawer-tab i').removeClass('icon-chevron-down').addClass('icon-chevron-up');this.trigger('drawer:resize',expandHeight);},_collapseDrawer:function($top,$bottom){var collapseHeight=this._determineCollapsedHeight();$top.css('height',collapseHeight);if($bottom.closest('#drawers').length>0){$bottom.css('top',collapseHeight+$top.offset().top);}else{$bottom.css('top',collapseHeight);}
$bottom.find('.drawer-tab i').removeClass('icon-chevron-up').addClass('icon-chevron-down');this.trigger('drawer:resize',collapseHeight);},_scrollToTop:function(){var drawers=this._getDrawers(true),$mainpane=drawers.$top.find('.main-pane'),$sidepane=drawers.$top.find('.sidebar-content');this.scrollTopPositions.push({main:$mainpane.scrollTop(),side:$sidepane.scrollTop()});$mainpane.scrollTop(0);$sidepane.scrollTop(0);},_scrollBackToOriginal:function(drawerLayout){var scrollPositions=this.scrollTopPositions.pop();if(drawerLayout){drawerLayout.$('.main-pane').scrollTop(scrollPositions.main);drawerLayout.$('.sidebar-content').scrollTop(scrollPositions.side);}else{app.$contentEl.find('.main-pane').scrollTop(scrollPositions.main);app.$contentEl.find('.sidebar-content').scrollTop(scrollPositions.side);}},getHeight:function(){if(_.isEmpty(this._components)){return 0;}
var $top=this._getDrawers(false).$top;return $top.height();},_dispose:function(){app.routing.offBefore("route",this.reset,this);this.reset();$(window).off('resize.drawer');app.view.View.prototype._dispose.call(this);},_resizeDrawer:_.throttle(function(){var drawers=this._getDrawers(false);if(drawers.$top){this._expandDrawer(drawers.$top,drawers.$bottom);}},300)})},"panel":{"controller":({className:"filtered tabbable tabs-left",HIDE_SHOW_KEY:'hide-show',HIDE_SHOW:{HIDE:'hide',SHOW:'show'},initialize:function(opts){app.view.Layout.prototype.initialize.call(this,opts);this.hideShowLastStateKey=app.user.lastState.key(this.HIDE_SHOW_KEY,this);this.on("panel:toggle",this.togglePanel,this);this.listenTo(this.collection,"reset",function(){var hideShowLastState=app.user.lastState.get(this.hideShowLastStateKey);if(_.isUndefined(hideShowLastState)){this.togglePanel(this.collection.length>0,false);}else{this.togglePanel(hideShowLastState===this.HIDE_SHOW.SHOW,false);}});this.listenTo(this.collection,"reset add remove",this._checkIfSubpanelEmpty,this);},_checkIfSubpanelEmpty:function(){this.$(".subpanel").toggleClass("empty",this.collection.length===0);},_placeComponent:function(component){this.$(".subpanel").append(component.el);this._hideComponent(component,false);},togglePanel:function(show,saveState){this.$(".subpanel").toggleClass("closed",!show);if(arguments.length===1||saveState){app.user.lastState.set(this.hideShowLastStateKey,show?this.HIDE_SHOW.SHOW:this.HIDE_SHOW.HIDE);}
_.each(this._components,function(component){this._hideComponent(component,show);},this);},_hideComponent:function(component,show){if(component.name!="panel-top"){if(show){component.show();}else{component.hide();}}}})},"dashlet":{"controller":({initialize:function(options){this.index=options.meta.index;app.view.Layout.prototype.initialize.call(this,options);this.on("render",function(){this.model.trigger("applyDragAndDrop");},this);this.context.on("dashboard:collapse:fire",this.collapse,this);},_addComponentsFromDef:function(components){if(!(this.meta.preview||this.meta.empty)){var dashletDef=_.first(components),dashletMeta,dashletModule,toolbar={},pattern=/^(LBL|TPL|NTC|MSG)_(_|[a-zA-Z0-9])*$/,label=this.meta.label;if(dashletDef.view){toolbar=dashletDef.view['custom_toolbar']||{};dashletMeta=app.metadata.getView(dashletDef.view.module,dashletDef.view.name||dashletDef.view.type);dashletModule=dashletDef.view.module?dashletDef.view.module:null;}else if(dashletDef.layout){toolbar=dashletDef.view['custom_toolbar']||{};dashletMeta=app.metadata.getLayout(dashletDef.layout.module,dashletDef.layout.name||dashletDef.layout.type);dashletModule=dashletDef.layout.module?dashletDef.layout.module:null;}
if(!dashletModule&&dashletDef.context&&dashletDef.context.module){dashletModule=dashletDef.context.module;}
if(pattern.test(this.meta.label)){label=app.lang.get(label,dashletModule,dashletDef.view||dashletDef.layout);}
if(_.isEmpty(toolbar)&&dashletMeta&&dashletMeta['custom_toolbar']){toolbar=dashletMeta['custom_toolbar'];}
if(toolbar!=="no"){components.push({view:{type:'dashlet-toolbar',label:label,toolbar:toolbar}});}}
if(this.meta.empty){this.$el.html(app.template.empty(this));}else{this.$el.html(this.template(this));}
var context=this.context.parent||this.context;app.view.Layout.prototype._addComponentsFromDef.call(this,components,context,context.get("module"));},createComponentFromDef:function(def,context,module){if(def.view&&!_.isUndefined(def.view.toolbar)){var dashlet=_.first(this._components);if(_.isFunction(dashlet.getLabel)){def.view.label=dashlet.getLabel();}
context=dashlet.context;}
var skipFetch=def.view?def.view.skipFetch:def.layout.skipFetch;if(def.context&&skipFetch!==false){def.context.skipFetch=true;}
return app.view.Layout.prototype.createComponentFromDef.call(this,def,context,module);},setInvisible:function(){if(this._invisible===true){return;}
var comp=_.first(this._components);this.model.on("setMode",this.setMode,this);this._invisible=true;this.$el.addClass('hide');this.listenTo(comp,"render",this.unsetInvisible,this);},unsetInvisible:function(){if(this._invisible!==true){return;}
var comp=_.first(this._components);comp.trigger("show");this._invisible=false;this.model.off("setMode",null,this);this.$el.removeClass('hide');this.stopListening(comp,"render");},_placeComponent:function(comp,def){if(this.meta.empty){this.$el.append(comp.el);}else if(this.meta.preview){this.$el.addClass("preview-data");this.$("[data-dashlet=widget]").append(comp.el);}else if(def.view&&!_.isUndefined(def.view.toolbar)){this.$("[data-dashlet=toolbar]").append(comp.el);}else{if(comp.triggerBefore("render")===false){this.setInvisible();}
this.$("[data-dashlet=widget]").append(comp.el);}},setDashletMetadata:function(meta){var metadata=this.model.get("metadata"),component=this.getCurrentComponent(metadata,this.index);_.each(meta,function(value,key){this[key]=value;},component);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:layout");if(this.model.mode==='view'){this.model.save(null,{silent:true,showAlerts:true});}
return component;},getCurrentComponent:function(metadata,tracekey){var position=tracekey.split(''),component=metadata.components;_.each(position,function(index){component=component.rows?component.rows[index]:component[index];},this);return component;},addDashlet:function(meta){var component=this.setDashletMetadata(meta);var def=component.view||component.layout||component;this.meta.empty=false;this.meta.label=def.label||def.name||"";_.each(this._components,function(component){component.layout=null;component.dispose();},this);this._components=[];if(component.context){_.extend(component.context,{forceNew:true})}
this.meta.components=[component];this._addComponentsFromDef(this.meta.components);this.loadData();this.render();},removeDashlet:function(){var metadata=this.model.get("metadata"),component=this.getCurrentComponent(metadata,this.index);_.each(component,function(value,key){if(key!=='width'){delete component[key];}},this);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:layout");if(this.model.mode==='view'){this.model.save(null,{showAlerts:true});}
this.meta.empty=true;_.each(this._components,function(component){component.layout=null;component.dispose();},this);this._components=[];this._addComponentsFromDef([{view:'dashlet-cell-empty',context:{module:'Home',skipFetch:true}}]);this.render();},addRow:function(columns){this.layout.addRow(columns);},reloadDashlet:function(options){var component=_.first(this._components),context=component.context;context.resetLoadFlag();component.loadData(options);},editDashlet:function(evt){var self=this,meta=app.utils.deepCopy(_.first(this.meta.components)),type=meta.layout?"layout":"view";if(_.isString(meta[type])){meta[type]={name:meta[type],config:true};}else{meta[type].config=true;}
meta[type]=_.extend({},meta[type],meta.context);if(meta.context){meta.context.skipFetch=true;delete meta.context.link;}
app.drawer.open({layout:{name:'dashletconfiguration',components:[meta]},context:{model:new app.Bean(),forceNew:true}},function(model){if(!model)return;var conf=model.toJSON(),dash={context:{module:model.get("module")||(meta.context?meta.context.module:null),link:model.get("link")||null}};delete conf.config;if(_.isEmpty(dash.context.module)&&_.isEmpty(dash.context.link)){delete dash.context;}
dash[type]=conf;self.addDashlet(dash);});},collapse:function(collapsed){this.$(".dashlet-toggle > i").toggleClass("icon-chevron-down",collapsed);this.$(".dashlet-toggle > i").toggleClass("icon-chevron-up",!collapsed);this.$(".thumbnail").toggleClass("collapsed",collapsed);this.$("[data-dashlet=widget]").toggleClass("hide",collapsed);},setMode:function(type){if(!this._invisible){return;}
if(type==='edit'||type==='drag'){this.show();}else{this.hide();}},_dispose:function(){this.model.off("setMode",null,this);this.off("render");this.context.off("dashboard:collapse:fire",null,this);app.view.Layout.prototype._dispose.call(this);}})},"dupecheck":{"controller":({initialize:function(options){if(options.context.has('dupelisttype')){options.meta=this.switchListView(options.meta,options.context.get('dupelisttype'));}
app.view.Layout.prototype.initialize.call(this,options);},switchListView:function(meta,dupelisttype){var listView=_.find(meta.components,function(component){return(component.name==='dupecheck-list');});listView.view=dupelisttype;return meta;}})},"filter":{"controller":({className:'filter-view search',plugins:['QuickSearchFilter'],events:{'click .add-on.icon-remove':function(){this.trigger('filter:clear:quicksearch');}},initialize:function(opts){var filterLayout=app.view._getController({type:'layout',name:'filter'});filterLayout.loadedModules=filterLayout.loadedModules||{};app.view.Layout.prototype.initialize.call(this,opts);this.layoutType=this.context.get('layout')||this.context.get('layoutName')||app.controller.context.get('layout');this.aclToCheck=(this.layoutType==='record')?'view':'list';this.filters=app.data.createBeanCollection('Filters');this.emptyFilter=app.data.createBean('Filters',{id:'all_records',name:app.lang.get('LBL_FILTER_ALL_RECORDS'),filter_definition:[],editable:false});if(this.layoutType==='records'){this.context.set('skipFetch',true);}else{if(this.context.parent){this.context.parent.set('skipFetch',true);}
this.context.on('context:child:add',function(childCtx){if(childCtx.get('link')){childCtx.set('skipFetch',true);}},this);}
this.on('filter:apply',this.applyFilter,this);this.on('filter:create:close',function(){this.layout.editingFilter=null;this.layout.trigger('filter:create:close');},this);this.on('filter:create:open',function(filterModel){this.layout.editingFilter=filterModel;this.layout.trigger('filter:create:open',filterModel);},this);this.on('subpanel:change',function(linkName){this.layout.trigger('subpanel:change',linkName);},this);this.on('filter:get',this.initializeFilterState,this);this.on('filter:change:filter',this.handleFilterChange,this);this.layout.on('filter:apply',function(query,def){this.trigger('filter:apply',query,def);},this);this.layout.on('filterpanel:change',this.handleFilterPanelChange,this);this.layout.on('filterpanel:toggle:button',this.toggleFilterButton,this);this.layout.on('filter:add',this.addFilter,this);this.layout.on('filter:remove',this.removeFilter,this);this.layout.on('filter:reinitialize',function(){this.initializeFilterState(this.layout.currentModule,this.layout.currentLink);},this);},removeFilter:function(model){this.filters.remove(model);app.user.lastState.set(app.user.lastState.key("saved-"+this.layout.currentModule,this),this.filters.toJSON());this.layout.trigger('filter:reinitialize');},setLastFilter:function(filterModule,layoutName,value){var key=app.user.lastState.key("last-"+filterModule+"-"+layoutName,this);return app.user.lastState.set(key,value);},getLastFilter:function(filterModule,layoutName){var key=app.user.lastState.key("last-"+filterModule+"-"+layoutName,this);return app.user.lastState.get(key);},clearLastFilter:function(filterModule,layoutName){var key=app.user.lastState.key("last-"+filterModule+"-"+layoutName,this);return app.user.lastState.remove(key);},addFilter:function(model){this.filters.add(model);app.user.lastState.set(app.user.lastState.key("saved-"+this.layout.currentModule,this),this.filters.toJSON());this.setLastFilter(this.layout.currentModule,this.layoutType,model.get("id"));this.layout.trigger('filter:reinitialize');},toggleFilterButton:function(toggleDataView,on){var toggleButtons=this.layout.$('.toggle-actions a.btn');_.each(toggleButtons,function(btn){if($(btn).data('view')===toggleDataView){if(on){$(btn).removeAttr('disabled').removeClass('disabled');}else{$(btn).attr('disabled','disabled').addClass('disabled');$(btn).attr('title',app.lang.get('LBL_NO_DATA_AVAILABLE'));}}});},handleFilterPanelChange:function(name,silent,setLastViewed){this.showingActivities=name==='activitystream';var module=this.showingActivities?"Activities":this.module;var link;if(this.layoutType==='record'&&!this.showingActivities){module=link=app.user.lastState.get(app.user.lastState.key("subpanels-last",this))||'all_modules';if(link!=='all_modules'){module=app.data.getRelatedModule(this.module,link);}}else{link=null;}
if(!silent){this.trigger("filter:render:module");this.trigger("filter:change:module",module,link);}
if(setLastViewed){this.layout.trigger('filterpanel:lastviewed:set',name);}},handleFilterChange:function(id,preventCache){if(id&&id!='create'&&!preventCache){this.setLastFilter(this.layout.currentModule,this.layoutType,id);}
var filter=this.filters.get(id)||this.emptyFilter,ctxList=this.getRelevantContextList();var clear=false;_.each(ctxList,function(ctx){var filterDef=filter.get('filter_definition');var orig=ctx.get('collection').origFilterDef;ctx.get('collection').origFilterDef=filterDef;if(_.isUndefined(orig)||!_.isEqual(orig,filterDef)){clear=true;}});if(clear){_.each(ctxList,function(ctx){ctx.get('collection').resetPagination();ctx.get('collection').reset(null,{silent:true});});this.trigger('filter:clear:quicksearch');}},applyFilter:function(query,dynamicFilterDef){this._toggleClearQuickSearchIcon(!_.isEmpty(query));var massCollection=this.context.get('mass_collection');if(massCollection&&massCollection.models&&massCollection.models.length>0){massCollection.reset([],{silent:true});}
var self=this,ctxList=this.getRelevantContextList();_.each(ctxList,function(ctx){var ctxCollection=ctx.get('collection'),origFilterDef=dynamicFilterDef||ctxCollection.origFilterDef||[],filterDef=self.buildFilterDef(origFilterDef,query,ctx),options={showAlerts:true,success:function(collection,response,options){app.events.trigger('preview:close');}};ctxCollection.filterDef=filterDef;ctxCollection.origFilterDef=origFilterDef;ctxCollection.resetPagination();options=_.extend(options,ctx.get('collectionOptions'));ctx.resetLoadFlag(false);if(!_.isEmpty(ctx._recordListFields)){ctx.set('fields',ctx._recordListFields);}
ctx.set('skipFetch',false);ctx.loadData(options);});},getRelevantContextList:function(){var contextList=[];if(this.showingActivities){_.each(this.layout._components,function(component){var ctx=component.context;if(component.name=='activitystream'&&!ctx.get('modelId')&&ctx.get('collection')){contextList.push(ctx);}});}else{if(this.layoutType==='records'){var ctx=this.context.parent||this.context;if(!ctx.get('modelId')&&ctx.get('collection')){contextList.push(ctx);}}else{_.each(this.context.children,function(ctx){if(ctx.get('isSubpanel')&&!ctx.get('hidden')&&!ctx.get('modelId')&&ctx.get('collection')){contextList.push(ctx);}});}}
return _.uniq(contextList);},buildFilterDef:function(oSelectedFilter,searchTerm,context){var selectedFilter=app.utils.deepCopy(oSelectedFilter),isSelectedFilter=_.size(selectedFilter)>0,module=context.get('module'),searchFilter=this.getFilterDef(module,searchTerm),isSearchFilter=_.size(searchFilter)>0;if(isSelectedFilter&&isSearchFilter){selectedFilter=_.isArray(selectedFilter)?selectedFilter:[selectedFilter];selectedFilter.push(searchFilter[0]);return[{'$and':selectedFilter}];}else if(isSelectedFilter){return selectedFilter;}else if(isSearchFilter){return searchFilter;}
return[];},initializeFilterState:function(moduleName,linkName){moduleName=moduleName||this.module;var lastFilter=this.getLastFilter(moduleName,this.layoutType),filterData;if(!(this.filters.get(lastFilter)))
lastFilter=null;if(this.layoutType==='record'&&!this.showingActivities){linkName=app.user.lastState.get(app.user.lastState.key("subpanels-last",this))||linkName;filterData={link:lastFilter||'all_modules',filter:lastFilter||'all_records'};}else{filterData={filter:lastFilter||null};}
this.applyPreviousFilter(moduleName,linkName,filterData);},applyPreviousFilter:function(moduleName,linkName,data){var module=moduleName||this.module,link=linkName||data.link;if(this.showingActivities)module="Activities";if(this.layoutType==='record'&&link!=='all_modules'&&!this.showingActivities){var moduleMeta=app.metadata.getModule(module);if(!_.isUndefined(moduleMeta.fields[link])){module=app.data.getRelatedModule(module,link)||module;}}
this.trigger('filter:change:module',module,link,true);this.getFilters(module,data.filter);},getFilters:function(moduleName,defaultId){var filter=[{'created_by':app.user.id},{'module_name':moduleName}],self=this;var filterLayout=app.view._getController({type:'layout',name:'filter'});if(filterLayout.loadedModules[moduleName]&&!_.isEmpty(app.user.lastState.get(app.user.lastState.key("saved-"+moduleName,this))))
{this.filters.reset();var filters=app.user.lastState.get(app.user.lastState.key("saved-"+moduleName,this));_.each(filters,function(f){self.filters.add(app.data.createBean("Filters",f));});self.handleFilterRetrieve(moduleName,defaultId);}
else{this.filters.fetch({showAlerts:false,filter:filter,success:function(){if(self.disposed)return;filterLayout.loadedModules[moduleName]=true;app.user.lastState.set(app.user.lastState.key("saved-"+moduleName,self),self.filters.toJSON());self.handleFilterRetrieve(moduleName,defaultId);}});}},handleFilterRetrieve:function(moduleName,defaultId){var lastFilter=this.getLastFilter(moduleName,this.layoutType);var defaultFilterFromMeta,possibleFilters=[],filterMeta=this.getModuleFilterMeta(moduleName);if(filterMeta){_.each(filterMeta,function(value){if(_.isObject(value)){if(_.isObject(value.meta.filters)){this.filters.add(value.meta.filters);}
if(value.meta.default_filter){defaultFilterFromMeta=value.meta.default_filter;}}},this);possibleFilters=[defaultId,defaultFilterFromMeta,'all_records'];possibleFilters=_.filter(possibleFilters,this.filters.get,this.filters);}
if(lastFilter&&!(this.filters.get(lastFilter))){this.clearLastFilter(moduleName,this.layoutType);}
this.layout.trigger('filterpanel:change:module',moduleName);this.trigger('filter:render:filter');this.trigger('filter:change:filter',this.getLastFilter(moduleName,this.layoutType)||_.first(possibleFilters)||'all_records',true);},createPanelIsOpen:function(){return!this.layout.$(".filter-options").is(":hidden");},canCreateFilter:function(){var contexts=this.getRelevantContextList(),creatable=app.acl.hasAccess("create","Filters"),meta;if(creatable&&contexts.length===1){meta=app.metadata.getModule(contexts[0].get("module"));if(_.isObject(meta.filters)){_.each(meta.filters,function(value){if(_.isObject(value)){creatable=creatable&&value.meta.create!==false;}});}}
return creatable;},getModuleFilterMeta:function(moduleName){var meta;if(moduleName!=='all_modules'){meta=app.metadata.getModule(moduleName);if(_.isObject(meta)){meta=meta.filters;}}
return meta;},_toggleClearQuickSearchIcon:function(addIt){if(addIt&&!this.$('.add-on.icon-remove')[0]){this.$el.append('<i class="add-on icon-remove"></i>');}else if(!addIt){this.$('.add-on.icon-remove').remove();}},_render:function(){if(app.acl.hasAccess(this.aclToCheck,this.module)){app.view.Layout.prototype._render.call(this);this.initializeFilterState();}},unbind:function(){this.filters.off();this.filters=null;app.view.Layout.prototype.unbind.call(this);}})},"header":{"controller":({initialize:function(options){app.view.Layout.prototype.initialize.call(this,options);this.on("header:update:route",this.resize,this);app.events.on("app:sync:complete",this.resize,this);app.events.on("app:view:change",this.resize,this);var resize=_.bind(this.resize,this);$(window).off("resize",resize).on("resize",resize);},_placeComponent:function(component){this.$el.find('.nav-collapse').append(component.$el);},resize:function(){var totalWidth=0,modulelist,maxMenuWidth,componentElement,container=this.$('.navbar-inner');_.each(this._components,function(component){componentElement=component.$el.children().first();if(component.name!=='modulelist'){if(componentElement.is(':visible')){totalWidth+=component.$el.outerWidth(true);}}else{modulelist=component.$el;}});maxMenuWidth=container.parent('.navbar-fixed-top').width();this.trigger('view:resize',maxMenuWidth-totalWidth);},_render:function(){var result=app.view.Layout.prototype._render.call(this);if(app.api.isAuthenticated()){this.$el.show();this.resize();}else{this.$el.hide();return this;}
return result;}})},"dashlet-main":{"controller":({tagName:"ul",className:"dashlets row-fluid",bindDataChange:function(){if(this.model){this.model.on("change:metadata",this.setMetadata,this);this.model.on("change:layout",this.setWidth,this);this.model.on("applyDragAndDrop",this.applyDragAndDrop,this);this.model.on("setMode",function(mode){this.model._previousMode=this.model.mode;this.model.mode=mode;},this);this.model.trigger('setMode',this.context.get("create")?'edit':'view');}},setMetadata:function(){if(!this.model.get("metadata"))return;_.each(this._components,function(component){component.dispose();},this);this._components=[];this.$el.children().remove();var components=app.utils.deepCopy(this.model.get("metadata")).components;_.each(components,function(component,index){this._addComponentsFromDef([{layout:{type:'dashlet-row',width:component.width,components:component.rows,index:index+''}}]);},this);this.loadData();this.render();},setWidth:function(){var metadata=this.model.get("metadata"),$el=this.$el.children();_.each(metadata.components,function(component,index){$el.get(index).className=$el.get(index).className.replace(/span\d+\s*/,'');$($el.get(index)).addClass("span"+component.width);},this);},applyDragAndDrop:function(){var self=this;this.$('.widget:not(.empty)').draggable({revert:'invalid',handle:'h4',scroll:true,scrollSensitivity:100,appendTo:this.$el,start:function(event,ui){$(this).css({visibility:'hidden'});self.model.trigger("setMode","drag");},stop:function(){self.model.trigger("setMode",self.model._previousMode);self.$(".widget.ui-draggable").attr("style","");},helper:function(){var $clone=$(this).clone();$clone.addClass('helper').css({opacity:0.8}).width($(this).width());$clone.find('.btn-toolbar').remove();return $clone;}});this.$('.widget-container').droppable({activeClass:'ui-droppable-active',hoverClass:'active',tolerance:'pointer',accept:function($el){return!$el.hasClass("sortable")&&self.$(this).find('.widget[data-action=droppable]').length===1;},drop:function(event,ui){var sourceIndex=ui.draggable.parents(".widget-container:first").data('index')(),targetIndex=self.$(this).data('index')();self.switchComponent(targetIndex,sourceIndex);}});},getCurrentComponent:function(metadata,tracekey){var position=tracekey.split(''),component=metadata.components;_.each(position,function(index){component=component.rows?component.rows[index]:component[index];},this);var layout=this;_.each(position,function(index){layout=layout._components[index];},this);return{metadata:component,layout:layout};},switchComponent:function(target,source){if(target===source){return;}
var metadata=this.model.get("metadata");var targetComponent=this.getCurrentComponent(metadata,target),sourceComponent=this.getCurrentComponent(metadata,source);var cloneMeta=app.utils.deepCopy(targetComponent.metadata);_.each(targetComponent.metadata,function(value,key){if(key!=='width'){delete targetComponent.metadata[key];}},this);_.each(sourceComponent.metadata,function(value,key){if(key!=='width'){targetComponent.metadata[key]=value;delete sourceComponent.metadata[key];}},this);_.each(cloneMeta,function(value,key){if(key!=='width'){sourceComponent.metadata[key]=value;}},this);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:layout");if(this.model._previousMode==='view'){this.model.save(null,{showAlerts:true});}
var targetDashlet=targetComponent.layout._components.splice(0),sourceDashlet=sourceComponent.layout._components.splice(0);var targetMeta=app.utils.deepCopy(targetComponent.layout.meta),sourceMeta=app.utils.deepCopy(sourceComponent.layout.meta);targetComponent.layout.meta=sourceMeta;sourceComponent.layout.meta=targetMeta;_.each(targetDashlet,function(comp){sourceComponent.layout._components.push(comp);comp.layout=sourceComponent.layout;},this);_.each(sourceDashlet,function(comp){targetComponent.layout._components.push(comp);comp.layout=targetComponent.layout;},this);var targetInvisible=targetComponent.layout._invisible,sourceInvisible=sourceComponent.layout._invisible;if(targetInvisible){sourceComponent.layout.setInvisible();}else{sourceComponent.layout.unsetInvisible();}
if(sourceInvisible){targetComponent.layout.setInvisible();}else{targetComponent.layout.unsetInvisible();}
var cloneEl=targetComponent.layout.$el.children(":first").get(0);targetComponent.layout.$el.append(sourceComponent.layout.$el.children(":not(.helper)").get(0));sourceComponent.layout.$el.append(cloneEl);},_dispose:function(){this.$('.widget').draggable('destroy');this.$('.widget-container').droppable('destroy');app.view.Layout.prototype._dispose.call(this);}})},"fluid":{"controller":({_placeComponent:function(comp,def){var compdef=def.layout||def.view,size=compdef.span||4;if(!this.$el.children()[0]){this.$el.addClass("container-fluid").append('<div class="row-fluid"></div>');}
$().add("<div></div>").addClass("span"+size).append(comp.el).appendTo(this.$el.find("div.row-fluid")[0]);}})},"filterpanel":{"controller":({extendsFrom:'TogglepanelLayout',editingFilter:null,initialize:function(opts){var moduleMeta=app.metadata.getModule(opts.module);this.disableActivityStreamToggle(opts.module,moduleMeta,opts.meta||{});this.on("filterpanel:change:module",function(module,link){this.currentModule=module;this.currentLink=link;},this);this.on("filter:create:open",function(model){this.$(".filter-options").show();},this);this.on("filter:create:close",function(reinitialize,id){if(reinitialize&&!id){this.trigger("filter:reinitialize");}
this.$(".filter-options").hide();},this);this.on('filterpanel:lastviewed:set',function(viewed){this.toggleViewLastStateKey=this.toggleViewLastStateKey||app.user.lastState.key('toggle-view',this);var lastViewed=app.user.lastState.get(this.toggleViewLastStateKey);if(lastViewed!==viewed){app.user.lastState.set(this.toggleViewLastStateKey,viewed);}},this);app.view.invokeParent(this,{type:'layout',name:'togglepanel',method:'initialize',args:[opts]});var lastViewed=app.user.lastState.get(this.toggleViewLastStateKey);this.trigger('filterpanel:change:module',(moduleMeta.activityStreamEnabled&&lastViewed==='activitystream')?'Activities':this.module);},applyLastFilter:function(collection,condition){var triggerFilter=true;if(_.size(collection.origFilterDef)){if(condition==='favorite'){triggerFilter=!_.isUndefined(_.find(collection.origFilterDef,function(value,key){return key==='$favorite'||(value&&!_.isUndefined(value.$favorite));}));}
if(triggerFilter){var query=this.$('.search input.search-name').val();this.trigger('filter:apply',query,collection.origFilterDef);}}},disableActivityStreamToggle:function(moduleName,moduleMeta,viewMeta){if(moduleName!=='Activities'&&!moduleMeta.activityStreamEnabled){_.each(viewMeta.availableToggles,function(toggle){if(toggle.name==='activitystream'){toggle.disabled=true;toggle.label='LBL_ACTIVITY_STREAM_DISABLED';}});}}})},"toggle":{"controller":({availableToggles:{},defaultToggle:null,initialize:function(options){this.toggleComponents=[];this.componentsList={};this.availableToggles=this.options.meta.available_toggles||this.availableToggles;this.defaultToggle=this.options.meta.default_toggle||this.defaultToggle;app.view.Layout.prototype.initialize.call(this,options);if(this.defaultToggle){this.showComponent(this.defaultToggle);}
this.on('toggle:showcomponent',this.showComponent,this);},_placeComponent:function(component){if(!_.isUndefined(this.availableToggles[component.name])){this.toggleComponents.push(component);this.componentsList[component.name]=component;this._components.splice(this._components.indexOf(component),1);}else{component.render();this.getContainer(component).append(component.el);}},getContainer:function(component){return this.$el;},showComponent:function(name){var oldToggle=this.currentToggle;if(this.componentsList[name]){this.componentsList[name].render();this._components.push(this.componentsList[name]);this.getContainer(this.componentsList[name]).append(this.componentsList[name].el);this.componentsList[name]=null;}
_.each(this.toggleComponents,function(component){if(component.name===name){component.show();}else{component.hide();}},this);this.currentToggle=name;this.trigger('toggle:change',name,oldToggle);},_dispose:function(){_.each(this.componentsList,function(component){if(component){component.dispose();}});this.componentsList={};this.toggleComponents=null;app.view.Layout.prototype._dispose.call(this);}})},"selection-list":{"controller":({loadData:function(options){this.context.set("fields",_.union(this.getFieldNames(),(this.context.get("fields")||[])));app.view.Layout.prototype.loadData.call(this,options,false);}})},"dashlet-row":{"controller":({tagName:'li',events:{'click .remove-row':'removeClicked'},plugins:['Tooltip'],initialize:function(options){this.index=options.meta.index;options.meta=this.setMetadata(options.meta);app.view.Layout.prototype.initialize.call(this,options);this.model.on("setMode",this.setMode,this);this.model.on("applyDragAndDrop",this.applyDragAndDrop,this);this.setMode(this.model.mode);},setMetadata:function(meta){meta.components=meta.components||[];_.each(meta.components,function(component,index){meta.components[index]={layout:{type:'dashlet-cell',index:this.index+''+index,components:component}};},this);var addRowDashlet={layout:{type:'dashlet',index:this.index+''+meta.components.length,empty:true,components:[{view:'dashlet-row-empty',context:{module:'Home',forceNew:true,create:true}}]}};meta.components.push(addRowDashlet);if(meta.css_class)meta.css_class+=' ';meta.css_class='span'+(meta.width||12);return meta;},_placeComponent:function(comp,def,prepend){var $body=this.$el.children(".dashlet-row");if($body.length===0){$body=$("<ul></ul>").addClass("dashlet-row");this.$el.append($body);}
var headerTemplate=app.template.getLayout(this.name+'.header')||app.template.empty,$container=$("<div></div>",{'class':'rows well well-invisible'}).append(headerTemplate()).append(comp.el),$el=$("<li></li>",{'class':'row-fluid','data-sortable':'1'}).data('index',function(){return comp.index+'';}).append($container);if(prepend){$body.children("li:last").before($el);}else{$body.append($el);}},addComponent:function(component,def){if(this.prependComponent){if(!component.layout)component.layout=this;this._components.splice(this._components.length-1,0,component);this._placeComponent(component,def,true);this.prependComponent=false;}else{app.view.Layout.prototype.addComponent.call(this,component,def);}},addRow:function(columns){var span=12/columns,components=[];_.times(columns,function(){components.push({width:span});});var metadata=this.model.get("metadata");var position=this.index.split(''),component=metadata.components;_.each(position,function(index){component=component.rows?component.rows[index]:component[index];},this);component.rows.push(app.utils.deepCopy(components));this.model.set("metadata",metadata,{silent:true});this.model.trigger("change:layout");this.prependComponent=true;_.each(this._components,function(component){component.index++;},this);this._addComponentsFromDef([{layout:{type:'dashlet-cell',index:this.index+''+(this._components.length-1),components:components}}]);_.each(this._components,function(component,index){component.index=this.index+''+index;},this);this.render();this.setMode(this.model.mode);},removeClicked:function(evt){var index=($(evt.currentTarget).parents(".row-fluid:first").data("index")()).split('').pop();this.removeRow(index);},removeRow:function(index){var metadata=this.model.get("metadata"),position=this.index.split(''),component=metadata.components;_.each(position,function(index){component=component.rows?component.rows[index]:component[index];},this);component.rows.splice(index,1);this._components[index].dispose();this._components.splice(index,1);_.each(this._components,function(component,index){component.index=this.index+''+index;},this);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:layout");this.$el.children(".dashlet-row").children("li:eq("+index+")").remove();},setMode:function(type){if(type==='edit'||(this.model._previousMode==='edit'&&type==='drag')){this.$el.children(".dashlet-row").sortable("enable");this.$el.children(".dashlet-row").children("li").not(":last").addClass("sortable").children(".rows").removeClass("well-invisible").children(".btn-link").toggleClass("hide",false);}else{this.$el.children(".dashlet-row").sortable("disable");this.$el.children(".dashlet-row").children("li").not(":last").addClass("sortable").children(".rows").addClass("well-invisible").children(".btn-link").toggleClass("hide",true);}},applyDragAndDrop:function(){var self=this;this.$el.children(".dashlet-row").sortable({axis:"y",items:"li.sortable",handle:".move",forcePlaceholderSize:true,placeholder:"placeholder",update:function(event,ui){var sourceIndex=ui.item.first().data('index')(),targetIndex=ui.item.first().next().data('index')();self.switchComponent(targetIndex,sourceIndex);}});this.setMode(this.model.mode);},switchComponent:function(target,source){var metadata=this.model.get("metadata"),position=this.index.split(''),component=metadata.components,targetIndex=target.split('').pop(),sourceIndex=source.split('').pop();_.each(position,function(index){component=component.rows?component.rows[index]:component[index];},this);var sourceMetadata=component.rows[sourceIndex],sourceComponent=this._components[sourceIndex];if(sourceIndex>targetIndex){component.rows.splice(sourceIndex,1);component.rows.splice(targetIndex,0,sourceMetadata);this._components.splice(sourceIndex,1);this._components.splice(targetIndex,0,sourceComponent);}else{component.rows.splice(targetIndex,0,sourceMetadata);component.rows.splice(sourceIndex,1);this._components.splice(targetIndex,0,sourceComponent);this._components.splice(sourceIndex,1);}
_.each(this._components,function(component,index){component.index=this.index+''+index;},this);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:layout");},_dispose:function(){this.$el.children(".dashlet-row").sortable("destroy");this.model.off("applyDragAndDrop",null,this);this.model.off("setMode",null,this);app.view.Layout.prototype._dispose.call(this);}})},"preview-activitystream":{"controller":({extendsFrom:'ActivitystreamLayout',_previewOpened:false,initialize:function(options){app.view.invokeParent(this,{type:'layout',name:'activitystream',method:'initialize',args:[options]});app.events.on("preview:render",this.fetchActivities,this);app.events.on('preview:open',function(){this._previewOpened=true;},this);app.events.on('preview:close',function(){this._previewOpened=false;this.disposeAllActivities();},this);},fetchActivities:function(model,collection,fetch,previewId){this.disposeAllActivities();this.collection.dataFetched=false;this.$el.hide();this.collection.reset();this.collection.resetPagination();this.collection.fetch({endpoint:function(method,collection,options,callbacks){var url=app.api.buildURL(model.module,'activities',{id:model.get('id'),link:true},options.params);return app.api.call('read',url,null,callbacks);},success:_.bind(this.renderActivities,this)});},renderActivities:function(collection){var self=this;if(this.disposed){return;}
if(this._previewOpened){if(collection.length===0){this.$el.hide();}else{this.$el.show();collection.each(function(activity){self.renderPost(activity,true);});}}else{_.delay(function(){self.renderActivities(collection);},500);}},setCollectionOptions:function(){},exposeDataTransfer:function(){},loadData:function(){},bindDataChange:function(){this.collection.on('add',function(activity){if(!this.disposed){this.renderPost(activity);}},this);}})}}},"modules":{"Login":{}}}})(SUGAR.App);

(function(app){SUGAR.jssource={"modules":{"Home":{"fieldTemplates":{"base":{"dashboardtitle":{"controller":({events:{'click .dropdown-toggle':'toggleClicked','click a[data-id]':'navigateClicked'},dashboards:null,toggleClicked:function(evt){var self=this;if(!_.isEmpty(this.dashboards)){return;}
this.collection.fetch({silent:true,success:function(collection){var pattern=/^(LBL|TPL|NTC|MSG)_(_|[a-zA-Z0-9])*$/;collection.remove(self.model,{silent:true});_.each(collection.models,function(model){if(pattern.test(model.get('name'))){model.set('name',app.lang.get(model.get('name'),collection.module||null));}});self.dashboards=collection;var optionTemplate=app.template.getField(self.type,"options",self.module);self.$(".dropdown-menu").html(optionTemplate(collection));}});},navigateClicked:function(evt){var id=$(evt.currentTarget).data("id");this.navigate(id);},navigate:function(id){this.view.layout.navigateLayout(id);},format:function(value){var module=this.context.parent?this.context.parent.get("module"):this.context.get("module"),pattern=/^(LBL|TPL|NTC|MSG)_(_|[a-zA-Z0-9])*$/;return pattern.test(value)?app.lang.get(value,module):value;},_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.context&&this.context.get('model')&&this.context.get('model').dashboardModule==='Home'){this.template=app.template.getField('base',this.tplName)||this.template;}},setMaxWidth:function(width){this.$el.css({'max-width':width});},getCellPadding:function(){var padding=0,$cell=this.$('.dropdown-toggle');if(!_.isEmpty($cell)){padding=parseInt($cell.css('padding-left'),10)+parseInt($cell.css('padding-right'),10);}
return padding;}})},"layoutsizer":{"controller":({spanMin:2,spanTotal:12,spanStep:1,format:function(value){var metadata=this.model.get("metadata");return(metadata&&metadata.components)?metadata.components.length-1:0;},_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.action!=='edit'){this.template=app.template.empty;}},_render:function(){app.view.Field.prototype._render.call(this);if(this.action==='edit'&&this.value>0){var self=this,metadata=this.model.get("metadata");this.$('#layoutwidth').empty().noUiSlider('init',{knobs:this.value,scale:[0,this.spanTotal],step:this.spanStep,connect:false,end:function(type){if(type!=='move'){var values=$(this).noUiSlider('value');self.setValue(values);}}}).append(function(){var html="",segments=(self.spanTotal/self.spanStep)+1,segmentWidth=$(this).width()/(segments-1),acum=0;_.times(segments,function(i){acum=(segmentWidth*i)-2;html+="<div class='ticks' style='left:"+acum+"px'></div>";},this);return html;});this.setSliderPosition(metadata);}else{this.$('.noUiSliderEnds').hide();}},setSliderPosition:function(metadata){var divider=0;_.each(_.pluck(metadata.components,'width'),function(span,index){if(index>=this.value)return;divider=divider+parseInt(span,10);this.$('#layoutwidth').noUiSlider('move',{handle:index,to:divider});},this);},setValue:function(value){var metadata=this.model.get("metadata"),divider=0;_.each(metadata.components,function(component,index){if(index==metadata.components.length-1){component.width=this.spanTotal-divider;if(component.width<this.spanMin){var adjustment=this.spanMin-component.width;for(var i=index-1;i>=0;i--){metadata.components[i].width-=adjustment;if(metadata.components[i].width<this.spanMin){adjustment=this.spanMin-metadata.components[i].width;metadata.components[i].width=this.spanMin;}else{adjustment=0;}}
component.width=this.spanMin;}}else{component.width=value[index]-divider;if(component.width<this.spanMin){component.width=this.spanMin;}
divider+=component.width;}},this);this.setSliderPosition(metadata);this.model.set("metadata",metadata,{silent:true});this.model.trigger("change:layout");},bindDataChange:function(){if(this.model){this.model.on("change:metadata",this.render,this);}},bindDomChange:function(){}})},"layoutbutton":{"controller":({events:{'click .btn.layout':'layoutClicked'},plugins:['Tooltip'],extendsFrom:'ButtonField',getFieldElement:function(){return this.$el;},_render:function(){var buttonField=app.view._getController({type:'field',name:'button',platform:app.config.platform});buttonField.prototype._render.call(this);},_loadTemplate:function(){app.view.Field.prototype._loadTemplate.call(this);if(this.action!=='edit'||(this.model.maxColumns<=1)){this.template=app.template.empty;}},format:function(value){var metadata=this.model.get("metadata");if(metadata){return(metadata.components)?metadata.components.length:1;}
return value;},layoutClicked:function(evt){var value=$(evt.currentTarget).data('value');this.setLayout(value);},setLayout:function(value){var span=12/value;if(this.value){if(value===this.value){return;}
var setComponent=function(){var metadata=this.model.get("metadata");_.each(metadata.components,function(component){component.width=span;},this);if(metadata.components.length>value){_.times(metadata.components.length-value,function(index){metadata.components[value-1].rows=metadata.components[value-1].rows.concat(metadata.components[value+index].rows);},this);metadata.components.splice(value);}else{_.times(value-metadata.components.length,function(index){metadata.components.push({rows:[],width:span});},this);}
this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:metadata");};if(value!==this.value){app.alert.show('resize_confirmation',{level:'confirmation',messages:app.lang.get('LBL_DASHBOARD_LAYOUT_CONFIRM',this.module),onConfirm:_.bind(setComponent,this),onCancel:_.bind(this.render,this)});}else{setComponent.call(this);}}else{var metadata={components:[]};_.times(value,function(index){metadata.components.push({rows:[],width:span});},this);this.model.set("metadata",app.utils.deepCopy(metadata),{silent:true});this.model.trigger("change:metadata");}},bindDomChange:function(){},bindDataChange:function(){if(this.model){this.model.on("change:metadata",this.render,this);if(this.model.isNew()){this.setLayout(1);this.model.changed={};}}}})}}},"views":{"base":{"about-resources":{"controller":({initialize:function(opts){this.serverInfo=app.metadata.getServerInfo();app.view.View.prototype.initialize.call(this,opts);}})},"top-activity-user":{"controller":({plugins:['Dashlet','GridBuilder'],events:{'change select[name=filter_duration]':'filterChanged'},initDashlet:function(viewName){this.collection=new app.BeanCollection();if(!this.meta.config){this.collection.on("reset",this.render,this);}else{app.view.invokeParent(this,{type:'view',name:'record',method:'_buildGridsFromPanelsMetadata',args:[this.meta.panels]});}},_mapping:{meetings:{icon:'icon-comments',label:'LBL_MOST_MEETING_HELD'},inbound_emails:{icon:'icon-envelope',label:'LBL_MOST_EMAILS_RECEIVED'},outbound_emails:{icon:'icon-envelope-alt',label:'LBL_MOST_EMAILS_SENT'},calls:{icon:'icon-phone',label:'LBL_MOST_CALLS_MADE'}},loadData:function(params){if(this.meta.config){return;}
var url=app.api.buildURL('mostactiveusers',null,null,{days:this.settings.get("filter_duration")}),self=this;app.api.call("read",url,null,{success:function(data){if(self.disposed){return;}
var models=[];_.each(data,function(attributes,module){if(_.isEmpty(attributes)){return;}
var model=new app.Bean(_.extend({id:_.uniqueId('aui')},attributes));model.module=module;model.set("name",model.get("first_name")+' '+model.get("last_name"));model.set("icon",self._mapping[module]['icon']);var template=Handlebars.compile(app.lang.get(self._mapping[module]['label'],self.module));model.set("label",template({count:model.get("count")}));model.set("pictureUrl",app.api.buildFileURL({module:"Users",id:model.get("user_id"),field:"picture"}));models.push(model);},this);self.collection.reset(models);},complete:params?params.complete:null});},filterChanged:function(evt){this.loadData();},_dispose:function(){if(this.collection){this.collection.off("reset",null,this);}
app.view.View.prototype._dispose.call(this);}})},"twitter":{"controller":({plugins:['Dashlet','Timeago'],limit:20,events:{'click .connect-twitter':'onConnectTwitterClick'},initDashlet:function(){if(this.meta.config){this.dashletConfig=app.metadata.getView(app.controller.context.get('module'),this.name)||this.dashletConfig;}
var limit=this.settings.get("limit")||this.limit;this.settings.set("limit",limit);this.cacheKey="twitter.dashlet.current_user_cache";var currentUserCache=app.cache.get(this.cacheKey);if(currentUserCache&&currentUserCache.current_twitter_user_name){self.current_twitter_user_name=currentUserCache.current_twitter_user_name;}
if(currentUserCache&&currentUserCache.current_twitter_user_pic){self.current_twitter_user_pic=currentUserCache.current_twitter_user_pic;}},onConnectTwitterClick:function(event){if(!_.isUndefined(event.currentTarget)){event.preventDefault();var href=this.$(event.currentTarget).attr('href');app.bwc.login(false,function(response){window.open(href);});}},_render:function(){if(this.tweets||this.meta.config){app.view.View.prototype._render.call(this);}},bindDataChange:function(){if(this.model){this.model.on("change",this.loadData,this);}},loadData:function(options){if(this.disposed||this.meta.config){return;}
var twitter=this.model.get('twitter')||this.model.get('name')||this.model.get('account_name')||this.model.get('full_name'),limit=parseInt(this.settings.get("limit"),10)||this.limit,self=this;this.screen_name=this.settings.get('twitter')||false;if(_.isNull(this.context.parent)){twitter=this.settings.get('twitter');}
if(!twitter||this.viewName==='config'){return false;}
twitter=twitter.replace(/ /g,"");this.twitter=twitter;var currentUserUrl=app.api.buildURL('connector/twitter/currentUser');if(!self.current_twitter_user_name){app.api.call('READ',currentUserUrl,{},{success:function(data){app.cache.set(self.cacheKey,{'current_twitter_user_name':data.screen_name,'current_twitter_user_pic':data.profile_image_url});self.current_twitter_user_name=data.screen_name;self.current_twitter_user_pic=data.profile_image_url;if(!this.disposed){self.render();}}});}
var url=app.api.buildURL('connector/twitter','',{id:twitter},{count:limit});app.api.call('READ',url,{},{success:function(data){if(self.disposed){return;}
var tweets=[];if(data.success!==false){_.each(data,function(tweet){var time=new Date(tweet.created_at.replace(/^\w+ (\w+) (\d+) ([\d:]+) \+0000 (\d+)$/,"$1 $2 $4 $3 UTC")),date=app.date.format(time,"Y/m/d H:i:s"),text=tweet.retweeted_status?'RT @'+tweet.retweeted_status.user.screen_name+': '+tweet.retweeted_status.text:tweet.text,sourceUrl=tweet.source,id=tweet.id_str,name=tweet.user.name,tokenText=text.split(' '),screen_name=tweet.user.screen_name,profile_image_url=tweet.user.profile_image_url_https,j,rightNow=new Date(),diff=(rightNow.getTime()-time.getTime())/(1000*60*60*24),timeLabel=diff>1?'LBL_TIME_RELATIVE_TWITTER_LONG':'LBL_TIME_RELATIVE_TWITTER_SHORT';for(j=0;j<tokenText.length;j++){if(tokenText[j].charAt(0)=='h'&&tokenText[j].charAt(1)=='t'){tokenText[j]="<a class='googledoc-fancybox' href="+'"'+tokenText[j]+'"'+"target='_blank'>"+tokenText[j]+"</a>";}}
text=tokenText.join(' ');tweets.push({id:id,name:name,screen_name:screen_name,profile_image_url:profile_image_url,text:text,source:sourceUrl,date:date,timeLabel:timeLabel});},this);}
self.tweets=tweets;if(!this.disposed){self.template=app.template.get(self.name+'.Home');self.render();}},error:function(xhr,status,error){self.showGeneric=true;self.errorLBL=app.lang.get('ERROR_UNABLE_TO_RETRIEVE_DATA');self.template=app.template.get(self.name+'.twitter-need-configure.Home');if(xhr.status===404){self.showGeneric=true;self.errorLBL=app.lang.get('LBL_ERROR_CANNOT_FIND_TWITTER')+self.twitter;}else if(xhr.status===424){app.cache.cut(self.key);self.needConnect=false;self.showGeneric=false;if(xhr.code&&xhr.code==='ERROR_NEED_AUTHORIZE'){self.needConnect=true;}else if(xhr.code&&xhr.code==='ERROR_NEED_OAUTH'){self.needOAuth=true;}
self.showAdmin=app.acl.hasAccess('admin','Administration');}
if(!self.disposed){app.view.View.prototype._render.call(self);}},complete:(options)?options.complete:null});},_dispose:function(){if(this.model){this.model.off("change",this.loadData,this);}
app.view.View.prototype._dispose.call(this);}})},"about-language-packs":{"controller":({linkTemplate:null,initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this.linkTemplate=app.template.getView(this.name+'.link',this.module);},_renderHtml:function(){_.each(this.meta.providers,function(provider){provider.link=this.linkTemplate(provider);},this);app.view.View.prototype._renderHtml.call(this);}})},"about-source-code":{"controller":({initialize:function(opts){this.serverInfo=app.metadata.getServerInfo();app.view.View.prototype.initialize.call(this,opts);}})},"webpage":{"controller":({plugins:['Dashlet'],_defaultOptions:{limit:10,},bindDataChange:function(){if(!this.meta.config){this.model.on("change",this.render,this);}},_render:function(){if(!this.meta.config){this.dashletConfig.view_panel[0].height=this.settings.get('limit')*this.rowHeight;}
app.view.View.prototype._render.call(this);},initDashlet:function(view){this.viewName=view;var settings=_.extend({},this._defaultOptions,this.settings.attributes);this.settings.set(settings);},loadData:function(options){if(options&&options.complete){options.complete();}}})},"about-headerpane":{"controller":({extendsFrom:'HeaderpaneView',_renderHtml:function(){var title=this.title||this.module;this.title=app.lang.get(title,this.module,app.metadata.getServerInfo());app.view.View.prototype._renderHtml.call(this);}})}}},"layouts":{}},"Contacts":{"fieldTemplates":{},"views":{},"layouts":{}},"Accounts":{"fieldTemplates":{},"views":{},"layouts":{}},"Opportunities":{"fieldTemplates":{"base":{"rowaction":{"controller":({extendsFrom:"RowactionField",initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('DisableDelete');app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.model.on("change:closed_revenue_line_items",function(){this.render();if(_.isFunction(this.view.initButtons)){this.view.initButtons();}
if(_.isFunction(this.view.setButtonStates)){this.view.setButtonStates(this.view.STATE.VIEW);}},this);}})}}},"views":{"base":{"record":{"controller":({extendsFrom:'RecordView',cancelClicked:function(){var changedAttributes=this.model.changedAttributes(this.model.getSyncedAttributes());this.model.set(changedAttributes);app.view.invokeParent(this,{type:'view',name:'record',method:'cancelClicked'});},})},"massupdate":{"controller":({extendsFrom:"MassupdateView",initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('DisableMassdelete');app.view.invokeParent(this,{type:'view',name:'massupdate',method:'initialize',args:[options]});}})}}},"layouts":{}},"Cases":{"fieldTemplates":{},"views":{},"layouts":{}},"Notes":{"fieldTemplates":{},"views":{},"layouts":{}},"Calls":{"fieldTemplates":{},"views":{},"layouts":{}},"Emails":{"fieldTemplates":{"base":{"sender":{"controller":({fieldTag:'input.select2',initialize:function(options){_.bindAll(this);app.view.Field.prototype.initialize.call(this,options);this.endpoint=this.def.endpoint;},_render:function(){var result=app.view.Field.prototype._render.call(this);if(this.tplName==='edit'){var action=(this.endpoint.action)?this.endpoint.action:null,attributes=(this.endpoint.attributes)?this.endpoint.attributes:null,params=(this.endpoint.params)?this.endpoint.params:null,myURL=app.api.buildURL(this.endpoint.module,action,attributes,params);app.api.call('GET',myURL,null,{success:this.populateValues,error:function(error){app.alert.show("server-error",{level:"error",messages:"ERR_GENERIC_SERVER_ERROR",autoClose:false});app.error.handleHttpError(error);}});}
return result;},populateValues:function(results){var self=this,defaultResult,defaultValue={};if(this.disposed===true){return;}
if(!_.isEmpty(results)){defaultResult=_.find(results,function(result){return result.default;});defaultValue=(defaultResult)?defaultResult:results[0];if(!this.model.has(this.name)){this.model.set(this.name,defaultValue.id);}}else{app.drawer.close();app.alert.show("no-email-configurations",{level:"warning",messages:app.lang.get('WARNING_SETTINGS_NOT_CONF',this.module),autoClose:false});}
var format=function(item){return item.display;};this.$(this.fieldTag).select2({data:{results:results,text:'display'},formatSelection:format,formatResult:format,width:'100%',placeholder:app.lang.get('LBL_SELECT_FROM_SENDER',this.module),initSelection:function(el,callback){if(!_.isEmpty(defaultValue)){callback(defaultValue);}}}).on("change",function(e){if(self.model.get(self.name)!==e.val){self.model.set(self.name,e.val,{silent:true});}});this.$(".select2-container").addClass("tleft");},bindDomChange:function(){}})},"compose-actionbar":{"controller":({extendsFrom:'FieldsetField',fields:null,events:{'click a:not(.dropdown-toggle)':'handleButtonClick'},getPlaceholder:function(){var placeholder=app.view.invokeParent(this,{type:'field',name:'fieldset',method:'getPlaceholder'});var $container=$(placeholder.toString());_.each(this.def.buttonSections,function(buttonSection){var placeHolderString;if(!_.isUndefined(buttonSection.type)){placeHolderString=this.buildTypedButtonSection(buttonSection);}else{placeHolderString=this.buildDefaultButtonSection(buttonSection);}
$container.append(placeHolderString);},this);return new Handlebars.SafeString($container.get(0).outerHTML);},buildTypedButtonSection:function(def){var field=app.view.createField({def:def,view:this.view,viewName:this.options.viewName,model:this.model});this.fields.push(field);return field.getPlaceholder().toString();},buildDefaultButtonSection:function(def){var $defaultSection=$('<div class="actions"></div>');if(def.css_class){$defaultSection.addClass(def.css_class);}
_.each(def.buttons,function(button){var field=app.view.createField({def:button,view:this.view,viewName:this.options.viewName,model:this.model});this.fields.push(field);$defaultSection.append(field.getPlaceholder().toString());},this);return $defaultSection.get(0).outerHTML;},handleButtonClick:function(evt){var triggerName,buttonName,$currentTarget=$(evt.currentTarget);if($currentTarget.data('event')){triggerName=$currentTarget.data('event');}else{buttonName=$currentTarget.attr('name')||'button';triggerName='actionbar:'+buttonName+':clicked';}
this.view.context.trigger(triggerName);}})},"recipients":{"controller":({showNoData:false,events:{"click .btn":"_showAddressBook"},fieldTag:'input.select2',tooltips:[],initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.model.set(this.name,new Backbone.Collection);},bindDataChange:function(){var updateTheDom=_.bind(function(recipients){this.getFieldElement().select2('data',recipients);this._initializeTooltips();},this);var bindCollectionChange=_.bind(function(){var value=this.model.get(this.name);if(value instanceof Backbone.Collection){value.on('add',function(models,collection){collection.reset(collection.clone().models);},this);value.on('remove',function(models,collection){updateTheDom(this.format(this.model.get(this.name)));},this);value.on('reset',function(collection){var recipients=this.format(collection.models);collection.reset(recipients,{silent:true});updateTheDom(recipients);},this);}},this);bindCollectionChange();this.model.on("change:"+this.name,function(model,recipients){var value=this.model.get(this.name);if(!(value instanceof Backbone.Collection)){this.model.set(this.name,new Backbone.Collection(value));}else{bindCollectionChange();value.reset(recipients.clone().models);}},this);},unbindData:function(){var value=this.model.get(this.name);if(value instanceof Backbone.Collection){value.off(null,null,this);}
app.view.Field.prototype.unbindData.call(this);},_render:function(){app.view.Field.prototype._render.call(this);var $recipientsField=this.getFieldElement();if($recipientsField.length>0){$recipientsField.select2({allowClear:true,multiple:true,width:'off',containerCssClass:'select2-choices-pills-close',containerCss:{'width':'100%'},minimumInputLength:1,query:_.bind(function(query){this.loadOptions(query);},this),createSearchChoice:_.bind(this.createOption,this),formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),formatSearching:_.bind(this.formatSearching,this),formatInputTooShort:_.bind(this.formatInputTooShort,this),selectOnBlur:true});if(!!this.def.disabled){$recipientsField.select2('disable');}}},loadOptions:_.debounce(function(query){var self=this,data={results:[],more:false},options={},callbacks={};options.q=query.term;options.module_list='Accounts,Contacts,Leads,Prospects,Users';options.fields='name,email';options.max_num=10;callbacks.success=function(result){var records=app.data.createMixedBeanCollection(result.records);data.results=self.format(records);};callbacks.error=function(){data.results=[];};callbacks.complete=function(){query.callback(data);};app.api.search(options,callbacks);},300),createOption:function(term,data){if(data.length===0){return{id:term,email:term};}},formatSelection:function(recipient){return recipient.name?recipient.name:recipient.email;},formatResult:function(recipient){return this.formatSelection(recipient);},formatSearching:function(){return app.lang.get("LBL_LOADING",this.module);},formatInputTooShort:function(term,min){return"";},format:function(data){var formattedRecipients=[];if(data instanceof Backbone.Collection){data=data.models;}else if(data instanceof Backbone.Model||(_.isObject(data)&&!_.isArray(data))){data=[data];}
if(_.isArray(data)){_.each(data,function(recipient){var formattedRecipient;if(!(recipient instanceof Backbone.Model)){recipient=new Backbone.Model(recipient);}
formattedRecipient=this._formatRecipient(recipient);if(!_.isEmpty(formattedRecipient.email)){formattedRecipients.push(formattedRecipient);}},this);}
return formattedRecipients;},bindDomChange:function(){var self=this;this.getFieldElement().on("change",function(){var value=$(this).select2('data');self.model.get(self.name).reset(value);}).on("change",function(event){self._initializeTooltips();}).on("selected",_.bind(this._handleEventOnSelected,this));},_handleEventOnSelected:function(event){var isValidChoice=false;if(event.object){if(event.object.id==event.object.email){isValidChoice=this._validateEmailAddress(event.object.email);}else{isValidChoice=true;}}
return isValidChoice;},unbindDom:function(){this._destroyTooltips();this.getFieldElement().select2('destroy');app.view.Field.prototype.unbindDom.call(this);},_showAddressBook:function(){var addRecipients=_.bind(function(recipients){if(recipients&&recipients.length>0){this.model.get(this.name).add(recipients.models);}},this);app.drawer.open({layout:"compose-addressbook",context:{module:"Emails",mixed:true}},function(recipients){addRecipients(recipients);});},setContentBefore:function(content){this.$('.select2-choices').attr('data-content-before',content);},getFieldElement:function(){return this.$(this.fieldTag);},_initializeTooltips:function(){var self=this;this._destroyTooltips();this.$('.select2-search-choice').each(function(){$(this).tooltip({container:'body',title:$(this).data('select2Data').email});self.tooltips.push($(this).data('tooltip'));});},_destroyTooltips:function(){_.each(this.tooltips,function(tooltip){tooltip.destroy();});this.tooltips=[];},_formatRecipient:function(recipient){var formattedRecipient={};if(recipient instanceof Backbone.Model){var bean=recipient.get('bean');if(bean){formattedRecipient=this._formatRecipient(bean);}
formattedRecipient={id:recipient.get('id')||formattedRecipient.id||recipient.get('email'),module:recipient.get('module')||recipient.module||recipient.get('_module')||formattedRecipient.module,email:recipient.get('email')||formattedRecipient.email,name:recipient.get('name')||recipient.get('full_name')||formattedRecipient.name};if(!_.isEmpty(formattedRecipient.id)){if(_.isArray(formattedRecipient.email)){var primaryEmailAddress=_.findWhere(formattedRecipient.email,{primary_address:true});if(!_.isUndefined(primaryEmailAddress)&&!_.isEmpty(primaryEmailAddress.email_address)){formattedRecipient.email=primaryEmailAddress.email_address;}}
_.each(formattedRecipient,function(val,key){if(_.isEmpty(formattedRecipient[key])||!_.isString(formattedRecipient[key])){delete formattedRecipient[key];}});}else{formattedRecipient={};}}
return formattedRecipient;},_validateEmailAddress:function(emailAddress){var isValid=false,callbacks={},options={async:false},url=app.api.buildURL("Mail","address/validate");callbacks.success=function(result){isValid=result[emailAddress];};callbacks.error=function(){isValid=false;};app.api.call("create",url,[emailAddress],callbacks,options);return isValid;}})},"quickcreate":{"controller":({extendsFrom:'QuickcreateField',initialize:function(options){var useSugarEmailClient=app.user.getPreference("use_sugar_email_client");if(useSugarEmailClient!=="true"){options.def.href="mailto:";}else{options.def.href=null;}
app.view.invokeParent(this,{type:'field',name:'quickcreate',method:'initialize',args:[options]});}})}}},"views":{"base":{"compose-addressbook-headerpane":{"controller":({extendsFrom:"HeaderpaneView",events:{"click [name=done_button]":"_done","click [name=cancel_button]":"_cancel"},_done:function(){var recipients=this.model.get("compose_addressbook_selected_recipients");if(recipients){app.drawer.close(recipients);}else{this._cancel();}},_cancel:function(){app.drawer.close();}})},"compose-addressbook-list":{"controller":({extendsFrom:'FlexListView',plugins:['ListColumnEllipsis','ListRemoveLinks'],unbindData:function(){var massCollection=this.context.get('mass_collection');if(massCollection){massCollection.off(null,null,this);}
app.view.invokeParent(this,{type:'view',name:'flex-list',method:'unbindData'});},getFieldNames:function(module){return['name','email'];},_render:function(){app.view.invokeParent(this,{type:'view',name:'flex-list',method:'_render'});var massCollection=this.context.get('mass_collection'),selectedRecipientsFieldName='compose_addressbook_selected_recipients';if(massCollection){massCollection.off(null,null,this);massCollection.on('add',function(model){var existingRecipients=this.model.get(selectedRecipientsFieldName);if(model.id&&existingRecipients instanceof Backbone.Collection){existingRecipients.add(model);}},this);massCollection.on('remove',function(model){var existingRecipients=this.model.get(selectedRecipientsFieldName);if(model.id&&existingRecipients instanceof Backbone.Collection){existingRecipients.remove(model);}},this);massCollection.on('reset',function(){var existingRecipients=this.model.get(selectedRecipientsFieldName);if(existingRecipients instanceof Backbone.Collection){existingRecipients.remove(this.collection.models);}},this);var existingRecipients=this.model.get(selectedRecipientsFieldName);if(existingRecipients instanceof Backbone.Collection&&existingRecipients.length>0){var recipientsToPreselect=existingRecipients.filter(_.bind(function(recipient){return(this.collection.where({id:recipient.get('id')}).length>0);},this));if(recipientsToPreselect.length>0){massCollection.add(recipientsToPreselect);}}}},_renderField:function(field){if(field.name=='_module'){field.model.set(field.name,app.lang.get('LBL_MODULE_NAME',field.model.get(field.name)));}
app.view.invokeParent(this,{type:'view',name:'flex-list',method:'_renderField',args:[field]});}})},"compose-addressbook-filter":{"controller":({_moduleFilterList:[],_allModulesId:'All',_selectedModule:null,_currentSearch:'',events:{'keyup .search-name':'throttledSearch','paste .search-name':'throttledSearch','click .add-on.icon-remove':'clearInput'},_render:function(){app.view.View.prototype._render.call(this);this.buildModuleFilterList();this.buildFilter();},buildModuleFilterList:function(){var allowedModules=this.context.get('allowed_modules');this._moduleFilterList=[{id:this._allModulesId,text:app.lang.get('LBL_TABGROUP_ALL')}];_.each(allowedModules,function(module){this._moduleFilterList.push({id:module,text:app.lang.get('LBL_MODULE_NAME',module)});},this);},buildFilter:function(){var $filter=this.getFilterField();if($filter.length>0){$filter.select2({data:this._moduleFilterList,allowClear:false,multiple:false,minimumResultsForSearch:-1,formatSelection:_.bind(this.formatModuleSelection,this),formatResult:_.bind(this.formatModuleChoice,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-filter-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},width:'off'});$filter.off('change');$filter.on('change',_.bind(this.handleModuleSelection,this));this._selectedModule=this._selectedModule||this._allModulesId;$filter.select2('val',this._selectedModule);}},getFilterField:function(){return this.$('input.select2');},getModuleFilter:function(){return this.$('div.choice-filter');},unbind:function(){$filter=this.getFilterField();if($filter.length>0){$filter.off();$filter.select2('destroy');}
app.view.invokeParent(this,{type:'view',name:'flex-list',method:'unbind'});},throttledSearch:_.debounce(function(evt){var newSearch=this.$(evt.currentTarget).val();if(this._currentSearch!==newSearch){this._currentSearch=newSearch;this.applyFilter();}},400),initSelection:function(el,callback){if(el.is(this.getFilterField())){var module=_.findWhere(this._moduleFilterList,{id:el.val()});callback({id:module.id,text:module.text});}},formatModuleSelection:function(item){this.getModuleFilter().html(item.text);return'<span class="select2-choice-type">'
+app.lang.get('LBL_MODULE')
+'<i class="icon-caret-down"></i></span>';},formatModuleChoice:function(option){return'<div><span class="select2-match"></span>'+option.text+'</div>';},handleModuleSelection:function(evt,overrideVal){var module=overrideVal||evt.val||this._selectedModule||this._allModulesId;if(!_.isEmpty(_.findWhere(this._moduleFilterList,{id:module}))){this._selectedModule=module;this.getFilterField().select2('val',this._selectedModule);this.getModuleFilter().css('cursor','pointer');this.applyFilter();}},applyFilter:function(){var searchAllModules=(this._selectedModule!==this._allModulesId),module=searchAllModules?this._selectedModule:[],isDirty=(!_.isEmpty(this._currentSearch)||searchAllModules);this._toggleClearQuickSearchIcon(isDirty);this.context.trigger('compose:addressbook:search',module,this._currentSearch);},_toggleClearQuickSearchIcon:function(addIt){if(addIt&&!this.$('.add-on.icon-remove')[0]){this.$('.filter-view.search').append('<i class="add-on icon-remove"></i>');}else if(!addIt){this.$('.add-on.icon-remove').remove();}},clearInput:function(){var $filter=this.getFilterField();this._currentSearch='';this._selectedModule=this._allModulesId;this.$('.search-name').val(this._currentSearch);if($filter.length>0){$filter.select2('val',this._selectedModule);}
this.applyFilter();}})},"compose-addressbook-recipientscontainer":{"controller":({extendsFrom:"RecordView",enableHeaderButtons:false,enableHeaderPane:false,events:{},initialize:function(options){app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this.model.isNotEmpty=true;},setupDuplicateFields:function(prefill){},delegateButtonEvents:function(){},initButtons:function(){this.buttons={};},showPreviousNextBtnGroup:function(){},bindDataChange:function(){},toggleHeaderLabels:function(isEdit){},toggleLabelByField:function(field){},handleKeyDown:function(e,field){},setButtonStates:function(state){},setTitle:function(title){}})},"compose-addressbook-list-bottom":{"controller":({extendsFrom:"ListBottomView"})},"compose":{"controller":({extendsFrom:'RecordView',_lastSelectedSignature:null,ATTACH_TYPE_SUGAR_DOCUMENT:'document',ATTACH_TYPE_TEMPLATE:'template',MIN_EDITOR_HEIGHT:300,EDITOR_RESIZE_PADDING:5,initialize:function(options){_.bindAll(this);app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this.events=_.extend({},this.events,{'click .cc-option':'showSenderOptionField','click .bcc-option':'showSenderOptionField','click [name=draft_button]':'saveAsDraft','click [name=send_button]':'send','click [name=cancel_button]':'cancel'});this.context.on('actionbar:template_button:clicked',this.launchTemplateDrawer,this);this.context.on('actionbar:attach_sugardoc_button:clicked',this.launchDocumentDrawer,this);this.context.on("actionbar:signature_button:clicked",this.launchSignatureDrawer,this);this.context.on('attachments:updated',this.toggleAttachmentVisibility,this);this.context.on('tinymce:oninit',this.handleTinyMceInit,this);this.on('more-less:toggled',this.handleMoreLessToggled,this);app.drawer.on('drawer:resize',this.resizeEditor,this);this._lastSelectedSignature=app.user.getPreference("signature_default");},_render:function(){var toAddressesField;app.view.invokeParent(this,{type:'view',name:'record',method:'_render'});if(this.createMode){this.setTitle(app.lang.get('LBL_COMPOSEEMAIL',this.module));}
if(this.model.isNotEmpty){var prepopulateValues=this.context.get("prepopulate");if(!_.isEmpty(prepopulateValues)){this.prepopulate(prepopulateValues);}
this.renderSenderOptions();if(this.model.isNew()){this._updateEditorWithSignature(this._lastSelectedSignature);}}
toAddressesField=this.getField('to_addresses');if(toAddressesField){toAddressesField.on('render',_.bind(function(){this.setRecipientContentBefore();},this));}},prepopulate:function(values){var self=this;_.defer(function(){_.each(values,function(value,fieldName){switch(fieldName){case'related':self.populateRelated(value);break;default:self.model.set(fieldName,value);}});});},populateRelated:function(relatedModel){var setParent=_.bind(function(model){model.value=model.get('name');this.getField('parent_name').setValue(model);},this);if(!_.isEmpty(relatedModel.get('id'))&&!_.isEmpty(relatedModel.get('name'))){setParent(relatedModel);}else if(!_.isEmpty(relatedModel.get('id'))){relatedModel.fetch({showAlerts:false,success:function(relatedModel){setParent(relatedModel);},fields:['name']});}},setMainButtonsDisabled:function(disabled){this.getField('main_dropdown').setDisabled(disabled);},renderSenderOptions:function(){var showCCLink=false,showBCCLink=false,toCC=this.model.get('cc_addresses')||[],toBCC=this.model.get('bcc_addresses')||[];if(toCC.length==0){this.hideField('cc_addresses');showCCLink=true;}
if(toBCC.length==0){this.hideField('bcc_addresses');showBCCLink=true;}
this.toggleSenderOptions('to_addresses',showCCLink,showBCCLink);},toggleSenderOptions:function(container,showCCLink,showBCCLink){var field=this.getField(container),ccField,senderOptionTemplate;if(field){ccField=field.$el.closest('.row-fluid.panel_body');senderOptionTemplate=app.template.getView("compose-senderoptions",this.module);$(senderOptionTemplate({'module':this.module,'showCC':showCCLink,'showBCC':showBCCLink,'showSeperator':showCCLink&&showBCCLink})).insertAfter(ccField.find('div span.normal'));}},showSenderOptionField:function(evt){var ccOption=$(evt.target),fieldName=ccOption.data('ccfield'),field=this.getField(fieldName),ccSeperator=this.$('.compose-sender-options .cc-seperator');ccOption.addClass('hide');ccSeperator.toggleClass('hide',true);field.$el.closest('.row-fluid.panel_body').removeClass('hide');this.setRecipientContentBefore();if(this.$('.cc-option').hasClass('hide')&&this.$('.bcc-option').hasClass('hide')){this.$('.compose-sender-options').addClass('hide');}
this.resizeEditor();},setRecipientContentBefore:function(){var toAddressesField=this.getField('to_addresses');if(toAddressesField){toAddressesField.setContentBefore(this.$('.compose-sender-options a').not('.hide').text());}},hideField:function(fieldName){var field=this.getField(fieldName);if(field){field.$el.closest('.row-fluid.panel_body').addClass('hide');}},cancel:function(){app.drawer.close();},getAttachmentsForApi:function(){var attachments=this.model.get('attachments')||[];if(!_.isArray(attachments)){attachments=[attachments];}
return attachments;},getRelatedForApi:function(){var related={};var id=this.model.get('parent_id');var type;if(!_.isUndefined(id)){id=id.toString();if(id.length>0){related['id']=id;type=this.model.get('parent_type');if(!_.isUndefined(type)){type=type.toString();}
related.type=type;}}
return related;},getTeamsForApi:function(){var teamName=this.model.get('team_name')||[];var teams={};teams.others=[];if(!_.isArray(teamName)){teamName=[teamName];}
_.each(teamName,function(team){if(team.primary){teams.primary=team.id.toString();}else if(!_.isUndefined(team.id)){teams.others.push(team.id.toString());}},this);if(teams.others.length==0){delete teams.others;}
return teams;},initializeSendEmailModel:function(){var sendModel=new Backbone.Model(_.extend({},this.model.attributes,{to_addresses:this.model.get('to_addresses'),cc_addresses:this.model.get('cc_addresses'),bcc_addresses:this.model.get('bcc_addresses'),attachments:this.getAttachmentsForApi(),related:this.getRelatedForApi(),teams:this.getTeamsForApi()}));return sendModel;},saveAsDraft:function(){this.saveModel('draft',app.lang.get('LBL_DRAFT_SAVING',this.module),app.lang.get('LBL_DRAFT_SAVED',this.module),app.lang.get('LBL_ERROR_SAVING_DRAFT',this.module));},send:function(){var sendEmail=_.bind(function(){this.saveModel('ready',app.lang.get('LBL_EMAIL_SENDING',this.module),app.lang.get('LBL_EMAIL_SENT',this.module),app.lang.get('LBL_ERROR_SENDING_EMAIL',this.module));},this);if(!this.isFieldPopulated('to_addresses')&&!this.isFieldPopulated('cc_addresses')&&!this.isFieldPopulated('bcc_addresses')){this.model.trigger('error:validation:to_addresses');app.alert.show('send_error',{level:'error',messages:'LBL_EMAIL_COMPOSE_ERR_NO_RECIPIENTS'});}else if(!this.isFieldPopulated('subject')&&!this.isFieldPopulated('html_body')){app.alert.show('send_confirmation',{level:'confirmation',messages:app.lang.get('LBL_NO_SUBJECT_NO_BODY_SEND_ANYWAYS',this.module),onConfirm:sendEmail});}else if(!this.isFieldPopulated('subject')){app.alert.show('send_confirmation',{level:'confirmation',messages:app.lang.get('LBL_SEND_ANYWAYS',this.module),onConfirm:sendEmail});}else if(!this.isFieldPopulated('html_body')){app.alert.show('send_confirmation',{level:'confirmation',messages:app.lang.get('LBL_NO_BODY_SEND_ANYWAYS',this.module),onConfirm:sendEmail});}else{sendEmail();}},saveModel:function(status,pendingMessage,successMessage,errorMessage){var myURL,sendModel=this.initializeSendEmailModel();this.setMainButtonsDisabled(true);app.alert.show('mail_call_status',{level:'process',title:pendingMessage});sendModel.set('status',status);myURL=app.api.buildURL('Mail');app.api.call('create',myURL,sendModel,{success:function(){app.alert.dismiss('mail_call_status');app.alert.show('mail_call_status',{autoClose:true,level:'success',messages:successMessage});app.drawer.close();},error:function(error){var msg={autoClose:false,level:'error'};if(error&&_.isString(error.message)){msg.messages=error.message;}
app.alert.dismiss('mail_call_status');app.alert.show('mail_call_status',msg);},complete:_.bind(function(){if(!this.disposed){this.setMainButtonsDisabled(false);}},this)});},isFieldPopulated:function(fieldName){return($.trim(this.model.get(fieldName))!=='');},launchTemplateDrawer:function(){app.drawer.open({layout:'selection-list',context:{module:'EmailTemplates'}},this.templateDrawerCallback);},templateDrawerCallback:function(model){if(model){var emailTemplate=app.data.createBean('EmailTemplates',{id:model.id});emailTemplate.fetch({success:this.confirmTemplate,error:_.bind(function(error){this._showServerError(error);},this)});}},confirmTemplate:function(template){if(this.disposed===true)return;app.alert.show('delete_confirmation',{level:'confirmation',messages:app.lang.get('LBL_EMAILTEMPLATE_MESSAGE_SHOW_MSG',this.module),onConfirm:_.bind(function(){this.insertTemplate(template);},this)});},insertTemplate:function(template){var subject,notes;if(_.isObject(template)){subject=template.get('subject');if(subject){this.model.set('subject',subject);}
if(template.get('text_only')===1){this.model.set("html_body",template.get("body"));}else{this.model.set("html_body",template.get("body_html"));}
notes=app.data.createBeanCollection("Notes");notes.fetch({'filter':{"filter":[{"parent_id":{"$equals":template.id}}]},success:_.bind(function(data){if(this.disposed===true)return;if(!_.isEmpty(data.models)){this.insertTemplateAttachments(data.models);}},this),error:_.bind(function(error){this._showServerError(error);},this)});this._updateEditorWithSignature(this._lastSelectedSignature);}},insertTemplateAttachments:function(attachments){this.context.trigger("attachments:remove-by-tag",'template');_.each(attachments,function(attachment){var filename=attachment.get('filename');this.context.trigger("attachment:add",{id:attachment.id,name:filename,nameForDisplay:filename,tag:'template',type:this.ATTACH_TYPE_TEMPLATE});},this);},launchDocumentDrawer:function(){app.drawer.open({layout:'selection-list',context:{module:'Documents'}},this.documentDrawerCallback);},documentDrawerCallback:function(model){if(model){var sugarDocument=app.data.createBean('Documents',{id:model.id});sugarDocument.fetch({success:_.bind(function(model){if(this.disposed===true)return;this.context.trigger("attachment:add",{id:model.id,name:model.get('filename'),nameForDisplay:model.get('filename'),type:this.ATTACH_TYPE_SUGAR_DOCUMENT});},this),error:_.bind(function(error){this._showServerError(error);},this)});}},toggleAttachmentVisibility:function(attachments){var $row=this.$('.attachments').closest('.row-fluid');if(attachments.length>0){$row.removeClass('hidden');$row.addClass('single');}else{$row.addClass('hidden');$row.removeClass('single');}
this.resizeEditor();},launchSignatureDrawer:function(){app.drawer.open({layout:"selection-list",context:{module:'UserSignatures'}},this._updateEditorWithSignature);},_updateEditorWithSignature:function(model){if(model&&model.id){var signature=app.data.createBean('UserSignatures',{id:model.id});signature.fetch({success:_.bind(function(model){if(this.disposed===true)return;if(this._insertSignature(model)){this._lastSelectedSignature=model;}},this),error:_.bind(function(error){this._showServerError(error);},this)});}},_insertSignature:function(signature){if(_.isObject(signature)&&signature.get('signature_html')){var signatureContent=this._formatSignature(signature.get('signature_html')),emailBody=this.model.get("html_body")||"",signatureOpenTag='<br class="signature-begin" />',signatureCloseTag='<br class="signature-end" />',signatureOpenTagForRegex='(<br\ class=[\'"]signature\-begin[\'"].*?\/?>)',signatureCloseTagForRegex='(<br\ class=[\'"]signature\-end[\'"].*?\/?>)',signatureOpenTagMatches=emailBody.match(new RegExp(signatureOpenTagForRegex,"gi")),signatureCloseTagMatches=emailBody.match(new RegExp(signatureCloseTagForRegex,"gi")),regex=new RegExp(signatureOpenTagForRegex+".*?"+signatureCloseTagForRegex,"gi");if(signatureOpenTagMatches&&!signatureCloseTagMatches){emailBody=this._insertSignatureTag(emailBody,signatureCloseTag,false);}else if(!signatureOpenTagMatches&&signatureCloseTagMatches){emailBody=this._insertSignatureTag(emailBody,signatureOpenTag,true);}else if(!signatureOpenTagMatches&&!signatureCloseTagMatches){emailBody=this._insertSignatureTag(emailBody,signatureOpenTag+signatureCloseTag,(app.user.getPreference("signature_prepend")=="true"));}
this.model.set("html_body",emailBody.replace(regex,"$1"+signatureContent+"$2"));return true;}
return false;},_insertSignatureTag:function(body,tag,prepend){var preSignature="",postSignature="";prepend=prepend||false;if(prepend){var bodyOpenTag="<body>",bodyOpenTagLoc=body.indexOf(bodyOpenTag);if(bodyOpenTagLoc>-1){preSignature=body.substr(0,bodyOpenTagLoc+bodyOpenTag.length);postSignature=body.substr(bodyOpenTagLoc+bodyOpenTag.length,body.length);}else{postSignature=body;}}else{var bodyCloseTag="</body>",bodyCloseTagLoc=body.indexOf(bodyCloseTag);if(bodyCloseTagLoc>-1){preSignature=body.substr(0,bodyCloseTagLoc);postSignature=body.substr(bodyCloseTagLoc,body.length);}else{preSignature=body;}}
return preSignature+tag+postSignature;},_formatSignature:function(signature){signature=signature.replace(/&lt;/gi,"<");signature=signature.replace(/&gt;/gi,">");return signature;},_showServerError:function(error){app.alert.show("server-error",{level:"error",messages:"ERR_GENERIC_SERVER_ERROR",autoClose:false});app.error.handleHttpError(error);},handleMoreLessToggled:function(){this.resizeEditor();},handleTinyMceInit:function(){this.resizeEditor();},_dispose:function(){if(app.drawer){app.drawer.off(null,null,this);}
app.view.invokeParent(this,{type:'view',name:'record',method:'_dispose'});},resizeEditor:function(drawerHeight){var $editor,headerHeight,recordHeight,showHideHeight,diffHeight,editorHeight,newEditorHeight;$editor=this.$('.mceLayout .mceIframeContainer iframe');if($editor.length===0){return;}
drawerHeight=drawerHeight||app.drawer.getHeight();headerHeight=this.$('.headerpane').outerHeight(true);recordHeight=this.$('.record').outerHeight(true);showHideHeight=this.$('.show-hide-toggle').outerHeight(true);editorHeight=$editor.height();diffHeight=drawerHeight-headerHeight-recordHeight-showHideHeight-this.EDITOR_RESIZE_PADDING;newEditorHeight=editorHeight+diffHeight;if(newEditorHeight<this.MIN_EDITOR_HEIGHT){newEditorHeight=this.MIN_EDITOR_HEIGHT;}
$editor.height(newEditorHeight);}})}}},"layouts":{"base":{"compose-addressbook":{"controller":({initialize:function(options){app.view.Layout.prototype.initialize.call(this,options);this.context.set('allowed_modules',['Accounts','Contacts','Leads','Prospects','Users']);this.context.on('compose:addressbook:search',this.search,this);},search:function(modules,term){var options={query:term,module_list:modules};this.collection.resetPagination();this.context.resetLoadFlag(false);this.context.set('skipFetch',false);this.loadData(options,true);},loadData:function(options,setFields){var allowedModules=this.context.get('allowed_modules');options=options||{};options.module_list=options.module_list||[];if(!_.isArray(options.module_list)){options.module_list=options.module_list.split(',');}
if(!_.isEmpty(options.module_list)){options.module_list=_.intersection(allowedModules,options.module_list);}
options.module_list=(!_.isEmpty(options.module_list))?options.module_list:allowedModules;app.view.Layout.prototype.loadData.call(this,options,setFields);}})}}}},"Meetings":{"fieldTemplates":{},"views":{},"layouts":{}},"Tasks":{"fieldTemplates":{"base":{"closebutton":{"controller":({events:{'click [name="record-close"]':'closeClicked','click [name="record-close-new"]':'closeNewClicked'},extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},closeClicked:function(){this._close(false);},closeNewClicked:function(){this._close(true);},hasAccess:function(){var acl=app.view.invokeParent(this,{type:'field',name:'button',method:'hasAccess'});return acl&&this.model.get('status')!=='Completed';},_close:function(createNew){var self=this;this.model.set('status','Completed');this.model.save({},{success:function(){app.alert.show('close_task_success',{level:'success',autoClose:true,title:app.lang.get('LBL_TASK_CLOSE_SUCCESS',self.module)});if(createNew){var module=app.metadata.getModule(self.model.module);var prefill=app.data.createBean(self.model.module);prefill.copy(self.model);if(module.fields.status&&module.fields.status['default']){prefill.set('status',module.fields.status['default']);}else{prefill.unset('status');}
app.drawer.open({layout:'create-actions',context:{create:true,model:prefill}},function(){if(self.parent){self.parent.render();}else{self.render();}});}},error:function(error){app.alert.show('close_task_error',{level:'error',autoClose:true,title:app.lang.getAppString('ERR_AJAX_LOAD')});app.logger.error('Failed to close a task. '+error);self.model.revertAttributes();}});},bindDataChange:function(){if(this.model){this.model.on("change:status",this.render,this);}}})}}},"views":{"base":{"record":{"controller":({setupDuplicateFields:function(prefill){var duplicateBlackList=["id","status"];_.each(duplicateBlackList,function(field){if(field&&prefill.has(field)){prefill.unset(field);}});}})}}},"layouts":{}},"Calendar":{"fieldTemplates":{},"views":{},"layouts":{}},"Leads":{"fieldTemplates":{"base":{"convertbutton":{"controller":({extendsFrom:'RowactionField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},_render:function(){var convertMeta=app.metadata.getLayout('Leads','convert-main');var missingRequiredAccess=_.some(convertMeta.modules,function(moduleMeta){return(moduleMeta.required===true&&!app.acl.hasAccess('create',moduleMeta.module));},this);if(this.model.get('converted')||missingRequiredAccess){this.hide();}else{app.view.invokeParent(this,{type:'field',name:'rowaction',method:'_render'});}},rowActionSelect:function(){var model=app.data.createBean(this.model.module);model.set(app.utils.deepCopy(this.model.attributes));app.drawer.open({layout:"convert",context:{forceNew:true,skipFetch:true,module:'Leads',leadsModel:model}});},bindDataChange:function(){if(this.model){this.model.on("change",this.render,this);}}})},"badge":{"controller":({showNoData:false,initialize:function(options){options.def.readonly=true;app.view.Field.prototype.initialize.call(this,options);}})}}},"views":{"base":{"record":{"controller":({extendsFrom:'RecordView',setupDuplicateFields:function(prefill){var duplicateBlackList=["id","status","converted","account_id","opportunity_id","contact_id"];_.each(duplicateBlackList,function(field){if(field&&prefill.has(field)){if(!_.isUndefined(prefill.fields[field])&&!_.isUndefined(prefill.fields[field].default)){prefill.set(field,prefill.fields[field].default);}else{prefill.unset(field);}}});}})},"convert-headerpane":{"controller":({extendsFrom:'HeaderpaneView',events:{'click [name=save_button]:not(".disabled")':'initiateSave','click [name=cancel_button]':'initiateCancel'},initialize:function(options){app.view.invokeParent(this,{type:'view',name:'headerpane',method:'initialize',args:[options]});this.context.on('lead:convert-save:toggle',this.toggleSaveButton,this);},_renderHtml:function(){var leadsModel=this.context.get('leadsModel');var name=!_.isUndefined(leadsModel.get('name'))?leadsModel.get('name'):leadsModel.get('first_name')+' '+leadsModel.get('last_name');this.title=app.lang.get("LBL_CONVERTLEAD_TITLE",this.module)+': '+name;app.view.invokeParent(this,{type:'view',name:'headerpane',method:'_renderHtml'});},initiateSave:function(){this.context.trigger('lead:convert:save');},initiateCancel:function(){app.drawer.close();},toggleSaveButton:function(enable){this.$('[name=save_button]').toggleClass('disabled',!enable);}})},"convert-results":{"controller":({extendsFrom:'ConvertResultsView',populateResults:function(){var model;if(!this.model.get('converted')){return;}
this.associatedModels.reset();model=this.buildAssociatedModel('Contacts','contact_id','contact_name');if(model){this.associatedModels.push(model);}
model=this.buildAssociatedModel('Accounts','account_id','account_name');if(model){this.associatedModels.push(model);}
model=this.buildAssociatedModel('Opportunities','opportunity_id','opportunity_name');if(model){this.associatedModels.push(model);}
app.view.View.prototype.render.call(this);},buildAssociatedModel:function(moduleName,idField,nameField){var moduleSingular=app.lang.getAppListStrings("moduleListSingular"),rowTitle,model;if(_.isEmpty(this.model.get(idField))){return false;}
rowTitle=app.lang.get('LBL_CONVERT_MODULE_ASSOCIATED',this.module,{'moduleName':moduleSingular[moduleName]});model=app.data.createBean(moduleName,{id:this.model.get(idField),name:this.model.get(nameField),row_title:rowTitle,_module:moduleName,target_module:moduleName});model.module=moduleName;return model;}})},"create-actions":{"controller":({extendsFrom:'CreateView',getCustomSaveOptions:function(){var options={};if(this.context.get('prospect_id')){options.params={};options.params.prospect_id=this.context.get('prospect_id');this.context.unset('prospect_id');}
return options;}})},"convert-panel-header":{"controller":({events:{'click .toggle-link':'handleToggleClick'},initialize:function(options){options.meta.buttons=this.getButtons(options);app.view.View.prototype.initialize.call(this,options);this.layout.on('toggle:change',this.handleToggleChange,this);this.layout.on('lead:convert-dupecheck:pending',this.setDupeCheckPending,this);this.layout.on('lead:convert-dupecheck:complete',this.setDupeCheckResults,this);this.layout.on('lead:convert-panel:complete',this.handlePanelComplete,this);this.layout.on('lead:convert-panel:reset',this.handlePanelReset,this);this.layout.on('lead:convert:duplicate-selection:change',this.setAssociateButtonState,this);this.context.on('lead:convert:'+this.meta.module+':shown',this.handlePanelShown,this);this.context.on('lead:convert:'+this.meta.module+':hidden',this.handlePanelHidden,this);this.initializeSubTemplates();},getButtons:function(options){return[{name:'associate_button',type:'button',label:this.getLabel('LBL_CONVERT_ASSOCIATE_MODULE',{'moduleName':options.meta.moduleSingular}),css_class:'btn-primary disabled'},{name:'reset_button',type:'button',label:'LBL_CONVERT_RESET_PANEL',css_class:'btn-invisible btn-link'}];},_render:function(){app.view.View.prototype._render.call(this);this.getField('reset_button').hide();},getCurrentState:function(){var currentState=_.extend({},this.layout.currentState,{create:(this.layout.currentToggle===this.layout.TOGGLE_CREATE),labelModule:this.module,moduleInfo:{'moduleName':this.meta.moduleSingular},required:this.meta.required});if(_.isNumber(currentState.dupeCount)){currentState.duplicateCheckResult={'duplicateCount':currentState.dupeCount};}
return currentState;},initializeSubTemplates:function(){this.tpls={};this.initial={};this.tpls.title=app.template.getView(this.name+'.title',this.module);this.initial.title=this.tpls.title(this.getCurrentState());this.tpls.dupecheckPending=app.template.getView(this.name+'.dupecheck-pending',this.module);this.tpls.dupecheckResults=app.template.getView(this.name+'.dupecheck-results',this.module);},handleToggleClick:function(event){var nextToggle=this.$(event.target).data('next-toggle');this.layout.trigger('toggle:showcomponent',nextToggle);event.stopPropagation();},handleToggleChange:function(toggle){this.renderTitle();this.toggleDupeCheckResults(toggle===this.layout.TOGGLE_DUPECHECK);this.setSubViewToggle(toggle);this.setAssociateButtonState();},handlePanelShown:function(){this.$('.accordion-heading').addClass('active');this.toggleSubViewToggle(true);this.setAssociateButtonState();this.toggleActiveIndicator(true);},handlePanelHidden:function(){this.$('.accordion-heading').removeClass('active');this.toggleSubViewToggle(false);this.setAssociateButtonState(false);this.toggleActiveIndicator(false);},handlePanelComplete:function(){this.setStepCircle(true);this.renderTitle();this.toggleDupeCheckResults(false);this.toggleSubViewToggle(false);this.toggleButtons(true);},handlePanelReset:function(){this.setStepCircle(false);this.renderTitle();this.toggleDupeCheckResults(true);this.toggleButtons(false);this.setAssociateButtonState();},setStepCircle:function(complete){var $stepCircle=this.$('.step-circle');if(complete){$stepCircle.addClass('complete');}else{$stepCircle.removeClass('complete');}},renderTitle:function(){this.$('.title').html(this.tpls.title(this.getCurrentState()));},setDupeCheckPending:function(){this.renderDupeCheckResults('pending');},setDupeCheckResults:function(duplicateCount){if(duplicateCount>0){this.renderDupeCheckResults('results');}else{this.renderDupeCheckResults('clear');this.toggleSubViewLink('dupecheck',false);this.toggleSubViewLink('create',false);}},renderDupeCheckResults:function(type){var results='';if(type==='results'){results=this.tpls.dupecheckResults(this.getCurrentState());}else if(type==='pending'){results=this.tpls.dupecheckPending(this.getCurrentState())}
this.$('.dupecheck-results').text(results);},toggleDupeCheckResults:function(show){this.$('.dupecheck-results').toggle(show);},toggleSubViewToggle:function(show){if(this.layout.currentState.complete){show=false}
this.$('.subview-toggle').toggleClass('hide',!show);},setSubViewToggle:function(nextToggle){_.each(['dupecheck','create'],function(currentToggle){this.toggleSubViewLink(currentToggle,(nextToggle===currentToggle));},this);},toggleSubViewLink:function(currentToggle,show){this.$('.subview-toggle .'+currentToggle).toggle(show);},toggleButtons:function(complete){var associateButton='associate_button',resetButton='reset_button'
if(complete){this.getField(associateButton).hide();this.getField(resetButton).show();}else{this.getField(associateButton).show();this.getField(resetButton).hide();}},setAssociateButtonState:function(activate){var $associateButton=this.$('[name="associate_button"]'),panelActive=this.$('.accordion-heading').hasClass('active');if(_.isUndefined(activate)){if(this.layout.currentToggle===this.layout.TOGGLE_CREATE){activate=true;}else{activate=this.layout.currentState.dupeSelected;}}
if(activate&&panelActive){$associateButton.removeClass('disabled');}else{$associateButton.addClass('disabled');}},toggleActiveIndicator:function(active){var $activeIndicator=this.$('.active-indicator i');$activeIndicator.toggleClass('icon-chevron-up',active);$activeIndicator.toggleClass('icon-chevron-down',!active);},getLabel:function(key,context){return app.lang.get(key,'Leads',context);}})}}},"layouts":{"base":{"convert-main":{"controller":({initialize:function(options){this.convertPanels={};this.associatedModels={};this.dependentModules={};this.noAccessRequiredModules=[];app.view.Layout.prototype.initialize.call(this,options);this.initializePanels(this.meta.modules);this.context.on('lead:convert-panel:complete',this.handlePanelComplete,this);this.context.on('lead:convert-panel:reset',this.handlePanelReset,this);this.context.on('lead:convert:save',this.handleSave,this);this.before('render',this.checkRequiredAccess);},initializePanels:function(modulesMetadata){var moduleNumber=1;_.each(modulesMetadata,function(moduleMeta,key,modulesList){if(!app.acl.hasAccess('create',moduleMeta.module)){if(moduleMeta.required===true){this.noAccessRequiredModules.push(moduleMeta.module);}
delete modulesList[key];return;}
moduleMeta.moduleNumber=moduleNumber++;var view=app.view.createLayout({context:this.context,name:'convert-panel',layout:this,meta:moduleMeta,type:'convert-panel',platform:this.options.platform});view.$el.addClass('accordion-group');view.$el.data('module',moduleMeta.module);this.addComponent(view);this.convertPanels[moduleMeta.module]=view;if(moduleMeta.dependentModules){this.dependentModules[moduleMeta.module]=moduleMeta.dependentModules;}},this);},checkRequiredAccess:function(){if(this.noAccessRequiredModules.length>0){this.denyUserAccess(this.noAccessRequiredModules);return false;}
return true;},denyUserAccess:function(noAccessRequiredModules){var translatedModuleNames=[];_.each(noAccessRequiredModules,function(module){translatedModuleNames.push(this.getModuleSingular(module));},this);app.alert.show('convert_access_denied',{level:'error',messages:app.lang.get('LBL_CONVERT_ACCESS_DENIED',this.module,{requiredModulesMissing:translatedModuleNames.join(', ')}),autoClose:false});app.drawer.close();},getModuleSingular:function(module){var modulePlural=app.lang.getAppListStrings("moduleList")[module]||module;return(app.lang.getAppListStrings("moduleListSingular")[module]||modulePlural);},_render:function(){app.view.Layout.prototype._render.call(this);this.$el.addClass('accordion');this.$el.attr('id','convert-accordion');this.$(".collapse").collapse({toggle:false,parent:'#convert-accordion'});this.$(".collapse").on('shown hidden',_.bind(this.handlePanelCollapseEvent,this));this.context.get('leadsModel').fetch({success:_.bind(function(model){this.context.trigger("lead:convert:populate",model);},this)});},handlePanelCollapseEvent:function(event){if(event.target!==event.currentTarget){return;}
var module=$(event.currentTarget).data('module');this.context.trigger('lead:convert:'+module+':'+event.type);},handlePanelComplete:function(module,model){this.associatedModels[module]=model;this.handlePanelUpdate();this.context.trigger('lead:convert:'+module+':complete',module,model);},handlePanelReset:function(module){delete this.associatedModels[module];this.handlePanelUpdate();this.context.trigger('lead:convert:'+module+':reset',module);},handlePanelUpdate:function(){this.checkDependentModules();this.checkRequired();},checkDependentModules:function(){_.each(this.dependentModules,function(dependencies,dependentModuleName){var isEnabled=_.all(dependencies,function(module,moduleName){return(this.associatedModels[moduleName]);},this);this.context.trigger("lead:convert:"+dependentModuleName+":enable",isEnabled);},this);},checkRequired:function(){var showSave=_.all(this.meta.modules,function(module){if(module.required){if(!this.associatedModels[module.module]){return false;}}
return true;},this);this.context.trigger('lead:convert-save:toggle',showSave);},handleSave:function(){var convertModel,myURL;this.context.trigger('lead:convert-save:toggle',false);app.alert.show('processing_convert',{level:'process',title:app.lang.getAppString('LBL_SAVING')});convertModel=new Backbone.Model(_.extend({},{'modules':this.associatedModels}));myURL=app.api.buildURL('Leads','convert',{id:this.context.get('leadsModel').id});app.api.call('create',myURL,convertModel,{success:_.bind(this.uploadAssociatedRecordFiles,this),error:_.bind(this.convertError,this)});},uploadAssociatedRecordFiles:function(convertResults){if(this.disposed)return;var modulesToProcess=_.keys(this.associatedModels).length,failureCount=0;var completeFn=_.bind(function(){modulesToProcess--;if(modulesToProcess===0){if(failureCount>0){this.convertWarning();}else{this.convertSuccess();}}},this);_.each(this.associatedModels,function(associatedModel,associatedModule){var moduleResult=_.find(convertResults.modules,function(result){return(associatedModule===result._module);},this);if(moduleResult&&_.isEmpty(associatedModel.get('id'))){associatedModel.set('id',moduleResult.id);app.file.checkFileFieldsAndProcessUpload(this.convertPanels[associatedModule].createView,{success:function(){completeFn();},error:function(){failureCount++;completeFn();}},{deleteIfFails:false},false);}else{completeFn();}},this);},convertSuccess:function(){this.convertComplete('success','LBL_CONVERTLEAD_SUCCESS',true);},convertWarning:function(){this.convertComplete('warning','LBL_CONVERTLEAD_FILE_WARN',true);},convertError:function(){this.convertComplete('error','LBL_CONVERTLEAD_ERROR',false);if(!this.disposed){this.context.trigger('lead:convert-save:toggle',true);}},convertComplete:function(level,message,doClose){var leadsModel=this.context.get('leadsModel');app.alert.dismiss('processing_convert');app.alert.show('convert_complete',{level:level,messages:app.lang.get(message,this.module,{leadName:leadsModel.get('first_name')+' '+leadsModel.get('last_name')}),autoClose:(level==='success')});if(!this.disposed&&doClose){this.context.trigger('lead:convert:exit');app.drawer.close();app.navigate(this.context,leadsModel,'record');}},_dispose:function(){this.$(".collapse").off();app.view.Layout.prototype._dispose.call(this);}})},"convert-panel":{"controller":({extendsFrom:'ToggleLayout',TOGGLE_DUPECHECK:'dupecheck',TOGGLE_CREATE:'create',availableToggles:{'dupecheck':{},'create':{}},accordionHeading:'.accordion-heading',accordionBody:'.accordion-body',initialize:function(options){var convertPanelEvents;this.meta=options.meta;this._setModuleSpecificValues();convertPanelEvents={};convertPanelEvents['click .accordion-heading.enabled']='togglePanel';convertPanelEvents['click [name="associate_button"]']='handleAssociateClick';convertPanelEvents['click [name="reset_button"]']='handleResetClick';this.events=_.extend({},this.events,convertPanelEvents);this.plugins=_.union(this.plugins||[],['FindDuplicates']);this.currentState={complete:false,dupeSelected:false};app.view.invokeParent(this,{type:'layout',name:'toggle',method:'initialize',args:[options]});this.addSubComponents();this.context.on('lead:convert:populate',this.handlePopulateRecords,this);this.context.on('lead:convert:'+this.meta.module+':enable',this.handleEnablePanel,this);this.context.on('lead:convert:'+this.meta.moduleNumber+':open',this.handleOpenRequest,this);this.context.on('lead:convert:exit',this.turnOffUnsavedChanges,this);this.addDependencyListeners();if(this.meta.moduleNumber===1){this.once('lead:convert-dupecheck:complete',this.openPanel,this);}},_setModuleSpecificValues:function(){var module=this.meta.module;this.meta.modulePlural=app.lang.getAppListStrings("moduleList")[module]||module;this.meta.moduleSingular=app.lang.getAppListStrings("moduleListSingular")[module]||this.meta.modulePlural;var moduleMetadata=app.metadata.getModule(module);this.meta.enableDuplicateCheck=(moduleMetadata&&moduleMetadata.dupCheckEnabled)||this.meta.enableDuplicateCheck||false;this.meta.duplicateCheckOnStart=this.meta.enableDuplicateCheck&&this.meta.duplicateCheckOnStart;},getContainer:function(component){if(component.name==='convert-panel-header'){return this.$('[data-container="header"]');}else{return this.$('[data-container="inner"]');}},addSubComponents:function(){this.addHeaderComponent();this.addDupeCheckComponent();this.addRecordCreateComponent();},addHeaderComponent:function(){var header=app.view.createView({context:this.context,name:'convert-panel-header',layout:this,meta:this.meta});this.addComponent(header);},addDupeCheckComponent:function(){var leadsModel=this.context.get('leadsModel'),context=this.context.getChildContext({'module':this.meta.module,'forceNew':true,'skipFetch':true,'dupelisttype':'dupecheck-list-select','collection':this.createDuplicateCollection(leadsModel,this.meta.module)});context.prepare();this.duplicateView=app.view.createLayout({context:context,name:this.TOGGLE_DUPECHECK,layout:this,module:context.module});this.duplicateView.context.on('change:selection_model',this.handleDupeSelectedChange,this);this.duplicateView.collection.once('reset',this.dupeCheckComplete,this);this.addComponent(this.duplicateView);},addRecordCreateComponent:function(){var context=this.context.getChildContext({'module':this.meta.module,forceNew:true,create:true});context.prepare();this.createView=app.view.createView({context:context,name:this.TOGGLE_CREATE,module:context.module,layout:this});this.createView.meta=this.removeFieldsFromMeta(this.createView.meta,this.meta);this.createView.enableHeaderButtons=false;this.addComponent(this.createView);},addDependencyListeners:function(){_.each(this.meta.dependentModules,function(details,module){this.context.on('lead:convert:'+module+':complete',this.updateFromDependentModuleChanges,this);this.context.on('lead:convert:'+module+':reset',this.resetFromDependentModuleChanges,this);},this);},dupeCheckComplete:function(){this.currentState.dupeCount=this.duplicateView.collection.length;if(this.currentState.dupeCount!==0){this.showComponent(this.TOGGLE_DUPECHECK);}else{this.showComponent(this.TOGGLE_CREATE);}
this.trigger('lead:convert-dupecheck:complete',this.currentState.dupeCount);},removeFieldsFromMeta:function(meta,moduleMeta){_.each(meta.panels,function(panel){_.each(panel.fields,function(field,index,list){if(_.isString(field)){field={name:field};}
if(_.contains(moduleMeta.hiddenFields,field.name||field)){field.readonly=true;field.required=false;list[index]=field;}});},this);return meta;},togglePanel:function(){this.$(this.accordionBody).collapse('toggle');},handleOpenRequest:function(){if(this.currentState.complete||!this.isPanelEnabled()){this.requestNextPanelOpen();}else{this.openPanel();}},isPanelEnabled:function(){return this.$(this.accordionHeading).hasClass('enabled');},openPanel:function(){if(this.isPanelEnabled()){this.$(this.accordionBody).collapse('show');}},closePanel:function(){this.$(this.accordionBody).collapse('hide');},handleAssociateClick:function(event){if(!$(event.currentTarget).hasClass('disabled')){if(this.currentToggle===this.TOGGLE_CREATE){this.runCreateValidation();}else{this.markPanelComplete(this.duplicateView.context.get('selection_model'));}}
event.stopPropagation();},runCreateValidation:function(){var view=this.createView,model=view.model;model.doValidate(view.getFields(view.module),_.bind(function(isValid){if(isValid){this.markPanelComplete(model);}},this));},markPanelComplete:function(model){var displayMessage=(this.currentToggle===this.TOGGLE_CREATE)?'LBL_CONVERT_MODULE_ASSOCIATED_NEW_SUCCESS':'LBL_CONVERT_MODULE_ASSOCIATED_SUCCESS';this.currentState.associatedName=this.getDisplayName(model);this.currentState.complete=true;this.context.trigger('lead:convert-panel:complete',this.meta.module,model);this.trigger('lead:convert-panel:complete',this.currentState.associatedName);app.alert.show('panel_associate_complete',{level:'success',title:app.lang.get('LBL_CONVERT_MODULE_ASSOCIATED',this.module,{moduleName:this.meta.moduleSingular}),messages:app.lang.get(displayMessage,this.module,{moduleNameLower:this.meta.moduleSingular.toLowerCase(),recordName:this.currentState.associatedName}),autoClose:true});this.$(this.accordionBody).addClass('disabled');this.closePanel();this.requestNextPanelOpen();},requestNextPanelOpen:function(){this.context.trigger('lead:convert:'+(this.meta.moduleNumber+1)+':open');},getDisplayName:function(model){var moduleFields=app.metadata.getModule(this.meta.module).fields,displayName='';if(model.has('name')){displayName=model.get('name');}else if(moduleFields.name&&moduleFields.name['db_concat_fields']){_.each(moduleFields.name['db_concat_fields'],function(field){if(model.has(field)){displayName+=model.get(field)+' ';}});}
return displayName.trim();},handleResetClick:function(event){this.resetPanel();this.openPanel();event.stopPropagation();},resetPanel:function(){this.$(this.accordionBody).removeClass('disabled');this.currentState.complete=false;this.context.trigger('lead:convert-panel:reset',this.meta.module);this.trigger('lead:convert-panel:reset');},handleDupeSelectedChange:function(){this.currentState.dupeSelected=this.duplicateView.context.has('selection_model');this.trigger('lead:convert:duplicate-selection:change');},triggerDuplicateCheck:function(){if(this.shouldDupeCheckBePerformed(this.createView.model)){this.trigger('lead:convert-dupecheck:pending');this.duplicateView.context.trigger("dupecheck:fetch:fire",this.createView.model,{showAlerts:true});}else{this.dupeCheckComplete();}},shouldDupeCheckBePerformed:function(model){var performDuplicateCheck=this.meta.enableDuplicateCheck;if(this.meta.duplicateCheckRequiredFields){_.each(this.meta.duplicateCheckRequiredFields,function(field){if(_.isEmpty(model.get(field))){performDuplicateCheck=false;}});}
return performDuplicateCheck;},handlePopulateRecords:function(model){this.populateRecords(model,this.meta.fieldMapping);if(this.meta.duplicateCheckOnStart){this.triggerDuplicateCheck();}},populateRecords:function(model,fieldMapping){var hasChanged=false;_.each(fieldMapping,function(sourceField,targetField){if(model.has(sourceField)&&model.get(sourceField)!==this.createView.model.get(targetField)){this.createView.model.set(targetField,model.get(sourceField));hasChanged=true;}},this);return hasChanged;},handleEnablePanel:function(isEnabled){var $header=this.$(this.accordionHeading);if(isEnabled){if(!this.currentState.complete){this.triggerDuplicateCheck();}
$header.addClass('enabled');}else{$header.removeClass('enabled');}},updateFromDependentModuleChanges:function(moduleName,model){var dependencies=this.meta.dependentModules,modelChanged=false;if(dependencies&&dependencies[moduleName]&&dependencies[moduleName].fieldMapping){modelChanged=this.populateRecords(model,dependencies[moduleName].fieldMapping);if(modelChanged){this.triggerDuplicateCheck();}}},resetFromDependentModuleChanges:function(moduleName){var dependencies=this.meta.dependentModules;if(dependencies&&dependencies[moduleName]){if(this.currentState.dupeCount){this.duplicateView.collection.reset();}
this.resetPanel();}},turnOffUnsavedChanges:function(){this.createView.model.changed={};},_dispose:function(){this.duplicateView.context.off(null,null,this);this.duplicateView.collection.off(null,null,this);app.view.invokeParent(this,{type:'layout',name:'toggle',method:'_dispose'});}})}}}},"Currencies":{"fieldTemplates":{},"views":{},"layouts":{}},"Contracts":{"fieldTemplates":{},"views":{},"layouts":{}},"Quotes":{"fieldTemplates":{},"views":{},"layouts":{}},"Products":{"fieldTemplates":{},"views":{"base":{"record":{"controller":({extendsFrom:'RecordView',delegateButtonEvents:function(){this.context.on('button:convert_to_quote:click',this.convertToQuote,this);app.view.invokeParent(this,{type:'view',name:'record',method:'delegateButtonEvents'});}})},"create-actions":{"controller":({extendsFrom:'CreateView'})}}},"layouts":{}},"RevenueLineItems":{"fieldTemplates":{"base":{"editablelistbutton":{"controller":({extendsFrom:'EditablelistbuttonField',getCustomSaveOptions:function(options){var origSuccess=options.success;return{success:_.bind(function(){if(_.isFunction(origSuccess)){origSuccess.apply(this,arguments);}
if(!_.isEmpty(this.model.get('quote_id'))){app.alert.show('save_rli_quote_notice',{level:'info',messages:app.lang.get('SAVE_RLI_QUOTE_NOTICE','RevenueLineItems'),autoClose:true});}},this)};}})},"rowaction":{"controller":({extendsFrom:"RowactionField",initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('DisableDelete');app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.context.on("record:deleted",function(){this.deleteCommitWarning();},this);},deleteCommitWarning:function(){var message=null
if(this.model.get("commit_stage")=="include"){message=app.lang.get("WARNING_DELETED_RECORD_RECOMMIT","RevenueLineItems");app.alert.show("included_delete_warning",{level:"warning",messages:message,onLinkClick:function(){app.alert.dismissAll();}});}
return message;}})}}},"views":{"base":{"record":{"controller":({extendsFrom:'RecordView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this._parsePanelFields(this.meta.panels);},cancelClicked:function(){var changedAttributes=this.model.changedAttributes(this.model.getSyncedAttributes());this.model.set(changedAttributes);app.view.invokeParent(this,{type:'view',name:'record',method:'cancelClicked'});},getCustomSaveOptions:function(options){var origSuccess=options.success;return{success:_.bind(function(){if(_.isFunction(origSuccess)){origSuccess();}
if(!_.isEmpty(this.model.get('quote_id'))){app.alert.show('save_rli_quote_notice',{level:'info',messages:app.lang.get('SAVE_RLI_QUOTE_NOTICE','RevenueLineItems'),autoClose:true});}},this)};},initButtons:function(){app.view.invokeParent(this,{type:'view',name:'record',method:'initButtons'});if(this.model.has('quote_id')&&!_.isEmpty(this.model.get('quote_id'))&&!_.isUndefined(this.buttons['convert_to_quote_button'])){this.buttons['convert_to_quote_button'].setDisabled(true);}},bindDataChange:function(){this.model.on('duplicate:before',this._handleDuplicateBefore,this);app.view.invokeParent(this,{type:'view',name:'record',method:'bindDataChange'});},_handleDuplicateBefore:function(new_model){new_model.unset('quote_id');new_model.unset('quote_name');},delegateButtonEvents:function(){this.context.on('button:convert_to_quote:click',this.convertToQuote,this);app.view.invokeParent(this,{type:'view',name:'record',method:'delegateButtonEvents'});},convertToQuote:function(e){if(_.isEmpty(this.model.get('product_template_id'))&&!_.isEmpty(this.model.get('category_id'))){app.alert.show('invalid_items',{level:'error',autoClose:false,title:app.lang.get('LBL_ALERT_TITLE_ERROR',this.module)+':',messages:[app.lang.get('LBL_CONVERT_INVALID_RLI_PRODUCT',this.module)]});return;}
var alert=app.alert.show('info_quote',{level:'info',autoClose:false,closeable:false,title:app.lang.get("LBL_CONVERT_TO_QUOTE_INFO",this.module)+":",messages:[app.lang.get("LBL_CONVERT_TO_QUOTE_INFO_MESSAGE",this.module)]});alert.$el.find('a.close').remove();var url=app.api.buildURL(this.model.module,'quote',{id:this.model.id});var callbacks={'success':_.bind(function(resp){app.alert.dismiss('info_quote');app.router.navigate(app.bwc.buildRoute('Quotes',resp.id,'EditView',{return_module:this.model.module,return_id:this.model.id}),{trigger:true});},this),'error':_.bind(function(){app.alert.dismiss('info_quote');app.alert.show('error_xhr',{level:'error',autoClose:true,title:app.lang.get("LBL_CONVERT_TO_QUOTE_ERROR",this.module)+":",messages:[app.lang.get("LBL_CONVERT_TO_QUOTE_ERROR_MESSAGE",this.module)]});},this)};app.api.call("create",url,null,callbacks);},_parsePanelFields:function(panels){_.each(panels,function(panel){if(!app.metadata.getModule("Forecasts","config").is_setup){_.every(panel.fields,function(field,index){if(field.name=='commit_stage'){panel.fields[index]={'name':'spacer','span':6,'readonly':true};return false;}
return true;},this);}else{_.each(panel.fields,function(field){if(field.name=="commit_stage"){field.options=app.metadata.getModule("Forecasts","config").buckets_dom;}},this);}},this);}})},"create-actions":{"controller":({extendsFrom:'CreateView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'create',method:'initialize',args:[options]});this._parsePanelFields(this.meta.panels);},_parsePanelFields:function(panels){_.each(panels,function(panel){if(!app.metadata.getModule("Forecasts","config").is_setup){_.every(panel.fields,function(field,index){if(field.name=='commit_stage'){panel.fields[index]={'name':'spacer','span':6,'readonly':true};return false;}
return true;},this);}else{_.each(panel.fields,function(field){if(field.name=="commit_stage"){field.options=app.metadata.getModule("Forecasts","config").buckets_dom;}},this);}},this);}})},"recordlist":{"controller":({extendsFrom:'RecordlistView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'recordlist',method:'initialize',args:[options]});this.layout.on("list:record:deleted",function(deletedModel){this.deleteCommitWarning(deletedModel);},this);},parseFields:function(){var catalog=app.view.invokeParent(this,{type:'view',name:'recordlist',method:'parseFields'});_.each(catalog,function(group,i){catalog[i]=_.filter(group,function(fieldMeta){var leave=true;if(app.metadata.getModule("Forecasts","config").is_setup){if(fieldMeta.name.indexOf('_case')!=-1){var field='show_worksheet_'+fieldMeta.name.replace('_case','');leave=(app.metadata.getModule("Forecasts","config")[field]==1);}}else{leave=!(fieldMeta.name=="commit_stage");}
return leave;});});return catalog;},deleteCommitWarning:function(deletedModel){var message=null;if(deletedModel.get("commit_stage")=="include"){message=app.lang.get("WARNING_DELETED_RECORD_RECOMMIT","RevenueLineItems");app.alert.show("included_list_delete_warning",{level:"warning",messages:message,onLinkClick:function(){app.alert.dismissAll();}});}
return message;},})},"massupdate":{"controller":({extendsFrom:'MassupdateView',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('DisableMassdelete');app.view.invokeParent(this,{type:'view',name:'massupdate',method:'initialize',args:[options]});},delegateListFireEvents:function(){this.layout.on("list:massquote:fire",this.massQuote,this);this.layout.on("list:records:deleted",this.deleteCommitWarning,this);app.view.invokeParent(this,{type:'view',name:'massupdate',method:'delegateListFireEvents'});},deleteCommitWarning:function(lastSelectedModels){var message=null;if(!_.isUndefined(_.find(lastSelectedModels,function(model){if(model.get("commit_stage")=="include"){return true;}
return false;}))){message=app.lang.get("WARNING_DELETED_RECORD_LIST_RECOMMIT","RevenueLineItems");app.alert.show("included_list_delete_warning",{level:"warning",messages:message,onLinkClick:function(){app.alert.dismissAll();}});}
return message;},massQuote:function(){this.hideAll();var massQuote=this.context.get("mass_collection"),options={},callbacks={};var invalidItems=massQuote.filter(function(model){if(_.isEmpty(model.get('product_template_id'))&&!_.isEmpty(model.get('category_id'))){return true;}else if(!_.isEmpty(model.get('quote_id'))){return true;}
return false;},this);if(!_.isEmpty(invalidItems)){var messages=[app.lang.get("LBL_CONVERT_INVALID_RLI",this.module)],messageTpl=app.template.getView('massupdate.invalid_link',this.module);;_.each(invalidItems,function(item){messages.push(messageTpl(item.attributes));});app.alert.show('invalid_items',{level:'warning',autoClose:false,title:app.lang.get("LBL_ALERT_TITLE_WARNING",this.module)+":",messages:messages,onLinkClick:function(){app.alert.dismiss('invalid_items');}});return;}
if(massQuote){var alert=app.alert.show('info_quote',{level:'info',autoClose:false,closeable:false,title:app.lang.get("LBL_CONVERT_TO_QUOTE_INFO",this.module)+":",messages:[app.lang.get("LBL_CONVERT_TO_QUOTE_INFO_MESSAGE",this.module)]});alert.$el.find('a.close').remove();var url=app.api.buildURL(this.context.get('module'),'multi-quote');options.success=_.bind(function(model,data,options){app.alert.dismiss('info_quote');app.router.navigate(app.bwc.buildRoute('Quotes',data.id,'EditView',{return_module:this.context.parent.get('module'),return_id:this.context.parent.get('model').get('id')}),{trigger:true});},this);options.error=_.bind(function(){app.alert.dismiss('info_quote');app.alert.show('error_xhr',{level:'error',autoClose:true,title:app.lang.get("LBL_CONVERT_TO_QUOTE_ERROR",this.context.module)+":",messages:[app.lang.get("LBL_CONVERT_TO_QUOTE_ERROR_MESSAGE",this.context.module)]});},this);var data={'records':massQuote.pluck('id'),'opportunity_id':this.context.parent.get('model').get('id'),'account_id':this.context.parent.get('model').get('account_id')};callbacks=app.data.getSyncCallbacks('create',massQuote,options);app.api.call("create",url,data,callbacks);}}})},"filter-rows":{"controller":({extendsFrom:'FilterRowsView',getFilterableFields:function(moduleName){var fields=app.view.invokeParent(this,{type:'view',name:'filter-rows',method:'getFilterableFields',args:[moduleName]})
if(app.metadata.getModule("Forecasts","config").is_setup!=1){delete fields['commit_stage'];}else{_.each(fields,function(field,key,list){if(key.indexOf('_case')!=-1){var fld='show_worksheet_'+key.replace('_case','');if(app.metadata.getModule("Forecasts","config")[fld]!=1){delete list[key];}}});}
return fields;}})},"panel-top":{"controller":({extendsFrom:'PanelTopView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'panel-top',method:'initialize',args:[options]});if(this.parentModule=="Accounts"){this.meta.buttons=_.filter(this.meta.buttons,function(item){if(item.type!="actiondropdown"){return true;}
return false;});}},createRelatedClicked:function(event){app.alert.dismiss('opp-rli-create');app.view.invokeParent(this,{type:'view',name:'panel-top',method:'createRelatedClicked',args:[event]});}})}}},"layouts":{}},"WebLogicHooks":{"fieldTemplates":{},"views":{},"layouts":{}},"ProductCategories":{"fieldTemplates":{},"views":{},"layouts":{}},"ProductTypes":{"fieldTemplates":{},"views":{},"layouts":{}},"ProductTemplates":{"fieldTemplates":{},"views":{},"layouts":{}},"Reports":{"fieldTemplates":{},"views":{},"layouts":{}},"Reports_1":{"fieldTemplates":{},"views":{},"layouts":{}},"Forecasts":{"fieldTemplates":{"base":{"assignquota":{"controller":({extendsFrom:'RowactionField',disableButton:true,initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'initialize',args:[options]});this.type='rowaction';},bindDataChange:function(){this.context.on('forecasts:worksheet:quota_changed',function(){this.disableButton=false;if(!this.disposed){this.render();}},this);this.context.on('forecasts:worksheet:committed',function(){this.disableButton=true;if(!this.disposed){this.render();}},this);this.context.on('forecasts:assign_quota',this.assignQuota,this);},_render:function(){app.view.invokeParent(this,{type:'field',name:'rowaction',method:'_render'});this.setDisabled(this.disableButton);},hasAccess:function(){var su=(this.context.get('selectedUser'))||app.user.toJSON(),isManager=su.isManager||false,showOpps=su.showOpps||false;return(su.id===app.user.get('id')&&isManager&&showOpps===false);},assignQuota:function(worksheetType,selectedUser,selectedTimeperiod){app.api.call('create',app.api.buildURL('ForecastManagerWorksheets/assignQuota'),{'user_id':selectedUser.id,'timeperiod_id':selectedTimeperiod},{success:_.bind(function(o){app.alert.dismiss('saving_quota');app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get('LBL_QUOTA_ASSIGNED','Forecasts')]});this.disableButton=true;this.context.trigger('forecasts:quota_assigned');if(!this.disposed){this.render();}},this)});}})},"lastcommit":{"controller":({commit_date:undefined,data_points:[],points:[],events:{'click':'triggerHistoryLog'},initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.points=[];this.data_points=[];_.each(options.def.datapoints,function(point){if(app.utils.getColumnVisFromKeyMap(point,'forecastsWorksheet')){this.points.push(point);}},this);this.on('render',function(){if(!_.isUndefined(this.commit_date)){this.$el.find("span.relativetime").timeago({logger:SUGAR.App.logger,date:SUGAR.App.date,lang:SUGAR.App.lang,template:SUGAR.App.template});}},this);},triggerHistoryLog:function(){this.$el.find('i').toggleClass('icon-caret-down icon-caret-up');this.context.trigger('forecast:commit_log:trigger');},bindDataChange:function(){this.collection.on('reset',function(){this.data_points=[];var model=_.first(this.collection.models)
if(!_.isUndefined(model)){this.commit_date=model.get('date_modified');this.data_points=this.processDataPoints(model);}else{this.commit_date=undefined;}
if(!this.disposed)this.render();},this);},processDataPoints:function(model){var points=[],noAccessTemplate=app.template.getField('base','noaccess')(this);_.each(this.points,function(point){var point_data={};if(app.acl.hasAccess('read','ForecastWorksheets',app.user.get('id'),point)){point_data.value=model.get(point)}else{point_data.error=noAccessTemplate;}
points.push(point_data);},this);return points;}})},"quotapoint":{"controller":({quotaAmount:undefined,selectedUser:undefined,selectedTimePeriod:undefined,userCurrencyID:undefined,resizeDetectTimer:undefined,initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.quotaAmount=0.00;this.selectedUser=this.context.get('selectedUser');this.selectedTimePeriod=this.context.get('selectedTimePeriod');this.userCurrencyID=app.user.getPreference('currency_id');$(window).on('resize.datapoints',_.bind(this.resize,this));this.on('render',function(){this.resize();return true;},this);},bindDataChange:function(){this.context.on('change:selectedUser',function(ctx,user){this.selectedUser=user;this.loadData({});},this);this.context.on('change:selectedTimePeriod',function(ctx,timePeriod){this.selectedTimePeriod=timePeriod;this.loadData({});},this);this.loadData();},toggleTotalsListeners:function(isTopLevelManager){if(isTopLevelManager){this.hasListenerAdded=true;this.context.on('forecasts:worksheet:totals',function(totals){var quota=0.00;if(_.has(totals,'quota')){quota=app.currency.formatAmountLocale(totals.quota,this.userCurrencyID);}else{quota=this.quotaAmount;}
this.quotaAmount=quota;if(!this.disposed){this.render();}},this);if(!this.selectedUser.showOpps){var collection=app.utils.getSubpanelCollection(this.context,'ForecastManagerWorksheets'),quota=0.00;_.each(collection.models,function(model){quota=app.math.add(quota,model.get('quota'));},this);this.quotaAmount=app.currency.formatAmountLocale(quota,this.userCurrencyID);this.render();}}else if(this.hasListenerAdded){this.hasListenerAdded=false;this.context.off('forecasts:worksheet:totals',null,this);}},getQuotasURL:function(){var method=(this.selectedUser.isManager&&this.selectedUser.showOpps)?'direct':'rollup',url='Forecasts/'+this.selectedTimePeriod+'/quotas/'+method+'/'+this.selectedUser.id;return app.api.buildURL(url,'read');},loadData:function(options){var url=this.getQuotasURL(),cb={context:this,success:this.handleQuotaData,complete:options?options.complete:null};app.api.call('read',url,null,null,cb);},handleQuotaData:function(quotaData){this.quotaAmount=quotaData.formatted_amount;this.toggleTotalsListeners(quotaData.isTopLevelManager);if(!this.disposed){this.render();}},adjustDatapointLayout:function(){if(this.view.$el){var thisView$El=this.view.$el,parentMarginLeft=thisView$El.find(".topline .datapoints").css("margin-left"),parentMarginRight=thisView$El.find(".topline .datapoints").css("margin-right"),timePeriodWidth=thisView$El.find(".topline .span4").outerWidth(true),toplineWidth=thisView$El.find(".topline ").width(),collection=thisView$El.find(".topline div.pull-right").children("span"),collectionWidth=parseInt(parentMarginLeft)+parseInt(parentMarginRight);collection.each(function(index){collectionWidth+=$(this).children("div.datapoint").outerWidth(true);});if((collectionWidth+timePeriodWidth)>toplineWidth){thisView$El.find(".topline div.hr").show();thisView$El.find(".info .last-commit").find("div.hr").show();thisView$El.find(".topline .datapoints").removeClass("span8").addClass("span12");thisView$El.find(".info .last-commit .datapoints").removeClass("span8").addClass("span12");thisView$El.find(".info .last-commit .commit-date").removeClass("span4").addClass("span12");}else{thisView$El.find(".topline div.hr").hide();thisView$El.find(".info .last-commit").find("div.hr").hide();thisView$El.find(".topline .datapoints").removeClass("span12").addClass("span8");thisView$El.find(".info .last-commit .datapoints").removeClass("span12").addClass("span8");thisView$El.find(".info .last-commit .commit-date").removeClass("span12").addClass("span4");var lastCommitHeight=thisView$El.find(".info .last-commit .commit-date").height();thisView$El.find(".info .last-commit .datapoints div.datapoint").height(lastCommitHeight);}
var index=this.$el.index()+1,width=this.$el.find("div.datapoint").outerWidth(),datapointLength=thisView$El.find(".info .last-commit .datapoints div.datapoint").length,sel=thisView$El.find('.last-commit .datapoints div.datapoint:nth-child('+index+')');if(datapointLength>2&&index<=2||datapointLength==2&&index==1){$(sel).width(width-18);}else{$(sel).width(width);}}},resize:function(){if(this.resizeDetectTimer){clearTimeout(this.resizeDetectTimer);}
this.resizeDetectTimer=setTimeout(_.bind(function(){this.adjustDatapointLayout();},this),250);}})},"commitlog":{"controller":({commitLog:[],previousDateEntered:'',initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.on('show',function(){if(!this.disposed){this.render();}},this);},bindDataChange:function(){this.collection.on('reset',function(){this.hide();this.buildCommitLog();},this);this.context.on('forecast:commit_log:trigger',function(){if(!this.isVisible()){this.show();}else{this.hide();}},this);},buildCommitLog:function(){this.commitLog=[];if(_.isEmpty(this.collection.models)){return;}
var previousModel=_.first(this.collection.models);var dateEntered=new Date(Date.parse(previousModel.get('date_modified')));if(dateEntered=='Invalid Date'){dateEntered=previousModel.get('date_modified');}
this.previousDateEntered=app.date.format(dateEntered,app.user.getPreference('datepref')+' '+app.user.getPreference('timepref'));var loopPreviousModel='';var models=_.clone(this.collection.models).reverse();_.each(models,function(model){this.commitLog.push(app.utils.createHistoryLog(loopPreviousModel,model));loopPreviousModel=model;},this);this.commitLog.reverse();}})},"reportingUsers":{"controller":({jsTree:{},reporteesEndpoint:'',currentTreeUrl:'',currentRootId:'',selectedUser:{},initHasSelected:false,initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.reporteesEndpoint=app.api.buildURL("Forecasts/reportees")+'/';this.selectedUser=this.context.get('selectedUser')||app.user.toJSON();this.currentTreeUrl=this.reporteesEndpoint+this.selectedUser.id;this.currentRootId=this.selectedUser.id;},_dispose:function(){if(app.user.get('isManager')&&!_.isEmpty(this.jsTree)){this.jsTree.off();}
app.view.Field.prototype._dispose.call(this);},render:function(){if(app.user.get('isManager')){app.view.Field.prototype.render.call(this);}},unbindData:function(){app.view.Field.prototype.unbindData.call(this);},checkRender:function(context,selectedUser){this.selectedUser=selectedUser;if(selectedUser.showOpps){var nodeId=(selectedUser.isManager?'jstree_node_myopps_':'jstree_node_')+selectedUser.user_name;this.selectJSTreeNode(nodeId)}else if(this.currentRootId!=selectedUser.id){if(selectedUser.isManager){this.currentRootId=selectedUser.id;this.currentTreeUrl=this.reporteesEndpoint+selectedUser.id;this.rendered=false;if(!this.disposed){this.render();}}else{var nodeId='jstree_node_'+selectedUser.user_name;if(this.jsTree.jstree('get_selected').attr('id')!=nodeId){this.selectJSTreeNode(nodeId)}}}},selectJSTreeNode:function(nodeId){this.jsTree.jstree('deselect_all');this.jsTree.jstree('select_node','#'+nodeId);},_recursiveReplaceHTMLChars:function(data,ctx){_.each(data,function(entry,index){if(entry.data){data[index].data=(function(value){return value.replace(/&amp;/gi,'&').replace(/&lt;/gi,'<').replace(/&gt;/gi,'>').replace(/&#039;/gi,'\'').replace(/&quot;/gi,'"');})(entry.data);if(entry.children){_.each(entry.children,function(childEntry,index2){entry.children[index2]=ctx._recursiveReplaceHTMLChars([childEntry]);if(childEntry.attr.rel=="my_opportunities"){childEntry.data=app.utils.formatString(app.lang.get('LBL_MY_OPPS_RLI','Forecasts'),[childEntry.data]);}},this);}}},this);return data;},_render:function(ctx,options){app.view.Field.prototype._render.call(this,ctx,options);var options={};options.success=_.bind(function(data){this.createTree(data);},this);app.api.call('read',this.currentTreeUrl,null,options);},createTree:function(data){if(!_.isArray(data)){data=[data];}
var treeData=this._recursiveReplaceHTMLChars(data,this),selectedUser=this.context.get('selectedUser'),nodeId=(selectedUser.isManager&&selectedUser.showOpps?'jstree_node_myopps_':'jstree_node_')+selectedUser.user_name;treeData.ctx=this.context;this.jsTree=$(".jstree-sugar").jstree({"plugins":["json_data","ui","crrm","types","themes"],"json_data":{"data":treeData},"ui":{"initially_select":[nodeId]},"types":{"types":{"types":{"parent_link":{},"manager":{},"my_opportunities":{},"rep":{},"root":{}}}}}).on("reselect.jstree",_.bind(function(){this.initHasSelected=true;},this)).on("select_node.jstree",_.bind(function(event,data){if(this.initHasSelected){var jsData=data.inst.get_json(),nodeType=jsData[0].attr.rel,userData=jsData[0].metadata,showOpps=false;if(nodeType=="my_opportunities"||nodeType=="rep"){showOpps=true}
var selectedUser={'id':userData.id,'user_name':userData.user_name,'full_name':userData.full_name,'first_name':userData.first_name,'last_name':userData.last_name,'isManager':(nodeType!='rep'),'showOpps':showOpps,'reportees':[]};app.utils.getSelectedUsersReportees(selectedUser,treeData.ctx);}},this));if(treeData){var rootId=-1;if(treeData.length==1){rootId=treeData[0].metadata.id;}else if(treeData.length==2){rootId=treeData[1].metadata.id;}
this.currentRootId=rootId;}
this.$el.find('#people').addClass("jstree-sugar");}})},"button":{"controller":({extendsFrom:'ButtonField',hasAccess:function(){if(this.def.acl_action=='current_user'){var su=(this.context.get('selectedUser'))||app.user.toJSON();return(su.id===app.user.get('id'))}else{return app.view.invokeParent(this,{type:'field',name:'button',method:'hasAccess'});}}})},"datapoint":{"controller":({previous_type:'',arrow:'',initial_total:'',total:0,last_commit:undefined,hasAccess:true,hasDataAccess:true,noDataAccessTemplate:undefined,total_field:'',initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.total_field=this.total_field||this.name;this.hasAccess=app.utils.getColumnVisFromKeyMap(this.name,'forecastsWorksheet');this.hasDataAccess=app.acl.hasAccess('read','ForecastWorksheets',app.user.get('id'),this.name);if(this.hasDataAccess===false){this.noDataAccessTemplate=app.template.getField('base','noaccess')(this);}
this.before('render',function(){if(!this.hasAccess){return false;}
this.arrow=app.utils.getArrowIconColorClass(this.total,this.initial_total);return true;},this);$(window).on('resize.datapoints',_.bind(this.resize,this));this.on('render',function(){if(!this.hasAccess){return false;}
this.resize();return true;},this);},_dispose:function(){$(window).off('resize.datapoints');app.view.Field.prototype._dispose.call(this);},getPlaceholder:function(){if(this.hasAccess){return app.view.Field.prototype.getPlaceholder.call(this);}
return'';},adjustDatapointLayout:function(){if(this.hasAccess){var parentMarginLeft=this.view.$el.find(".topline .datapoints").css("margin-left");var parentMarginRight=this.view.$el.find(".topline .datapoints").css("margin-right");var timePeriodWidth=this.view.$el.find(".topline .span4").outerWidth(true);var toplineWidth=this.view.$el.find(".topline ").width();var collection=this.view.$el.find(".topline div.pull-right").children("span");var collectionWidth=parseInt(parentMarginLeft)+parseInt(parentMarginRight);collection.each(function(index){collectionWidth+=$(this).children("div.datapoint").outerWidth(true);});if((collectionWidth+timePeriodWidth)>toplineWidth){this.view.$el.find(".topline div.hr").show();this.view.$el.find(".info .last-commit").find("div.hr").show();this.view.$el.find(".topline .datapoints").removeClass("span8").addClass("span12");this.view.$el.find(".info .last-commit .datapoints").removeClass("span8").addClass("span12");this.view.$el.find(".info .last-commit .commit-date").removeClass("span4").addClass("span12");}else{this.view.$el.find(".topline div.hr").hide();this.view.$el.find(".info .last-commit").find("div.hr").hide();this.view.$el.find(".topline .datapoints").removeClass("span12").addClass("span8");this.view.$el.find(".info .last-commit .datapoints").removeClass("span12").addClass("span8");this.view.$el.find(".info .last-commit .commit-date").removeClass("span12").addClass("span4");var lastCommitHeight=this.view.$el.find(".info .last-commit .commit-date").height();this.view.$el.find(".info .last-commit .datapoints div.datapoint").height(lastCommitHeight);}
var index=this.$el.index();var width=this.$el.find("div.datapoint").outerWidth();var datapointLength=this.view.$el.find(".info .last-commit .datapoints div.datapoint").length;var sel=this.view.$el.find('.last-commit .datapoints div.datapoint:nth-child('+index+')');if(datapointLength>2&&index<=2||datapointLength==2&&index==1){$(sel).width(width-8);}else{$(sel).width(width);}}},resize:function(){var self=this;if(self.resizeDetectTimer){clearTimeout(this.resizeDetectTimer);}
self.resizeDetectTimer=setTimeout(function(){self.adjustDatapointLayout();},250);},bindDataChange:function(){if(!this.hasAccess){return;}
this.context.on('change:selectedUser change:selectedTimePeriod',function(){this.last_commit=undefined;this.initial_total=0;this.total=0;this.arrow='';},this);this.collection.on('reset',function(){var model=_.first(this.collection.models)
if(!_.isUndefined(model)){this.last_commit=app.math.round(model.get(this.total_field),2);this.initial_total=app.math.round(model.get(this.total_field),2);}else{this.last_commit=undefined;this.initial_total=0;this.total=0;this.arrow='';}
if(!this.disposed)this.render();},this);this.context.on('forecasts:worksheet:totals',function(totals,type){var field=this.total_field;if(type=="manager"){field=field.split('_')[0]+'_adjusted'}
this.total=totals[field];this.previous_type=type;if(!this.disposed)this.render();},this);}})}}},"views":{"base":{"forecastsHowto":{"controller":({howtoData:{},bindDataChange:function(){this.context.on('change:howtoData',function(ctx,howtoData){this.howtoData=howtoData;this._render();},this);},_render:function(){this.$el.html(this.template(this.howtoData))}})},"preview":{"controller":({extendsFrom:'PreviewView',originalModel:undefined,closePreview:function(){this.originalModel=undefined;app.view.invokeParent(this,{type:'view',name:'preview',method:'closePreview'});},_renderPreview:function(model,collection,fetch,previewId,dontClose){var self=this;dontClose=dontClose||false;if(app.drawer&&!app.drawer.isActive(this.$el)){return;}
if(!dontClose&&this.originalModel&&model&&(this.originalModel.get("id")==model.get("id")&&previewId==this.previewId)){app.events.trigger("list:preview:decorate",false);app.events.trigger('preview:close');return;}
if(model){this.meta=app.metadata.getView(model.get('parent_type')||model.get('_module'),'record')||{};this.meta=this._previewifyMetadata(this.meta);}
if(fetch){var mdl=app.data.createBean(model.get('parent_type'),{'id':model.get('parent_id')});this.originalModel=model;mdl.fetch({showAlerts:true,success:function(model){self.renderPreview(model,collection);}});}else{this.renderPreview(model,collection);}
this.previewId=previewId;},showPreviousNextBtnGroup:function(){if(!this.model||!this.layout||!this.collection){return;}
var collection=this.collection;if(!collection.size()){this.layout.hideNextPrevious=true;}
var model=this.originalModel||this.model;var recordIndex=collection.indexOf(collection.get(model.id));this.layout.previous=collection.models[recordIndex-1]?collection.models[recordIndex-1]:undefined;this.layout.next=collection.models[recordIndex+1]?collection.models[recordIndex+1]:undefined;this.layout.hideNextPrevious=_.isUndefined(this.layout.previous)&&_.isUndefined(this.layout.next);this.layout.trigger("preview:pagination:update");},renderPreview:function(model,newCollection){if(newCollection){this.collection.reset(newCollection.models);}
if(model){this.model=app.data.createBean(model.module,model.toJSON());this.render();if(this.previewModule&&this.previewModule==="Activities"){this.layout.hideNextPrevious=true;this.layout.trigger("preview:pagination:update");}
app.events.trigger("preview:open",this);app.events.trigger("list:preview:decorate",this.originalModel,this);if(!this.$el.is(":visible")){this.context.trigger("openSidebar",this);}}},switchPreview:function(data,index,id,module){var self=this,currModule=module||this.model.module,currID=id||this.model.get("postId")||this.model.get("id"),currIndex=index||_.indexOf(this.collection.models,this.collection.get(this.originalModel.get('id')));if(this.switching||this.collection.models.length<2){return;}
this.switching=true;if(data.direction==="left"&&(currID===_.first(this.collection.models).get("parent_id"))||data.direction==="right"&&(currID===_.last(this.collection.models).get("parent_id"))){this.switching=false;return;}
else{data.direction==="left"?currIndex-=1:currIndex+=1;if(_.isUndefined(this.collection.models[currIndex].get("target_id"))&&this.collection.models[currIndex].get("activity_data")){currID=this.collection.models[currIndex].id;this.switching=false;this.switchPreview(data,currIndex,currID,currModule);}else{var targetModule=this.collection.models[currIndex].get("target_module")||currModule;this.model=app.data.createBean(targetModule);if(_.isUndefined(this.collection.models[currIndex].get("target_id"))){this.model.set("id",this.collection.models[currIndex].get("parent_id"));}else{this.model.set("postId",this.collection.models[currIndex].get("id"));this.model.set("id",this.collection.models[currIndex].get("target_id"));}
this.originalModel=this.collection.models[currIndex];this.model.fetch({showAlerts:true,success:function(model){model.set("_module",targetModule);self.model=null;app.events.trigger("preview:render",model,null,false);self.switching=false;}});}}}})},"forecastsConfigVariables":{"controller":({events:{'click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},_renderField:function(field){if(field.def.multi){field=this._setUpMultiselectField(field);}
app.view.View.prototype._renderField.call(this,field);field.$el.find('.chzn-container').css("width","100%");field.$el.find('.chzn-drop').css("width","100%");},_setUpMultiselectField:function(field){field.def.value=this.model.get(field.name);field.events=_.extend({"change select":"_updateSelections"},field.events);field.bindDomChange=function(){};field._updateSelections=function(event,input){var fieldValue=this.model.get(this.name);var id;if(_.has(input,"selected")){id=input.selected;if(!_.contains(fieldValue,id)){fieldValue=_.union(fieldValue,id);}}else if(_.has(input,"deselected")){id=input.deselected;if(_.contains(fieldValue,id)){fieldValue=_.without(fieldValue,id);}}
this.def.value=fieldValue;this.model.set(this.name,fieldValue);};return field;}})},"forecastsConfigWorksheetColumns":{"controller":({titleSelectedValues:'',titleViewNameTitle:'',toggleTitleTpl:{},wkstColumnsSelect2:{},selectedOptions:[],allOptions:[],likelyFieldObj:{},bestFieldObj:{},worstFieldObj:{},events:{'click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_WORKSHEET_COLUMNS','Forecasts');this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');this.allOptions=[];this.selectedOptions=[];var config=app.metadata.getModule('Forecasts','config'),cfgFields=config.worksheet_columns,index=0;_.each(options.meta.panels[0].fields,function(field){var labelModule=(!_.isUndefined(field.label_module))?field.label_module:'Forecasts',obj={id:field.name,text:app.lang.get(field.label,labelModule),index:index,locked:field.locked||false},cField=_.find(cfgFields,function(cfgField){return cfgField==field.name;},this),addFieldToFullList=true;if(field.name=='best_case'){this.bestFieldObj=obj;addFieldToFullList=(config.show_worksheet_best===1)}else if(field.name=='likely_case'){this.likelyFieldObj=obj;addFieldToFullList=(config.show_worksheet_likely===1)}else if(field.name=='worst_case'){this.worstFieldObj=obj;addFieldToFullList=(config.show_worksheet_worst===1)}
if(addFieldToFullList){this.allOptions.push(obj);}
if(!_.isUndefined(cField)){this.selectedOptions.push(obj);}
index++;},this);},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change:columns',function(model){var arr=[],cfgFields=this.model.get('worksheet_columns'),metaFields=this.meta.panels[0].fields;_.each(metaFields,function(metaField){_.each(cfgFields,function(field){if(metaField.name==field){var labelModule=metaField.label_module||'Forecasts';arr.push(app.lang.get(metaField.label,labelModule));}},this);},this);this.titleSelectedValues=arr.join(', ');this.titleSelectedValues=this.titleSelectedValues.slice(0,50)+"...";this.updateTitle();},this);this.model.trigger('change:columns',this.model);this.model.on('change:scenarios',function(model){if(this.model.get('show_worksheet_best')){this.addOption(this.bestFieldObj);}else{this.removeOption(this.bestFieldObj);}
if(this.model.get('show_worksheet_likely')){this.addOption(this.likelyFieldObj);}else{this.removeOption(this.likelyFieldObj);}
if(this.model.get('show_worksheet_worst')){this.addOption(this.worstFieldObj);}else{this.removeOption(this.worstFieldObj);}
this._render();var arr=[];_.each(this.selectedOptions,function(field){arr.push(field.id);},this);this.setModelValue(arr);},this);}},addOption:function(fieldObj){if(!_.contains(this.allOptions,fieldObj)){this.allOptions.splice(fieldObj.index,0,fieldObj);this.selectedOptions.splice(fieldObj.index,0,fieldObj);}},removeOption:function(fieldObj){this.allOptions=_.without(this.allOptions,fieldObj);this.selectedOptions=_.without(this.selectedOptions,fieldObj);},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigWorksheetColumns'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_render:function(){app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this.updateTitle();this.wkstColumnsSelect2=this.$el.find('#wkstColumnsSelect').select2({data:this.allOptions,multiple:true,containerCssClass:"select2-choices-pills-close",initSelection:_.bind(function(element,callback){callback(this.selectedOptions);},this)});this.wkstColumnsSelect2.select2('val',this.selectedOptions);this.wkstColumnsSelect2.on('change',_.bind(this.handleColumnModelChange,this));},handleColumnModelChange:function(evt){if(!_.isUndefined(evt.added)){this.selectedOptions.push(evt.added);}
if(!_.isUndefined(evt.removed)){this.selectedOptions=_.without(this.selectedOptions,evt.removed);}
this.setModelValue(evt.val);},setModelValue:function(value){this.model.set('worksheet_columns',value);this.model.trigger('change:columns',this.model);},_dispose:function(){this.wkstColumnsSelect2.off();this.wkstColumnsSelect2.select2('destroy');this.wkstColumnsSelect2=null;app.view.Component.prototype._dispose.call(this);}})},"list-headerpane":{"controller":({extendsFrom:'HeaderpaneView',initialize:function(options){app.view.invokeParent(this,{type:'view',name:'headerpane',method:'initialize',args:[options]});this.on('render',function(){this.getField('save_draft_button').setDisabled();this.getField('save_draft_button').$el.addClass('btn-group');this.getField('commit_button').setDisabled();},this);},bindDataChange:function(){this.context.on('change:selectedUser',function(model,changed){this.title=changed.full_name;if(!this.disposed)this.render();},this);this.context.on('button:print_button:click',function(){window.print();},this);this.context.on('forecasts:worksheet:is_dirty',function(worksheet_type,is_dirty){this.getField('save_draft_button').setDisabled(!is_dirty);this.getField('commit_button').setDisabled(!is_dirty);},this);this.context.on('button:commit_button:click button:save_draft_button:click',function(){this.getField('save_draft_button').setDisabled(true);this.getField('commit_button').setDisabled(true);},this);this.context.on('forecasts:worksheet:saved',function(totalSaved,worksheet_type,wasDraft){if(wasDraft===true){this.getField('commit_button').setDisabled(false);}},this);this.context.on('forecasts:worksheet:needs_commit',function(worksheet_type){this.getField('commit_button').setDisabled(false);},this);app.view.invokeParent(this,{type:'view',name:'headerpane',method:'bindDataChange'});},_renderHtml:function(){var user=this.context.get('selectedUser')||app.user.toJSON();this.title=this.title||user.full_name;app.view.invokeParent(this,{type:'view',name:'headerpane',method:'_renderHtml'});}})},"forecastsConfigHeaderButtons":{"controller":({events:{'click a[name="cancel_button"]':'onButtonClicked','click a[name="save_button"]':'onButtonClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);var model=this.context.get('model');model.url=app.api.buildURL("Forecasts","config");model.sync=function(method,model,options){this.trigger("data:sync:start",method,model,options);var url=_.isFunction(model.url)?model.url():model.url;return app.api.call(method,url,model,options);};model.fetch=function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger('error',model,resp,options);};return this.sync('read',this,options);};model.save=function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
if(attrs&&(!options||!options.wait)&&!this.set(attrs,options))return false;options=_.extend({validate:true},options);if(!this._validate(attrs,options))return false;if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs);}
if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false;}
if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};method=this.isNew()?'create':(options.patch?'patch':'update');if(method==='patch')options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr;}
this.context.set({model:model});},onButtonClicked:function(evt){var btnName=$(evt.target).attr('name').slice(0,-7);switch(btnName){case'cancel':this.cancelConfig();break;case'save':this.saveConfig();break;}},saveConfig:function(){var firstTime=false;this.context.get('model').set({is_setup:true,show_forecasts_commit_warnings:true});if(this.context.get('model').get('first_time')!=undefined){this.context.get('model').unset('first_time');firstTime=true;}
var mdl=this.context.get('model');if(mdl.get('forecast_ranges')=="show_custom_buckets"){var ranges=mdl.get('show_custom_buckets_ranges'),commitStages=[];mdl.unset('commit_stages_included');_.each(ranges,function(range,key){if(range.in_included_total){commitStages.push(key)}
delete range.in_included_total;},this);mdl.set({commit_stages_included:commitStages,show_custom_buckets_ranges:ranges});}
this.context.get('model').save({},{success:_.bind(function(model){if(app.drawer&&!firstTime){this.showSavedConfirmation();app.drawer.close(this.context,this.context.get('model'));}else{app.drawer.close(this.context,this.context.get('model'));if(app.controller.context.get("module")=="Forecasts"){this.showSavedConfirmation(function(){window.location='#Forecasts';window.location.reload();});}else{this.showSavedConfirmation();}}},this)});},showSavedConfirmation:function(onClose){onClose=onClose||function(){};var alert=app.alert.show('forecasts_config_success',{level:'success',title:app.lang.get('LBL_FORECASTS_CONFIG_TITLE_FORECAST_SETTINGS','Forecasts')+':',messages:app.lang.get('LBL_FORECASTS_CONFIG_SETTINGS_SAVED','Forecasts'),autoClose:true,onAutoClose:_.bind(function(){alert.getCloseSelector().off();onClose();})});alert.getCloseSelector().on('click',onClose);},cancelConfig:function(){if(app.drawer){app.drawer.close(this.context,this.context.get('model'));}
if(this.context.get('model').get('is_setup')==0){if(app.controller.context.get('module')=='Forecasts'){app.router.goBack();}}}})},"forecasts-chart":{"controller":({plugins:['Dashlet'],values:new Backbone.Model(),className:'forecasts-chart-wrapper',initOptions:null,forecastManagerWorksheetContext:undefined,forecastWorksheetContext:undefined,initialize:function(options){this.values.clear({silent:true});this.once('init',this.findWorksheetContexts,this);this.once('render',function(){this.parseCollectionForData();},this);app.view.View.prototype.initialize.call(this,options);if(!this.meta.config){var ctx=this.context.parent,user=ctx.get('selectedUser')||app.user.toJSON();this.values.set({user_id:user.id,display_manager:user.is_manager,ranges:ctx.get('selectedRanges')||['include'],timeperiod_id:ctx.get('selectedTimePeriod'),dataset:'likely',group_by:'forecast',no_data:true});}},initDashlet:function(){var fieldOptions,cfg=app.metadata.getModule('Forecasts','config');fieldOptions=app.lang.getAppListStrings(this.dashletConfig.dataset.options);this.dashletConfig.dataset.options={};if(cfg.show_worksheet_worst&&app.acl.hasAccess('view','ForecastWorksheets',app.user.get('id'),'worst_case')){this.dashletConfig.dataset.options['worst']=fieldOptions['worst'];}
if(cfg.show_worksheet_likely){this.dashletConfig.dataset.options['likely']=fieldOptions['likely'];}
if(cfg.show_worksheet_best&&app.acl.hasAccess('view','ForecastWorksheets',app.user.get('id'),'best_case')){this.dashletConfig.dataset.options['best']=fieldOptions['best'];}},findWorksheetContexts:function(){_.filter(this.context.parent.children,function(item){if(item.get('module')=='ForecastWorksheets'){this.forecastWorksheetContext=item;return true;}else if(item.get('module')=='ForecastManagerWorksheets'){this.forecastManagerWorksheetContext=item;return true;}
return false;},this);var collection;if(this.forecastWorksheetContext){collection=this.forecastWorksheetContext.get('collection');if(collection){collection.on('change',this.repWorksheetChanged,this);collection.on('reset',function(collection){this.parseCollectionForData(collection);},this);}}
if(this.forecastManagerWorksheetContext){collection=this.forecastManagerWorksheetContext.get('collection');if(collection){collection.on('change',this.mgrWorksheetChanged,this);collection.on('reset',function(collection){this.parseCollectionForData(collection);},this);}}},parseCollectionForData:function(collection){var field=this.getField('paretoChart');if(field&&!field.hasServerData()){field.once('chart:pareto:rendered',this.parseCollectionForData,this);return;}
if(this.values.get('display_manager')){this.parseManagerWorksheet(collection||this.forecastManagerWorksheetContext.get('collection'));}else{this.parseRepWorksheet(collection||this.forecastWorksheetContext.get('collection'));}},parseRepWorksheet:function(collection){var field=this.getField('paretoChart');if(field){var serverData=field.getServerData();serverData.data=collection.map(function(item){var i={id:item.get('id'),forecast:item.get('commit_stage'),probability:item.get('probability'),sales_stage:item.get('sales_stage'),likely:app.currency.convertWithRate(item.get('likely_case'),item.get('base_rate')),date_closed_timestamp:parseInt(item.get('date_closed_timestamp'))};if(!_.isUndefined(this.dashletConfig.dataset.options['best'])){i.best=app.currency.convertWithRate(item.get('best_case'),item.get('base_rate'));}
if(!_.isUndefined(this.dashletConfig.dataset.options['worst'])){i.worst=app.currency.convertWithRate(item.get('worst_case'),item.get('base_rate'));}
return i;},this);field.setServerData(serverData,true);}},parseManagerWorksheet:function(collection){var field=this.getField('paretoChart');if(field){var serverData=field.getServerData();serverData.data=collection.map(function(item){var i={id:item.get('id'),user_id:item.get('user_id'),name:item.get('name'),likely:app.currency.convertWithRate(item.get('likely_case'),item.get('base_rate')),likely_adjusted:app.currency.convertWithRate(item.get('likely_case_adjusted'),item.get('base_rate')),quota:app.currency.convertWithRate(item.get('quota'),item.get('base_rate'))};if(!_.isUndefined(this.dashletConfig.dataset.options['best'])){i.best=app.currency.convertWithRate(item.get('likely_case'),item.get('base_rate'));i.best_adjusted=app.currency.convertWithRate(item.get('likely_case_adjusted'),item.get('base_rate'));}
if(!_.isUndefined(this.dashletConfig.dataset.options['worst'])){i.worst=app.currency.convertWithRate(item.get('likely_case'),item.get('base_rate'));i.worst_adjusted=app.currency.convertWithRate(item.get('likely_case_adjusted'),item.get('base_rate'));}
return i;},this);serverData.quota=_.reduce(serverData.data,function(memo,item){return memo+item.quota;},0);field.setServerData(serverData);}},repWorksheetChanged:function(model){var changed=model.changed,changedField=_.keys(changed),field=this.getField('paretoChart'),serverData=field.getServerData();if(changedField.length==1&&changedField[0]=='date_closed'){changedField.push('date_closed_timestamp');changed.date_closed_timestamp=Math.round(+app.date.parse(changed.date_closed).getTime()/1000);model.set('date_closed_timestamp',changed.date_closed_timestamp,{silent:true});}
if(_.contains(changedField,'likely_case')){changed.likely=app.currency.convertWithRate(changed.likely_case,model.get('base_rate'));delete changed.likely_case;}
if(_.contains(changedField,'best_case')){changed.best=app.currency.convertWithRate(changed.best_case,model.get('base_rate'));delete changed.best_case;}
if(_.contains(changedField,'worst_case')){changed.worst=app.currency.convertWithRate(changed.worst_case,model.get('base_rate'));delete changed.worst_case;}
if(_.contains(changedField,'commit_stage')){changed.forecast=changed.commit_stage;delete changed.commit_stage;}
_.find(serverData.data,function(record,i,list){if(model.get('id')==record.id){list[i]=_.extend({},record,changed);return true;}
return false;});field.setServerData(serverData,_.contains(changedField,'probability'));},mgrWorksheetChanged:function(model){var fieldsChanged=_.keys(model.changed),changed=model.changed,field=this.getField('paretoChart');if(field){var serverData=field.getServerData();if(_.contains(fieldsChanged,'quota')){var q=parseInt(serverData.quota,10);q=app.math.add(app.math.sub(q,model.previous('quota')),model.get('quota'));serverData.quota=q;}else{var f=_.first(fieldsChanged),fieldChartName=f.replace('_case','');_.find(serverData.data,function(record,i,list){if(model.get('user_id')==record.user_id){list[i][fieldChartName]=changed[f];return true;}
return false;});}
field.setServerData(serverData);}},loadData:function(options){var field=this.getField('paretoChart');if(!_.isUndefined(field)){field.once('chart:pareto:rendered',this.parseCollectionForData,this);field.renderChart(options);}},toggleRepOptionsVisibility:function(){this.$el.find('div.groupByOptions').toggleClass('hide',this.values.get('display_manager')===true);},bindDataChange:function(){var meta=this.meta||this.initOptions.meta;if(meta.config){return;}
this.on('render',function(){var f=this.getField('paretoChart'),dt=this.layout.getComponent('dashlet-toolbar');if(dt){f.before('chart:pareto:render',function(){this.$("[data-action=loading]").removeClass(this.cssIconDefault).addClass(this.cssIconRefresh)},{},dt);f.on('chart:pareto:rendered',function(){this.$("[data-action=loading]").removeClass(this.cssIconRefresh).addClass(this.cssIconDefault)},dt);}
this.toggleRepOptionsVisibility();this.parseCollectionForData();},this);var ctx=this.context.parent;ctx.on('change:selectedUser',function(context,user){this.values.set({user_id:user.id,display_manager:(user.showOpps===false&&user.isManager===true)});this.toggleRepOptionsVisibility();},this);ctx.on('change:selectedTimePeriod',function(context,timePeriod){this.values.set({timeperiod_id:timePeriod});},this);ctx.on('change:selectedRanges',function(context,value){this.values.set({ranges:value});},this);},unbindData:function(){var ctx=this.context.parent;if(ctx){ctx.off(null,null,this);}
if(this.forecastManagerWorksheetContext&&this.forecastManagerWorksheetContext.get('collection')){this.forecastManagerWorksheetContext.get('collection').off(null,null,this);}
if(this.forecastWorksheetContext&&this.forecastWorksheetContext.get('collection')){this.forecastWorksheetContext.get('collection').off(null,null,this);}
if(this.context)this.context.off(null,null,this);if(this.values)this.values.off(null,null,this);app.view.View.prototype.unbindData.call(this);}})},"forecast-pipeline":{"controller":({results:{},chart:{},plugins:['Dashlet','Tooltip'],forecastSetup:0,forecastAdmin:false,state:"open",preview_open:false,events:{'click button.btn':'handleTypeButtonClick'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.forecastSetup=app.metadata.getModule('Forecasts','config').is_setup;this.forecastAdmin=(_.isUndefined(app.user.getAcls()['Forecasts'].admin));},initDashlet:function(view){this.settings.set({'display_type':'self'},{silent:true});if(this.forecastSetup){app.api.call('GET',app.api.buildURL('TimePeriods/current'),null,{success:_.bind(function(o){this.settings.set({'selectedTimePeriod':o.id},{silent:true});this.layout.loadData();},this),complete:view.options?view.options.complete:null});}
this.chart=nv.models.funnelChart().showTitle(false).tooltips(false).colorData('class',{step:2}).fmtValueLabel(function(d){return d.label;});},handleTypeButtonClick:function(e){var $el=$(e.currentTarget),displayType=$el.data('type');if(this.settings.get('display_type')!==displayType){this.settings.set({'display_type':displayType});}},bindDataChange:function(){this.settings.on('change',function(model){if(this.state=='open'&&!this.preview_open){this.loadData({});}},this);app.events.on('preview:open',function(){this.preview_open=true;},this);app.events.on('preview:close',function(){this.preview_open=false;},this);app.events.on('app:toggle:sidebar',function(state){this.state=state;if(this.state=='open'&&!this.preview_open){this.chart.update();}},this);},render:function(){app.view.invokeParent(this,{type:'view',name:'view',method:'render'});if(this.chart&&!_.isEmpty(this.results)){this.renderChart();}},renderChart:function(){if(this.state!='open'||this.preview_open){return;}
if(this.disposed){return;}
if(!_.isEmpty(this.chart)){nv.utils.windowUnResize(this.chart.update);this.$("svg#"+this.cid).children().remove();}
if(this.results.data.length>0){this.$('.nv-chart').toggleClass('hide',false);this.$('.block-footer').toggleClass('hide',true);d3.select('svg#'+this.cid).datum(this.results).transition().duration(500).call(this.chart);nv.utils.windowResize(this.chart.update);this.resizeOnPrint(this.chart);}else{this.$('.nv-chart').toggleClass('hide',true);this.$('.block-footer').toggleClass('hide',false);}},loadData:function(options){var timePeriod=this.settings.get('selectedTimePeriod');if(!timePeriod){return;}
var url_base='Opportunities/chart/pipeline';if(this.settings.has('selectedTimePeriod')){url_base+='/'+timePeriod;if(this.settings.has('display_type')){url_base+='/'+this.settings.get('display_type');}
var url=app.api.buildURL(url_base);app.api.call('GET',url,null,{success:_.bind(function(o){this.results={};this.results=o;this.renderChart();},this),complete:options?options.complete:null});}},resizeOnPrint:function(chart){var resizeChart=function(){chart.delay(0);chart.update();chart.delay(300);};if(window.matchMedia){var mediaQueryList=window.matchMedia('print');mediaQueryList.addListener(function(mql){if(mql.matches){resizeChart();}});}else if(window.attachEvent){window.attachEvent("onbeforeprint",resizeChart);}else{window.onbeforeprint=resizeChart;}
window.onafterprint=resizeChart;}})},"forecastsConfigForecastBy":{"controller":({titleSelectedValues:'',titleViewNameTitle:'',optionsLang:{},toggleTitleTpl:{},events:{'click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_FORECAST_BY','Forecasts');this.optionsLang=app.lang.getAppListStrings('forecasts_config_worksheet_layout_forecast_by_options_dom');this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change:forecast_by',function(){this.titleSelectedValues=this.optionsLang[this.model.get('forecast_by')];this.updateTitle();},this);}},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigForecastBy'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_render:function(){app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this.updateTitle();}})},"forecastsConfigScenarios":{"controller":({titleSelectedValues:'',titleViewNameTitle:'',toggleTitleTpl:{},scenarioOptions:[],selectedOptions:[],defaultOption:{},defaultSelect2:{},optionsSelect2:{},defaultForecastedAmountKey:'show_worksheet_likely',events:{'click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_SCENARIOS','Forecasts');this.selectedOptions=[];this.defaultOption={};this.scenarioOptions=[];_.each(options.meta.panels[0].fields,function(field){var obj={id:field.name,text:app.lang.get(field.label,'Forecasts')}
if(field.name==this.defaultForecastedAmountKey){obj['locked']=true;this.defaultOption=obj;}else{this.scenarioOptions.push(obj);}
if(this.context.get('model').get(field.name)==1&&!obj.locked){this.selectedOptions.push(obj);}},this);this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change:scenarios',function(model){var arr=[];if(model.get('show_worksheet_likely')){arr.push(app.lang.get('LBL_FORECASTS_CONFIG_WORKSHEET_SCENARIOS_LIKELY','Forecasts'));}
if(model.get('show_worksheet_best')){arr.push(app.lang.get('LBL_FORECASTS_CONFIG_WORKSHEET_SCENARIOS_BEST','Forecasts'));}
if(model.get('show_worksheet_worst')){arr.push(app.lang.get('LBL_FORECASTS_CONFIG_WORKSHEET_SCENARIOS_WORST','Forecasts'));}
this.titleSelectedValues=arr.join(', ');this.updateTitle();},this);this.model.trigger('change:scenarios',this.model);}},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigScenarios'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_render:function(){app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this.updateTitle();this.defaultSelect2=this.$el.find('#scenariosLocked').select2({data:this.defaultOption,multiple:true,dropdownCss:{width:'auto'},dropdownCssClass:'search-related-dropdown',containerCss:"border: none",containerCssClass:'select2-choices-pills-close select2-container-disabled',escapeMarkup:function(m){return m;},initSelection:_.bind(function(element,callback){callback(this.defaultOption);},this)});this.$el.find('.select2-container-disabled').width('auto');this.$el.find('.select2-search-field').css('display','none');this.defaultSelect2.select2('val',this.defaultOption);this.defaultSelect2.select2('disable');this.optionsSelect2=this.$el.find('#scenariosSelect').select2({data:this.scenarioOptions,multiple:true,dropdownCss:{width:"auto"},width:"90%",containerCss:"border: none",containerCssClass:"select2-choices-pills-close",escapeMarkup:function(m){return m;},initSelection:_.bind(function(element,callback){callback(this.selectedOptions);},this)});this.optionsSelect2.select2('val',this.selectedOptions);this.optionsSelect2.on('change',_.bind(this.handleScenarioModelChange,this));},handleScenarioModelChange:function(evt){var changedEnabled=[],changedDisabled=[],allOptions=[];_.each($(evt.target).val().split(','),function(option){changedEnabled.push(option);this.model.set(option,true,{silent:true});},this);_.each(this.scenarioOptions,function(option){allOptions.push(option.id);},this);changedDisabled=_.difference(allOptions,changedEnabled);_.each(changedDisabled,function(option){this.model.set(option,false,{silent:true});},this);this.model.trigger('change:scenarios',this.model);},formatCustomSelection:function(item){return'<a class="select2-choice-filter" rel="'+item.id+'" href="javascript:void(0)">'+item.text+'</a>';},_dispose:function(){this.defaultSelect2.off();this.defaultSelect2.select2('destroy');this.defaultSelect2=null;this.optionsSelect2.off();this.optionsSelect2.select2('destroy');this.optionsSelect2=null;app.view.Component.prototype._dispose.call(this);}})},"forecastsConfigRanges":{"controller":({label:'',forecastRangesField:{},bucketsDomField:{},categoryRangesField:{},selection:'',fieldRanges:{},disableRanges:false,titleSelectedRange:'',titleSelectedValues:'',titleViewNameTitle:'',toggleTitleTpl:{},fieldsMeta:{},includedCommitStages:[],events:{'click #btnAddCustomRange a':'addCustomRange','click #btnAddCustomRangeWithoutProbability a':'addCustomRange','click .addCustomRange':'addCustomRange','click .removeCustomRange':'removeCustomRange','keyup input[type=text]':'updateCustomRangeLabel','change input[type=checkbox]':'updateCustomRangeIncludeInTotal','click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_RANGES','Forecasts');this.label=_.first(this.meta.panels).label;this.fieldsMeta=_.first(this.meta.panels).fields;this.forecastRangesField=this.fieldsMeta.forecast_ranges;this.bucketsDomField=this.fieldsMeta.buckets_dom;this.categoryRangesField=this.fieldsMeta.category_ranges;this.model.set($.extend(true,{},app.metadata.getModule('Forecasts','config')));this.updateTitleValues(this.model);this.forecastByModule=app.lang.getAppListStrings('moduleList')[this.model.get('forecast_by')];this.includedCommitStages=this.model.get('commit_stages_included'),this.forecastRangesField.value=this.model.get('forecast_ranges');this.bucketsDomField.value=this.model.get('buckets_dom');this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change',function(model){this.updateTitleValues(model);},this);}},updateTitleValues:function(model){if(_.isUndefined(model)){model=this.model;}
var forecastRanges=model.get('forecast_ranges'),rangeObjs=model.get(forecastRanges+'_ranges'),tmpObj={},str='';_.each(rangeObjs,function(vals){tmpObj[vals.min]=vals.max;});_.each(tmpObj,function(max,min){str+=min+"% - "+max+"%, ";});str=str.slice(0,str.length-2);this.titleSelectedValues=str;this.titleSelectedRange=app.lang.getAppListStrings('forecasts_config_ranges_options_dom')[forecastRanges];if(_.isFunction(this.toggleTitleTpl)){this.updateTitle();}},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,message:this.titleSelectedRange,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigRanges'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_render:function(){this.disableRanges=this.model.get('has_commits');this.selection=this.model.get('forecast_ranges');app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this._addForecastRangesSelectionHandler();this.updateTitle();return this;},_addForecastRangesSelectionHandler:function(){var elements=this.$el.find(':radio[name="'+this.forecastRangesField.name+'"]');_.each(elements,function(el){$(el).change({view:this},this.selectionHandler);if($(el).prop('checked')){$(el).triggerHandler("change");}},this);},selectionHandler:function(event){var view=event.data.view,oldValue,bucket_dom,hideElement,showElement;oldValue=view.selection;view.selection=this.value;bucket_dom=view.bucketsDomField.options[this.value];hideElement=view.$el.find('#'+oldValue+'_ranges');showElement=view.$el.find('#'+this.value+'_ranges');if(showElement.children().length==0){this.value=='show_custom_buckets'?view._customSelectionHandler(this,showElement):view._selectionHandler(this,showElement);view.connectSliders.call(view,this.value,view.fieldRanges);}
if(hideElement){hideElement.toggleClass('hide',true);}
if(showElement){showElement.toggleClass('hide',false);}
view.model.set(this.name,this.value);view.model.set(view.bucketsDomField.name,bucket_dom);},_selectionHandler:function(element,showElement){var bucket_dom=this.bucketsDomField.options[element.value];this.fieldRanges[element.value]={};showElement.append('<p>'+app.lang.get('LBL_FORECASTS_CONFIG_'+element.value.toUpperCase()+'_RANGES_DESCRIPTION','Forecasts',this)+'</p>');_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){if(key!='exclude'){var rangeField,model=new Backbone.Model(),fieldSettings;model.set(key,this.view.model.get(this.category+'_ranges')[key]);fieldSettings={view:this.view,def:this.view.fieldsMeta.category_ranges[key],viewName:'edit',context:this.view.context,module:this.view.module,model:model,meta:app.metadata.getField('range')};rangeField=app.view.createField(fieldSettings);this.showElement.append('<b>'+label+':</b>').append(rangeField.el);rangeField.render();this.view.fieldRanges[this.category][key]=rangeField;rangeField.sliderDoneDelegate=function(category,key,view){return function(value){this.view.updateRangeSettings(category,key,value);};}(this.category,key,this.view);}},{view:this,showElement:showElement,category:element.value});showElement.append($('<p>'+app.lang.get("LBL_FORECASTS_CONFIG_RANGES_EXCLUDE_INFO","Forecasts")+'</p>'));},_customSelectionHandler:function(element,showElement){var bucket_dom=this.bucketsDomField.options[element.value],bucket_dom_options=[],rangeField,_ranges;this.fieldRanges[element.value]={};showElement.append('<p>'+app.lang.get('LBL_FORECASTS_CONFIG_'+element.value.toUpperCase()+'_RANGES_DESCRIPTION','Forecasts',this)+'</p>');if(!this.model.has(element.value+'_ranges')){this.model.set(element.value+'_ranges',{});}
_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){if(_.isUndefined(this.view.model.get(this.category+'_ranges')[key])){_ranges=this.view.model.get(this.category+'_ranges');_ranges[key]={min:0,max:100,in_included_total:false};this.view.model.set(this.category+'_ranges',_ranges);}else{_ranges=this.view.model.get(this.category+'_ranges');_ranges[key].in_included_total=(_.contains(this.view.includedCommitStages,key));this.view.model.set(this.category+'_ranges',_ranges);}
bucket_dom_options.push([key,label]);},{view:this,category:element.value});this.model.set(element.value+'_options',bucket_dom_options);this.model.on('change:'+element.value+'_options',function(event){this.view.validateCustomRangeLabels(this.category);},{view:this,category:element.value});this._renderCustomRangesLayout(showElement,element.value);_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){rangeField=this.view._renderCustomRange(key,label,showElement,element.value);this.view.fieldRanges[element.value][key]=rangeField;},{view:this,showElement:showElement,category:element.value});if(this._getLastCustomRangeIndex(element.value,'custom')){this.$el.find('#btnAddCustomRange').hide();}
if(this._getLastCustomRangeIndex(element.value,'custom_without_probability')){this.$el.find('#btnAddCustomRangeWithoutProbability').hide();}},_renderCustomRangesLayout:function(showElement,category){var template='<p><b>{{str "LBL_FORECASTS_RANGES_BASED_TITLE" "Forecasts"}}</b></p>'+'<div id="plhCustomProbabilityRanges">'+'   <div id="plhCustomDefault"></div>'+'   <p><b>{{str "LBL_FORECASTS_CUSTOM_BASED_TITLE" "Forecasts"}}</b></p>'+'   <div id="plhCustom"></div>'+'   <div id="plhExclude">'+'       <div class="btn-group" id="btnAddCustomRange"><a class="btn" href="javascript:void(0)" data-type="custom" data-category="{{category}}"><i class="icon-plus"></i></a></div>'+'   </div>'+'</div>'+'<p><b>{{str "LBL_FORECASTS_CUSTOM_NO_BASED_TITLE" "Forecasts"}}</b></p>'+'<div id="plhCustomWithoutProbability">'+'   <div class="btn-group" id="btnAddCustomRangeWithoutProbability"><a class="btn" href="javascript:void(0)" data-type="custom_without_probability" data-category="{{category}}"><i class="icon-plus"></i></a></div>'+'</div>';showElement.append(Handlebars.compile(template)({category:category}));},_renderCustomRange:function(key,label,showElement,category){var customType=key,customIndex=0,isExclude=false,currentPlh=showElement,rangeField,model=new Backbone.Model(),fieldSettings,lastCustomRange;if(key.substring(0,26)=='custom_without_probability'){customType='custom_without_probability';customIndex=key.substring(27);currentPlh=this.$el.find('#plhCustomWithoutProbability');}else if(key.substring(0,6)=='custom'){customType='custom';customIndex=key.substring(7);currentPlh=this.$el.find('#plhCustom');}else if(key.substring(0,7)=='exclude'){customType='custom_default';currentPlh=this.$el.find('#plhExclude');isExclude=true;}else{customType='custom_default';currentPlh=this.$el.find('#plhCustomDefault');}
model.set(key,this.model.get(category+'_ranges')[key]);var fieldDef=this.fieldsMeta.category_ranges[key]||this.fieldsMeta.category_ranges[customType];fieldSettings={view:this,def:_.clone(fieldDef),viewName:'forecastsCustomRange',context:this.context,module:this.module,model:model,meta:app.metadata.getField('range')};fieldSettings.def.name=key;fieldSettings.def.view='forecastsCustomRange';fieldSettings.def.enabled=true;rangeField=app.view.createField(fieldSettings);currentPlh.append(rangeField.el);rangeField.label=label;rangeField.customType=customType;rangeField.customIndex=customIndex;rangeField.isExclude=isExclude;rangeField.in_included_total=(_.contains(this.includedCommitStages,key));rangeField.category=category;rangeField.render();rangeField.$el.find(rangeField.fieldTag).noUiSlider('enable');lastCustomRange=this._getLastCustomRange(category,rangeField.customType);if(!_.isUndefined(lastCustomRange)){lastCustomRange.$el.find('.addCustomRange').parent().hide();}
_.isEmpty(rangeField.label)?rangeField.$el.find('.control-group').addClass('error'):rangeField.$el.find('.control-group').removeClass('error');rangeField.sliderDoneDelegate=function(category,key,view){return function(value){this.view.updateRangeSettings(category,key,value);};}(category,key,this);return rangeField;},_getLastCustomRangeIndex:function(category,customType){var lastCustomRangeIndex=0;if(this.fieldRanges[category]){_.each(this.fieldRanges[category],function(range){if(range.customType==customType&&range.customIndex>lastCustomRangeIndex){lastCustomRangeIndex=range.customIndex;}},this);}
return lastCustomRangeIndex;},_getLastCustomRange:function(category,customType){if(this.fieldRanges[category]&&!_.isEmpty(this.fieldRanges[category])){var lastCustomRange=undefined;_.each(this.fieldRanges[category],function(range){if(range.customType==customType&&(_.isUndefined(lastCustomRange)||range.customIndex>lastCustomRange.customIndex)){lastCustomRange=range;}},this);if(_.isUndefined(lastCustomRange)){if(customType=='custom'){lastCustomRange=this.fieldRanges[category].upside||this.fieldRanges[category].include;}else{lastCustomRange=this.fieldRanges[category].exclude;}}}
return lastCustomRange;},addCustomRange:function(event){var view=this,category=$(event.currentTarget).data('category')||null,customType=$(event.currentTarget).data('type')||null,ranges=view.model.get(category+'_ranges'),bucket_dom_options=view.model.get(category+'_options'),showElement=(customType=='custom')?view.$el.find('#plhCustom'):view.$el.find('#plhCustomWithoutProbability'),label=app.lang.get('LBL_FORECASTS_CUSTOM_RANGES_DEFAULT_NAME','Forecasts'),key,rangeField,lastCustomRange,lastCustomRangeIndex,lastOptionIndex;if(_.isNull(category)||_.isNull(customType)||_.isUndefined(ranges)&&_.isUndefined(bucket_dom_options)){return false;}
lastCustomRange=view._getLastCustomRange(category,customType);lastCustomRangeIndex=view._getLastCustomRangeIndex(category,customType);lastCustomRangeIndex++;key=customType+'_'+lastCustomRangeIndex;if(customType!='custom'){ranges[key]={min:0,max:0,in_included_total:false};}else if(ranges.exclude.max-ranges.exclude.min>3){ranges[key]={min:parseInt(ranges.exclude.max,10)-1,max:parseInt(ranges.exclude.max,10),in_included_total:false};ranges.exclude.max=parseInt(ranges.exclude.max,10)-2;if(!_.isUndefined(view.fieldRanges[category].exclude.$el)){view.fieldRanges[category].exclude.$el.find(view.fieldRanges[category].exclude.fieldTag).noUiSlider('move',{handle:'upper',to:ranges.exclude.max});}}else if(ranges[lastCustomRange.name].max-ranges[lastCustomRange.name].min>3){ranges[key]={min:parseInt(ranges[lastCustomRange.name].min,10),max:parseInt(ranges[lastCustomRange.name].min,10)+1,in_included_total:false};ranges[lastCustomRange.name].min=parseInt(ranges[lastCustomRange.name].min,10)+2;if(!_.isUndefined(lastCustomRange.$el)){lastCustomRange.$el.find(lastCustomRange.fieldTag).noUiSlider('move',{handle:'lower',to:ranges[lastCustomRange.name].min});}}else{ranges[key]={min:parseInt(ranges[lastCustomRange.name].min,10)-2,max:parseInt(ranges[lastCustomRange.name].min,10)-1,in_included_total:false};}
view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);rangeField=view._renderCustomRange(key,label,showElement,category);if(!_.isUndefined(rangeField)&&!_.isNull(rangeField)){view.fieldRanges[category][key]=rangeField;}
_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){lastOptionIndex=key;}},{value:lastCustomRange.name});bucket_dom_options.splice(lastOptionIndex+1,0,[key,label]);view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);if(customType=='custom'){view.$el.find('#btnAddCustomRange').hide();view.connectSliders.call(view,category,view.fieldRanges);}else{view.$el.find('#btnAddCustomRangeWithoutProbability').hide();_.each(view.fieldRanges[category],function(item){if(item.customType==this.key&&item.customIndex<this.index&&!_.isUndefined(item.$el)){item.$el.find('.addCustomRange').parent().hide();}},this);}},removeCustomRange:function(event){var view=this,category=$(event.currentTarget).data('category')||null,fieldKey=$(event.currentTarget).data('key')||null,ranges=view.model.get(category+'_ranges'),bucket_dom_options=view.model.get(category+'_options'),range,previousCustomRange,lastCustomRangeIndex,lastCustomRange,optionIndex;if(_.isNull(category)||_.isNull(fieldKey)||_.isUndefined(view.fieldRanges[category])||_.isUndefined(view.fieldRanges[category][fieldKey])||_.isUndefined(ranges)||_.isUndefined(bucket_dom_options))
{return false;}
range=view.fieldRanges[category][fieldKey];if(_.indexOf(['include','upside','exclude'],range.name)!=-1){return false;}
if(range.customType=='custom'){_.each(this.fieldRanges[category],function(item){if(item.customType=='custom'&&item.customIndex<range.customIndex){previousCustomRange=item;}},this);if(_.isUndefined(previousCustomRange)){previousCustomRange=!_.isUndefined(view.fieldRanges[category].upside)?view.fieldRanges[category].upside:view.fieldRanges[category].include;}
ranges[previousCustomRange.name].min=+ranges[range.name].min;if(!_.isUndefined(previousCustomRange.$el)){previousCustomRange.$el.find(previousCustomRange.fieldTag).noUiSlider('move',{handle:'lower',to:ranges[previousCustomRange.name].min});}}
view.fieldRanges[category][range.name].remove();delete ranges[range.name];delete view.fieldRanges[category][range.name];_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){optionIndex=key;}},{value:range.name});bucket_dom_options.splice(optionIndex,1);view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);lastCustomRangeIndex=view._getLastCustomRangeIndex(category,range.customType);if(range.customType=='custom'){if(lastCustomRangeIndex==0){view.$el.find('#btnAddCustomRange').show();}
view.connectSliders.call(view,category,view.fieldRanges);}else{if(lastCustomRangeIndex==0){view.$el.find('#btnAddCustomRangeWithoutProbability').show();}}
lastCustomRange=view._getLastCustomRange(category,range.customType);if(!_.isUndefined(lastCustomRange.$el)){lastCustomRange.$el.find('.addCustomRange').parent().show();}},updateCustomRangeLabel:function(event){var view=this,category=$(event.target).data('category')||null,fieldKey=$(event.target).data('key')||null,bucket_dom_options=view.model.get(category+'_options'),optionIndex;if(!_.isNull(category)&&!_.isNull(fieldKey)&&!_.isUndefined(bucket_dom_options)){_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){optionIndex=key;}},{value:fieldKey});bucket_dom_options[optionIndex][1]=$(event.target).val();view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);}},validateCustomRangeLabels:function(category){_.each(this.model.get(category+'_options'),function(item,key){if(_.isEmpty(item[1])){this.view.fieldRanges[category][item[0]].$el.find('.control-group').addClass('error');this.view.layout.$el.find('[name=save_button]').addClass('disabled');}else{this.view.fieldRanges[category][item[0]].$el.find('.control-group').removeClass('error')}},{view:this});},updateCustomRangeIncludeInTotal:function(event){var view=this,category=$(event.target).data('category')||null,fieldKey=$(event.target).data('key')||null,ranges;if(!_.isNull(category)&&!_.isNull(fieldKey))
{ranges=view.model.get(category+'_ranges');if(!_.isUndefined(ranges)&&!_.isUndefined(ranges[fieldKey]))
{if(fieldKey!=='exclude'&&fieldKey.indexOf('custom_without_probability')==-1){ranges[fieldKey].in_included_total=$(event.target).is(':checked');}else{ranges[fieldKey].in_included_total=false;}
view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);}}},updateRangeSettings:function(category,range,value){var catRange=category+'_ranges',setting=this.model.get(catRange);if(category=='show_custom_buckets'){value.in_included_total=setting[range].in_included_total||false;}
setting[range]=value;this.model.unset(catRange,{silent:true});this.model.set(catRange,setting);},connectSliders:function(ranges,sliders){var rangeSliders=sliders[ranges];if(ranges=='show_binary'){rangeSliders.include.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'upper',to:rangeSliders.include.def.maxRange});this.view.setExcludeValueForLastSlider(value,ranges,rangeSliders.include);};}else if(ranges=='show_buckets'){rangeSliders.include.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'upper',to:rangeSliders.include.def.maxRange});rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('move',{handle:'upper',to:value.min-1});if(value.min<=rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('value')[0]+1){rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('move',{handle:'lower',to:value.min-2});}};rangeSliders.upside.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'lower',to:value.max+1});this.view.setExcludeValueForLastSlider(value,ranges,rangeSliders.upside);};}else if(ranges=='show_custom_buckets'){var i,max,customSliders=_.sortBy(_.filter(rangeSliders,function(item){return item.customType=='custom'}),function(item){return parseInt(item.customIndex,10);}),probabilitySliders=_.union(rangeSliders.include,rangeSliders.upside,customSliders,rangeSliders.exclude);if(probabilitySliders.length){for(i=0,max=probabilitySliders.length;i<max;i++){probabilitySliders[i].connectedSlider=(!_.isUndefined(probabilitySliders[i+1]))?probabilitySliders[i+1]:null;probabilitySliders[i].connectedToSlider=(!_.isUndefined(probabilitySliders[i-1]))?probabilitySliders[i-1]:null;probabilitySliders[i].sliderChangeDelegate=function(value,populateEvent){if(this.name=='include'){this.$el.find(this.fieldTag).noUiSlider('move',{handle:'upper',to:this.def.maxRange});}else if(this.name=='exclude'){this.$el.find(this.fieldTag).noUiSlider('move',{handle:'lower',to:this.def.minRange});}
if(!_.isUndefined(this.connectedSlider)&&!_.isNull(this.connectedSlider)){this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('move',{handle:'upper',to:value.min-1});if(value.min<=this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[0]+1){this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('move',{handle:'lower',to:value.min-2});}
if(_.isUndefined(populateEvent)||populateEvent=='down'){this.connectedSlider.sliderChangeDelegate.call(this.connectedSlider,{min:this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[0],max:this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[1]},'down');}}
if(!_.isUndefined(this.connectedToSlider)&&!_.isNull(this.connectedToSlider)){this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('move',{handle:'lower',to:value.max+1});if(value.max>=this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[1]-1){this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('move',{handle:'upper',to:value.max+2});}
if(_.isUndefined(populateEvent)||populateEvent=='up'){this.connectedToSlider.sliderChangeDelegate.call(this.connectedToSlider,{min:this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[0],max:this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[1]},'up');}}};}}}},setExcludeValueForLastSlider:function(value,ranges,slider){var excludeRange={min:0,max:100},settingName=ranges+'_ranges',setting=this.model.get(settingName);excludeRange.max=value.min-1;excludeRange.min=slider.def.minRange;setting.exclude=excludeRange;this.model.set(settingName,setting);}})},"forecastsConfigTimeperiods":{"controller":({titleSelectedValues:'',titleViewNameTitle:'',titleMessage:'',toggleTitleTpl:{},events:{'click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_TIMEPERIODS','Forecasts');this.titleMessage=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_MESSAGE_TIMEPERIODS','Forecasts');this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change',function(model){if(_.isUndefined(model)){model=this.model;}
if(model.changed['timeperiod_start_date']){var tmpD=new Date(new Date(model.changed['timeperiod_start_date']))
tmpD=new Date(tmpD.getTime()+(tmpD.getTimezoneOffset()*60000));this.titleSelectedValues=app.date.format(tmpD,app.user.getPreference('datepref'));this.updateTitle();}},this);}},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,message:this.titleMessage,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigTimeperiods'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_renderField:function(field){field=this._setUpTimeperiodConfigField(field);if(this.model.get('is_setup')){field.options.def.view='detail';}
app.view.View.prototype._renderField.call(this,field);},_render:function(){app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this.updateTitle();},_setUpTimeperiodConfigField:function(field){switch(field.name){case"timeperiod_shown_forward":case"timeperiod_shown_backward":return this._setUpTimeperiodShowField(field);case"timeperiod_interval":return this._setUpTimeperiodIntervalBind(field);default:return field;}},_setUpTimeperiodShowField:function(field){field.events=_.extend({"change input":"_updateSelection"},field.events);field.bindDomChange=function(){};field._updateSelection=function(event){var value=$(event.currentTarget).val();this.def.value=value;this.model.set(this.name,value);};this.model.set(field.name,this.model.get(field.name).toString(),{silent:true});field.def.value=this.model.get(field.name)||1;return field;},_setUpTimeperiodIntervalBind:function(field){field.def.value=this.model.get(field.name);field.events=_.extend({"change input":"_updateIntervals"},field.events);field.bindDomChange=function(){};if(typeof(field.def.options)=='string'){field.def.options=app.lang.getAppListStrings(field.def.options);}
field._updateIntervals=function(event){var selected_interval=$(event.currentTarget).val();this.def.value=selected_interval;this.model.set(this.name,selected_interval);this.model.set('timeperiod_leaf_interval',selected_interval=='Annual'?'Quarter':'Month');}
return field;}})}}},"layouts":{"base":{"config-main":{"controller":({collapseDivId:'forecast-config-accordion',timeperiodsTitle:'',timeperiodsText:'',scenariosTitle:'',scenariosText:'',rangesTitle:'',rangesText:'',forecastByTitle:'',forecastByText:'',wkstColumnsTitle:'',wkstColumnsText:'',selectedPanel:'',events:{'click .accordion-toggle':'onAccordionToggleClicked'},initialize:function(options){app.view.Layout.prototype.initialize.call(this,options);var appLang=app.lang,forecastBy=app.metadata.getModule('Forecasts','config').forecast_by,forecastByLabels={forecastByModule:appLang.getAppListStrings('moduleList')[forecastBy],forecastByModuleSingular:appLang.getAppListStrings('moduleListSingular')[forecastBy]};this.timeperiodsTitle=appLang.get('LBL_FORECASTS_CONFIG_TITLE_TIMEPERIODS','Forecasts');this.timeperiodsText=appLang.get('LBL_FORECASTS_CONFIG_HELP_TIMEPERIODS','Forecasts');this.scenariosTitle=appLang.get('LBL_FORECASTS_CONFIG_TITLE_SCENARIOS','Forecasts');this.scenariosText=appLang.get('LBL_FORECASTS_CONFIG_HELP_SCENARIOS','Forecasts',forecastByLabels);this.rangesTitle=appLang.get('LBL_FORECASTS_CONFIG_TITLE_RANGES','Forecasts');this.rangesText=appLang.get('LBL_FORECASTS_CONFIG_HELP_RANGES','Forecasts',forecastByLabels);this.forecastByTitle=appLang.get('LBL_FORECASTS_CONFIG_HOWTO_TITLE_FORECAST_BY','Forecasts');this.forecastByText=appLang.get('LBL_FORECASTS_CONFIG_HELP_FORECAST_BY','Forecasts');this.wkstColumnsTitle=appLang.get('LBL_FORECASTS_CONFIG_TITLE_WORKSHEET_COLUMNS','Forecasts');this.wkstColumnsText=appLang.get('LBL_FORECASTS_CONFIG_HELP_WORKSHEET_COLUMNS','Forecasts');if(this.context.get('model').get('is_setup')==0){this.context.get('model').set({first_time:1});}},_render:function(){app.view.Layout.prototype._render.call(this);this.$el.addClass('accordion');this.$el.attr('id',this.collapseDivId);this.$('.collapse').collapse({toggle:false,parent:'#'+this.collapseDivId});this.selectPanel(_.first(this.meta.components).view);},selectPanel:function(panelName){this.selectedPanel=panelName;this.$el.find('#'+panelName+'Collapse').collapse('show');this.onAccordionToggleClicked();},onAccordionToggleClicked:function(evt){var helpId=(evt)?$(evt.currentTarget).data('help-id'):this.selectedPanel,data={};switch(helpId){case'forecastsConfigTimeperiods':data.title=this.timeperiodsTitle;data.text=this.timeperiodsText;break;case'forecastsConfigScenarios':data.title=this.scenariosTitle;data.text=this.scenariosText;break;case'forecastsConfigRanges':data.title=this.rangesTitle;data.text=this.rangesText;break;case'forecastsConfigForecastBy':data.title=this.forecastByTitle;data.text=this.forecastByText;break;case'forecastsConfigWorksheetColumns':data.title=this.wkstColumnsTitle;data.text=this.wkstColumnsText;break;}
this.context.set({howtoData:data});}})},"records":{"controller":({initOptions:undefined,initialize:function(options){this.initOptions=options;var acls=app.user.getAcls().Forecasts,hasAccess=(!_.has(acls,'access')||acls.access=='yes');if(hasAccess){if(app.utils.checkForecastConfig()){this.syncInitData();}else{this.codeBlockForecasts('LBL_FORECASTS_MISSING_STAGE_TITLE','LBL_FORECASTS_MISSING_SALES_STAGE_VALUES');}}else{this.codeBlockForecasts('LBL_FORECASTS_ACLS_NO_ACCESS_TITLE','LBL_FORECASTS_ACLS_NO_ACCESS_MSG');}},codeBlockForecasts:function(title,msg){var alert=app.alert.show('no_access_to_forecasts',{level:'error',autoClose:false,title:app.lang.get(title,"Forecasts")+":",messages:[app.lang.get(msg,"Forecasts")]});alert.getCloseSelector().on('click',function(){alert.getCloseSelector().off();app.router.navigate('#Home',{trigger:true});});},loadData:function(){},bindDataChange:function(){if(!_.isUndefined(this.model)){this.collection.on('reset',function(){var lastCommit=_.first(this.collection.models);var commitDate=undefined;if(lastCommit instanceof Backbone.Model&&lastCommit.has('date_modified')){commitDate=lastCommit.get('date_modified');}
this.context.set({'currentForecastCommitDate':commitDate});},this);this.context.on('change:selectedUser',function(model,changed){var update={'selectedUserId':changed.id,'forecastType':app.utils.getForecastType(changed.isManager,changed.showOpps)}
this.model.set(update);},this);this.model.on('change:selectedTimePeriod',function(model,changed){this.context.set('selectedTimePeriod',changed);},this);this.model.on('change',function(){this.context.set({'currentForecastCommitDate':undefined},{silent:true});this.collection.fetch();},this);this.context.on('forecasts:worksheet:commit',function(user,worksheet_type,forecast_totals){this.commitForecast(user,worksheet_type,forecast_totals);},this);}},openConfigDrawer:function(){if(app.drawer._components.length==0){app.router.navigate('Forecasts/config',{replace:true,trigger:true});}},syncInitData:function(options){var callbacks,url;options=options||{};options.success=_.bind(function(model,data,options){app.user.set(data.initData.userData);if(data.initData.forecasts_setup===0){this.openConfigDrawer();}else{this.initForecastsModule(data,options);}},this);var model=this.initOptions.context.get('model');callbacks=app.data.getSyncCallbacks('read',model,options);this.trigger("data:sync:start",'read',model,options);url=app.api.buildURL("Forecasts/init",null,null,options.params);app.api.call("read",url,null,callbacks);},initForecastsModule:function(data,options){var ctx=this.initOptions.context;ctx.once('change:selectedUser',this._onceInitSelectedUser,this);ctx.set({currentForecastCommitDate:undefined,selectedTimePeriod:data.defaultSelections.timeperiod_id.id,selectedRanges:data.defaultSelections.ranges},{silent:true});ctx.get('model').set({'selectedTimePeriod':data.defaultSelections.timeperiod_id.id},{silent:true});app.utils.getSelectedUsersReportees(app.user.toJSON(),ctx);},_onceInitSelectedUser:function(model,change){app.view.Layout.prototype.initialize.call(this,this.initOptions);this.model.set('selectedUserId',change.id,{silent:true});this.model.set('forecastType',app.utils.getForecastType(change.isManager,change.showOpps));this.collection.sync=_.bind(this.sync,this);app.view.Layout.prototype.loadData.call(this);this.bindDataChange();if(!this.disposed)this.render();},sync:function(method,model,options){var callbacks,url;options=options||{};options.params=options.params||{};var args_filter=[],filter=null;if(this.model.has('selectedTimePeriod')){args_filter.push({"timeperiod_id":this.model.get('selectedTimePeriod')});}
if(this.model.has('selectedUserId')){args_filter.push({"user_id":this.model.get('selectedUserId')});args_filter.push({"forecast_type":this.model.get('forecastType')});}
if(!_.isEmpty(args_filter)){filter={"filter":args_filter};}
options.params.order_by='date_entered:DESC'
options=app.data.parseOptionsForSync(method,model,options);options.success=_.bind(function(model,data,options){if(!this.disposed){this.collection.reset(data);}},this);callbacks=app.data.getSyncCallbacks(method,model,options);this.trigger("data:sync:start",method,model,options);url=app.api.buildURL("Forecasts/filter",null,null,options.params);app.api.call("create",url,filter,callbacks);},commitForecast:function(user,worksheet_type,forecast_totals){var forecast=new this.collection.model(),forecastType=app.utils.getForecastType(user.isManager,user.showOpps),forecastData={};forecastData.commit_type=worksheet_type;forecastData.timeperiod_id=forecast_totals.timeperiod_id||this.model.get('selectedTimePeriod');forecastData.forecast_type=forecastType;forecast.save(forecastData,{success:_.bind(function(model,response){if(!this.disposed){this.collection.fetch();this.context.trigger("forecasts:worksheet:committed",worksheet_type,response);app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get("LBL_FORECASTS_WORKSHEET_COMMIT_SUCCESS","Forecasts")]});}},this),silent:true,alerts:{'success':false}});}})},"config":{"controller":({initialize:function(options){var acls=app.user.getAcls().Forecasts,hasAccess=(!_.has(acls,'access')||acls.access=='yes'),isSysAdmin=(app.user.get('type')=='admin'),isDev=(!_.has(acls,'developer')||acls.developer=='yes');if(hasAccess&&(isSysAdmin||isDev)){app.view.Layout.prototype.initialize.call(this,options);app.view.Layout.prototype.loadData.call(this);}else{this.codeBlockForecasts('LBL_FORECASTS_NO_ACCESS_TO_CFG_TITLE','LBL_FORECASTS_NO_ACCESS_TO_CFG_MSG');}},codeBlockForecasts:function(title,msg){var alert=app.alert.show('no_access_to_forecasts',{level:'error',autoClose:false,title:app.lang.get(title,"Forecasts")+":",messages:[app.lang.get(msg,"Forecasts")]});alert.getCloseSelector().on('click',function(){alert.getCloseSelector().off();app.router.navigate('#Home',{trigger:true});});},loadData:function(){}})}}}},"ForecastSchedule":{"fieldTemplates":{},"views":{},"layouts":{}},"ForecastWorksheets":{"fieldTemplates":{"base":{"parent":{"controller":({extendsFrom:'ParentField',_render:function(){if(this.model.get('parent_deleted')==1){this.deleted_value=this.model.get('name');this.options.viewName='deleted';}
app.view.invokeParent(this,{type:'field',name:'parent',method:'_render'});}})},"enum":{"controller":({extendsFrom:'EnumField',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('ClickToEdit');app.view.invokeParent(this,{type:'field',name:'enum',method:'initialize',args:[options]});}})},"date":{"controller":({extendsFrom:'DateField',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('ClickToEdit');app.view.invokeParent(this,{type:'field',name:'date',method:'initialize',args:[options]});}})},"currency":{"controller":({extendsFrom:'CurrencyField',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('ClickToEdit');app.view.invokeParent(this,{type:'field',name:'currency',method:'initialize',args:[options]});}})},"int":{"controller":({extendsFrom:'IntField',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('ClickToEdit');app.view.invokeParent(this,{type:'field',name:'int',method:'initialize',args:[options]});}})}}},"views":{"base":{"recordlist":{"controller":({extendsFrom:'RecordlistView',worksheetType:'sales_rep',totals:{},before_colspan:0,after_colspan:0,selectedUser:{},canEdit:true,filters:[],filteredCollection:new Backbone.Collection(),selectedTimeperiod:'',navigationMessage:'',routeNavigationMessage:'',displayNavigationMessage:false,hasCheckedForDraftRecords:false,previewModel:undefined,previewVisible:false,isCollectionSyncing:false,noAccessDataErrorTemplate:undefined,initialize:function(options){this.plugins=_.clone(this.plugins);this.plugins.push('CteTabbing','DirtyCollection');app.view.invokeParent(this,{type:'view',name:'recordlist',method:'initialize',args:[options]});this.template=app.template.getView('flex-list',this.module);this.selectedUser=this.context.get('selectedUser')||this.context.parent.get('selectedUser')||app.user.toJSON();this.selectedTimeperiod=this.context.get('selectedTimePeriod')||this.context.parent.get('selectedTimePeriod')||'';this.context.set('skipFetch',!(this.selectedUser.showOpps||!this.selectedUser.isManager));this.filters=this.context.get('selectedRanges')||this.context.parent.get('selectedRanges');this.collection.sync=_.bind(this.sync,this);this.noAccessDataErrorTemplate=app.template.getField('base','noaccess')(this);},_dispose:function(){if(!_.isUndefined(this.context.parent)&&!_.isNull(this.context.parent)){this.context.parent.off(null,null,this);}
app.routing.offBefore('route',this.beforeRouteHandler,this);$(window).off("beforeunload."+this.worksheetType);app.view.invokeParent(this,{type:'view',name:'recordlist',method:'_dispose'});},bindDataChange:function(){if(!_.isUndefined(this.context.parent)&&!_.isUndefined(this.context.parent.get('model'))){if(this.context.parent.get('model').module=='Forecasts'){this.context.parent.on('button:export_button:click',function(){if(this.layout.isVisible()){this.exportCallback();}},this);this.before('render',function(){return this.beforeRenderCallback()},this);this.on('render',function(){this.renderCallback();if(this.previewVisible){this.decorateRow(this.previewModel);}},this);this.on('list:toggle:column',function(column,isVisible,columnMeta){this.calculateTotals();},this);this.context.parent.on('forecasts:worksheet:totals',function(totals,type){if(type==this.worksheetType&&this.layout.isVisible()){var tpl=app.template.getView('recordlist.totals',this.module);this.$el.find('tfoot').remove();this.$el.find('tbody').after(tpl(this));}},this);this.context.parent.on('change:selectedTimePeriod',function(model,changed){this.updateSelectedTimeperiod(changed);},this);this.context.parent.on('change:selectedUser',function(model,changed){this.updateSelectedUser(changed)},this);this.context.parent.on('button:save_draft_button:click',function(){if(this.layout.isVisible()){this.context.parent.once('forecasts:worksheet:saved',function(){this.setNavigationMessage(false,'','');this.cleanUpDirtyModels();this.refreshData();this.collection.once('reset',function(){this.context.parent.trigger('forecasts:worksheet:needs_commit',this.worksheetType);},this);},this);this.saveWorksheet(true);}},this);this.context.parent.on('button:commit_button:click',function(){if(this.layout.isVisible()){this.context.parent.once('forecasts:worksheet:saved',function(){this.context.parent.trigger('forecasts:worksheet:commit',this.selectedUser,this.worksheetType,this.getCommitTotals())},this);this.saveWorksheet(false);}},this);this.context.parent.on('change:currentForecastCommitDate',function(context,changed){if(this.layout.isVisible()){this.checkForDraftRows(changed);}},this);this.collection.on('data:sync:start',function(){this.isCollectionSyncing=true;},this);this.collection.on('data:sync:complete',function(){this.isCollectionSyncing=false;},this);this.collection.on('reset',function(){this.setNavigationMessage(false,'','');this.cleanUpDirtyModels();var ctx=this.context.parent||this.context
ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,false);this.checkForDraftRows(ctx.get('currentForecastCommitDate'));this.filterCollection();},this);this.collection.on('change:commit_stage',function(model){if(!_.isEmpty(this.filters)&&_.indexOf(this.filters,model.get('commit_stage'))===-1){this.filterCollection();if(!this.disposed){this.render();}}else{this.$el.find('tr[name='+model.module+'_'+model.id+']').attr('data-forecast',model.get('commit_stage'));}},this);this.context.parent.on('change:selectedRanges',function(model,changed){this.filters=changed;this.once('render',function(){app.alert.dismiss('worksheet_filtering');});this.filterCollection();if(!this.disposed)this.render();},this);this.context.parent.on('forecasts:worksheet:committed',function(){if(this.layout.isVisible()){this.setNavigationMessage(false,'','');this.cleanUpDirtyModels();var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,false);if(this.selectedUser.isManager&&app.metadata.getModule('Forecasts','config').show_forecasts_commit_warnings==1){this.collection.once('reset',function(){this.setNavigationMessage(true,'LBL_WORKSHEET_COMMIT_ALERT','LBL_WORKSHEET_COMMIT_ALERT');},this)}
this.refreshData();}},this);this.context.parent.on('forecasts:worksheet:is_dirty',function(worksheetType,is_dirty){if(this.worksheetType==worksheetType){if(is_dirty){this.setNavigationMessage(true,'LBL_WORKSHEET_SAVE_CONFIRM','LBL_WORKSHEET_SAVE_CONFIRM_UNLOAD');}else{this.setNavigationMessage(false,'','');}}},this);app.routing.before('route',this.beforeRouteHandler,{},this);$(window).bind("beforeunload."+this.worksheetType,_.bind(function(){var ret=this.showNavigationMessage('window');if(_.isString(ret)){return ret;}},this));}}
this.collection.on('reset change',function(){this.calculateTotals();},this);if(!_.isUndefined(this.dirtyModels)){this.dirtyModels.on('add',function(){if(this.canEdit){var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,true);}},this);}
this.layout.on('hide',function(){this.totals={};},this);app.view.invokeParent(this,{type:'view',name:'recordlist',method:'bindDataChange'});},beforeRouteHandler:function(){var ret=this.showNavigationMessage('router');this.processNavigationMessageReturn(ret);},unbindData:function(){app.events.off(null,null,this);app.view.invokeParent(this,{type:'view',name:'recordlist',method:'unbindData'});},showNavigationMessage:function(type){if(this.layout.isVisible()){var canEdit=this.dirtyCanEdit||this.canEdit;if(canEdit&&this.displayNavigationMessage){if(type=='window'){if(!_.isEmpty(this.routeNavigationMessage)){return app.lang.get(this.routeNavigationMessage,'Forecasts');}
return false;}
if(this.navigationMessage=='LBL_WORKSHEET_COMMIT_ALERT'){alert(app.lang.get(this.navigationMessage,'Forecasts'));return true;}else{var ret=confirm(app.lang.get(this.navigationMessage,'Forecasts').split("<br>"));return{'message':this.navigationMessage,'run_action':ret};}}
return true;}
return true;},setNavigationMessage:function(display,reload_label,route_label){this.displayNavigationMessage=display;this.navigationMessage=reload_label;this.routeNavigationMessage=route_label;},exportCallback:function(){var url='index.php?module=Forecasts&action=ExportWorksheet';url+='&user_id='+this.selectedUser.id;url+='&timeperiod_id='+this.selectedTimeperiod;if(this.canEdit&&this.isDirty()){if(confirm(app.lang.get("LBL_WORKSHEET_EXPORT_CONFIRM","Forecasts"))){this.runExport(url);}}else{this.runExport(url);}},runExport:function(url){var dlFrame=$("#forecastsDlFrame");if(dlFrame.length==0){dlFrame=$("<iframe>");dlFrame.attr("id","forecastsDlFrame");dlFrame.css("display","none");$("body").append(dlFrame);}
dlFrame.attr("src",url);},beforeRenderCallback:function(){var showOpps=(_.isUndefined(this.selectedUser.showOpps))?false:this.selectedUser.showOpps,isManager=(_.isUndefined(this.selectedUser.isManager))?true:this.selectedUser.isManager;if(!(showOpps||!isManager)&&this.layout.isVisible()){this.layout.hide();}else if((showOpps||!isManager)&&!this.layout.isVisible()){this.layout.once('show',this.calculateTotals,this);this.layout.show();}
this.leftColumns=[];return(showOpps||!isManager);},renderCallback:function(){var user=this.selectedUser||this.context.parent.get('selectedUser')||app.user.toJSON()
if(user.showOpps||!user.isManager){if(!this.layout.isVisible()){this.layout.show();}
if(this.filteredCollection.length==0){var tpl=app.template.getView('recordlist.noresults',this.module);this.$el.find('tbody').html(tpl(this));}
if(!_.isEmpty(this.totals)&&this.layout.isVisible()){var tpl=app.template.getView('recordlist.totals',this.module);this.$el.find('tbody').after(tpl(this));}
var sales_stage_width=this.$el.find('td[data-field-name="sales_stage"] span.isEditable').width();var sales_stage_outerwidth=this.$el.find('td[data-field-name="sales_stage"] span.isEditable').outerWidth();this.$el.find('td[data-field-name="sales_stage"] span.isEditable').width(sales_stage_width+20);this.$el.find('td[data-field-name="sales_stage"] span.isEditable').parent("td").css("min-width",sales_stage_outerwidth+26+"px");this.setRowActionButtonStates();this.adjustCurrencyColumnWidths();}else{if(this.layout.isVisible()){this.layout.hide();}}},updateSelectedUser:function(changed){var doFetch=false;if(this.selectedUser.id!=changed.id){doFetch=(changed.showOpps||!changed.isManager);}
if(!doFetch&&(changed.showOpps||!changed.isManager)){doFetch=true;}
if(this.displayNavigationMessage){this.dirtyUser=this.selectedUser;this.dirtyCanEdit=this.canEdit;}
this.selectedUser=changed;this.canEdit=(this.selectedUser.id==app.user.get('id'));this.hasCheckedForDraftRecords=false;if(doFetch){this.refreshData();}else{if((!this.selectedUser.showOpps&&this.selectedUser.isManager)&&this.layout.isVisible()){if(this.displayNavigationMessage&&this.dirtyUser.id==this.selectedUser.id){this.processNavigationMessageReturn(this.showNavigationMessage('rep_to_manager'));}else if(this.displayNavigationMessage){this.processNavigationMessageReturn(this.showNavigationMessage('user_switch'));}
this.cleanUpDirtyModels();this.layout.hide();}}},updateSelectedTimeperiod:function(changed){if(this.displayNavigationMessage){this.dirtyTimeperiod=this.selectedTimeperiod;}
this.selectedTimeperiod=changed;this.hasCheckedForDraftRecords=false;if(this.layout.isVisible()){this.refreshData();}},checkForDraftRows:function(lastCommitDate){if(this.layout.isVisible()&&this.canEdit&&this.hasCheckedForDraftRecords===false&&!_.isEmpty(this.collection.models)&&this.isCollectionSyncing===false){this.hasCheckedForDraftRecords=true;if(_.isUndefined(lastCommitDate)){this.context.parent.trigger('forecasts:worksheet:needs_commit',this.worksheetType);}else{this.collection.find(function(item){if(item.get('date_modified')>lastCommitDate){this.context.parent.trigger('forecasts:worksheet:needs_commit',this.worksheetType);return true;}
return false;},this);}}else if(this.layout.isVisible()===false&&this.canEdit&&this.hasCheckedForDraftRecords===false){this.layout.once('show',function(){this.checkForDraftRows(lastCommitDate);},this);}else if(this.isCollectionSyncing===true){this.collection.once('data:sync:complete',function(){this.checkForDraftRows(lastCommitDate);},this);}},setRowActionButtonStates:function(){_.each(this.fields,function(field){if(field.def.event==='list:preview:fire'){field.setDisabled((field.model.get('parent_deleted')=="1"));field.render();}});},filterCollection:function(){this.filteredCollection.reset();if(_.isEmpty(this.filters)){this.filteredCollection.add(this.collection.models);}else{this.collection.each(function(model){if(_.indexOf(this.filters,model.get('commit_stage'))!==-1){this.filteredCollection.add(model);}},this);}},saveWorksheet:function(isDraft){var totalToSave=0;if(this.layout.isVisible()){var saveCount=0,ctx=this.context.parent||this.context;if(this.isDirty()){totalToSave=this.dirtyModels.length;this.dirtyModels.each(function(model){model.set({"draft":(isDraft&&isDraft==true)?1:0,"timeperiod_id":this.dirtyTimeperiod||this.selectedTimeperiod,"current_user":this.dirtyUser.id||this.selectedUser.id},{silent:true});model.save({},{success:_.bind(function(){saveCount++;if(this.previewVisible){var previewId=this.previewModel.get('parent_id')||this.previewModel.get('id');if(model.get('parent_id')==previewId){var previewCollection=new Backbone.Collection();this.filteredCollection.each(function(model){if(model.get('parent_deleted')!=="1"){previewCollection.add(model);}},this);app.events.trigger("preview:render",model,previewCollection,true,model.get('id'),true);}}
if(totalToSave===saveCount){if(isDraft){app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get("LBL_FORECASTS_WORKSHEET_SAVE_DRAFT_SUCCESS","Forecasts")]});}
ctx.trigger('forecasts:worksheet:saved',totalToSave,this.worksheetType,isDraft);}},this),silent:true,alerts:{'success':false}});},this);this.cleanUpDirtyModels();}else{if(isDraft){app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get("LBL_FORECASTS_WORKSHEET_SAVE_DRAFT_SUCCESS","Forecasts")]});}
ctx.trigger('forecasts:worksheet:saved',totalToSave,this.worksheetType,isDraft);}}
return totalToSave},calculateTotals:function(){if(this.layout.isVisible()){this.totals=this.getCommitTotals();var calcFields=['worst_case','best_case','likely_case'],fields=_.filter(this._fields.visible,function(field){if(_.contains(calcFields,field.name)){this.totals[field.name+'_access']=app.acl.hasAccess('read',this.module,app.user.get('id'),field.name);this.totals[field.name+'_display']=true;return true;}
return false;},this);for(var x=0;x<this._fields.visible.length;x++){var f=this._fields.visible[x];if(_.contains(calcFields,f.name)){break;}}
this.before_colspan=x;this.after_colspan=(this._fields.visible.length-(x+fields.length));var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:totals',this.totals,this.worksheetType);}},displayLoadingMessage:function(){app.alert.show('workshet_loading',{level:'process',title:app.lang.getAppString('LBL_LOADING')});this.collection.once('reset',function(){app.alert.dismiss('workshet_loading');},this);},refreshData:function(){var ret=this.showNavigationMessage('forecast');if(this.processNavigationMessageReturn(ret)){this.displayLoadingMessage();this.collection.fetch();}},processNavigationMessageReturn:function(message_result){if(_.isObject(message_result)&&message_result.run_action===true){if(message_result.message=='LBL_WORKSHEET_SAVE_CONFIRM'){this.context.parent.once('forecasts:worksheet:saved',function(){if(this.layout.isVisible()){this.displayLoadingMessage();this.collection.fetch();}},this);this.saveWorksheet(true);}
return false}
return true;},sync:function(method,model,options){var callbacks,url;options=options||{};options.params=options.params||{};if(!_.isUndefined(this.selectedUser.id)){options.params.user_id=this.selectedUser.id;}
if(!_.isEmpty(this.selectedTimeperiod)){options.params.timeperiod_id=this.selectedTimeperiod;}
options.limit=1000;options=app.data.parseOptionsForSync(method,model,options);if(!_.isUndefined(options.params.order_by)&&options.params.order_by.indexOf('parent_name')===0){options.params.order_by=options.params.order_by.replace('parent_','');}
options.success=_.bind(function(model,data,options){if(!this.disposed){this.collection.reset(data);}},this);callbacks=app.data.getSyncCallbacks(method,model,options);this.collection.trigger("data:sync:start",method,model,options);url=app.api.buildURL("ForecastWorksheets",null,null,options.params);app.api.call("read",url,null,callbacks);},getCommitTotals:function(){var includedAmount=0,includedBest=0,includedWorst=0,overallAmount=0,overallBest=0,overallWorst=0,includedCount=0,lostCount=0,lostAmount=0,lostBest=0,lostWorst=0,wonCount=0,wonAmount=0,wonBest=0,wonWorst=0,includedClosedCount=0,includedClosedAmount=0,cfg=app.metadata.getModule('Forecasts','config');var sales_stage_won_setting=cfg.sales_stage_won||[],sales_stage_lost_setting=cfg.sales_stage_lost||[];var commit_stages_in_included_total=['include'];if(cfg.forecast_ranges=='show_custom_buckets'){commit_stages_in_included_total=cfg.commit_stages_included;}
this.collection.each(function(model){var won=_.include(sales_stage_won_setting,model.get('sales_stage')),lost=_.include(sales_stage_lost_setting,model.get('sales_stage')),amount=parseFloat(model.get('likely_case')),commit_stage=model.get('commit_stage'),best=parseFloat(model.get('best_case')),base_rate=parseFloat(model.get('base_rate')),worst=parseFloat(model.get('worst_case')),worst_base=app.currency.convertWithRate(worst,base_rate),amount_base=app.currency.convertWithRate(amount,base_rate),best_base=app.currency.convertWithRate(best,base_rate);if(won&&_.include(commit_stages_in_included_total,commit_stage)){wonAmount=app.math.add(wonAmount,amount_base);wonBest=app.math.add(wonBest,best_base);wonWorst=app.math.add(wonWorst,worst_base);wonCount++;}else if(lost){lostAmount=app.math.add(lostAmount,amount_base);lostBest=app.math.add(lostBest,best_base);lostWorst=app.math.add(lostWorst,worst_base);lostCount++;}
if(_.include(commit_stages_in_included_total,commit_stage)){includedAmount+=amount_base;includedBest+=best_base;includedWorst+=worst_base;includedCount++;if(won){includedClosedCount++;includedClosedAmount=app.math.add(amount_base,includedClosedAmount);}}
overallAmount+=amount_base;overallBest+=best_base;overallWorst+=worst_base;},this);return{'likely_case':includedAmount,'best_case':includedBest,'worst_case':includedWorst,'overall_amount':overallAmount,'overall_best':overallBest,'overall_worst':overallWorst,'timeperiod_id':this.dirtyTimeperiod||this.selectedTimeperiod,'lost_count':lostCount,'lost_amount':lostAmount,'won_count':wonCount,'won_amount':wonAmount,'included_opp_count':includedCount,'total_opp_count':this.collection.length,'closed_count':includedClosedCount,'closed_amount':includedClosedAmount};},addPreviewEvents:function(){this.context.on("list:preview:fire",function(model){var previewCollection=new Backbone.Collection();this.filteredCollection.each(function(model){if(model.get('parent_deleted')!=="1"){previewCollection.add(model);}},this);if(_.isUndefined(this.previewModel)||model.get('id')!=this.previewModel.get('id')){this.previewModel=model;app.events.trigger("preview:render",model,previewCollection,true);}else{this.decorateRow();app.events.trigger('preview:close');}},this);app.events.on("list:preview:decorate",this.decorateRow,this);if(this.layout){this.layout.on("list:sort:fire",function(){app.events.trigger("preview:close");},this);}
app.events.on('preview:render',function(model){this.previewModel=model;this.previewVisible=true;},this);app.events.on('preview:close',function(){this.previewVisible=false;this.previewModel=undefined;},this);},adjustCurrencyColumnWidths:function(){if(this.collection.length==0){return;}
_.each(this._fields.visible,function(field){if(field.type==='currency'){var converted=this.$el.find('span[data-name^="'+field.name+'"] .converted'),original=this.$el.find('span[data-name^="'+field.name+'"] label.original'),widths=converted.map(function(){return $(this).width();}).get(),labelWidths=original.map(function(){return $(this).width();}).get();converted.width(_.max(widths)+5);original.width(_.max(labelWidths));var parentTds=this.$el.find('span[data-name^="'+field.name+'"]'),parentWidth=_.max(parentTds.map(function(){return $(this).outerWidth();}).get()),finalTDWidth=parentWidth+20;this.$el.find('th[data-fieldname^="'+field.name+'"]').width(finalTDWidth).css('maxWidth',finalTDWidth+'px').css('minWidth',finalTDWidth+'px');}},this);}})},"filter":{"controller":({events:{'keydown .select2-input':'disableSelect2KeyPress'},disableSelect2KeyPress:function(event){event.preventDefault();},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.selectedUser={id:app.user.get('id'),isManager:app.user.get('isManager'),showOpps:false};},bindDomChange:function(){},_render:function(){app.view.View.prototype._render.call(this);this.node=this.$el.find("#"+this.cid);this._setUpFilters();return this;},_setUpFilters:function(){var ctx=this.context.parent||this.context,selectedRanges=ctx.has("selectedRanges")?ctx.get("selectedRanges"):app.defaultSelections.ranges;this.node.select2({data:this._getRangeFilters(),initSelection:function(element,callback){callback(_.filter(this.data,function(obj){return _.contains(this,obj.id);},$(element.val().split(","))));},multiple:true,placeholder:app.lang.get("LBL_MODULE_FILTER"),dropdownCss:{width:"auto"},containerCssClass:"select2-choices-pills-close",containerCss:"border: none",formatSelection:this.formatCustomSelection,dropdownCssClass:"search-filter-dropdown",escapeMarkup:function(m){return m;},width:'100%'});this.node.select2("val",selectedRanges);this.node.change({context:ctx},function(event){app.alert.show('worksheet_filtering',{level:'process',title:app.lang.getAppString('LBL_LOADING')});_.delay(function(){event.data.context.set("selectedRanges",event.val);},25);});},formatCustomSelection:function(item){return'<span class="select2-choice-type">'+app.lang.get("LBL_FILTER")+'</span><a class="select2-choice-filter" rel="'+item.id+'" href="javascript:void(0)">'+item.text+'</a>';},_getRangeFilters:function(){var options=app.metadata.getModule('Forecasts','config').buckets_dom||'commit_stage_binary_dom';return _.map(app.lang.getAppListStrings(options),function(value,key){return{id:key,text:value};});}})}}},"layouts":{}},"ForecastManagerWorksheets":{"fieldTemplates":{"base":{"userLink":{"controller":({events:{'click a.worksheetManagerLink':'linkClicked'},plugins:['EllipsisInline'],uid:'',initialize:function(options){this.uid=this.model.get('user_id');app.view.Field.prototype.initialize.call(this,options);return this;},format:function(value){var su=this.context.get('selectedUser')||this.context.parent.get('selectedUser')||app.user.toJSON();if(value==su.full_name){var hb=Handlebars.compile("{{str key module context}}");value=hb({'key':'LBL_MY_OPPS_RLI','module':this.module,'context':su});}
return value;},linkClicked:function(event){var uid=$(event.target).data('uid');var selectedUser={id:'',user_name:'',full_name:'',first_name:'',last_name:'',isManager:false,showOpps:false,reportees:[]};var options={dataType:'json',success:_.bind(function(data){selectedUser.id=data.id;selectedUser.user_name=data.user_name;selectedUser.full_name=data.full_name;selectedUser.first_name=data.first_name;selectedUser.last_name=data.last_name;selectedUser.isManager=data.isManager;var su=this.context.get('selectedUser')||this.context.parent.get('selectedUser')||app.user.toJSON();selectedUser.showOpps=(su.id==data.id);app.utils.getSelectedUsersReportees(selectedUser,this.context.parent);},this)};myURL=app.api.buildURL('Forecasts','user/'+uid);app.api.call('read',myURL,null,options);}})},"rowactions":{"controller":({extendsFrom:'RowactionsField',initialize:function(options){app.view.invokeParent(this,{type:'field',name:'rowactions',method:'initialize',args:[options]});this.setPlaceholder=_.throttle(this.customSetPlaceholder,100);},getPlaceholder:function(){var placeholder=app.view.Field.prototype.getPlaceholder.call(this),$container=$(placeholder.toString()),$caret=$('<a class="btn dropdown-toggle" data-toggle="dropdown" href="javascript:void(0);"><i class="icon-caret-down"></i></a>'),$dropdown=$('<ul class="dropdown-menu"></ul>');if(this.def.primary){$caret.addClass('btn-primary');}
_.each(this.def.buttons,function(fieldDef,index,list){var field=app.view.createField({def:fieldDef,view:this.view,viewName:this.options.viewName,model:this.model});this.fields.push(field);field.on('show hide',this.setPlaceholder,this);field.parent=this;if(index==0){$container.append(field.getPlaceholder().toString());}else{if(index==1){$container.addClass('actions btn-group');if(list.length>2){$container.append($caret).append($dropdown);}}
if(list.length>2){$dropdown.append('<li>'+field.getPlaceholder().toString()+'</li>');}else{$container.append(field.getPlaceholder().toString());}}},this);return new Handlebars.SafeString($container.get(0).outerHTML);},customSetPlaceholder:function(){if(this.$el){var index=0;_.each(this.fields,function(field,idx,list){var fieldPlaceholder=this.$("span[sfuuid='"+field.sfId+"']");if(field.isHidden){fieldPlaceholder.toggleClass('hide',true);this.$el.append(fieldPlaceholder);}else{fieldPlaceholder.toggleClass('hide',false);if(index==0||list.length==2){field.getFieldElement().addClass("btn");if(this.def.primary){field.getFieldElement().addClass("btn-primary");}
if(index==0){this.$el.prepend(fieldPlaceholder);}else{this.$el.append(fieldPlaceholder);}}else{field.getFieldElement().removeClass("btn btn-primary");this.$(".dropdown-menu").append($('<li>').html(fieldPlaceholder));}
index++;}},this);if(index<=1){this.$(".dropdown-toggle").hide();this.$el.removeClass('btn-group');}else{this.$(".dropdown-toggle").show();this.$el.addClass('btn-group');}
this.$(".dropdown-menu").children("li").each(function(index,el){if($(el).html()===''){$(el).remove();}});}}})},"currency":{"controller":({extendsFrom:'CurrencyField',initialize:function(options){this.plugins=_.clone(this.plugins)||[];this.plugins.push('ClickToEdit');app.view.invokeParent(this,{type:'field',name:'currency',method:'initialize',args:[options]});}})},"commithistory":{"controller":({initialize:function(options){app.view.Field.prototype.initialize.call(this,options);this.on('render',function(){this.loadData();},this);},loadData:function(){var ctx=this.context.parent||this.context,su=ctx.get('selectedUser')||app.user.toJSON(),isManager=this.model.get('isManager'),showOpps=(su.id==this.model.get('user_id'))?1:0,forecastType=app.utils.getForecastType(isManager,showOpps),args_filter=[],options={};args_filter.push({"user_id":this.model.get('user_id')});args_filter.push({"forecast_type":forecastType});var url={"url":app.api.buildURL('Forecasts','filter'),"filters":{"filter":args_filter}};options.success=_.bind(function(data){this.buildLog(data);},this);app.api.call('create',url.url,url.filters,options,{context:this});},buildLog:function(data){data=data.records;var ctx=this.context.parent||this.context,forecastCommitDate=ctx.get('currentForecastCommitDate'),commitDate=new Date(forecastCommitDate),newestModel=new Backbone.Model(_.first(data)),otherModels=_.last(data,data.length-1),oldestModel={},displayCommitDate=newestModel.get('date_modified');for(var i=0;i<otherModels.length;i++){if(new Date(otherModels[i].date_modified)<=commitDate){oldestModel=new Backbone.Model(otherModels[i]);displayCommitDate=oldestModel.get('date_modified');break;}}
var tpl=app.template.getField(this.type,'log',this.module);this.$el.html(tpl({commit:app.utils.createHistoryLog(oldestModel,newestModel).text,commit_date:displayCommitDate}));this.$el.find("span.relativetime").timeago({logger:SUGAR.App.logger,date:SUGAR.App.date,lang:SUGAR.App.lang,template:SUGAR.App.template});},_render:function(){this.$el=this.view.$el.find('span[sfuuid="'+this.sfId+'"]');app.view.Field.prototype._render.call(this);}})}}},"views":{"base":{"recordlist":{"controller":({extendsFrom:'RecordlistView',worksheetType:'manager',selectedUser:{},canEdit:true,selectedTimeperiod:{},totals:{},defaultValues:{quota:0,best_case:0,best_case_adjusted:0,likely_case:0,likely_case_adjusted:0,worst_case:0,worst_case_adjusted:0,show_history_log:0},navigationMessage:'',routeNavigationMessage:'',displayNavigationMessage:false,hasCheckedForDraftRecords:false,draftSaveType:undefined,isCollectionSyncing:false,initialize:function(options){this.plugins=_.clone(this.plugins);this.plugins.push('CteTabbing');this.plugins.push('DirtyCollection');app.view.invokeParent(this,{type:'view',name:'recordlist',method:'initialize',args:[options]});this.selectedUser=this.context.get('selectedUser')||this.context.parent.get('selectedUser')||app.user.toJSON();this.selectedTimeperiod=this.context.get('selectedTimePeriod')||this.context.parent.get('selectedTimePeriod')||'';this.context.set('skipFetch',(this.selectedUser.isManager&&this.selectedUser.showOpps));this.collection.sync=_.bind(this.sync,this);},_dispose:function(){if(!_.isUndefined(this.context.parent)&&!_.isNull(this.context.parent)){this.context.parent.off(null,null,this);}
app.routing.offBefore('route',this.beforeRouteHandler,this);$(window).off("beforeunload."+this.worksheetType);app.view.invokeParent(this,{type:'view',name:'recordlist',method:'_dispose'});},bindDataChange:function(){if(!_.isUndefined(this.context.parent)&&!_.isUndefined(this.context.parent.get('model'))){if(this.context.parent.get('model').module=='Forecasts'){this.context.parent.on('button:export_button:click',function(){if(this.layout.isVisible()){this.exportCallback();}},this);this.before('render',function(){return this.beforeRenderCallback();},true);this.on('render',function(){this.renderCallback();},this);this.on('list:toggle:column',function(column,isVisible,columnMeta){this.calculateTotals();},this);this.context.parent.on('button:save_draft_button:click',function(){if(this.layout.isVisible()){this.context.parent.once('forecasts:worksheet:saved',function(){this.setNavigationMessage(false,'','');this.context.parent.trigger('forecasts:worksheet:needs_commit',this.worksheetType);},this);this.draftSaveType='draft';this.saveWorksheet(true);}},this);this.context.parent.on('button:commit_button:click',function(){if(this.layout.isVisible()){this.context.parent.once('forecasts:worksheet:saved',function(){this.context.parent.trigger('forecasts:worksheet:commit',this.selectedUser,this.worksheetType,this.getCommitTotals())},this);this.draftSaveType='commit';this.saveWorksheet(false);}},this);this.context.parent.on('change:selectedTimePeriod',function(model,changed){this.updateSelectedTimeperiod(changed);},this);this.context.parent.on('forecasts:worksheet:totals',function(totals,type){if(type==this.worksheetType){var tpl=app.template.getView('recordlist.totals',this.module);this.$el.find('tfoot').remove();this.$el.find('tbody').after(tpl(this));}},this);this.context.parent.on('change:selectedUser',function(model,changed){this.updateSelectedUser(changed);},this);this.context.parent.on('change:currentForecastCommitDate',function(context,changed){if(this.layout.isVisible()){this.checkForDraftRows(changed);}},this);this.collection.on('data:sync:start',function(){this.isCollectionSyncing=true;},this);this.collection.on('data:sync:complete',function(){this.isCollectionSyncing=false;},this);this.collection.on('reset',function(){var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,false);this.checkForDraftRows(ctx.get('currentForecastCommitDate'));},this);this.collection.on('change:quota',function(model,changed){var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:quota_changed',this.worksheetType);},this);this.context.parent.on('forecasts:worksheet:committed',function(){if(this.layout.isVisible()){var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,false);this.refreshData();this.hasCheckedForDraftRecords=true;}},this);this.context.parent.on('forecasts:worksheet:is_dirty',function(worksheetType,is_dirty){if(this.worksheetType==worksheetType){if(is_dirty){this.setNavigationMessage(true,'LBL_WORKSHEET_SAVE_CONFIRM','LBL_WORKSHEET_SAVE_CONFIRM_UNLOAD');}else{this.cleanUpDirtyModels();this.setNavigationMessage(false,'','');}}},this);this.context.parent.on('button:assign_quota:click',function(){this.context.parent.once('forecasts:worksheet:saved',function(){this.setNavigationMessage(false,'','');this.context.parent.trigger('forecasts:assign_quota',this.worksheetType,this.selectedUser,this.selectedTimeperiod);},this);app.alert.show('saving_quota',{level:'process',title:app.lang.get('LBL_ASSIGNING_QUOTA','Forecasts')});this.draftSaveType='assign_quota';this.saveWorksheet(true,true);},this);this.context.parent.on('forecasts:quota_assigned',function(){this.refreshData();},this);app.routing.before('route',this.beforeRouteHandler,{},this);$(window).bind("beforeunload."+this.worksheetType,_.bind(function(){if(!this.disposed){var ret=this.showNavigationMessage('window');if(_.isString(ret)){return ret;}}},this));}}
if(!_.isUndefined(this.dirtyModels)){this.dirtyModels.on('add',function(){var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:is_dirty',this.worksheetType,true);},this);}
this.context.on('list:history_log:fire',function(model,e){var row_name=model.module+'_'+model.id;var log_row=this.$el.find('tr[name="'+row_name+'_commit_history"]');var field;if(log_row.length==1){log_row.remove();field=_.find(this.fields,function(field,idx){return(field.name==row_name+'_commit_history');},this);field.dispose();}else{var rowTpl=app.template.getView('recordlist.commithistory',this.module);field=app.view.createField({def:{'type':'commithistory','name':row_name+'_commit_history'},view:this,model:model});this.$el.find('tr[name="'+row_name+'"]').after(rowTpl({module:this.module,id:model.id,placeholder:field.getPlaceholder(),colspan:this._fields.visible.length+this.leftColumns.length+this.rightColumns.length}));field.render();}},this);this.collection.on('reset change',function(){this.calculateTotals();},this);this.layout.on('hide',function(){this.totals={};},this);app.view.invokeParent(this,{type:'view',name:'recordlist',method:'bindDataChange'});},beforeRouteHandler:function(){var ret=this.showNavigationMessage('router');this.processNavigationMessageReturn(ret);},showNavigationMessage:function(type){if(this.layout.isVisible()){var canEdit=this.dirtyCanEdit||this.canEdit;if(canEdit&&this.displayNavigationMessage){if(type=='window'){if(!_.isEmpty(this.routeNavigationMessage)){return app.lang.get(this.routeNavigationMessage,'Forecasts');}
return false;}
var ret=confirm(app.lang.get(this.navigationMessage,'Forecasts').split("<br>"));return{'message':this.navigationMessage,'run_action':ret};}
return true;}
return true;},setNavigationMessage:function(display,reload_label,route_label){this.displayNavigationMessage=display;this.navigationMessage=reload_label;this.routeNavigationMessage=route_label;},refreshData:function(){var ret=this.showNavigationMessage('forecast');if(this.processNavigationMessageReturn(ret)){this.hasCheckedForDraftRecords=false;this.displayLoadingMessage();this.collection.fetch();}},displayLoadingMessage:function(){app.alert.show('workshet_loading',{level:'process',title:app.lang.getAppString('LBL_LOADING')});this.collection.once('reset',function(){app.alert.dismiss('workshet_loading');},this);},processNavigationMessageReturn:function(message_result){if(_.isObject(message_result)&&message_result.run_action===true){if(message_result.message=='LBL_WORKSHEET_SAVE_CONFIRM'){this.context.parent.once('forecasts:worksheet:saved',function(){if(this.layout.isVisible()){this.displayLoadingMessage();this.collection.fetch();}},this);this.saveWorksheet(true);}
return false}
return true;},exportCallback:function(){var url='index.php?module=Forecasts&action=ExportManagerWorksheet';url+='&user_id='+this.selectedUser.id;url+='&timeperiod_id='+this.selectedTimeperiod;if(this.canEdit&&this.isDirty()){if(confirm(app.lang.get("LBL_WORKSHEET_EXPORT_CONFIRM","Forecasts"))){this.runExport(url);}}else{this.runExport(url);}},runExport:function(url){var dlFrame=$("#forecastsDlFrame");if(dlFrame.length==0){dlFrame=$("<iframe>");dlFrame.attr("id","forecastsDlFrame");dlFrame.css("display","none");$("body").append(dlFrame);}
dlFrame.attr("src",url);},beforeRenderCallback:function(){var ret=true;if(_.isUndefined(this.selectedUser.isManager)||this.selectedUser.isManager==false){ret=false;}
if(ret){ret=!(this.selectedUser.showOpps);}
if(ret===false&&this.layout.isVisible()){this.layout.hide();}
this.leftColumns=[];return ret;},renderCallback:function(){var user=this.selectedUser||this.context.parent.get('selectedUser')||app.user.toJSON();if(user.isManager&&user.showOpps==false){if(!this.layout.isVisible()){this.layout.once('show',this.calculateTotals,this);this.layout.show();}
if(!_.isEmpty(this.totals)&&this.layout.isVisible()){var tpl=app.template.getView('recordlist.totals',this.module);this.$el.find('tfoot').remove();this.$el.find('tbody').after(tpl(this));}
this.setCommitLogButtonStates();var outerwidth=this.$el.find('span.isEditable').outerWidth();this.$el.find('span.isEditable').parent("td").css("min-width","105px");}else{if(this.layout.isVisible()){this.layout.hide();}}},updateSelectedTimeperiod:function(changed){if(this.displayNavigationMessage){this.dirtyTimeperiod=this.selectedTimeperiod;}
this.selectedTimeperiod=changed;if(this.layout.isVisible()){this.refreshData();}},updateSelectedUser:function(changed){var doFetch=false;if(this.selectedUser.id!=changed.id){doFetch=true;}
if(!doFetch&&this.selectedUser.isManager!=changed.isManager){doFetch=true;}
if(!doFetch&&this.selectedUser.showOpps!=changed.showOpps){doFetch=!(changed.showOpps);}
if(this.displayNavigationMessage){this.dirtyUser=this.selectedUser;this.dirtyCanEdit=this.canEdit;}
this.selectedUser=changed;this.canEdit=(this.selectedUser.id==app.user.get('id'));if(doFetch){this.refreshData();}else{if(this.selectedUser.isManager&&this.selectedUser.showOpps==true&&this.layout.isVisible()){if(this.displayNavigationMessage&&this.dirtyUser.id==this.selectedUser.id){this.processNavigationMessageReturn(this.showNavigationMessage('manager_to_rep'));}else if(this.displayNavigationMessage){this.processNavigationMessageReturn(this.showNavigationMessage('user_switch'));}
this.layout.hide();}}},checkForDraftRows:function(lastCommitDate){if(this.layout.isVisible()&&this.canEdit&&!_.isUndefined(lastCommitDate)&&this.collection.length!==0&&this.hasCheckedForDraftRecords===false&&this.isCollectionSyncing===false){this.hasCheckedForDraftRecords=true;this.collection.find(function(item){if(item.get('date_modified')>lastCommitDate){this.context.parent.trigger('forecasts:worksheet:needs_commit',this.worksheetType);return true;}
return false;},this);}else if(this.layout.isVisible()===false&&this.canEdit&&this.hasCheckedForDraftRecords===false){this.layout.once('show',function(){this.checkForDraftRows(lastCommitDate);},this);}else if(this.isCollectionSyncing===true){this.collection.once('data:sync:complete',function(){this.checkForDraftRows(lastCommitDate);},this);}},setCommitLogButtonStates:function(){_.each(this.fields,function(field){if(field.def.event==='list:history_log:fire'){field.setDisabled((field.model.get('show_history_log')=="0"));if((field.model.get('show_history_log')=="0")){field.$el.find("a.rowaction").attr("data-original-title",app.lang.get("LBL_NO_COMMIT","ForecastManagerWorksheets"));}}});},sync:function(method,model,options){if(!_.isUndefined(this.context.parent)&&!_.isUndefined(this.context.parent.get('selectedUser'))){var sl=this.context.parent.get('selectedUser');if(sl.isManager==false){if(this.layout.isVisible()){this.layout.hide();}
return;}}
var callbacks,url;options=options||{};options.params=options.params||{};if(!_.isUndefined(this.selectedUser.id)){options.params.user_id=this.selectedUser.id;}
if(!_.isEmpty(this.selectedTimeperiod)){options.params.timeperiod_id=this.selectedTimeperiod;}
options.limit=1000;options=app.data.parseOptionsForSync(method,model,options);options.success=_.bind(function(model,data,options){this.collectionSuccess(data);},this);callbacks=app.data.getSyncCallbacks(method,model,options);this.collection.trigger("data:sync:start",method,model,options);url=app.api.buildURL("ForecastManagerWorksheets",null,null,options.params);app.api.call("read",url,null,callbacks);},collectionSuccess:function(data){var records=[],users=$.map(this.selectedUser.reportees,function(obj){return $.extend(true,{},obj);});users.unshift({id:this.selectedUser.id,name:this.selectedUser.full_name});var currency_id=app.currency.getBaseCurrencyId();var currency_base_rate=app.metadata.getCurrency(app.currency.getBaseCurrencyId()).conversion_rate;_.each(users,function(user){var row=_.find(data,function(rec){return(rec.user_id==this.id)},user);if(!_.isUndefined(row)){row.name=user.name;}else{row=_.clone(this.defaultValues);row.currency_id=currency_id;row.base_rate=currency_base_rate;row.user_id=user.id;row.assigned_user_id=this.selectedUser.id;row.draft=(this.selectedUser.id==app.user.id)?1:0;row.name=user.name;}
records.push(row);},this);if(!_.isUndefined(this.orderBy)){if(this.orderBy.field!=='name'){records=_.sortBy(records,function(item){if(this.orderBy.direction=="_desc"){return-item[this.orderBy.field];}else{return item[this.orderBy.field];}},this);}else{records.sort(_.bind(function(a,b){if(this.orderBy.direction=='_asc'){if(a.name.toString()<b.name.toString())return 1;if(a.name.toString()>b.name.toString())return-1;}else{if(a.name.toString()<b.name.toString())return-1;if(a.name.toString()>b.name.toString())return 1;}
return 0;},this));}}
this.collection.reset(records);},calculateTotals:function(){if(this.layout.isVisible()){this.totals=this.getCommitTotals();this.totals['display_total_label_in']=_.first(this._fields.visible).name;_.each(this._fields.visible,function(field){this.totals[field.name+'_display']=true;},this);var ctx=this.context.parent||this.context;ctx.trigger('forecasts:worksheet:totals',this.totals,this.worksheetType);}},getCommitTotals:function(){var quota=0,best_case=0,best_case_adjusted=0,likely_case=0,likely_case_adjusted=0,worst_case_adjusted=0,worst_case=0,included_opp_count=0,pipeline_opp_count=0,pipeline_amount=0,closed_amount=0;this.collection.forEach(function(model){var base_rate=parseFloat(model.get('base_rate')),mPipeline_opp_count=model.get("pipeline_opp_count"),mPipeline_amount=model.get("pipeline_amount"),mClosed_amount=model.get("closed_amount"),mOpp_count=model.get("opp_count");quota+=app.currency.convertWithRate(model.get('quota'),base_rate);best_case+=app.currency.convertWithRate(model.get('best_case'),base_rate);best_case_adjusted+=app.currency.convertWithRate(model.get('best_case_adjusted'),base_rate);likely_case+=app.currency.convertWithRate(model.get('likely_case'),base_rate);likely_case_adjusted+=app.currency.convertWithRate(model.get('likely_case_adjusted'),base_rate);worst_case+=app.currency.convertWithRate(model.get('worst_case'),base_rate);worst_case_adjusted+=app.currency.convertWithRate(model.get('worst_case_adjusted'),base_rate);included_opp_count+=(_.isUndefined(mOpp_count))?0:parseInt(mOpp_count);pipeline_opp_count+=(_.isUndefined(mPipeline_opp_count))?0:parseInt(mPipeline_opp_count);if(!_.isUndefined(mPipeline_amount)){pipeline_amount=app.math.add(pipeline_amount,mPipeline_amount);}
if(!_.isUndefined(mClosed_amount)){closed_amount=app.math.add(closed_amount,mClosed_amount);}});return{'quota':quota,'best_case':best_case,'best_adjusted':best_case_adjusted,'likely_case':likely_case,'likely_adjusted':likely_case_adjusted,'worst_case':worst_case,'worst_adjusted':worst_case_adjusted,'included_opp_count':included_opp_count,'pipeline_opp_count':pipeline_opp_count,'pipeline_amount':pipeline_amount,'closed_amount':closed_amount,'closed_count':(included_opp_count-pipeline_opp_count)};},parseFields:function(){var catalog=app.view.invokeParent(this,{type:'view',name:'recordlist',method:'parseFields'});_.each(catalog,function(group,i){catalog[i]=_.filter(group,function(fieldMeta){return app.utils.getColumnVisFromKeyMap(fieldMeta.name,'forecastsWorksheetManager');});});return catalog;},saveWorksheet:function(isDraft,suppressMessage){var saveObj={totalToSave:0,saveCount:0,model:undefined,isDraft:isDraft,suppressMessage:suppressMessage||false,timeperiod:this.dirtyTimeperiod,userId:this.dirtyUser},ctx=this.context.parent||this.context;if(this.layout.isVisible()){if(_.isUndefined(saveObj.userId)){saveObj.userId=this.selectedUser;}
saveObj.userId=saveObj.userId.id;if(this.isDirty()){saveObj.totalToSave=this.dirtyModels.length;this.dirtyModels.each(function(model){saveObj.model=model;this._worksheetSaveHelper(saveObj,ctx);},this);this.cleanUpDirtyModels();}else{if(isDraft&&saveObj.suppressMessage===false){app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get("LBL_FORECASTS_WORKSHEET_SAVE_DRAFT_SUCCESS","Forecasts")]});}
ctx.trigger('forecasts:worksheet:saved',saveObj.totalToSave,this.worksheetType,isDraft);}}
this.draftSaveType=undefined;return saveObj.totalToSave},_worksheetSaveHelper:function(saveObj,ctx){saveObj.model.set({current_user:saveObj.userId||this.selectedUser.id,timeperiod_id:saveObj.timeperiod||this.selectedTimeperiod,draft_save_type:this.draftSaveType},{silent:true});saveObj.model.save({},{success:_.bind(function(){saveObj.saveCount++;if(saveObj.totalToSave===saveObj.saveCount){if(saveObj.isDraft&&saveObj.suppressMessage===false){app.alert.show('success',{level:'success',autoClose:true,title:app.lang.get("LBL_FORECASTS_WIZARD_SUCCESS_TITLE","Forecasts")+":",messages:[app.lang.get("LBL_FORECASTS_WORKSHEET_SAVE_DRAFT_SUCCESS","Forecasts")]});}
ctx.trigger('forecasts:worksheet:saved',saveObj.totalToSave,this.worksheetType,saveObj.isDraft);}},this),silent:true,alerts:{'success':false}});}})}}},"layouts":{}},"MergeRecords":{"fieldTemplates":{},"views":{},"layouts":{}},"Quotas":{"fieldTemplates":{},"views":{},"layouts":{}},"Teams":{"fieldTemplates":{},"views":{},"layouts":{}},"TeamNotices":{"fieldTemplates":{},"views":{},"layouts":{}},"Manufacturers":{"fieldTemplates":{},"views":{},"layouts":{}},"Activities":{"fieldTemplates":{},"views":{},"layouts":{}},"Comments":{"fieldTemplates":{},"views":{},"layouts":{}},"Subscriptions":{"fieldTemplates":{},"views":{},"layouts":{}},"Bugs":{"fieldTemplates":{},"views":{},"layouts":{}},"Feeds":{"fieldTemplates":{},"views":{},"layouts":{}},"iFrames":{"fieldTemplates":{},"views":{},"layouts":{}},"TimePeriods":{"fieldTemplates":{},"views":{},"layouts":{}},"TaxRates":{"fieldTemplates":{},"views":{},"layouts":{}},"ContractTypes":{"fieldTemplates":{},"views":{},"layouts":{}},"Schedulers":{"fieldTemplates":{},"views":{},"layouts":{}},"Campaigns":{"fieldTemplates":{},"views":{},"layouts":{}},"CampaignLog":{"fieldTemplates":{},"views":{},"layouts":{}},"CampaignTrackers":{"fieldTemplates":{},"views":{},"layouts":{}},"Documents":{"fieldTemplates":{},"views":{},"layouts":{}},"DocumentRevisions":{"fieldTemplates":{},"views":{},"layouts":{}},"Connectors":{"fieldTemplates":{},"views":{},"layouts":{}},"Roles":{"fieldTemplates":{},"views":{},"layouts":{}},"Notifications":{"fieldTemplates":{"base":{"datetimecombo":{"controller":({format:function(value){if(this._getViewName()==='raw'){return value;}
return app.view.invokeParent(this,{type:'field',name:'datetimecombo',method:'render',platform:'base'});}})},"severity":{"controller":({extendsFrom:'EnumField',_styleMapping:{'default':'label',alert:'label label-important',information:'label label-info',other:'label label-inverse',success:'label label-success',warning:'label label-warning'},_render:function(){this._super('_render');var severity=this.model.get(this.name);var severityCss=this._styleMapping[severity]||this._styleMapping.default;this.getFieldElement().addClass(severityCss);}})}}},"views":{"base":{"raw":{"controller":({plugins:['Timeago'],events:{'click span.name':'toggleName'},initialize:function(options){var meta=app.metadata.getView(options.module,'raw')||{};options.meta=_.extend({},meta,options.meta||{});this._super('initialize',[options]);this._initCollection();},_initCollection:function(){this.collection.options={params:{order_by:'date_entered:desc'}};this.collection.filterDef=[];this.collection.filterDef.push({'$owner':''});if(_.isUndefined(this.meta.filter_type)){return this;}
var startDate=new Date();startDate.setHours(0,0,0);startDate.toISOString();var endDate=new Date();endDate.setHours(23,59,59);endDate.toISOString();var defaultFilters={today:{date_entered:{$dateBetween:[startDate,endDate]}},recent:{date_entered:{$lt:startDate}}};this.collection.filterDef.push(defaultFilters[this.meta.filter_type]);return this;},bindDataChange:function(){if(this.collection){this.collection.on('reset',function(){this.render();},this);}},toggleName:function(e){this.$(e.currentTarget).toggleClass('expanded');}})}}},"layouts":{}},"Sync":{"fieldTemplates":{},"views":{},"layouts":{}},"WorkFlow":{"fieldTemplates":{},"views":{},"layouts":{}},"EAPM":{"fieldTemplates":{},"views":{},"layouts":{}},"Worksheet":{"fieldTemplates":{},"views":{},"layouts":{}},"Users":{"fieldTemplates":{},"views":{},"layouts":{}},"Employees":{"fieldTemplates":{},"views":{},"layouts":{}},"Administration":{"fieldTemplates":{},"views":{},"layouts":{}},"ACLRoles":{"fieldTemplates":{},"views":{},"layouts":{}},"InboundEmail":{"fieldTemplates":{},"views":{},"layouts":{}},"Releases":{"fieldTemplates":{},"views":{},"layouts":{}},"Prospects":{"fieldTemplates":{},"views":{"base":{"convert-results":{"controller":({extendsFrom:'ConvertResultsView',populateResults:function(){if(!_.isEmpty(this.model.get('lead_id'))){var leads=app.data.createBean('Leads',{id:this.model.get('lead_id')});leads.fetch({success:_.bind(this.populateLeadCallback,this),error:function(){app.logger.error.log("error");}});}},populateLeadCallback:function(leadModel){var rowTitle;this.associatedModels.reset();rowTitle=app.lang.get('LBL_CONVERTED_LEAD',this.module);leadModel.set('row_title',rowTitle);this.associatedModels.push(leadModel);app.view.View.prototype.render.call(this);}})},"record":{"controller":({extendsFrom:'RecordView',delegateButtonEvents:function(){this.context.on('button:convert_button:click',this.convertProspectClicked,this);app.view.invokeParent(this,{type:'view',name:'record',method:'delegateButtonEvents'});},convertProspectClicked:function(){var prefill=app.data.createBean('Leads');prefill.copy(this.model);app.drawer.open({layout:'create-actions',context:{create:true,model:prefill,module:'Leads',prospect_id:this.model.get('id')}},_.bind(function(context,model){if(model&&model.id&&!this.disposed){this.model.fetch();}},this));}})}}},"layouts":{}},"Queues":{"fieldTemplates":{},"views":{},"layouts":{}},"EmailMarketing":{"fieldTemplates":{},"views":{},"layouts":{}},"EmailTemplates":{"fieldTemplates":{},"views":{},"layouts":{}},"SNIP":{"fieldTemplates":{},"views":{},"layouts":{}},"ProspectLists":{"fieldTemplates":{},"views":{"base":{"record":{"controller":({extendsFrom:'RecordView',delegateButtonEvents:function(){this.context.on('button:export_button:click',this.exportListMembers,this);app.view.invokeParent(this,{type:'view',name:'record',method:'delegateButtonEvents'});},exportListMembers:function(){app.alert.show('export_loading',{level:'process',title:app.lang.getAppString('LBL_PORTAL_LOADING')});app.api.exportRecords({module:this.module,uid:this.model.id,entire:false,members:true,filter:null},this.$el,{complete:function(){app.alert.dismiss('export_loading');}});}})}}},"layouts":{}},"SavedSearch":{"fieldTemplates":{},"views":{},"layouts":{}},"UpgradeWizard":{"fieldTemplates":{},"views":{},"layouts":{}},"Trackers":{"fieldTemplates":{},"views":{},"layouts":{}},"TrackerPerfs":{"fieldTemplates":{},"views":{},"layouts":{}},"TrackerSessions":{"fieldTemplates":{},"views":{},"layouts":{}},"TrackerQueries":{"fieldTemplates":{},"views":{},"layouts":{}},"FAQ":{"fieldTemplates":{},"views":{},"layouts":{}},"Newsletters":{"fieldTemplates":{},"views":{},"layouts":{}},"KBDocuments":{"fieldTemplates":{},"views":{},"layouts":{}},"SugarFavorites":{"fieldTemplates":{},"views":{},"layouts":{}},"PdfManager":{"fieldTemplates":{},"views":{},"layouts":{}},"OAuthKeys":{"fieldTemplates":{},"views":{},"layouts":{}},"OAuthTokens":{"fieldTemplates":{},"views":{},"layouts":{}},"Filters":{"fieldTemplates":{},"views":{},"layouts":{}},"UserSignatures":{"fieldTemplates":{},"views":{},"layouts":{}},"Library":{"fieldTemplates":{},"views":{},"layouts":{}},"EmailAddresses":{"fieldTemplates":{},"views":{},"layouts":{}},"Words":{"fieldTemplates":{},"views":{},"layouts":{}},"Styleguide":{"fieldTemplates":{},"views":{"base":{"styleguide":{"controller":({className:'container-fluid',_render:function(){var self=this;app.view.View.prototype._render.call(this);}})},"sg-headerpane":{"controller":({className:'headerpane',pageData:{},section:{},page:{},section_page:false,parent_link:'',file:'',keys:[],initialize:function(options){var self=this,keys=[];app.view.View.prototype.initialize.call(this,options);this.pageData=options.meta.page_data;this.file=this.context.get('page_name');if(this.file&&this.file!==''){keys=this.file.split('_');}
this.keys=keys;if(keys.length){if(keys[0]==='index'){if(keys.length>1){this.section=this.pageData[keys[1]];}else{this.section=this.pageData[keys[0]];}
this.section_page=true;this.file='index';}else if(keys.length>1){this.section=this.pageData[keys[0]];this.page=this.section.pages[keys[1]];this.parent_link='_'+keys[0];}else{this.section=this.pageData[keys[0]];}}},_render:function(){var self=this,$find;app.view.View.prototype._render.call(this);$find=$('#find_patterns');if($find.length)
{var $optgroup;$.each(this.pageData,function(k,v){if(!v.index)return;$optgroup=$('<optgroup>').appendTo($find).attr('label',v.title);$.each(v.pages,function(i,d){renderSearchOption(k,i,d,$optgroup);});});$find.on('change',function(e){window.location.href=$(this).val();});$find.select2();}
function renderSearchOption(section,page,d,optgroup){$('<option>').appendTo(optgroup).attr('value',(d.url?d.url:fmtLink(section,page))).text(d.label);}
function fmtLink(section,page){return'#Styleguide/docs/'+
(page?'':'index_')+section.replace(/[\s\,]+/g,'-').toLowerCase()+(page?'_'+page:'');}},})},"field":{"controller":({className:'container-fluid',section:{},parent_link:'',useTable:true,tempfields:[],errorfields:[],_render:function(){this.section.title='Form Elements';this.section.description='Basic fields that support detail, record, and edit modes with error addons.';var self=this,fieldTypeReq=this.context.get('field_type'),fieldTypes=(fieldTypeReq==='all'?['text','bool','email','date','currency']:[fieldTypeReq]),errors={required:true,'This is an error message.':{}},errorMeta={},fieldMeta={};this.useTable=(fieldTypeReq==='all'?true:false);this.parent_link=(fieldTypeReq==='all'?'docs/index.forms':'field/all');this.tempfields=[];this.errorfields=[];_.each(fieldTypes,function(fieldType){fieldMeta=_.find(self.model.fields,function(field){if(field.type==='datetime'&&fieldType.indexOf('date')===0){field.type=fieldType;}
return field.type==fieldType;},self);if(fieldMeta){if(_.isObject(self.meta['template_values'][fieldType])&&!_.isArray(self.meta['template_values'][fieldType])){_.each(self.meta['template_values'][fieldType],function(value,name){self.model.set(name,value);},self);}else{self.model.set(fieldMeta.name,self.meta['template_values'][fieldType]);}
errorMeta=app.utils.deepCopy(fieldMeta);errorMeta.name=fieldMeta.name+'_ERROR';fieldMeta.errorMeta=[];fieldMeta.errorMeta.push(errorMeta);self.tempfields.push(fieldMeta);}});if(fieldTypeReq!=='all'){this.title=fieldTypeReq+' field';var descTpl=app.template.getView('styleguide.'+fieldTypeReq,'Styleguide');if(descTpl){this.description=descTpl();}}
app.view.View.prototype._render.call(this);_.each(this.fields,function(field){if(field.tplName==='edit'){field.setMode('edit');}
if(field.tplName==='disabled'){field.setDisabled(true);field.setMode('edit');}
if(field.tplName==='error'){field.setMode('edit');self.model.trigger('error:validation:'+field.name,errors);}},this);}})},"docs":{"controller":({className:'container-fluid',pageData:{},section:{},page:{},section_page:false,parent_link:'',file:'',keys:[],initialize:function(options){var self=this,keys=[];app.view.View.prototype.initialize.call(this,options);this.pageData=app.metadata.getView('Styleguide','sg-headerpane').page_data;this.file=this.context.get('page_name');if(this.file&&this.file!==''){keys=this.file.split('_');}
this.keys=keys;if(keys.length){if(keys[0]==='index'){if(keys.length>1){this.section=this.pageData[keys[1]];}else{this.section=this.pageData[keys[0]];}
this.section_page=true;this.file='index';}else if(keys.length>1){this.section=this.pageData[keys[0]];this.page=this.section.pages[keys[1]];this.parent_link='_'+keys[0];}else{this.section=this.pageData[keys[0]];}}
var initFn=this['init_'+keys[1]];if(initFn){initFn(this.pageData);}},_render:function(){var self=this,$find;var pageContent=app.template.getView('content.'+this.file,'Styleguide');if(pageContent){this.content=pageContent(self);}
app.view.View.prototype._render.call(this);if(this.keys[0]==='index'){this.render_index(this.keys[1]);}else{var renderFn=this['render_'+this.keys[1]];if(renderFn){renderFn(self);}
window.prettyPrint&&prettyPrint();}},init_labels:function(pageData){pageData.module_list=[];if(app.metadata.getModuleNames(true,'read')){_.each(app.metadata.getModuleNames(true,'read'),function(val){if(['Home'].indexOf(val)===-1){pageData.module_list.push(val);}});}
pageData.module_list.sort();},render_jstree:function(view){view.$('#people').jstree({"json_data":{"data":[{"data":"Sabra Khan","state":"open","metadata":{id:1},"children":[{"data":"Mark Gibson","metadata":{id:2}},{"data":"James Joplin","metadata":{id:3}},{"data":"Terrence Li","metadata":{id:4}},{"data":"Amy McCray","metadata":{id:5},"children":[{"data":"Troy McClure","metadata":{id:6}},{"data":"James Kirk","metadata":{id:7}}]}]}]},"plugins":["json_data","ui","types"]}).bind('loaded.jstree',function(){view.$('#people').addClass('jstree-sugar');view.$('#people > ul').addClass('list');view.$('#people > ul > li > a').addClass('jstree-clicked');}).bind('select_node.jstree',function(e,data){data.inst.toggle_node(data.rslt.obj);});},render_editable:function(view){view.$('.url-editable-trigger').on('click.styleguide',function(){var uefield=$(this).next();uefield.html(uefield.text()).editable(function(value,settings){var nvprep='<a href="'+value+'">',nvapp='</a>',value=nvprep.concat(value);return(value);},{onblur:'submit'}).trigger('click.styleguide');});view.$('.text-editable-trigger').on('click.styleguide',function(){var uefield=$(this).next();uefield.html(uefield.text()).editable().trigger('click.styleguide');});view.$('.urleditable-field > a').each(function(){if(isEllipsis($(this))===true){$(this).attr({'data-original-title':$(this).text(),'rel':'tooltip','class':'longUrl'});}});function isEllipsis(e){return(e[0].offsetWidth<e[0].scrollWidth);}
view.$('.longUrl[rel=tooltip]').tooltip({placement:'top'});},render_switch:function(view){view.$('#mySwitch').on('switch-change',function(e,data){var $el=$(data.el),value=data.value;});},render_datetime:function(view){view.model.start_date='2000-01-01T22:47:00+00:00';var fieldSettingsDate={view:view,def:{name:'start_date',type:'date',view:'edit',enabled:true},viewName:'edit',context:view.context,module:view.module,model:view.model,meta:app.metadata.getField('date')},dateField=app.view.createField(fieldSettingsDate);view.$('#sugar7_date').append(dateField.el);dateField.render();view.model.start_datetime='2000-01-01T22:47:00+00:00';var fieldSettingsCombo={view:view,def:{name:'start_datetime',type:'datetimecombo',view:'edit',enabled:true},viewName:'edit',context:view.context,module:view.module,model:view.model,meta:app.metadata.getField('datetimecombo')},datetimecomboField=app.view.createField(fieldSettingsCombo);view.$('#sugar7_datetimecombo').append(datetimecomboField.el);datetimecomboField.render();view.$('#dp1').datepicker();view.$('#tp1').timepicker();view.$('#dp2').datepicker({format:'mm-dd-yyyy'});view.$('#tp2').timepicker({timeFormat:'H.i.s'});view.$('#dp3').datepicker();var startDate=new Date(2012,1,20);var endDate=new Date(2012,1,25);view.$('#dp4').datepicker().on('changeDate',function(ev){if(ev.date.valueOf()>endDate.valueOf()){view.$('#alert').show().find('strong').text('The start date can not be greater then the end date');}else{view.$('#alert').hide();startDate=new Date(ev.date);view.$('#startDate').text(view.$('#dp4').data('date'));}
view.$('#dp4').datepicker('hide');});view.$('#dp5').datepicker().on('changeDate',function(ev){if(ev.date.valueOf()<startDate.valueOf()){view.$('#alert').show().find('strong').text('The end date can not be less then the start date');}else{view.$('#alert').hide();endDate=new Date(ev.date);view.$('#endDate').text(view.$('#dp5').data('date'));}
view.$('#dp5').datepicker('hide');});view.$('#tp3').timepicker({'scrollDefaultNow':true});view.$('#tp4').timepicker();view.$('#tp4_button').on('click',function(){view.$('#tp4').timepicker('setTime',new Date());});view.$('#tp5').timepicker({'minTime':'2:00pm','maxTime':'6:00pm','showDuration':true});view.$('#tp6').timepicker();view.$('#tp6').on('changeTime',function(){view.$('#tp6_legend').text('You selected: '+$(this).val());});view.$('#tp7').timepicker({'step':5});},render_modals:function(view){view.$('[rel=popover]').popover();view.$('.modal').tooltip({selector:'[rel=tooltip]'});view.$('#dp1').datepicker({format:'mm-dd-yyyy'});view.$('#dp3').datepicker();view.$('#tp1').timepicker();},render_wizard:function(view){view.$('#launch_simple_wizard').on('click.styleguide',function(e){wizard.init({id:'wizardSimpleDemo',modalUrl:'styleguide/content/wizard-modal.html',className:'setup',headerText:'Simple Wizard Demo',navMenu:new Array('Screen Two','Screen Screen Three','Screen Four')});e.stopPropagation();e.preventDefault();});view.$('#launch_wizard').on('click.styleguide',function(e){wizard.init({id:'wizardDemo',modalUrl:'styleguide/content/wizard-modal.html',className:'setup',headerText:'Custom Wizard Demo',navMenu:new Array('Screen Two','Screen Screen Three','Screen Four'),'onWizardStart':function(){view.$('#wizardDemo .start').live('click',function(){view.$('#wizardDemo .manual').css('display','none');});},defaults:{startText:'Setup Wizard','footer':function(){return'<div class="modal-footer">'+'<a href="#" class="btn btn-invisible btn-link pull-left cancel">'+this.cancelText+'</a>'+'<a class="btn back" href="#">'+this.backText+'</a>'+'<a class="btn btn-primary next" href="#">'+this.nextText+'</a>'+'<a class="btn btn-primary finish" href="#">'+this.finishText+'</a>'+'<a href="#" class="btn manual">Manual Setup</a>'+'<a class="btn btn-primary start" href="#">'+this.startText+'</a>'+'</div>';}}});e.stopPropagation();e.preventDefault();});},render_tooltips:function(view){$('body').tooltip({selector:'[rel=tooltip]'});},render_dropdowns:function(view){view.$('#mm001demo *').on('click.styleguide',function(){return false;});view.$('*').on('click.styleguide',function(){setTimeout(function(){view.$('#mm001demo').find('li.open .btn-group').addClass('open');},0.1);});},render_popovers:function(view){view.$('[rel=popover]').popover();view.$('[rel=popoverHover]').popover({trigger:'hover'});view.$('[rel=popoverTop]').popover({placement:'top'});view.$('[rel=popoverBottom]').popover({placement:'bottom'});},render_alerts:function(view){$(document).keyup(function(e){if(e.keyCode===27){view.$('.alert-top .timeten').hide();view.$('.alert-confirm').modal('hide');}});setTimeout(function(){view.$('.timeten').fadeOut().remove();},9000);view.$('.alert-confirm').on('show.styleguide',function(){var modal=$(this);modal.find('a.close').off('click').on('click',function(e){modal.modal('hide');});modal.find('a.leave').off('click').on('click',function(e){modal.modal('hide');});modal.find('a.return').off('click').on('click',function(e){modal.modal('hide');});}).modal({'backdrop':'static','show':false});view.$('a').on('click.styleguide',function(e){e.preventDefault();e.stopPropagation();view.$('.alert-confirm').modal('show');view.$('.alert-confirm a.leave').attr('href',e.target.href);});},render_drawer:function(view){view.$('#sg_open_drawer').on('click.styleguide',function(){app.drawer.open({layout:'create',context:{create:true,model:app.data.createBean('Styleguide')}});});},render_tabs:function(view){view.$('#nav-tabs-pills').find('ul.nav-tabs > li > a, ul.nav-list > li > a, ul.nav-pills > li > a').on('click.styleguide',function(e){e.preventDefault();e.stopPropagation();$(this).tab('show');});},render_inputs:function(view){view.$('.error input, .error textarea').on('focus.styleguide',function(){$(this).next().tooltip('show');});view.$('.error input, .error textarea').on('blur.styleguide',function(){$(this).next().tooltip('hide');});view.$('.add-on').tooltip({trigger:'click',container:'body'});},render_range:function(view){var fieldSettings={view:view,def:{name:'include',type:'range',view:'edit',sliderType:'connected',minRange:0,maxRange:100,'default':true,enabled:true},viewName:'edit',context:view.context,module:view.module,model:view.model,meta:app.metadata.getField('range')},rangeField=app.view.createField(fieldSettings);view.$('#test_slider').append(rangeField.el);rangeField.render();rangeField.sliderDoneDelegate=function(minField,maxField){return function(value){minField.val(value.min);maxField.val(value.max);};}(view.$('#test_slider_min'),view.$('#test_slider_max'));},render_index:function(section){var self=this,i=0,m='',l=0;if(!section){$.each(this.pageData,function(kS,vS){if(!vS.index)return;m+=(i%3===0?'<div class="row-fluid">':'');m+='<div class="span4"><h3>'+'<a class="section-link" href="'+
(vS.url?vS.url:fmtLink(kS))+'">'+
vS.title+'</a></h3><p>'+vS.description+'</p><ul>';if(vS.pages){$.each(vS.pages,function(kP,vP){m+='<li ><a class="section-link" href="'+
(vP.url?vP.url:fmtLink(kS,kP))+'">'+
vP.label+'</a></li>';});}
m+='</ul></div>';m+=(i%3===2?'</div>':'');i+=1;});}else{$.each(this.pageData[section].pages,function(kP,vP){m+=(i%4===0?'<div class="row-fluid">':'');m+='<div class="span3"><h3>'+
(!vP.items?('<a class="section-link" href="'+(vP.url?vP.url:fmtLink(section,kP))+'">'+vP.label+'</a>'):vP.label)+'</h3><p>'+vP.description;m+='</p></div>';m+=(i%4===3?'</div>':'');i+=1;});}
$('#index-content').append('<section id="section-menu"></section>').html(m);function fmtLink(section,page){return'#Styleguide/docs/'+
(page?'':'index_')+section.replace(/[\s\,]+/g,'-').toLowerCase()+(page?'_'+page:'');}
(function($){jQuery.expr[':'].Contains=function(a,i,m){return(a.textContent||a.innerText||'').toUpperCase().indexOf(m[3].toUpperCase())>=0;};function filterList($input,$list){$input.on('change.styleguide',function(){var filter=$(this).val();if(filter)
{$list.find('p').hide();var $matches=$list.find('ul').find('a:Contains('+filter+')').parent();$('li',$list).not($matches).slideUp();$matches.slideDown();}
else
{$list.find('p').show();$list.find('li').slideDown();}
return false;}).on('keyup.styleguide',function(){$(this).change();});}
$(function(){filterList($('.filterinput'),$('#index-content'));});}(jQuery));}})}}},"layouts":{"base":{"styleguide":{"controller":({_placeComponent:function(component){this.$('#styleguide').append(component.$el);}})},"field":{"controller":({plugins:['Prettify'],_placeComponent:function(component){this.$('#styleguide').append(component.$el);}})},"docs":{"controller":({plugins:['Prettify'],_placeComponent:function(component){this.$('#styleguide').append(component.$el);}})}}}},"Sugar_Favorites":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_finance_performance":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_member_levels":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Memberships":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Account_Plan":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Touch_Points":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Program_Catalogue":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Program":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Sponsor":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Sponsors":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Registrants":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Contractors":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Hotels":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Orders":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Invoices":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Payments":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Events":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Sessions":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Speakers":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Sponsorship_Types":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Sponsorship":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Council":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Council_Memberships":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Council_Members":{"fieldTemplates":{},"views":{},"layouts":{}},"Bhea_Councils":{"fieldTemplates":{},"views":{},"layouts":{}},"bhea_Sponsorship_Types":{"fieldTemplates":{},"views":{},"layouts":{}},"Audit":{"fieldTemplates":{"base":{"fieldtype":{"controller":({format:function(value){if(this.context&&this.context.parent){var parentModel=this.context.parent.get('model'),field=parentModel.fields[value];if(field){value=app.lang.get(field.label||field.vname,parentModel.module);}}
return value;}})}}},"views":{},"layouts":{}}}}})(SUGAR.App);